---
title: udpä¸¢åŒ…æ’æŸ¥
date: 2024-03-21 21:50:17
tags: [c++,linux,udp]
---



> æœ€è¿‘åœ¨å†™é¡¹ç›®çš„æ—¶å€™ï¼Œå‘ç°äº†udpä¸¢åŒ…æƒ…å†µï¼Œç‰¹æ­¤è®°å½•ä¸€ä¸‹



# é—®é¢˜æè¿°

- åœ¨ä½¿ç”¨**æœ¬åœ°ç½‘å¡**å‘é€å¤šä¸ªudpåŒ…æ—¶ï¼Œä¼šå‡ºç°ä¸¢åŒ…é—®é¢˜
  - å®¢æˆ·ç«¯å‘é€1000ä¸ªudpåŒ…
  - æœåŠ¡ç«¯åªæ”¶åˆ°900å¤šä¸ªåŒ…

# é—®é¢˜å¤ç°

æˆ‘å†™äº† server.cc å’Œ client.cc æ¥å¤ç°è¿™ä¸ªé—®é¢˜

[/udp/server.cc](https://github.com/kehaha-5/kehaha-5.github.io/blob/main/source/_posts/2024-03-21-udp%E4%B8%A2%E5%8C%85%E6%8E%92%E6%9F%A5/udp_drop_packets_test/udp/server.cc) 


[/udp/client.cc](https://github.com/kehaha-5/kehaha-5.github.io/blob/main/source/_posts/2024-03-21-udp%E4%B8%A2%E5%8C%85%E6%8E%92%E6%9F%A5/udp_drop_packets_test/udp/client.cc)

é€šè¿‡ä¸Šè¿°ä»£ç å¯çŸ¥é“ï¼Œå®¢æˆ·ç«¯å°†ä¼šæ¯ç§’å‘é€ä¸€å®šæ•°é‡çš„udpåŒ…ç»™æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯å°±æ˜¯æ¯ç§’æ˜¾ç¤ºå®ƒæ‰€æ¥æ”¶åˆ°çš„åŒ…æ•°é‡

# æµ‹è¯•ç»“æœ

![SER](.\1-1.png)

![CLI](.\1-2.png)

# é—®é¢˜åˆ†æ

æˆ‘ä»¬ä»ä¸Šå›¾ä¸­å¯ä»¥çœ‹åˆ°å½“å®¢æˆ·ç«¯æ¯ç§’å‘é€1000ä¸ªudpåŒ…æ—¶ï¼ŒæœåŠ¡ç«¯åªæ¥å—åˆ°äº†ä¸åˆ°1000ï¼Œé‚£å‰©ä¸‹æ²¡æœ‰æ¥æ”¶åˆ°çš„åŒ…å»å“ªé‡Œäº†ğŸ¤”ï¼Œè¿™æ—¶æˆ‘ä»¬å¯ä»¥åˆ©ç”¨`sar`æ¥è¿›è¡Œç½‘ç»œåˆ†æ

![CLI](.\1-3.png)

æˆ‘ä»¬å¯ä»¥çœ‹åˆ° ` odgm/s` è·Ÿæˆ‘ä»¬clientæ¯ç§’å‘é€çš„åŒ…çš„æ•°é‡ä¸€è‡´ï¼Œ`idgm/s`è¡¨ç¤ºçš„æ—¶æ¯ç§’é€è¾¾çš„åŒ…æ•°é‡ï¼Œä½†æ˜¯ä¸è·Ÿ`odgm/s`ç›¸åŒï¼Œè€Œæ²¡æœ‰æ”¶åˆ°çš„åŒ…æ•°é‡åˆšå¥½ç­‰äº` idgmerr/s` é‚£ä¹ˆè¿™ä¸ª` idgmerr/s`æ‰€è¡¨ç¤ºçš„æ˜¯ä»€ä¹ˆæï¼Œé€šè¿‡æŸ¥è¯¢å‘ç°è§£é‡Šå¦‚ä¸‹ [æŸ¥çœ‹]( https://www.man7.org/linux/man-pages/man1/sar.1.html#:~:text=idgmerr/s%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20The%20number%20of%20received%20UDP%20datagrams%20per%20second%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20that%20could%20not%20be%20delivered%20for%20reasons%20other%20than%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20the%20lack%20of%20an%20application%20at%20the%20destination%20port%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5BudpInErrors%5D.)

> idgmerr/s
> The number of received UDP datagrams per second that could not be delivered for reasons other than the lack of an application at the destination port [udpInErrors].

ä½†æ˜¯udpä¸¢åŒ…çš„åŸå› æœ‰å¾ˆå¤š

- ç½‘å¡é©±åŠ¨ä¸¢åŒ…
- å†…æ ¸ç¼“å†²åŒºä¸¢åŒ…
- æ€§èƒ½ä¸è¶³å¯¼è‡´ä¸¢åŒ…
  - cpuæ»¡è½½
  - free memå¤ªå°‘
  - ....

ä¸ºäº†æ›´è¿‘ä¸€æ­¥åœ°åˆ†ææ˜¯ä»€ä¹ˆåŸå› å¯¼è‡´çš„ä¸¢åŒ…ï¼Œåˆ©ç”¨ `netstat ` è¿›è¡Œåˆ†æ

## ç½‘å¡é©±åŠ¨ä¸¢åŒ…

åˆ©ç”¨`netstat -i`çœ‹æŸ¥çœ‹ç½‘å¡ä¿¡æ¯

```text
Kernel Interface table
Iface      MTU    RX-OK RX-ERR RX-DRP RX-OVR    TX-OK TX-ERR TX-DRP TX-OVR Flg
eth0      1432      517      0      0 0           378      0      0      0 BMRU
lo       65536    48420      0      0 0         48420      0      0      0 LRU
```

æˆ‘ä»¬æ˜¯åœ¨æœ¬åœ°è¿›è¡Œæµ‹è¯•çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ç”¨çš„æ˜¯æœ¬åœ°ç½‘å¡(lo)ï¼Œä½†æ˜¯é€šè¿‡æŸ¥çœ‹å‘ç°å®ƒä»¬çš„`RX-ERR` ` RX-DRP` `RX-OVR` éƒ½ä¸º0ï¼Œå³ç½‘å¡é©±åŠ¨æ²¡æœ‰ä¸¢åŒ…

## å†…æ ¸ç¼“å†²åŒºä¸¢åŒ…

åˆ©ç”¨`netstat -su`æ¥æŸ¥çœ‹ä¿¡æ¯

- åœ¨å¼€å§‹æµ‹è¯•å‰è®°å½•ä¸€æ¬¡

  ```text
  Udp:
      18 packets received
      0 packets to unknown port received
      0 packet receive errors
      18 packets sent
      0 receive buffer errors
      0 send buffer errors
  UdpLite:
  IpExt:
      InOctets: 25796930
      OutOctets: 25722753
      InNoECTPkts: 1414
  ```

- åœ¨æ‰§è¡Œæµ‹è¯•åå†æŸ¥çœ‹ä¿¡æ¯

  ```text
  IcmpMsg:
      InType3: 1
      OutType3: 1
  Udp:
      11257 packets received
      1 packets to unknown port received
      373 packet receive errors
      11631 packets sent
      373 receive buffer errors
      0 send buffer errors
      IgnoredMulti: 1
  UdpLite:
  IpExt:
      InBcastPkts: 1
      InOctets: 616541094
      OutOctets: 616446301
      InBcastOctets: 229
      InNoECTPkts: 17160
  ```

- å†ç»“åˆ`sar` çš„ä¿¡æ¯è¿›è¡ŒæŸ¥çœ‹

  ```text
  Linux 5.15.133.1-microsoft-standard-WSL2 (DESKTOP-4GO6ORF)      03/22/24        _x86_64_        (8 CPU)
  
  10:56:08       idgm/s    odgm/s  noport/s idgmerr/s
  10:56:09         0.00      0.00      0.00      0.00
  10:56:10         0.00      0.00      0.00      0.00
  10:56:11       993.00   1000.00      0.00      7.00
  10:56:12       926.00   1000.00      0.00     74.00
  10:56:13       931.00   1000.00      0.00     69.00
  10:56:14       943.00   1000.00      0.00     57.00
  10:56:15       980.00   1000.00      0.00     20.00
  10:56:16       983.00   1002.00      0.00     19.00
  10:56:17       981.00   1000.00      0.00     19.00
  10:56:18       957.00   1000.00      0.00     43.00
  10:56:19       935.00   1000.00      0.00     65.00
  10:56:20         0.00      0.00      0.00      0.00
  10:56:21         0.00      0.00      0.00      0.00
  ```

ä»ä¸Šè¿°ä¸­ï¼Œå‘ç° `packet receive errors`  ç»Ÿè®¡åˆ°çš„ä¸¢åŒ…æ•°é‡è·Ÿ   `idgmerr/s` çš„æ•°é‡å·®ä¸å¤šï¼Œå› æ­¤å¯ä»¥ç¡®å®šä¸¢åŒ…çš„[åŸå› ](https://linux-tips.com/t/udp-packet-drops-and-packet-receive-error-difference/237#:~:text=There%20are%2038491,or%20kernel%20side)

- udp packet header corruption or checksum problems
- packet receive buffer problems in application or kernel side

åœ¨çœ‹åˆ°`receive buffer errors`çš„æ•°é‡å’Œ `packet receive errors`ä¸€è‡´å¯ä»¥ç¡®å®šä¸¢åŒ…çš„åŸå› å°±æ˜¯ packet receive buffer problems in application or kernel side

## æ€§èƒ½ä¸è¶³å¯¼è‡´ä¸¢åŒ…

åœ¨æµ‹è¯•æ—¶æ‰§è¡Œ`sar`å‘½ä»¤æŸ¥çœ‹cpu å’Œ å†…å­˜ä½¿ç”¨æƒ…å†µ

```text
sar -u 1
Linux 5.15.133.1-microsoft-standard-WSL2 (DESKTOP-4GO6ORF)      03/22/24        _x86_64_        (8 CPU)

14:38:19        CPU     %user     %nice   %system   %iowait    %steal     %idle
14:38:20        all      0.37      0.00      0.87      0.00      0.00     98.75
14:38:21        all      0.25      0.00      0.25      0.00      0.00     99.50
14:38:22        all      1.38      0.00      1.63      0.00      0.00     96.99
14:38:23        all      0.25      0.00      0.87      0.12      0.00     98.75
14:38:24        all      0.38      0.00      0.63      0.00      0.00     99.00
14:38:25        all      0.25      0.00      0.50      0.00      0.00     99.25
14:38:26        all      0.25      0.00      1.12      0.00      0.00     98.63
14:38:27        all      0.25      0.00      0.25      0.00      0.00     99.50
14:38:28        all      0.37      0.00      1.12      0.00      0.00     98.50
14:38:29        all      0.25      0.00      0.25      0.00      0.00     99.50
14:38:30        all      0.63      0.00      0.38      0.00      0.00     99.00
14:38:31        all      0.13      0.00      0.13      0.00      0.00     99.75
14:38:32        all      0.25      0.00      0.75      0.00      0.00     99.00
14:38:33        all      0.12      0.00      0.25      0.00      0.00     99.62
14:38:34        all      0.63      0.00      0.38      0.25      0.00     98.75
14:38:35        all      0.13      0.00      0.25      0.00      0.00     99.62
14:38:36        all      0.25      0.00      1.12      0.00      0.00     98.62
14:38:37        all      0.25      0.00      0.00      0.00      0.00     99.75
14:38:38        all      0.37      0.00      0.62      0.00      0.00     99.00
14:38:39        all      0.00      0.00      0.13      0.88      0.00     99.00
^C
Average:        all      0.34      0.00      0.58      0.06      0.00     99.02
```

```text
sar -r 1 -h
Linux 5.15.133.1-microsoft-standard-WSL2 (DESKTOP-4GO6ORF)      03/22/24        _x86_64_        (8 CPU)

14:38:20    kbmemfree   kbavail kbmemused  %memused kbbuffers  kbcached  kbcommit   %commit  kbactive   kbinact   kbdirty
14:38:21         3.9G      4.4G      1.1G     19.4%     52.5M    688.2M      1.4G     21.0%    286.4M      1.3G      0.0k
14:38:22         3.9G      4.4G      1.1G     19.4%     52.5M    688.2M      1.4G     21.0%    286.5M      1.3G      0.0k
14:38:23         3.9G      4.4G      1.1G     19.4%     52.5M    688.2M      1.4G     21.0%    286.5M      1.3G      4.0k
14:38:24         3.9G      4.4G      1.1G     19.5%     52.5M    688.2M      1.4G     21.0%    286.5M      1.3G     16.0k
14:38:25         3.9G      4.4G      1.1G     19.5%     52.5M    688.2M      1.4G     21.0%    286.5M      1.3G    108.0k
14:38:26         3.9G      4.4G      1.1G     19.4%     52.5M    688.2M      1.4G     21.0%    286.5M      1.3G      0.0k
14:38:27         3.9G      4.4G      1.1G     19.5%     52.5M    688.2M      1.4G     21.0%    286.5M      1.3G      0.0k
14:38:28         3.8G      4.4G      1.1G     19.5%     52.5M    688.2M      1.4G     21.0%    286.5M      1.3G      0.0k
14:38:29         3.9G      4.4G      1.1G     19.5%     52.5M    688.2M      1.4G     21.0%    286.5M      1.3G     16.0k
14:38:30         3.9G      4.4G      1.1G     19.4%     52.5M    688.2M      1.4G     21.0%    286.5M      1.3G     16.0k
14:38:31         3.9G      4.4G      1.1G     19.4%     52.5M    688.2M      1.4G     21.0%    286.5M      1.3G     16.0k
14:38:32         3.9G      4.4G      1.1G     19.4%     52.5M    688.2M      1.4G     21.0%    286.5M      1.3G     16.0k
14:38:33         3.9G      4.4G      1.1G     19.4%     52.5M    688.2M      1.4G     21.0%    286.5M      1.3G     16.0k
14:38:34         3.8G      4.4G      1.1G     19.6%     52.5M    688.2M      1.4G     21.0%    286.5M      1.3G     16.0k
14:38:35         3.9G      4.4G      1.1G     19.4%     52.5M    688.2M      1.4G     21.0%    286.5M      1.3G     16.0k
14:38:36         3.9G      4.4G      1.1G     19.5%     52.5M    688.2M      1.4G     21.0%    286.5M      1.3G     20.0k
14:38:37         3.8G      4.4G      1.1G     19.5%     52.5M    688.2M      1.4G     20.8%    286.5M      1.3G     20.0k
14:38:38         3.9G      4.4G      1.1G     19.5%     52.5M    688.2M      1.4G     20.7%    286.5M      1.3G     96.0k
14:38:39         3.8G      4.4G      1.1G     19.5%     52.5M    688.2M      1.4G     20.7%    286.5M      1.3G     96.0k
14:38:40         3.8G      4.4G      1.1G     19.5%     52.5M    688.2M      1.4G     20.7%    286.5M      1.3G     96.0k
^C

Average:         3.9G      4.4G      1.1G     19.5%     52.5M    688.2M      1.4G     21.0%    286.5M      1.3G     28.4k
```

é€šè¿‡ä¸Šé¢æŸ¥çœ‹å¹¶æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œå› æ­¤æ€§èƒ½é—®é¢˜è¢«æ’é™¤

# è§£å†³æ–¹æ³•

## å¢åŠ ç¼“å†²åŒº

åœ¨æŸ¥è¯¢`socket`æ—¶ï¼Œå‘ç°å®ƒæœ‰ä¸€ä¸ªoption [SO_RCVBUF](https://www.man7.org/linux/man-pages/man7/socket.7.html#:~:text=SO_RCVBUF%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20Sets%20or,option%20is%20256.)

> ```
>  SO_RCVBUF
>               Sets or gets the maximum socket receive buffer in bytes.
>               The kernel doubles this value (to allow space for
>               bookkeeping overhead) when it is set using setsockopt(2),
>               and this doubled value is returned by getsockopt(2).  The
>               default value is set by the
>               /proc/sys/net/core/rmem_default file, and the maximum
>               allowed value is set by the /proc/sys/net/core/rmem_max
>               file.  The minimum (doubled) value for this option is 256.
> ```

ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¿®æ”¹è¿™ä¸ªå€¼å»å¢å¤§æ¥æ”¶ç«¯çš„buffï¼Œä½†æ˜¯æœ€å¤§å€¼ä¸èƒ½è¶…è¿‡ `/proc/sys/net/core/rmem_max`ï¼Œå½“ç„¶æˆ‘ä»¬ä¹Ÿæ˜¯å¯ä»¥é€šè¿‡å‘½ä»¤æ¥ä¿®æ”¹`/proc/sys/net/core/rmem_max`çš„å€¼

```bash
sysctl -w net.core.rmem_max=26214400 # è®¾ç½®ä¸º 25M
```

è‹¥è§‰å¾—è¦ç”¨å‘½ä»¤ä¿®æ”¹å¤ªéº»çƒ¦æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ [SO_RCVBUFFORCE](https://www.man7.org/linux/man-pages/man7/socket.7.html#:~:text=SO_RCVBUFFORCE%20(since%20Linux%202.6.14)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20Using%20this%20socket%20option%2C%20a%20privileged%20(CAP_NET_ADMIN)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20process%20can%20perform%20the%20same%20task%20as%20SO_RCVBUF%2C%20but%20the%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20rmem_max%20limit%20can%20be%20overridden.) éœ€è¦rootæƒé™æ‰§è¡Œ

> ```text
> SO_RCVBUFFORCE (since Linux 2.6.14)
>        Using this socket option, a privileged (CAP_NET_ADMIN)
>        process can perform the same task as SO_RCVBUF, but the
>        rmem_max limit can be overridden.
> ```

æˆ‘è¿™é‡Œé€šè¿‡åœ¨ä»£ç ä¸­ä½¿ç”¨`setsockopt()`å’Œ`SO_RCVBUFFORCE`å¢åŠ ç¨‹åºä¸­socketçš„æ¥æ”¶ç¼“å†²åŒºå¤§å° 

[/udp/server_increase_recv_buff.cc](https://github.com/kehaha-5/kehaha-5.github.io/blob/main/source/_posts/2024-03-21-udp%E4%B8%A2%E5%8C%85%E6%8E%92%E6%9F%A5/udp_drop_packets_test/udp/server_increase_recv_buff.cc)

```c++
  int socket_opt_recv_buff = 0;
  socklen_t socket_opt_recv_buff_len = sizeof(socket_opt_recv_buff);

  if (getsockopt(socketfd, SOL_SOCKET, SO_RCVBUF, &socket_opt_recv_buff,
                 &socket_opt_recv_buff_len) == -1) {
    perror("getsockopt");
    exit(EXIT_FAILURE);
  }
```



# å†æ¬¡æµ‹è¯•

```text
kehaha@DESKTOP-4GO6ORF:~/projects/study/blogsDemos/epoll_read_even_and_sendto$ sudo ./build/SER_INC 134217728 #128M
setsocket opt recvbuff :134217728
socket recvbuff :268435456
udp bind is listenning ... port 8888
hasRevc:0
hasRevc:0
hasRevc:10000
hasRevc:20000
hasRevc:30000
hasRevc:40000
hasRevc:50000
hasRevc:60000
hasRevc:70000
hasRevc:80000
hasRevc:90000
hasRevc:100000
hasRevc:110000
hasRevc:120000
hasRevc:130000
hasRevc:140000
```

```text
kehaha@DESKTOP-4GO6ORF:~/projects/study/blogsDemos/epoll_read_even_and_sendto$ ./build/CLI 10000 # 1000*64kb ~ 62.5M
hasSendPacketsNum:10000
hasSendPacketsNum:20000
hasSendPacketsNum:30000
hasSendPacketsNum:40000
hasSendPacketsNum:50000
hasSendPacketsNum:60000
hasSendPacketsNum:70000
hasSendPacketsNum:80000
hasSendPacketsNum:90000
hasSendPacketsNum:100000
hasSendPacketsNum:110000
hasSendPacketsNum:120000
hasSendPacketsNum:130000
```

```text
kehaha@DESKTOP-4GO6ORF:~$ sudo sar -n UDP 1
Linux 5.15.133.1-microsoft-standard-WSL2 (DESKTOP-4GO6ORF)      03/22/24        _x86_64_        (8 CPU)

14:54:45       idgm/s    odgm/s  noport/s idgmerr/s
14:54:46     10000.00  10000.00      0.00      0.00
14:54:47     10000.00  10000.00      0.00      0.00
14:54:48     10000.00  10000.00      0.00      0.00
14:54:49     10000.00  10000.00      0.00      0.00
14:54:50     10000.00  10000.00      0.00      0.00
14:54:51     10000.00  10000.00      0.00      0.00
14:54:52     10000.00  10000.00      0.00      0.00
14:54:53     10000.00  10000.00      0.00      0.00
14:54:54     10000.00  10000.00      0.00      0.00
14:54:55     10000.00  10000.00      0.00      0.00
14:54:56     10000.00  10000.00      0.00      0.00
14:54:57     10000.00  10000.00      0.00      0.00
14:54:58         0.00      0.00      0.00      0.00
14:54:59         0.00      0.00      0.00      0.00
^C

Average:      8571.43   8571.43      0.00      0.00
```

é€šè¿‡ä¸Šè¿°è§‚å¯Ÿï¼Œè¿™ä¸ªä¸¢åŒ…é—®é¢˜å°±è¢«è§£å†³äº†âœŒ

# æ€»ç»“

## æ‰©å±•

- æˆ‘è¿™æ¬¡ä¸»è¦é—®é¢˜æ˜¯æ¥æ”¶ç«¯çš„buffä¸è¶³å¯¼è‡´ä¸¢åŒ…ï¼Œå¦‚æœæ˜¯å‘é€ç«¯å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•è§£å†³

  - ä¿®æ”¹ `/proc/sys/net/core/wmem_max` å’Œ `/proc/sys/net/core/wmem_default`

    ```bash
    sysctl -w net.core.wmem_max=26214400 # è®¾ç½®ä¸º 25M
    ```

  - ä½¿ç”¨`setsockopt()`

    - [SO_SNDBUF ](https://www.man7.org/linux/man-pages/man7/socket.7.html#:~:text=SO_SNDBUF%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20Sets%20or,option%20is%202048.)

       > ```text
        > SO_SNDBUF
        >               Sets or gets the maximum socket send buffer in bytes.  The
        >               kernel doubles this value (to allow space for bookkeeping
        >               overhead) when it is set using setsockopt(2), and this
        >               doubled value is returned by getsockopt(2).  The default
        >               value is set by the /proc/sys/net/core/wmem_default file
        >               and the maximum allowed value is set by the
        >               /proc/sys/net/core/wmem_max file.  The minimum (doubled)
        >               value for this option is 2048.
        > ```

    - [SO_SNDBUFFORCE ](https://www.man7.org/linux/man-pages/man7/socket.7.html#:~:text=SO_SNDBUFFORCE%20(since%20Linux%202.6.14)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20Using%20this%20socket%20option%2C%20a%20privileged%20(CAP_NET_ADMIN)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20process%20can%20perform%20the%20same%20task%20as%20SO_SNDBUF%2C%20but%20the%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20wmem_max%20limit%20can%20be%20overridden.)

       > ```text
        >        SO_SNDBUFFORCE (since Linux 2.6.14)
        >               Using this socket option, a privileged (CAP_NET_ADMIN)
        >               process can perform the same task as SO_SNDBUF, but the
        >               wmem_max limit can be overridden.
        > ```
    
  - ä½¿ç”¨`epoll`å‡½æ•°å»ç›‘å¬[POLLOUT](https://www.man7.org/linux/man-pages/man7/socket.7.html#:~:text=The%20user%20can%20then%20wait%20for%20various%20events%20via%0A%20%20%20%20%20%20%20poll(2)%20or%20select(2).)äº‹ä»¶

    ```text
    The user can then wait for various events via poll(2) or select(2).
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                          I/O events                           â”‚
           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    		.....
           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
           â”‚ Write      â”‚ POLLOUT   â”‚ Socket has enough send buffer space  â”‚
           â”‚            â”‚           â”‚ for writing new data.                â”‚
           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    		.....
    ```

    

- å½“ç„¶æˆ‘åœ¨ç½‘ä¸Šçœ‹å…¶å®ƒæ–‡ç« é‡Œé¢ä¹Ÿæœ‰å†™åˆ°å¯ä»¥é€šè¿‡å¢åŠ  `net.core.netdev_max_backlog` å‚æ•°æ¥è§£å†³ï¼Œä½†æ˜¯æœ‰äº›æ–‡ç« å´ä¸æ˜¯è¿™æ ·è®¤ä¸º [æ—¥å¸¸æ’éšœï¼šUDP ä¸¢åŒ…é—®é¢˜ - çŸ¥ä¹ (zhihu.com)](https://zhuanlan.zhihu.com/p/617397417)

## æ€è€ƒğŸ¤”

ä¸ºä»€ä¹ˆtcpä¸‹çš„é“¾æ¥å°±ä¸ä¼šåœ¨å‡ºç°æœåŠ¡å™¨ä¸¢åŒ…æ

> [Unlike TCP, UDP protocol does not have built-in flow-control capabilities](https://linux-tips.com/t/udp-packet-drops-and-packet-receive-error-difference/237#:~:text=Unlike%20TCP%2C%20UDP%20protocol%20does%20not%20have%20built%2Din%20flow%2Dcontrol%20capabilities)

ä¸ºäº†éªŒè¯è¿™ä¸ªè¯´æ³•ï¼Œæˆ‘å†™äº†ä¸¤ä¸ªæ–‡ä»¶æ¥æµ‹è¯•

[/tcp/server.cc](https://github.com/kehaha-5/kehaha-5.github.io/blob/main/source/_posts/2024-03-21-udp%E4%B8%A2%E5%8C%85%E6%8E%92%E6%9F%A5/udp_drop_packets_test/tcp/server.cc)

[/tcp/client.cc](https://github.com/kehaha-5/kehaha-5.github.io/blob/main/source/_posts/2024-03-21-udp%E4%B8%A2%E5%8C%85%E6%8E%92%E6%9F%A5/udp_drop_packets_test/tcp/client.cc)

åŒæ ·æ˜¯å®¢æˆ·ç«¯æ¯ç§’å‘é€æŒ‡å®šåŒ…ï¼Œæœ€åå®¢æˆ·ç«¯ç»Ÿè®¡æ‰€æœ‰å‘é€çš„æ•°æ®å¤§å°ï¼ŒæœåŠ¡ç«¯ç»Ÿè®¡æ¥æ”¶åˆ°çš„æ•°æ®å¤§å°

- æµ‹è¯•å‰ç»Ÿè®¡ç½‘å¡ä¿¡æ¯

  ```text
  kehaha@DESKTOP-4GO6ORF:~$ netstat -i
  Kernel Interface table
  Iface      MTU    RX-OK RX-ERR RX-DRP RX-OVR    TX-OK TX-ERR TX-DRP TX-OVR Flg
  eth0      1432      686      0      0 0           682      0      0      0 BMRU
  lo       65536   914976      0      0 0        914976      0      0      0 LRU
  ```

- å¼€å§‹æµ‹è¯•

  ```text
  kehaha@DESKTOP-4GO6ORF:~/projects/study/blogsDemos/udp_drop_packets_test$ ./build/TCP_SER
  tcp bind is listenning ... port 9999
  hasRevc:10016 hasRevcSize:655070000
  hasRevc:20075 hasRevcSize:1310140000
  hasRevc:30127 hasRevcSize:1965210000
  hasRevc:40184 hasRevcSize:2620280000
  hasRevc:50215 hasRevcSize:3275350000
  hasRevc:60246 hasRevcSize:3930420000
  hasRevc:70293 hasRevcSize:4585490000
  hasRevc:80335 hasRevcSize:5240560000
  hasRevc:90338 hasRevcSize:5895630000
  hasRevc:100351 hasRevcSize:6550700000
  ```

  ```text
  kehaha@DESKTOP-4GO6ORF:~/projects/study/blogsDemos/udp_drop_packets_test$ ./build/TCP_CLI 10000
  hasSendPacketsNum:10000
  hasSendPacketsNum:20000
  hasSendPacketsNum:30000
  hasSendPacketsNum:40000
  hasSendPacketsNum:50000
  hasSendPacketsNum:60000
  hasSendPacketsNum:70000
  hasSendPacketsNum:80000
  hasSendPacketsNum:90000
  hasSendPacketsNum:100000
  total hasSendPacketsNum:100000 hasSendSize:6550700000
  ```

- æŸ¥çœ‹ç½‘å¡ä¿¡æ¯

  ```text
  kehaha@DESKTOP-4GO6ORF:~$ netstat -i
  Kernel Interface table
  Iface      MTU    RX-OK RX-ERR RX-DRP RX-OVR    TX-OK TX-ERR TX-DRP TX-OVR Flg
  eth0      1432      696      0      0 0           695      0      0      0 BMRU
  lo       65536  1139780      0      0 0       1139780      0      0      0 LRU
  ```

- æŸ¥çœ‹`sarä¿¡æ¯`

  ```text
  kehaha@DESKTOP-4GO6ORF:~$ sar -n TCP 1
  Linux 5.15.133.1-microsoft-standard-WSL2 (DESKTOP-4GO6ORF)      03/22/24        _x86_64_        (8 CPU)
  
  17:11:11     active/s passive/s    iseg/s    oseg/s
  17:11:12         0.00      0.00     12.00     12.00
  17:11:13         0.00      0.00      6.00      6.00
  17:11:14         1.00      1.00  18462.00  18462.00 //å¼€å§‹ä¼ é€æ•°æ®
  17:11:15         0.00      0.00  17274.00  17274.00
  17:11:16         0.00      0.00  15761.00  15761.00
  17:11:17         0.00      0.00  24753.00  24753.00
  17:11:18         0.00      0.00  20243.00  20243.00
  17:11:19         0.00      0.00  15196.00  15196.00
  17:11:20         0.00      0.00  18340.00  18340.00
  17:11:21         0.00      0.00  19880.00  19880.00
  17:11:22         0.00      0.00  28062.00  28062.00
  17:11:23         0.00      0.00  18363.00  18363.00 //ç»“æŸä¼ é€æ•°æ®
  17:11:24         0.00      0.00     13.00     13.00
  17:11:25         0.00      0.00     10.00     10.00
  ^C
  
  Average:         0.07      0.07  14026.79  14026.79
  ```

  ç”±æ­¤å¯çŸ¥ï¼Œå³ä½¿clientæ¯ç§’å‘é€10000ä¸ªåŒ…ï¼Œä½†æ˜¯å› ä¸ºtcpæ‹¥æœ‰æµæ§åˆ¶å’Œçª—å£æ»‘åŠ¨æœºåˆ¶ï¼ˆæ ¹æ®å¯ç”¨çš„win sizeæ¥è°ƒæ•´æ¯ä¸ªåŒ…çš„å¤§å°ï¼‰ï¼Œæ‰€ä»¥ä¸åƒudpçœŸå°±æ¯ç§’å‘é€10000ä¸ª64kçš„åŒ…å¯¼è‡´æ¥æ”¶ç«¯çš„buffä¸è¶³ä»è€Œå¼•èµ·ä¸¢åŒ…




