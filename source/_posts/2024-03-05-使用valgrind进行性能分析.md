---
title: valgrindè¿›è¡Œæ€§èƒ½åˆ†æ--udp-transfiler
date: 2024-03-05 14:30:48
tags: [c++,valgrind,callgrind,æ€§èƒ½]
---

> æœ€è¿‘å†™äº†ä¸€ä¸ª[c++é¡¹ç›®](https://github.com/kehaha-5/udp-transfiler)æ¥å­¦ä¹ ï¼Œåœ¨å®Œæˆåï¼Œæˆ‘æƒ³åˆ©ç”¨ `valgrind` å¯¹æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯è¿›è¡Œæ€§èƒ½åˆ†æ

# å‰è¨€

å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯éƒ½åœ¨æœ¬åœ°è¿è¡Œ

åœ¨æœªå¼€å§‹ä¼˜åŒ–æ—¶ï¼Œå®¢æˆ·ç«¯ä¸‹è½½é€Ÿåº¦

![speed1](./speed1.png)
é€Ÿåº¦åªæœ‰13MB


# å·¥å…·

æœ¬æ¬¡æ€§èƒ½åˆ†æåˆ©ç”¨çš„æ˜¯valgrindçš„[callgrind](https://valgrind.org/docs/manual/cl-manual.html#cl-manual.options)å·¥å…·
```bash
# åˆ†æå‘½ä»¤
 valgrind --tool=callgrind --callgrind-out-file=./valgrindCheck/callgrind/client --separate-threads=yes ./build/TRANFILER_CLIENT #å®¢æˆ·ç«¯
 valgrind --tool=callgrind --callgrind-out-file=./valgrindCheck/callgrind/server --separate-threads=yes ./build/TRANFILER_SERVER #æœåŠ¡ç«¯
#--separate-threads=<no|yes> [default: no]
# This option specifies whether profile data should be generated separately for every thread. If yes, the file names get "-threadID" appended.
```
ç»“æœåˆ†æç”¨çš„æ˜¯ [kcachegrind](https://kcachegrind.github.io)

# æµ‹è¯•è¿‡ç¨‹
å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯åˆ†åˆ«æ‰§è¡Œä»¥ä¸Šå‘½ä»¤ï¼Œç„¶åå®¢æˆ·ç«¯ä¸‹è½½ä¸€ä¸ªæ–‡ä»¶(å¤§çº¦200M)æŸ¥çœ‹ç»“æœï¼ˆå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯æ‰“åŒ…çš„éƒ½æ˜¯releaseç‰ˆæœ¬ï¼‰

# åˆ†æ

## å®¢æˆ·ç«¯
å› ä¸ºæ˜¯è¦å¯¹ä¸‹è½½æ€§èƒ½è¿›è¡Œæ£€æµ‹ï¼Œå› æ­¤æˆ‘æŒ‘äº†ä¸‹è½½ä»£ç æ¥è¿›è¡Œåˆ†æ

![å®¢æˆ·ç«¯-ä¸‹è½½](./speed1-client-analysis-sendMsg.png)
ä¸Šå›¾æ˜¯å®¢æˆ·ç«¯çš„å‘é€æ¶ˆæ¯çš„ä»£ç ï¼Œä»å›¾ä¸­å¯ä»¥åˆ†æå‡ºæ¥ `google::protobuf` ä½¿ç”¨äº†ä¸€åŠçš„cpuï¼Œå¦ä¸€åŠæ˜¯è¢« `setAck()`ä½¿ç”¨äº†

![å®¢æˆ·ç«¯-ä¸‹è½½](./speed1-client-analysis-recv.png)

![å®¢æˆ·ç«¯-ä¸‹è½½](./speed1-client-analysis-recv2.png)

ä¸Šé¢ä¸¤å¼ å›¾éƒ½æ˜¯å®¢æˆ·ç«¯çš„æ¥æ”¶æ•°æ®çš„ä»£ç ï¼Œä»å›¾ä¸­å¯ä»¥åˆ†æå‡ºæ¥ `google::protobuf` ä½¿ç”¨äº†å¿«80%çš„cpu 

## æœåŠ¡ç«¯
![æœåŠ¡ç«¯-ä¸‹è½½](./speed1-server-analysis-1.png)
ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼ŒæœåŠ¡ç«¯ä¸­è·å–æ–‡ä»¶å†…å®¹ `file::server` ä½¿ç”¨äº†1.63%çš„cpuï¼Œè€Œå¤„ç†`google::protobuf`ä½¿ç”¨äº† 17.26%

## ç»“è®º
å› æ­¤å¾—å‡ºå¯¼è‡´æ€§èƒ½é—®é¢˜çš„åŸå› å¤§æ¦‚ç‡æ˜¯`google::protobuf`ï¼Œæ‰“å¼€protoæ–‡ä»¶
```proto
syntax = "proto2";

package msg.proto;

option optimize_for = CODE_SIZE;

message FileDownMsg{
    required string hash = 1;
    required uint64 startPos =2;
    required uint64 dataIndex = 3;
    optional int64 size = 4;
    optional bytes data = 5;
}
```
å‘ç°äº†é—®é¢˜ï¼šoptimize_forç”¨çš„æ˜¯CODE_SIZE ~~ä¸ºä»€ä¹ˆå½“åˆä¼šç”¨è¿™ä¸ªï¼Œæˆ‘ä¹Ÿä¸çŸ¥é“ğŸ¤¡~~ï¼Œåªè¦æŠŠoptimize_foråˆ é™¤äº†é»˜è®¤ä½¿ç”¨çš„å°±æ˜¯SPEED [æ–‡æ¡£](https://protobuf.dev/programming-guides/proto2/#:~:text=optimize_for%20(file%20option,full%20Message%20interface.)

# å†æ¬¡æµ‹è¯•
![speed2](./speed2.png)
é€Ÿåº¦è¾¾åˆ°23MBï¼Œæé«˜äº†75% ğŸ¤

## å®¢æˆ·ç«¯
![speed2-å®¢æˆ·ç«¯-ä¸‹è½½](./speed2-client-recv.png)

![speed2-å®¢æˆ·ç«¯-ä¸‹è½½](./speed2-client-sendMsg.png)

ç”±ä¸Šé¢ä¸¤å¹…å›¾å¯ä»¥çŸ¥é“ï¼Œç»è¿‡ä¼˜åŒ–åï¼Œæ¥æ”¶æ•°æ®ä¸­çš„ `google::protobuf` çš„æ€§èƒ½ä½¿ç”¨è·Ÿ `recvfrom` çš„ä½¿ç”¨å‡ ä¹ä¸€æ ·äº†ï¼Œå‘é€ç«¯æ›´æ˜¯çœ‹ä¸åˆ°äº†`google::protobuf`æ€§èƒ½ç»Ÿè®¡

## æœåŠ¡ç«¯
![speed2-æœåŠ¡ç«¯-ä¸‹è½½](./speed2-server-analysis-1.png)
ç”±ä¸Šå›¾ä¹ŸçŸ¥æœåŠ¡ç«¯çš„`google::protobuf` çš„æ€§èƒ½ä½¿ç”¨ä¹Ÿæ˜æ˜¾ä¸‹é™äº†

# è¿˜èƒ½å†ä¼˜åŒ–å—

## ç¬¬äºŒæ¬¡åˆ†æ
ä½†æ˜¯ï¼Œåœ¨æœåŠ¡ç«¯ä¸­çš„å¤„ç†è¯·æ±‚ä¸­ä¸ºä»€ä¹ˆåªä½¿ç”¨äº†26%å·¦å³çš„cpuï¼Œé‚£å…¶ä»–cpuæ€§èƒ½å»å“ªé‡Œæ ğŸ¤”

![speed2-æœåŠ¡ç«¯-ä¸‹è½½](./speed2-server-analysis-2.png)

é€šè¿‡æŸ¥çœ‹æ•´ä¸ªè°ƒç”¨æ ˆæˆ‘å‘ç°äº† `log` å‡½æ•°ä½¿ç”¨äº†40%çš„cpuï¼Œå°¤å…¶è®°å½•logæ—¶è·å–çš„æ—¶é—´å‡½æ•°

## è·å–æ—¶é—´
è·å–æ—¶é—´çš„ä»£ç å¦‚ä¸‹
```cpp
std::string Log::getCurrTime() {
    std::time_t t = std::time(NULL);
    std::string mbstr(50, 0);
    std::strftime(&mbstr[0], mbstr.size(), "%F-%T", std::localtime(&t));
    return mbstr;
}
```
é‚£ä¹ˆè¿™æ®µä»£ç é‡Œé¢æœ‰ä»€ä¹ˆæ€§èƒ½é—®é¢˜æï¼Œå¯ä»¥åœ¨kcachegrindä¸­ç‚¹å‡»`log`å‡½æ•°è¿›è¡ŒæŸ¥çœ‹

![speed2-æœåŠ¡ç«¯-ä¸‹è½½](./speed2-server-analysis-3.png)

å‘ç°äº†å°±æ˜¯ `strftime` å’Œ `localtime`ï¼Œé‚£ä¸ºä»€ä¹ˆå®ƒä»¬æ‰§è¡Œæ€ä¹ˆæ…¢æï¼Œå› ä¸ºå®ƒä»¬éƒ½è¿›è¡Œäº†`syscall`ï¼ˆè¯¦æƒ…è¯·çœ‹[strftime](https://stackoverflow.com/questions/8174147/strftime-performance-vs-snprintf#:~:text=POSIX%20requires%20strftime%20to%20call%20tzset()%20(or%20act%20as%20if%20it%20did)%2C%20which%20on%20a%20linux%20system%20will%20likely%20stat%20/etc/timezone%20and%20other%20files%2C%20which%20is%20slow%20(compared%20to%20snprintf).%20Setting%20the%20TZ%20environment%20variable%20will%20generally%20give%20it%20a%20great%20boost.),[localtime](https://en.cppreference.com/w/cpp/chrono/c/localtime#:~:text=Notes-,This%20function%20may%20not%20be%20thread%2Dsafe.,.,-Example)ï¼‰
é‚£å¦‚ä½•è¿›è¡Œä¿®æ”¹
ç¬¬ä¸€ç§æ–¹æ³•æ˜¯ï¼šä¿®æ”¹ä»£ç ï¼Œä»£ç å‚è€ƒ[è¿™é‡Œ](https://gist.github.com/felipou/ad107bbb3a91814679beb22c0686fbeb)
ç¬¬äºŒç§æ–¹æ³•æ˜¯ï¼š~~åªç”Ÿäº§ timevalï¼Œåœ¨çœŸæ­£è¿›è¡Œå†™å…¥çš„æ—¶å€™åœ¨è½¬æ¢æˆæ—¥æœŸï¼ˆlogçº¿ç¨‹ï¼‰ä½†æ˜¯æ—¢ç„¶éƒ½è¿›è¡Œäº†ä¼˜åŒ–äº†ï¼Œè‚¯å®šæ˜¯é€‰æ‹©ç¬¬äºŒä¸ªæ–¹æ¡ˆï¼Œå¹¶ä¸”é‡‡ç”¨å‚è€ƒä»£ç é‡Œé¢çš„func3~~ï¼ˆæˆ‘éƒ½ä¸æ˜¾ç¤ºæ­£å¸¸è¯·æ±‚çš„logäº†ï¼Œè¯¦ç»†è¯·çœ‹åæ–‡ï¼‰

## å†æ¬¡æµ‹è¯• ğŸ¤¡

![speed3](./speed3.png)

??? ä¸ºä»€ä¹ˆé€Ÿåº¦åŸºæœ¬ä¸Šè·Ÿä¸Šæ¬¡ä¸€æ ·ï¼Œé€Ÿé€Ÿæ‰“å¼€kcachegrindè¿›è¡Œåˆ†æ ğŸ¤ºğŸ¤ºğŸ¤º

## ç¬¬ä¸‰æ¬¡åˆ†åˆ†æ

![speed2-æœåŠ¡ç«¯-ä¸‹è½½](./speed3-server-analysis-1.png)

å¯ä»¥çœ‹åˆ°`log`çš„cpuå ç”¨ç¡®å®å˜å°‘äº†ï¼Œä½†è¿˜æ˜¯å ç”¨äº†27%çš„cpuï¼Œæ‰€ä»¥ä¸å¦‚ç‚¹è¿›å»ä»”ç»†åˆ†æä¸€ä¸‹é‚£è¡Œä»£ç å ç”¨å¤§é‡cpu

![speed2-æœåŠ¡ç«¯-ä¸‹è½½](./speed3-server-analysis-2.png)
è¿›å…¥`log`åï¼Œå¯ä»¥çœ‹åˆ°åœ¨`Callee Map`ä¸­ï¼Œæœ€å¤§çš„ä¸¤å—åˆ†åˆ«æ˜¯ `sprintf` `vsprintf`

![speed2-æœåŠ¡ç«¯-ä¸‹è½½](./speed3-server-analysis-3.png)
æŸ¥çœ‹åˆ°å¯¹åº”çš„ä»£ç å°±æ˜¯è¾“å‡ºæ—¶çš„æ ¼å¼åŒ–ï¼ˆè¦åœ¨debugæ¨¡å¼ä¸‹æ‰å¯ä»¥çœ‹åˆ°æºç ï¼‰ï¼Œé‚£è¿™ä¸ªçœŸçš„æ²¡æœ‰åŠæ³•ä¼˜åŒ–äº†å—ï¼Œå…¶å®è¿˜æ˜¯æœ‰çš„ï¼Œå°±æ˜¯å…³é—­æ­£å¸¸è¯·æ±‚æ—¶çš„logæ˜¾ç¤ºã€‚å› ä¸ºä¸€ä¸ªè¯·æ±‚å°±ä¼šè¾“å‡ºä¸¤ä¸ªlogä¿¡æ¯
```bash
2024-03-xx 09:03:44.975857 INFO 63 | udp recvfrom data to ip 127.0.0.1 prot 35512 ack is 1315955221
2024-03-xx 09:03:44.975940 INFO 63 | udp recvfrom data to ip 127.0.0.1 prot 35512 ack is 508775843
2024-03-xx 09:03:44.975978 INFO 90 | udp send data to ip 127.0.0.1 prot 35512 ack is 3372925139
2024-03-xx 09:03:44.976044 INFO 90 | udp send data to ip 127.0.0.1 prot 35512 ack is 508775843
```
è€Œåœ¨ä¸‹è½½æ–‡ä»¶çš„æ—¶å€™ä¸€ç§’é’Ÿä¼šä¼ è¾“å¤§é‡çš„æ•°æ®åŒ…
![speed2-æœåŠ¡ç«¯-ä¸‹è½½](./speed3-server-analysis-4.png)
è¿™å°±ä¼šå¤§é‡è°ƒç”¨logå‡½æ•°ï¼Œä»è€Œå½±å“æ€§èƒ½ã€‚ä½†æ˜¯ä¸ºäº†è°ƒè¯•æ–¹ä¾¿ï¼Œå¯ä»¥æŠŠè¿™ä¸ªæ˜¯å¦æ˜¾ç¤ºæ­£å¸¸è¯·æ±‚çš„logå†™å…¥åˆ°é…ç½®æ–‡ä»¶ä¸­ï¼Œæ ¹æ®å®é™…è¿›è¡Œé…ç½®

# æœ€ç»ˆç»“æœ
ç»è¿‡äº†ä¸Šè¿°`log`æ¨¡å—çš„ä¿®æ”¹ï¼Œä¸€ä¸‹å°±æ˜¯æœ€ç»ˆç»“æœï¼Œä»13Mæå‡åˆ°35M ğŸ¤ğŸ¤
![speed4](./speed4.png)











