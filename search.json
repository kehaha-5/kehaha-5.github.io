[{"title":"ç›‘æ§é©±åŠ¨çš„æ•…éšœæ’æŸ¥ï¼šåˆ©ç”¨PMQLå®šä½é›†ç¾¤é—®é¢˜","url":"/2025/09/13/ç›‘æ§é©±åŠ¨çš„æ•…éšœæ’æŸ¥ï¼šåˆ©ç”¨PMQLå®šä½é›†ç¾¤é—®é¢˜/","content":"\n## èƒŒæ™¯\n\n> èµ·å› æ˜¯é’‰é’‰ç¾¤å†…å‘ç°å¤§é‡å‘Šè­¦\n\næŸ¥çœ‹é›†ç¾¤çŠ¶æ€ï¼Œå‘ç°nodeçŠ¶æ€åœ¨readyå’Œnotreadyä¹‹é—´åå¤æ¨ªè·³ï¼Œæœ‰é—®é¢˜çš„nodeéƒ½æ˜¯æŸåœ°åŒºIDCæœºæˆ¿çš„èŠ‚ç‚¹ï¼Œ<font style=\"color:rgb(44, 44, 54);\">é›†ç¾¤è·Ÿè¯¥åœ°åŒºIDCèŠ‚ç‚¹ç»„ç½‘ä½¿ç”¨åŸºäºWireGuardåè®®çš„åº”ç”¨ï¼ŒèŠ‚ç‚¹é—´é€šä¿¡ä¾èµ–å…¬ç½‘å‡ºå£ã€‚</font>\n\n## é—®é¢˜å®šä½\n\n### agentç»„ç½‘èŠ‚ç‚¹æ£€æŸ¥\n\næ£€æŸ¥ç»„ç½‘èŠ‚ç‚¹æ˜¯å¦å·¥ä½œæ­£å¸¸\n\nå‘ç°æ˜¯agentèŠ‚ç‚¹å‡ºç°æ— æ³•è¿æ¥ä¸­ç»§èŠ‚ç‚¹æˆ–è€…ç›´è¿masterèŠ‚ç‚¹ï¼Œæ‰€ä»¥æœ‰å¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜\n\n![](./tailscaled.png)\n\n### æœºæˆ¿å…¬ç½‘æµé‡æ£€æŸ¥\n\næŸ¥çœ‹æœºæˆ¿å…¬ç½‘æµé‡å‡ºå£ï¼Œå‘ç°å…¬ç½‘çš„å‡ºæµé‡æŠŠå¸¦å®½éƒ½å æ»¡äº†ï¼Œå¯ä»¥ç¡®å®šæ˜¯æœ‰äººæŠŠå…¬ç½‘å‡ºæµé‡å æ»¡äº†ï¼Œå¯¼è‡´é›†ç¾¤ç»„ç½‘å‡ºç°é—®é¢˜ï¼Œä»è€Œå‡ºç°èŠ‚ç‚¹notreadyçš„æƒ…å†µ\n\n![](./outbound.png)\n\n## æ’æŸ¥\n\né›†ç¾¤å†…çš„å…¬ç½‘æµé‡åˆ†ä¸ºï¼š\n\n+ å†…éƒ¨æµé‡ï¼šå„ä¸ªpodã€nodeä¹‹é—´ç›¸å…³è®¿é—®çš„æµé‡ï¼ˆå› ä¸ºæœ‰ç»„ç½‘ï¼Œæ‰€ä»¥è¿™äº›å†…éƒ¨æµé‡ä¹Ÿæ˜¯èµ°å…¬ç½‘å‡ºå£ï¼‰\n+ å¤–éƒ¨æµé‡ï¼šé›†ç¾¤ä¸­çš„å·¥ä½œè´Ÿè½½é€šè¿‡ç½‘å…³è®¿é—®å…¬ç½‘\n\n### å†…éƒ¨æµé‡æ’æŸ¥\n\né›†ç¾¤ä¸­å†…éƒ¨ç»„ç½‘ä½¿ç”¨äº†agentèŠ‚ç‚¹ï¼Œæ‰€ä»¥è¯¥æœºæˆ¿ä¸­çš„å†…éƒ¨æµé‡éƒ½ä¼šèµ°è¯¥agentå‡ºå»ï¼ŒæŸ¥çœ‹å…¶æµé‡è¶‹åŠ¿\n\n![](./grafana.png)\n\nå‘ç°æµé‡æ•°æ®è¿˜ç®—æ­£å¸¸ï¼Œæ’é™¤é›†ç¾¤å†…å¤§æµé‡çš„é—®é¢˜\n\n### å¤–éƒ¨æµé‡æ’æŸ¥\n\né›†ç¾¤ä½¿ç”¨kube-ovn CNIï¼Œå¤–éƒ¨å…¬ç½‘æµé‡åˆ†ä¸ºé›†ä¸­å¼ç½‘å…³å’Œåˆ†å¸ƒå¼ç½‘å…³ä¸¤ç§æ–¹å¼ã€‚\n\n+ é›†ä¸­å¼ç½‘å…³ç”¨çš„æ˜¯ vpc-nat-gateway + multus-cni ï¼Œå®ƒä¼šæŠŠèŠ‚ç‚¹ä¸Šé¢çš„ç½‘å¡åŠ å…¥åˆ°å¯¹åº”podä¸Šé¢ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡æŸ¥çœ‹å¯¹åº”èŠ‚ç‚¹çš„ç½‘å¡æµé‡æƒ…å†µå¾—å‡ºè¯¥ç½‘å…³çš„æµé‡æƒ…å†µã€‚\n\n![](./kube-ovn-1.png)\n\n+ åˆ†å¸ƒå¼ç½‘å…³æ˜¯podè®¿é—®å…¬ç½‘æ—¶ï¼Œæµé‡ä¼šç»è¿‡podæ‰€åœ¨èŠ‚ç‚¹çš„ç½‘å¡ï¼Œèµ°èŠ‚ç‚¹è‡ªèº«çš„ç½‘ç»œã€‚\n\n![](./kube-ovn-2.png)\n\nå› ä¸ºé›†ç¾¤é‡Œé¢çš„èŠ‚ç‚¹éƒ½å®‰è£…äº†node-exporterï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨pmqlæ¥å®šä½å“ªä¸ªèŠ‚ç‚¹çš„ç½‘å¡å‡ºæµé‡æœ€å¤š\n\n```plain\n# 3å°æ—¶å†…ï¼Œå¹³å‡å‘é€æ•°æ®(MB)top5çš„ç½‘å¡ä¿¡æ¯\ntopk(5, sum by (instance,device) (rate(node_network_transmit_bytes_total{device!~\"lo|veth.*|docker.*|br.*\"}[3h]))) / 1024 / 1024\n```\n\n![](./pmql.png)\n\nç»“æœå‘ç°æœ‰ä¸€å¼ ç½‘å¡çš„æµé‡ååˆ†é«˜ï¼Œå®šä½åˆ°æ˜¯ä¸€ä¸ªé›†ä¸­å¼ç½‘å…³çš„èŠ‚ç‚¹ï¼Œä¸Šé¢çš„ç½‘å¡è¢«ç”¨æ¥åšç½‘å…³çš„å…¬ç½‘å‡ºå£ç½‘å¡äº†ï¼Œæ‰€ä»¥å¯ä»¥ç¡®å®šå¤§æµé‡çš„åº”ç”¨å°±åœ¨è¿™ä¸ªç½‘å…³åé¢ã€‚\n\nåœ¨é›†ç¾¤ä¸­ä½¿ç”¨é›†ä¸­å¼ç½‘å…³çš„éƒ½ä¼šç»™å®ƒåˆ†é…ä¸€ä¸ªEIPèµ„æºï¼ŒåŒæ—¶é›†ç¾¤é‡Œé¢ä¹Ÿæœ‰å¯¹åº”çš„exporteræ¥æ”¶é›†EIPçš„æµé‡ä½¿ç”¨æƒ…å†µï¼Œæ‰€ä»¥å¯ä»¥ç»§ç»­ä½¿ç”¨å¯¹åº”çš„pmqlæ¥å®šä½å¯¹åº”çš„EIPèµ„æºã€‚\n\n```plain\n# å†…éƒ¨æŸ¥çœ‹eipæµé‡çš„pmqlï¼Œä»…ä¾›å‚è€ƒ\ntopk(5, sum by (eipName) (rate(xxx_eip_network_traffic_egress_bytes{xxx}[3h]))) / 1024 / 1024\n```\n\nåœ¨æˆåŠŸå®šä½åˆ°æœ‰é—®é¢˜çš„EIPåï¼Œåå°é©¬ä¸Šæ‰¾åˆ°äº†å¯¹åº”çš„èµ„æºï¼Œæ˜¯ä¸€å°è£¸é‡‘å±ã€‚\n\nè¿™å°è£¸é‡‘å±åœ¨1ä¸ªæœˆå‰å› åˆå§‹é…ç½®ä¸å½“å¯¼è‡´æœªæˆæƒè®¿é—®ï¼Œå¹¶è¢«ä¿®æ”¹äº†å¯†ç ï¼Œåœ¨ä¿®æ”¹å¯†ç åå°±å¯ä»¥ç™»å½•å›å»äº†ã€‚ä½†æ˜¯å› ä¸ºä¸Šé¢æœ‰ä¸€äº›è™šæ‹Ÿæœºåº”ç”¨åœ¨è·‘ï¼Œæ‰€ä»¥æ²¡æœ‰é€‰æ‹©é‡è£…ç³»ç»Ÿï¼Œè€Œæ˜¯é‡è£…äº†éƒ¨åˆ†æ ¸å¿ƒè½¯ä»¶ï¼Œå¹¶æ£€æŸ¥å’Œæ¸…é™¤ç›¸å…³å…¥ä¾µç—•è¿¹ã€‚æ‰€ä»¥å¯ä»¥ç¡®å®šæ˜¯è£¸é‡‘å±è¢«é»‘äº†å¯¼è‡´å‡ºæµé‡æ¿€å¢ï¼Œä¸æ˜¯å› ä¸ºç›¸å…³ä¸šåŠ¡ã€‚\n\n#### å¤„ç†\n\nè¿™é‡Œå¤„ç†åˆ†ä¸ºä¸¤æ­¥ï¼š\n\n+ å¯¹åº”çš„åŒå­¦å¤‡ä»½è™šæ‹Ÿæœºå’Œç³»ç»Ÿä¸Šé¢çš„é‡è¦æ•°æ®ï¼Œç¡®ä¿ç³»ç»Ÿå¯ä»¥é‡è£…\n+ å¯¹è£¸é‡‘å±è¿›è¡Œä¸´æ—¶å¤„ç†ï¼Œå¹¶ä¸”çœ‹ä¸€ä¸‹æ˜¯å¦å¯ä»¥æ‰¾åˆ°å¯¹åº”çš„é—®é¢˜\n\n### è£¸é‡‘å±å¤„ç†\n\n#### æµé‡æŸ¥çœ‹\n\né€šè¿‡`iftop`æŸ¥çœ‹å®æ—¶æµé‡ï¼Œå‘ç°éšæœºå‘å¤šä¸ªIPå‘é€å¤§æµé‡æ•°æ®\n\n![](./iftop.png)\n\nä½¿ç”¨tcpdumpè¿›è¡ŒæŠ“åŒ…æŸ¥çœ‹ç›¸å…³æ•°æ®ï¼Œå‘ç°æµé‡ä¼šè®¿é—®ç›®æ ‡ipçš„80æˆ–443ç«¯å£ï¼Œå¹¶ä¸”ä¼šä¸€ç›´å‘é€SYNåŒ…\n\n![](./tcpdump.png)\n\nç»¼ä¸Šæ‰€è¿°ï¼Œè¿™å°æœåŠ¡å™¨æ˜¯è¢«äººæ‹¿æ¥åšè‚‰é¸¡ï¼Œå¯¹å…¬ç½‘æœåŠ¡å‘èµ·SYNæ´ªæ°´æ”»å‡»\n\n#### ä¸´æ—¶å¤„ç†\n\nä¸ºé¿å…è¿›ä¸€æ­¥å½±å“ä¸šåŠ¡ï¼Œä¸´æ—¶ç”¨tcç»™ç³»ç»Ÿé™é€Ÿï¼Œç¡®ä¿ä¸è¦å†å‘é€å¤§æµé‡æŠŠç³»ç»Ÿå…¬ç½‘å¸¦å®½å æ»¡ã€‚è¦æ±‚ï¼šä¸šåŠ¡ipæµé‡ä¸é™åˆ¶ï¼ˆsshç™»å½•ipã€è™šæ‹Ÿæœºçš„ä¸šåŠ¡æµé‡ï¼‰ï¼Œåªé™åˆ¶å¼‚å¸¸æµé‡ï¼ˆæ‰€æœ‰ipçš„80ã€443ç«¯å£å‡ºæµé‡ï¼‰ã€‚\n\n```plain\n# æ¸…ç©ºå¯¹åº”ç½‘å¡æ—§è§„åˆ™\n# tc qdisc del dev enp1s0 root\n\n# æ·»åŠ qdiscï¼Œå¹¶ä¸”é»˜è®¤å½’ç±»ä¸º 1:20 çš„è§„åˆ™ï¼ˆæ²¡æœ‰åŒ¹é…åˆ°è§„åˆ™çš„æµé‡èµ° 1:20 ï¼‰\n# tc qdisc add dev enp1s0  root handle 1: htb default 20\n\n# æ·»åŠ classè§„åˆ™\n# tc class add dev enp1s0  parent 1: classid 1:1   htb rate 20Mbit ceil 20Mbit burst 15k\n# å¼‚å¸¸æµé‡é™é€Ÿè§„åˆ™\n# tc class add dev enp1s0 parent 1:1 classid 1:10 htb rate 1Mbit ceil 1Mbit burst 1k \n# å…¶å®ƒæµé‡è§„åˆ™\n# tc class add dev enp1s0 parent 1:1 classid 1:20 htb rate 20Mbit ceil 20Mbit burst 15k\n\n# ä¸ºäº†é¿å…ä¸€ä¸ªä¼šè¯æ°¸å å¸¦å®½,æ·»åŠ éšå³å…¬å¹³é˜Ÿåˆ—sfq\n# tc qdisc add dev enp1s0  parent 1:10 handle 10: sfq perturb 10 \n# tc qdisc add dev enp1s0  parent 1:20 handle 20: sfq perturb 10  \n\n# æ·»åŠ filteræ¥åº”ç”¨classè§„åˆ™ï¼Œè¿™é‡Œæ˜¯ç›®æ ‡ç«¯å£ä¸º80ã€443çš„éƒ½åˆ° 1:10çš„class ä¸­\n# tc filter add dev enp1s0  protocol ip parent 1:0 prio 3 u32   match ip dport 443 0xffff   flowid 1:10 \n# tc filter add dev enp1s0  protocol ip parent 1:0 prio 2 u32   match ip dport 80 0xffff   flowid 1:10\n\n# è§„åˆ™æ£€éªŒ\n# tc qdisc show dev enp1s0\n# tc class show dev enp1s0\n# tc filter show dev enp1s0 \n\n# æ•°æ®ç»Ÿè®¡ æŸ¥çœ‹æœ‰å¤šå°‘æµé‡å‘½ä¸­é‚£äº›è§„åˆ™\n# tc -s class show dev enp1s0\n# tc -s filter show dev enp1s0 \n```\n\né™é€Ÿåï¼Œå…¬ç½‘æµé‡æ¢å¤æ­£å¸¸ï¼Œé›†ç¾¤èŠ‚ç‚¹çŠ¶æ€æ¢å¤ã€‚\n\n#### æ’æŸ¥\n\nç›´æ¥è¯´ç»“è®ºï¼Œè¿˜æ²¡æœ‰æ’æŸ¥å‡ºæ¥é—®é¢˜ç³»ç»Ÿå°±è¢«é‡è£…äº†ï¼Œ~~æ‰€ä»¥æ€€ç–‘æ˜¯æœ‰é—®é¢˜çš„è¿›ç¨‹è¢«æ›¿æ¢æˆæ­£å¸¸çš„è¿›ç¨‹ç¨‹åºäº†~~ã€‚ğŸ˜¥\n\nè¿™é‡Œè¯´ä¸€ä¸‹æ’æŸ¥æ€è·¯å’Œè¿‡ç¨‹ï¼š\n\n+ é‡æ–°å®‰è£…åŸºç¡€å‘½ä»¤å·¥å…·ï¼ˆpsã€ssã€lsofç­‰ï¼‰\n+ ä½¿ç”¨ iftop æŒç»­ç›‘æ§æµé‡\n+ ä½¿ç”¨ ssã€psã€lsof å®šä½å¯ç–‘è¿›ç¨‹ï¼š\n  - æœªå‘ç°å¯ç–‘è¿›ç¨‹ä¸æ”»å‡»IPçš„è¿æ¥\n  - å‘ç°å‡ ä¸ªå¼‚å¸¸å…¬ç½‘ipçš„VNC-consoleè¿æ¥ï¼Œç¦æ­¢ç›¸å…³IPè®¿é—®åé‡å¯libvirtæœåŠ¡ï¼Œé—®é¢˜ä»å­˜åœ¨\n+ æ£€æŸ¥ç³»ç»Ÿæ—¥å¿—ã€ç™»å½•æ—¥å¿—ã€æ“ä½œæ—¥å¿—ã€å®‰å…¨æ—¥å¿—åŠå†…æ ¸æ—¥å¿—\n+ æ£€æŸ¥iptablesé…ç½®ï¼Œç¡®è®¤æ— å¼‚å¸¸ä¸¢å¼ƒACK/FINåŒ…è§„åˆ™\n+ æ£€æŸ¥å®šæ—¶ä»»åŠ¡ã€å¯åŠ¨è„šæœ¬ã€å¯ç–‘ç”¨æˆ·åŠç™»å½•ä¿¡æ¯\n+ æ£€æŸ¥è™šæ‹Ÿæœºå†…éƒ¨æµé‡ï¼Œç¡®è®¤æ­£å¸¸\n+ ä½¿ç”¨Rootkitå·¥å…·è¿›è¡Œå…¨é¢æ£€æŸ¥\n\nå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œä¸Šè¿°æ’æŸ¥åå‘ç°ï¼Œè‡ªä¸Šæ¬¡ä¿®æ”¹å¯†ç åï¼Œç³»ç»Ÿæ— ä»»ä½•å¯ç–‘IPç™»å½•è®°å½•ï¼Œæ€€ç–‘æ”»å‡»è€…åœ¨åˆæ¬¡å…¥ä¾µæ—¶æ¤å…¥äº†æŒä¹…åŒ–åé—¨æˆ–æ¶æ„ç¨‹åºã€‚\n\næœ€ååœ¨å…¶ä»–åŒå­¦å¤‡ä»½å¥½ç›¸å…³æ–‡ä»¶åï¼Œå¯¹ç³»ç»Ÿè¿›è¡Œäº†é‡è£…ã€‚\n\n## æ€»ç»“\n\nåœ¨ç»å†äº†ä¸Šè¿°äº‹ä»¶åï¼Œè¿˜æ˜¯è¦åŠ å¼ºä»¥ä¸‹ä¸¤ç‚¹ï¼š\n\n+ ç³»ç»Ÿæš´éœ²åœ¨å…¬ç½‘ç¯å¢ƒä¸‹ï¼Œæœ€å¥½æ˜¯ä¸è¦ç”¨å¼±å¯†ç ï¼ˆç”¨å¯†é’¥æˆ–è€…å¼ºå¯†ç ï¼‰å¹¶ä¸”è¦å¼€å¯é˜²ç«å¢™ï¼Œé™åˆ¶å¯ä»¥ç™»å½•çš„ipç™½åå•ã€‚\n+ è¦ç²¾ç»†åŒ–ç›‘æ§å‘Šè­¦ï¼Œåƒä¸Šè¿°çš„é—®é¢˜éƒ½æ˜¯é€šè¿‡<font style=\"color:rgb(44, 44, 54);\">PMQL</font>æ¥å®šä½çš„ï¼Œè¿™æ ·å®Œå…¨å¯ä»¥ç¼–å†™å¯¹åº”çš„å‘Šè­¦è§„åˆ™ï¼Œåœ¨å‡ºç°ç›¸å…³é—®é¢˜çš„æ—¶å€™ï¼Œç¬¬ä¸€æ—¶é—´å¯ä»¥å®šä½åˆ°å¯¹åº”çš„èµ„æºï¼ŒåŠ å¿«æ•…éšœæ¢å¤é€Ÿåº¦ã€‚\n","tags":["æ’éšœ","k8s"]},{"title":"é˜¿é‡Œäº‘Prometheusæˆæœ¬ä¼˜åŒ–å®æˆ˜","url":"/2025/09/03/é˜¿é‡Œäº‘Prometheusæˆæœ¬ä¼˜åŒ–å®æˆ˜/","content":"\n## èƒŒæ™¯\n\n> è¿‘æ—¥ï¼Œå›¢é˜Ÿå‘ç°é˜¿é‡Œäº‘ä¸ŠæŸä¸ªé¡¹ç›®çš„Prometheusç›‘æ§å®ä¾‹æˆæœ¬å¼‚å¸¸é«˜æ˜‚ï¼Œæœˆå‡è´¹ç”¨è¾¾åˆ°2-3åƒå…ƒï¼Œè€Œå…¶ä»–ç±»ä¼¼è§„æ¨¡çš„é¡¹ç›®ä»…éœ€å‡ ç™¾å…ƒã€‚æˆ‘å¯¹æ­¤è¿›è¡Œäº†æˆæœ¬ä¼˜åŒ–ã€‚\n\næ¶æ„\n\nåœ¨æˆ‘ä»¬é¡¹ç›®çš„é›†ç¾¤ä¸­æ˜¯æœ‰è‡ªå»ºçš„Prometheuså®ä¾‹çš„ï¼ŒåŒæ—¶é‡‡ç”¨äº†æ··åˆç›‘æ§æ–¹æ¡ˆï¼š\n\n- é›†ç¾¤å†…éƒ¨ç½²äº†è‡ªå»ºPrometheuså®ä¾‹ï¼Œè´Ÿè´£åŸºç¡€ç›‘æ§æ•°æ®çš„é‡‡é›†å’Œå­˜å‚¨\n- é€šè¿‡Prometheusçš„remote_writeåŠŸèƒ½ï¼Œå°†ç›‘æ§æ•°æ®åŒæ­¥è‡³é˜¿é‡Œäº‘ARMS Prometheus\n- å‘Šè­¦åŠŸèƒ½å®Œå…¨ä¾èµ–é˜¿é‡Œäº‘Prometheusçš„é«˜çº§è§„åˆ™é…ç½®å®ç°\n\nè¿™ç§æ¶æ„è®¾è®¡åˆè¡·æ˜¯ä¸ºäº†åˆ©ç”¨é˜¿é‡Œäº‘Prometheusæ›´å¼ºå¤§çš„å‘Šè­¦ç®¡ç†èƒ½åŠ›ï¼Œä½†åŒæ—¶ä¹Ÿå¸¦æ¥äº†é¢å¤–çš„æˆæœ¬ã€‚\n\n![é™æœ¬-Prometheus-æ¶æ„å›¾.drawio.png](./æ¶æ„å›¾.png)\n\n## é—®é¢˜è¯Šæ–­\n\né¦–å…ˆï¼Œæˆ‘ç™»å½•é˜¿é‡Œäº‘æ§åˆ¶å°æŸ¥çœ‹è¯¥Prometheuså®ä¾‹çš„æŒ‡æ ‡æ•°æ®ï¼Œå‘ç°åŸºç¡€æŒ‡æ ‡å’Œè‡ªå®šä¹‰æŒ‡æ ‡æ•°é‡å‡å¼‚å¸¸é«˜ã€‚ç„¶è€Œï¼Œå½“æˆ‘æ£€æŸ¥é›†ç¾¤å†…è‡ªå»ºPrometheusçš„æ•°æ®å­˜å‚¨é‡æ—¶ï¼Œä»…æ˜¾ç¤º400å¤šGBï¼Œä¸é˜¿é‡Œäº‘ä¸Šæ˜¾ç¤ºçš„è§„æ¨¡æ˜æ˜¾ä¸ç¬¦ã€‚\n\n![image.png](./before.png)\n\nå› æ­¤ç›´æ¥ç»™é˜¿é‡Œäº‘æä¸Šå·¥å•è¯¢é—®ä¸ºä»€ä¹ˆæœ¬åœ°çœ‹çš„Prometheuså­˜å‚¨æ•°æ®å’Œé˜¿é‡Œäº‘ä¸Šé¢çœ‹åˆ°çš„ä¸ä¸€è‡´ã€‚\n\nåœ¨å®¢æœè¯¢é—®åå¾—çŸ¥ï¼Œé˜¿é‡Œäº‘ä¸Šé¢çš„æŒ‡æ ‡æ•°æ®æ˜¯æœªç»è¿‡å‹ç¼©çš„ï¼Œè€ŒPrometheusæœ¬åœ°æŸ¥çœ‹çš„æ•°æ®æ˜¯ç»è¿‡äº†å‹ç¼©çš„ï¼Œæ‰€ä»¥å­˜å‚¨å ç”¨çœ‹èµ·æ¥ä¼šå°‘å¾ˆå¤šã€‚\n\nçœ‹æ¥åªèƒ½åšç›¸å…³è¿œç¨‹å†™çš„æŒ‡æ ‡ä¼˜åŒ–ï¼Œé¦–å…ˆè¦ç¡®å®šé˜¿é‡Œäº‘Prometheusçš„æ”¶è´¹æ ‡å‡†\n\nåœ¨æŸ¥è¯¢æ–‡æ¡£å’Œè¯¢é—®å®¢æœåå¾—çŸ¥å¾—çŸ¥é˜¿é‡Œäº‘Prometheusçš„æ”¶è´¹æ˜¯åˆ†ä¸¤ç§ï¼Œè®¡è´¹æ–¹å¼ä¸ºé‡Œé¢ä»»æ„ä¸€ç§ã€‚\n\n- æŒ‰å†™å…¥é‡æ”¶è´¹ï¼Œåˆ†ä¸ºåŸºç¡€æŒ‡æ ‡ï¼ˆå…è´¹ï¼‰å’Œè‡ªå®šä¹‰æŒ‡æ ‡ï¼ˆæ”¶è´¹ï¼‰\n- æŒ‰ä¸ŠæŠ¥é‡æ”¶è´¹ï¼Œä¹Ÿæ˜¯åˆ†ä¸ºåŸºç¡€æŒ‡æ ‡ï¼ˆå…è´¹ï¼‰å’Œè‡ªå®šä¹‰æŒ‡æ ‡ï¼ˆæ”¶è´¹ï¼‰\n\n[Prometheus å®ä¾‹çš„è®¡è´¹æ–¹å¼ã€è®¡è´¹é¡¹ã€è®¡è´¹å•ä»·å’Œå¼€é€šæ–¹å¼_åº”ç”¨å®æ—¶ç›‘æ§æœåŠ¡(ARMS)-é˜¿é‡Œäº‘å¸®åŠ©ä¸­å¿ƒ](https://help.aliyun.com/zh/arms/prometheus-monitoring/product-overview/billing-description/?spm=a2c4g.11186623.0.0.460f611641GFxf)\n\nå¹¶ä¸”è¿œç¨‹å†™é‡Œé¢ä¹Ÿæ˜¯å¯ä»¥åŒºåˆ†åŸºç¡€æŒ‡æ ‡ï¼ˆå…è´¹ï¼‰å’Œè‡ªå®šä¹‰æŒ‡æ ‡ï¼ˆæ”¶è´¹ï¼‰\n\nç‰¹åˆ«å…³é”®çš„æ˜¯ï¼Œé€šè¿‡remote_writeåŒæ­¥çš„æ•°æ®ä¹Ÿå¯ä»¥åŒºåˆ†åŸºç¡€æŒ‡æ ‡å’Œè‡ªå®šä¹‰æŒ‡æ ‡ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥é€šè¿‡é…ç½®relabelè§„åˆ™ï¼Œç²¾ç¡®æ§åˆ¶å“ªäº›æŒ‡æ ‡éœ€è¦åŒæ­¥åˆ°é˜¿é‡Œäº‘ï¼Œä»è€Œå¤§å¹…é™ä½è´¹ç”¨ã€‚\n\n![image.png](./å‚è€ƒ.png)\n\n## ä¼˜åŒ–æ–¹æ¡ˆ\n\nåŸºäºä»¥ä¸Šåˆ†æï¼Œæˆ‘åˆ¶å®šäº†ä»¥ä¸‹ä¼˜åŒ–ç­–ç•¥ï¼š\n\n1. **ä¿ç•™æ‰€æœ‰å…è´¹çš„åŸºç¡€æŒ‡æ ‡**ï¼šç¡®ä¿Kubernetesæ ¸å¿ƒç»„ä»¶ç›‘æ§ä¸å—å½±å“\n2. **ç²¾ç®€è‡ªå®šä¹‰æŒ‡æ ‡**ï¼šä»…ä¿ç•™éœ€è¦å‘Šè­¦çš„å…³é”®ä¸šåŠ¡æŒ‡æ ‡\n3. **åœç”¨é˜¿é‡Œäº‘Grafana**ï¼šæ”¹ç”¨é›†ç¾¤å†…è‡ªå»ºçš„Grafanaå®ä¾‹ï¼Œé¿å…é¢å¤–è´¹ç”¨\n\n### é…ç½®\n\né›†ç¾¤ä¸­ä½¿ç”¨çš„Prometheuså®‰è£…æ–¹çš„æ˜¯ [prometheus-operator](https://github.com/prometheus-operator/prometheus-operator) \n\næ‰€ä»¥å¯ä»¥æŒ‰ç…§æ–‡æ¡£é‡Œé¢çš„æ–¹å¼å¯¹remove wirteé…ç½®è¿›è¡Œä¿®æ”¹ [ç›¸å…³æ–‡æ¡£](https://github.com/prometheus-operator/prometheus-operator/blob/v0.79.2/Documentation/api.md) \n\nè¿™é‡Œæ˜¯ç›´æ¥ä¿®æ”¹é›†ç¾¤ä¸­Prometheuså¯¹è±¡\n\nåœ¨spec.remoteWrite.writeRelabelConfigs ä¸­è¿›è¡Œé…ç½®\n\nè¿™é‡Œæˆ‘é…ç½®æ˜¯ä»¥jobä¸ºæœ€å°å•ä½ï¼Œè™½ç„¶å‘Šè­¦ç”¨çš„æ˜¯ç‰¹å®šçš„æŒ‡æ ‡æ•°æ®ï¼Œä½†æ˜¯åœ¨æŸ¥çœ‹ç›¸å…³è‡ªå®šä¹‰jobçš„æ•°æ®åï¼Œå‘ç°å®ƒä»¬çš„å ç”¨å¹¶ä¸é«˜ï¼ŒåŒæ—¶å› ä¸ºæ¯æ¬¡ä¿®æ”¹å®ŒåremoteWriteçš„ç›¸å…³é…ç½®åï¼Œéƒ½è¦é‡å¯Prometheusï¼Œæ‰€ä»¥ä¹Ÿæ˜¯ä¸ºäº†é¿å…åç»­å› è°ƒæ•´å‘Šè­¦è§„åˆ™è€Œä¸æ–­é‡å¯Prometheusï¼Œæ‰€ä»¥è€ƒè™‘ä½¿ç”¨äº†jobçš„èŒƒå›´æ¥åšrelabelçš„é…ç½®\n\n```yaml\n    remoteWrite\n      writeRelabelConfigs:\n        - sourceLabels: [job]\n          regex: '^(apiserver|node-exporter|kube-state-metrics|kubelet|metallb-metrics|kube-dns|xxx-.*|ceph-.*|.*etcd.*)$'\n          action: keep\n```\n\né…ç½®å¥½åï¼Œé‡å¯å¯¹åº”çš„statefulset\n\n```bash\nKubectl rollout restart statefulsets.apps prometheus-k8s -n monitoring\n```\n\n### éªŒè¯\n\nåœ¨é…ç½®å¥½åï¼Œåˆ°æŒ‡æ ‡ä¸­å¿ƒæŸ¥çœ‹upçš„job\n\n```promql\nsum(up{}) by (job)\n```\n\nåŒæ—¶é€ä¸€éªŒè¯æ¯ä¸ªå‘Šè­¦è§„åˆ™çš„PromQLè¡¨è¾¾å¼ï¼Œç¡®ä¿æ‰€æœ‰å…³é”®å‘Šè­¦ä»èƒ½æ­£å¸¸è§¦å‘\n\n## ä¼˜åŒ–æ•ˆæœ\n\nåœ¨é…ç½®å¥½å¹¶è¿‡äº†ä¸€å¤©åæŸ¥çœ‹å¯¹åº”æ•°æ®\n\n![image.png](./before.png)\n\n![image.png](./after.png)\n\nä»ä¸Šé¢å¯ä»¥çœ‹å‡ºå¯¹åº”çš„è‡ªå®šä¹‰æŒ‡æ ‡æ•°æ®æœ‰å¤§å¹…ä¸‹é™ï¼ŒåŒæ—¶åœ¨æŸ¥çœ‹æˆæœ¬åï¼Œå‘ç°å¯¹åº”çš„Prometheusçš„æˆæœ¬ä¹Ÿæ˜¯ä¸‹é™äº†ã€‚\n\nåŸå…ˆæ˜¯æ¯å¤©160G x 0.4(æˆ‘ä»¬çš„Prometheusæ˜¯0.4æ¯G) = 64 ä¸‹é™æˆ 9G x 0.4 = 3.6 \n\n## æ€»ç»“\n\né€šè¿‡åˆç†é…ç½®Prometheusçš„remote wirteè§„åˆ™ï¼ŒæˆåŠŸå°†é˜¿é‡Œäº‘Prometheuså®ä¾‹çš„æˆæœ¬é™ä½äº†90%ä»¥ä¸Šï¼ŒåŒæ—¶å®Œæ•´ä¿ç•™äº†å‘Šè­¦åŠŸèƒ½ã€‚å”¯ä¸€çš„å˜åŠ¨æ˜¯å°†GrafanaæŸ¥çœ‹åœ°å€åˆ‡æ¢å›é›†ç¾¤å†…éƒ¨ç½²çš„å®ä¾‹ã€‚\n\nè¿™æ¬¡ä¼˜åŒ–å®è·µè¡¨æ˜ï¼Œäº‘æœåŠ¡çš„æˆæœ¬æ§åˆ¶ä¸ä»…éœ€è¦å…³æ³¨èµ„æºè§„æ ¼ï¼Œæ›´éœ€è¦æ·±å…¥ç†è§£æœåŠ¡çš„è®¡è´¹æ¨¡å‹ï¼Œé€šè¿‡æŠ€æœ¯æ‰‹æ®µç²¾å‡†æ§åˆ¶èµ„æºæ¶ˆè€—ã€‚\n\nå¯¹äºä½¿ç”¨é˜¿é‡Œäº‘Prometheusçš„å›¢é˜Ÿï¼Œå»ºè®®å®šæœŸå®¡æŸ¥æŒ‡æ ‡æ‘„å…¥æƒ…å†µï¼Œé¿å…ä¸å¿…è¦çš„è´¹ç”¨æ”¯å‡ºã€‚","tags":["ä¼˜åŒ–","Prometheus"]},{"title":"Linuxç½‘ç»œä¸¢åŒ…å‘Šè­¦çš„æ’æŸ¥å®è·µ","url":"/2025/08/14/Linuxç½‘ç»œä¸¢åŒ…å‘Šè­¦çš„æ’æŸ¥å®è·µ/","content":"\n> æŸå¤©æ™šä¸Šï¼Œå‘ç°åœ¨å‘Šè­¦ç¾¤é‡Œé¢æ”¶åˆ°ä¸€æ¡å…³äºç½‘ç»œä¸¢åŒ…çš„å‘Šè­¦\n\n![](./alert_dingtalk.png)\n\nè¿™é‡Œçœ‹åˆ°æœ‰ä¸¤å¼ ç½‘å¡éƒ½å‡ºç°äº†ä¸¢åŒ…ï¼Œä¸”ä¸¢åŒ…æ•°é‡ä¸€è‡´ï¼Œé‚£æ˜¯å› ä¸ºè¿™ä¸ªboud4ç½‘å¡æ˜¯ç”±enp26s0f0np0å’Œenp26s0f1np1èšåˆå‡ºæ¥äº†ï¼ˆä¸ºäº†åšé«˜å¯ç”¨ï¼‰ï¼Œæ‰€ä»¥åªè¦çœ‹enp26s0f0np0è¿™å¼ ç½‘å¡å°±å¥½äº†ã€‚\n\n# æŸ¥çœ‹èŠ‚ç‚¹æµé‡çŠ¶æ€\n\n![](./grafana.png)\n\nåœ¨grafanaä¸­æŸ¥çœ‹èŠ‚ç‚¹ç½‘ç»œçŠ¶æ€ï¼Œç¡®å®æ˜¯æœ‰å¤§æµé‡åœ¨è·‘\n\n# ç™»å½•åˆ°èŠ‚ç‚¹è¿›è¡Œæ’æŸ¥\n\nå…ˆç”¨ `ip link` æ¥æŸ¥çœ‹ç½‘å¡ç›¸å…³ä¿¡æ¯\n\n```shell\n# ip -s link show enp26s0f0np0 \n4: enp26s0f0np0: <BROADCAST,MULTICAST,SLAVE,UP,LOWER_UP> mtu 9000 qdisc mq master bond4 state UP mode DEFAULT group default qlen 1000\n    link/ether 0c:42:a1:32:11:d6 brd ff:ff:ff:ff:ff:ff\n    RX:      bytes     packets errors dropped  missed   mcast           \n    25911288114346 25333203540      0  574380       0 9523278 \n    TX:      bytes     packets errors dropped carrier collsns           \n    30755111916060 25795803740      0       0       0       0\n```\n\nå¯ä»¥å‘ç°åœ¨ç½‘å¡æ¥å—åŒ…çš„æ—¶å€™å‡ºç°äº†ä¸¢åŒ…åŸå› \n\nä½¿ç”¨ <font style=\"color:rgb(51, 51, 51);\">ethtool â€“S æŸ¥çœ‹ç½‘å¡åŒ…ä¿¡æ¯ï¼Œä¸»è¦å…³æ³¨rxçš„ä¿¡æ¯</font>\n\n<font style=\"color:rgb(51, 51, 51);\">å…¶ä¸­å…³äºä¸¢åŒ…çš„ä¿¡æ¯è¦å…³æ³¨ä»¥ä¸‹å‡ ä¸ªå­—æ®µ</font> ï¼ˆæˆ–è€…æ˜¯å¸¦errã€dropå­—æ ·çš„å­—æ®µï¼‰\n\n<font style=\"color:rgb(51, 51, 51);\">rx_err_lane_xx_phy  ç‰©ç†å±‚ï¼ˆPHYå±‚ï¼‰æ¥æ”¶è¿‡ç¨‹ä¸­ï¼Œç‰¹å®šä¼ è¾“é€šé“ä¸Šæ£€æµ‹åˆ°çš„é”™è¯¯ï¼ˆå¯èƒ½æ˜¯ç½‘çº¿å­˜åœ¨é—®é¢˜ï¼‰</font>\n\n<font style=\"color:rgb(51, 51, 51);\">rx_out_of_buffer  ç½‘å¡æ²¡æœ‰å¯ç”¨çš„æ¥æ”¶ç¼“å†²åŒºæ¥å­˜å‚¨ä¼ å…¥æ•°æ®åŒ…è€Œå¯¼è‡´ä¸¢åŒ…  </font>\n\n<font style=\"color:rgb(51, 51, 51);\">rx_buff_alloc_err   ç½‘å¡åœ¨æ¥æ”¶æ•°æ®åŒ…æ—¶å°è¯•åˆ†é…å†…å­˜ç¼“å†²åŒºæ—¶å‘ç”Ÿè€Œå¯¼è‡´ä¸¢åŒ…</font>\n\n<font style=\"color:rgb(51, 51, 51);\">rx_oversize_pkts_sw_drop æ•°æ®åŒ…å¤§å°è¶…è¿‡äº†è½¯ä»¶å±‚é¢å…è®¸ï¼ˆMTUï¼‰çš„æœ€å¤§å€¼è€Œè¢«ä¸¢å¼ƒçš„æ¥æ”¶æ•°æ®åŒ…æ•°é‡    </font>\n\n<font style=\"color:rgb(51, 51, 51);\">rx_wqe_err  æ¥æ”¶å·¥ä½œé˜Ÿåˆ—é¡¹ï¼ˆWork Queue Entryï¼‰é”™è¯¯ , æ„å‘³ç€ç½‘å¡é©±åŠ¨ä¸ç¡¬ä»¶ä¹‹é—´çš„é€šä¿¡é—®é¢˜  </font>\n\n```shell\n# ethtool -S enp26s0f0np0 | grep -i rx\n...\nrx_out_of_buffer  572782\n...\n```\n\n<font style=\"color:rgb(51, 51, 51);\">æˆ‘è¿™é‡Œå‘ç°rx_out_of_bufferçš„æ•°é‡ä¸€ç›´åœ¨å¢åŠ ï¼Œè¯´æ˜ç½‘å¡çš„ç¼“å†²åŒºå¤„ç†é€Ÿåº¦æ›´ä¸ä¸Šç½‘ç»œä¼ è¾“é€Ÿåº¦ï¼Œåœ¨ä¸Šå›¾ä¸­ä¹Ÿçœ‹åˆ°ç½‘ç»œç¡®å®æœ‰å¤§é‡æµé‡è¿›æ¥</font>\n\n<font style=\"color:rgb(51, 51, 51);\">æŸ¥çœ‹ç½‘å¡ç¼“å†²åŒºå¤§å°</font>\n\n```shell\n# ethtool -g enp26s0f0np0 \nRing parameters for enp26s0f0np0:\nPre-set maximums:\nRX:             1024\nRX Mini:        n/a\nRX Jumbo:       n/a\nTX:             1024\nCurrent hardware settings:\nRX:             1024\nRX Mini:        n/a\nRX Jumbo:       n/a\nTX:             1024\nRX Buf Len:             n/a\nTX Push:        n/a\n```\n\n<font style=\"color:rgb(51, 51, 51);\">å‘ç°RXçš„ç½‘å¡ç¼“å†²åŒºå¤§å°ä¸º1024ï¼Œä¸´æ—¶ä¿®æ”¹ä¸º8192ï¼Œçœ‹çœ‹é—®é¢˜æ˜¯å¦è¿˜å­˜åœ¨</font>\n\n```shell\n# ethtool -G enp26s0f0np0 rx 8192\n# ethtool -g enp26s0f0np0 \nRing parameters for enp26s0f0np0:\nPre-set maximums:\nRX:             8192\nRX Mini:        n/a\nRX Jumbo:       n/a\nTX:             8192\nCurrent hardware settings:\nRX:             8192\nRX Mini:        n/a\nRX Jumbo:       n/a\nTX:             1024\nRX Buf Len:             n/a\nTX Push:        n/a\n#  ethtool -S enp26s0f0np0 | grep -i rx_out_of_buffer\n```\n\nåœ¨ä¿®æ”¹åå‘ç° rx_out_of_buffer çš„æ•°é‡æ²¡æœ‰å†æ·»åŠ äº†ï¼Œè¿‡äº†5åˆ†é’Ÿå·¦å³å¯¹åº”çš„å‘Šè­¦ä¹Ÿæ¢å¤äº†\n\n![](./alert_recovery.png)\n\nç°åœ¨å°±è¦æŠŠå¯¹åº”çš„é…ç½®è¿›è¡ŒæŒä¹…åŒ–\n\n```shell\n# ä¿®æ”¹å¯¹åº”çš„é…ç½®æ–‡ä»¶ï¼Œæ·»åŠ å¯¹åº”çš„é…ç½® ${DEVICE} ä¸ºå¯¹åº”çš„ç½‘å¡åç§°\n# vi /etc/sysconfig/network-scripts/ifcfg-enp26s0f0np0\n...\nETHTOOL_OPTS=\"-G ${DEVICE} rx 8192\"\n# æˆ‘è¿™é‡Œæ˜¯bondæ‰€ä»¥å¦ä¸€å¼ ç½‘å¡ä¹Ÿè¦ä¿®æ”¹\n# vi /etc/sysconfig/network-scripts/ifcfg-enp26s0f1np1\n...\nETHTOOL_OPTS=\"-G ${DEVICE} rx 8192\"\n```\n\n# æ€»ç»“\n\nè¿™ä¸ªç½‘å¡çš„<font style=\"color:rgb(51, 51, 51);\">ç¼“å†²åŒºæœ‰ä»€ä¹ˆç”¨</font>\n\n<font style=\"color:rgb(51, 51, 51);\">å…ˆçœ‹ä¸€ä¸‹ä¸€ä¸ªç½‘ç»œæ•°æ®åŒ…åˆ°linuxä¸Šçš„å¤§æ¦‚æµç¨‹</font>\n\n[https://zhuanlan.zhihu.com/p/256428917](https://zhuanlan.zhihu.com/p/256428917) è¿™é‡Œå‚è€ƒå¤§ä½¬çš„æ–‡ç« \n\n![](./net1.png)\n\nè¿™é‡Œå¯ä»¥çœ‹åˆ°æŠŠæ•°æ®ä¿å­˜åœ¨ç¼“å†²åŒºï¼ˆRing bufferï¼‰ä¸ºç¬¬6æ­¥\n\n![](./net2.png)\n\nè¿™ä¸ªæµç¨‹å†ç»†åˆ†ä¸€ä¸‹å°±æ˜¯ä»¥ä¸Šçš„æ­¥éª¤ï¼Œä¹Ÿå°±æ˜¯è¯´å½“ç½‘å¡æŠŠæ•°æ®æ‹·åˆ°å†…å­˜çš„æ—¶å€™å‘ç°ç¼“å†²åŒºé˜Ÿåˆ—æ»¡äº†ï¼Œæ— æ³•å†æ·»åŠ æ•°æ®å¯¼è‡´æœ¬æ¬¡ä¸¢åŒ…\n\nåŒæ—¶ä¸Šè¿°çš„æ–‡ç« é‡Œé¢ä¹Ÿè¯´äº†ä¸ºä»€ä¹ˆethtoolå¯ä»¥ä¿®æ”¹è¿™ä¸ªç¼“å†²åŒºçš„é…ç½®ï¼Œå› ä¸º<font style=\"color:rgb(25, 27, 31);\">ç½‘å¡é©±åŠ¨å®ç°äº†ethtoolæ‰€éœ€è¦çš„æ¥å£ï¼Œä¹Ÿåœ¨è¿™é‡Œå®Œæˆå‡½æ•°åœ°å€çš„æ³¨å†Œã€‚å½“ ethtool å‘èµ·ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ä¹‹åï¼Œå†…æ ¸ä¼šæ‰¾åˆ°å¯¹åº”æ“ä½œçš„å›è°ƒå‡½æ•°ï¼ˆå®é™…ä¸Šè°ƒç”¨çš„å°±æ˜¯ç½‘å¡çš„æ¥å£ï¼‰ã€‚</font>\n\n![](./net3.png)\n\n","tags":["æ’éšœ","linux"]},{"title":"å¦‚ä½•åˆ¶ä½œWindows11é•œåƒå¹¶åœ¨KubeVirtä¸­éƒ¨ç½²","url":"/2025/07/07/å¦‚ä½•åˆ¶ä½œWindows11é•œåƒå¹¶åœ¨KubeVirtä¸­éƒ¨ç½²/","content":"\n> æœ€è¿‘éœ€è¦åœ¨k8sä¸­è§£é”win11è™šæ‹Ÿæœºï¼Œæ‰€ä»¥è¿›è¡Œäº†ç›¸å…³å­¦ä¹ å¹¶è®°å½•ä¸‹æ­¤ç¯‡åšå®¢\n\n# win11è™šæ‹Ÿæœºé…ç½®\n\næœ¬åœ°å…ˆå®‰è£…win11è™šæ‹Ÿæœºå¹¶å‡†å¤‡æ‰€éœ€è¦çš„è½¯ä»¶ï¼Œè¿™é‡Œä½¿ç”¨linuxæ¥åˆ›å»ºwin11è™šæ‹Ÿæœº\n\n```bash\nvirt-install \\\n --virt-type=kvm \\\n --name win11-render-1.6 \\\n --ram 16384 \\\n --vcpus=8 \\\n --os-variant=win11  \\\n --cdrom=/data/render/Win11_24H2_Chinese_Simplified_x64.iso \\\n --network=default,model=virtio \\\n --graphics vnc,listen=0.0.0.0 --noautoconsole \\\n --disk path=/data/render/virtio-win-0.1.271.iso,device=cdrom \\\n --disk path=/data/render/win11-render-1.6.qcow2,size=256,bus=virtio,format=qcow2 \\\n --boot uefi # win11é»˜è®¤ä½¿ç”¨uefiå¯åŠ¨\n```\n\nè¿™é‡Œæœ‰ä¸€ä¸ªè¦æ³¨æ„çš„ç‚¹æ˜¯å¯åŠ¨çš„æ—¶å€™é™¤äº†æŒ‚è½½win11çš„isoè¿˜è¦æŒ‚è½½virtio-winçš„é©±åŠ¨ï¼Œä¸ç„¶ä¼šå‡ºç°ä¸ªåˆ«ç¡¬ä»¶æ— æ³•ä½¿ç”¨çš„é—®é¢˜\n\nvirtio-winä¸‹è½½åœ°å€ï¼š[https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/archive-virtio/](https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/archive-virtio/)\n\n## é©±åŠ¨å®‰è£…\n\nå‚è€ƒæ–‡æ¡£\n\n[https://kubevirt.io/user-guide/user_workloads/windows_virtio_drivers/](https://kubevirt.io/user-guide/user_workloads/windows_virtio_drivers/)\n\nåœ¨å®‰è£…ç³»ç»Ÿçš„æ—¶å€™ä¼šå‡ºç°æ— å¯é€‰ç£ç›˜çš„é—®é¢˜ï¼Œè¿™ä¸ªæ—¶å€™å°±è¦å®‰è£…virtio-winé‡Œé¢çš„ç£ç›˜é©±åŠ¨ï¼ˆvioscsiï¼‰ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥æŠŠç½‘ç»œé©±åŠ¨ç»™å®‰è£…äº†(NetKvm)\n\n![](./install-vioscsi.png)\n\nè¿›åˆ°ç³»ç»Ÿåæ‰“å¼€è®¾å¤‡ç®¡ç†å™¨çœ‹çœ‹é‚£äº›è®¾å¤‡éœ€è¦å®‰è£…é©±åŠ¨ï¼ˆä»virtio-winé‡Œé¢å®‰è£…ï¼‰\n\n![](./driver.png)\n\n## è§£é”BitLocker\n\næˆåŠŸè¿›å…¥ç³»ç»Ÿåå…ˆåˆ«æ€¥ç€å¯¹ç³»ç»Ÿè¿›è¡Œå®šåˆ¶å®‰è£…ï¼Œå…ˆæŠŠç£ç›˜çš„BitLockerç»™å…³é—­æ‰ï¼Œä»¥ä¾¿åé¢è¿›è¡Œsysprepæ‰“åŒ…\n\nåœ¨powershellä¸­è¾“å…¥\n\n```powershell\n# æŸ¥çœ‹ç£ç›˜è§£é”çŠ¶æ€\nmanage-bde -status\nBitLocker é©±åŠ¨å™¨åŠ å¯†: é…ç½®å·¥å…·ç‰ˆæœ¬ 10.0.26100\nç‰ˆæƒæ‰€æœ‰ (C) 2013 Microsoft Corporationã€‚ä¿ç•™æ‰€æœ‰æƒåˆ©ã€‚\n\nå¯ä»¥ä½¿ç”¨ BitLocker é©±åŠ¨å™¨åŠ å¯†\nä¿æŠ¤çš„ç£ç›˜å·:\nå· C: []\n[OS å·]\n\n    å¤§å°:              255.19 GB\n    BitLocker ç‰ˆæœ¬:    æ— \n    è½¬æ¢çŠ¶æ€:          å®Œå…¨è§£å¯†\n    å·²åŠ å¯†ç™¾åˆ†æ¯”:      0.0%  # æŸ¥çœ‹è§£å¯†è¿›åº¦\n    åŠ å¯†æ–¹æ³•:          æ— \n    ä¿æŠ¤çŠ¶æ€:          ä¿æŠ¤å…³é—­\n    é”å®šçŠ¶æ€:          å·²è§£é”\n    æ ‡è¯†å­—æ®µ:          æ— \n    å¯†é’¥ä¿æŠ¤å™¨:        æ‰¾ä¸åˆ°\n    \n# å…³é—­å¯¹åº”ç£ç›˜BitLocker\nmanage-bde -off C:\n```\n\n## cloudbase-init å®‰è£…\n\nåœ¨å®Œæˆç³»ç»Ÿå®šåˆ¶åŒ–è½¯ä»¶å®‰è£…åï¼Œä¸‹è½½cloudbase-initè¿›è¡Œç³»ç»Ÿé…ç½® [https://cloudbase.it/cloudbase-init/](https://cloudbase.it/cloudbase-init/)\n\nä½¿ç”¨cloudbase-initå¯ä»¥è¯»å–è™šæ‹Ÿæœºå¯åŠ¨æ—¶çš„é…ç½®è¿›è¡ŒåŠ¨æ€é…ç½®ç³»ç»Ÿä¿¡æ¯ï¼ˆæ¯”å¦‚hostnameã€ç”¨æˆ·å¯†ç ç­‰ï¼‰\n\n![](./cloudbase1.png)\n\nå¦‚æœä½ è¿™ä¸ªæ—¶å€™å·²ç»é…ç½®å¥½ç³»ç»Ÿäº†ï¼Œå¯ä»¥å‹¾é€‰ä¸‹é¢çš„é€‰é¡¹ï¼Œå®ƒå°†ä¼šè‡ªåŠ¨æ‰§è¡Œsysprepå¹¶å…³æœº\n\n![](./cloudbase2.png)\n\n### é…ç½®cloudbase-init\n\n cloudbase-init çš„å…¸å‹ç”¨æ³•ä¸»è¦æ˜¯é€šè¿‡é…ç½®æ–‡ä»¶è¿›è¡Œé…ç½®ï¼Œä»¥ç¡®å®šè¦ä½¿ç”¨å“ªäº›æœåŠ¡ï¼ˆservicesï¼‰å’Œæ’ä»¶ï¼ˆpluginsï¼‰ï¼Œç„¶ååœ¨è¿™äº›æ–‡ä»¶ä¸­è®¾ç½®å‚æ•°æ¥å®šåˆ¶å®ƒä»¬çš„è¡Œä¸ºä»¥åŠæ•´ä½“åˆå§‹åŒ–è¿‡ç¨‹  \n\n[https://cloudbase-init.readthedocs.io/en/latest/](https://cloudbase-init.readthedocs.io/en/latest/)\n\nè¿™é‡Œè¿›è¡Œé»˜è®¤ç”¨æˆ·å¯†ç ä¿®æ”¹å’Œhostnameçš„é…ç½®\n\né¦–å…ˆå…ˆé…ç½®å¯¹åº”çš„é…ç½®æ–‡ä»¶ cloudbase-init.conf ï¼Œè¿™é‡Œåªç”¨é…ç½® cloudbase-init.conf ï¼Œä¸ç”¨é…ç½®cloudbase-init-unattend.conf \n\nå› ä¸ºæˆ‘ä»¬è¿™ä½¿ç”¨çš„pluginsæ˜¯ **cloudbaseinit.plugins.common.sethostname.SetHostNamePlugin** ã€**cloudbaseinit.plugins.common.setuserpassword.SetUserPasswordPlugin** å’Œ **cloudbaseinit.plugins.common.userdata.UserDataPlugin**\n\nè€Œcloudbase-init-unattend.confä¸­åªèƒ½ä½¿ç”¨**MTU** å’Œ **hostname** plugins\n\nå› ä¸ºè¦åœ¨æœ¬åœ°éªŒè¯é…ç½®ï¼Œæ‰€ä»¥ä½¿ç”¨çš„serviceæ˜¯  **cloudbaseinit.metadata.services.nocloudservice.NoCloudConfigDriveService**\n\n[https://cloudbase-init.readthedocs.io/en/latest/tutorial.html#configuration-file](https://cloudbase-init.readthedocs.io/en/latest/tutorial.html#configuration-file)\n\n```plain\n# cloudbase-init.conf  metadata_serviceså’Œpluginsç­‰ç›¸å…³é…ç½®\nmetadata_services=cloudbaseinit.metadata.services.nocloudservice.NoCloudConfigDriveService\nplugins=cloudbaseinit.plugins.common.sethostname.SetHostNamePlugin,cloudbaseinit.plugins.common.setuserpassword.SetUserPasswordPlugin,cloudbaseinit.plugins.windows.updates.WindowsAutoUpdatesPlugin,cloudbaseinit.plugins.common.userdata.UserDataPlugin\nallow_reboot=false    # allow the service to reboot the system\nstop_service_on_exit=false\n```\n\n### å‡†å¤‡ <font style=\"color:rgb(0, 0, 0);\">NoCloudConfigDriveService æ•°æ®</font>\n\n> <font style=\"color:rgb(64, 64, 64);background-color:rgb(252, 252, 252);\">The metadata is provided on a config-drive (vfat or iso9660) with the label cidata or CIDATA.</font>\n>\n> <font style=\"color:rgb(64, 64, 64);background-color:rgb(252, 252, 252);\">The default folder structure for NoCloud is:</font>\n>\n> + <font style=\"color:rgb(64, 64, 64);background-color:rgb(252, 252, 252);\">/user-data</font>\n> + <font style=\"color:rgb(64, 64, 64);background-color:rgb(252, 252, 252);\">/meta-data</font>\n\nè¿™ä¸ª `NoCloudConfigDriveServic ` æ•°æ®æ˜¯ä¸€ä¸ªisoç£ç›˜ï¼Œå¹¶ä¸”åç§°è¦ä¸º cidata æˆ– CIDATA\n\n<font style=\"color:rgb(0, 0, 0);\">é‡Œé¢çš„æ–‡ä»¶å¯ä»¥æœ‰ï¼šmeta-data(å…ƒæ•°æ®) å’Œuser-data(ç”¨æˆ·å®šä¹‰çš„æ•°æ®)</font>\n\n[https://cloudinit.readthedocs.io/en/latest/reference/datasources/nocloud.html](https://cloudinit.readthedocs.io/en/latest/reference/datasources/nocloud.html)\n\n[https://cloudbase-init.readthedocs.io/en/latest/plugins.html#user-data-main](https://cloudbase-init.readthedocs.io/en/latest/plugins.html#user-data-main)\n\nä»¥ä¸‹å°±æ˜¯è¿™æ¬¡meta_dataå’Œuser_dataçš„é…ç½®\n\n```shell\n# cat meta_data.yaml \ninstance-id: test-windows\nhostname: test-windows\n# cat user_data.yaml\n#cloud-config\nset_hostname: test-windows\n\nusers:\n  - name: admin\n    passwd: 1qaz@WSX # å¯¹åº”ç”¨æˆ·çš„åˆå§‹åŒ–å¯†ç \n    groups:\n      - Administrators\n\nruncmd:\n  - 'powershell -command \"Write-Host \\\"Cloudbase-Init configuration applied successfully!\\\"\"'\n```\n\nè¿›è¡Œisoæ‰“åŒ…\n\n[https://documentation.ubuntu.com/public-images/public-images-how-to/use-local-cloud-init-ds/](https://documentation.ubuntu.com/public-images/public-images-how-to/use-local-cloud-init-ds/)\n\n```shell\n# ä¸‹è½½ cloud-localds\n# dnf --enablerepo=devel install cloud-utils\n# cloud-localds config-drive.iso user_data.yaml meta_data.yaml\n```\n\næŠŠæ‰“åŒ…å‡ºæ¥çš„config-drive.isoæŒ‚è½½åˆ°å¯¹åº”çš„è™šæ‹Ÿæœºé‡Œé¢\n\n```shell\n# virsh edit --domain win11-test-cloudbase-init \n...\n    <disk type='file' device='cdrom'>\n      <driver name='qemu' type='raw'/>\n      <source file='/data/render/cloudbase-init/config-drive.iso'/>\n      <target dev='sdd' bus='sata'/>\n      <readonly/>\n      <address type='drive' controller='0' bus='0' target='0' unit='3'/>\n    </disk>\n...\n```\n\n![](./disk.png)\n\n```powershell\nPS G:\\> dir\n\n    ç›®å½•: G:\\\n\nMode                 LastWriteTime         Length Name\n----                 -------------         ------ ----\n--r---          2025/7/6     23:32             49 meta-data\n--r---          2025/7/6     23:32            224 user-data\n```\n\næ¥ä¸‹æ¥å¯ä»¥æŒ‰ç…§é¡¹ç›®è¦æ±‚å®‰è£…è½¯ä»¶ï¼Œæ¯”å¦‚åœ¨windowsä¸Šé¢å®‰è£…opensshæ–¹ä¾¿ä½¿ç”¨ansibleè¿›è¡Œç®¡ç†\n\n[ä½¿ç”¨ansibleç®¡ç†windwos - kehaha-5](https://kehaha-5.github.io/2025/07/06/ä½¿ç”¨ansibleç®¡ç†windwos/)\n\n## sysprepç³»ç»Ÿå°è£…\n\næ‰‹åŠ¨è¿›è¡Œsysprepç³»ç»Ÿå°è£…\n\n[https://learn.microsoft.com/zh-cn/windows-hardware/manufacture/desktop/sysprep--system-preparation--overview?view=windows-11](https://learn.microsoft.com/zh-cn/windows-hardware/manufacture/desktop/sysprep--system-preparation--overview?view=windows-11)\n\nå‘½ä»¤æ–‡æ¡£ï¼š[https://learn.microsoft.com/zh-cn/windows-hardware/manufacture/desktop/sysprep-command-line-options?view=windows-11](https://learn.microsoft.com/zh-cn/windows-hardware/manufacture/desktop/sysprep-command-line-options?view=windows-11)\n\nå¦‚æœä½ çš„ç³»ç»Ÿæƒ³è¦ç¬¬ä¸€æ¬¡è¿›å…¥æ—¶è¿›è¡Œé‡æ–°é…ç½®(oobe)å°±æ‰§è¡Œ \n\noobe: <font style=\"color:rgb(22, 22, 22);\">å®¢æˆ·å¯ä»¥é€šè¿‡å¼€ç®±å³ç”¨ä½“éªŒ (OOBE) æ·»åŠ ç”¨æˆ·ç‰¹å®šçš„ä¿¡æ¯å¹¶æ¥å— Microsoft è½¯ä»¶è®¸å¯æ¡æ¬¾</font>\n\n```powershell\n%WINDIR%\\system32\\sysprep\\sysprep.exe /generalize /shutdown /oobe /mode:vm\n```\n\nå¦‚æœæƒ³è¦ç³»ç»Ÿç¬¬ä¸€æ¬¡è¿›å…¥æ—¶è¿›å…¥å®¡æ ¸æ¨¡å¼ï¼Œæ–¹ä¾¿ç³»ç»Ÿè°ƒå¼å°±æ‰§è¡Œ\n\n```powershell\n%WINDIR%\\system32\\sysprep\\sysprep.exe /generalize /shutdown /oobe /mode:vm\n```\n\nå¦‚æœæƒ³è¦è¿›å…¥åˆ°æ— äººæ¥è§¦æ¨¡å¼å°±è¦é…ç½®å¥½unattendæ–‡ä»¶ï¼ŒåŒæ—¶å‘½ä»¤ä¸­æŒ‡å®šå¯¹åº”çš„æ–‡ä»¶\n\n```powershell\n%WINDIR%\\system32\\sysprep\\sysprep.exe /generalize /oobe /shutdown /unattend:xxx /mode:vm\n```\n\nè¿™é‡Œä½¿ç”¨çš„æ˜¯æ— äººæ¥è§¦æ¨¡å¼ï¼Œå¦‚æœæ²¡æœ‰å…¶å®ƒç‰¹æ®Šçš„é…ç½®ï¼Œunattend.xmlå¯ä»¥ç”¨cloudbase-initå®‰è£…æ—¶ä¼šæºå¸¦çš„unattend.xmlæ–‡ä»¶\n\næ³¨æ„å¿…é¡»è¦æ·»åŠ  `/mode:vm` å‚æ•°ï¼Œå¦åˆ™å¯èƒ½ä¼šå‡ºç°å¯åŠ¨è“å±ï¼ˆcode:INACCESSIBLE BOOT DEVICEï¼‰æˆ–è€…å‡ºç°æç¤ºç³»ç»Ÿæ— æ³•å¯åŠ¨ï¼Œè¯·é‡æ–°å®‰è£…windwosç­‰æ— æ³•å¯åŠ¨çš„é—®é¢˜\n\nè¿™é‡Œä½¿ç”¨æ·»åŠ  `/shutdown` å‚æ•°ç¡®ä¿ç³»ç»Ÿæ‰“åŒ…å¥½åè‡ªåŠ¨å…³æœº\n\n## é…ç½®éªŒè¯\n\nåœ¨é…ç½®å®Œä¸Šè¿°çš„CloudBase-Initå’ŒSysprepæ‰“åŒ…å…³æœºåï¼Œæ‰‹åŠ¨å¯åŠ¨ç³»ç»Ÿï¼Œåœ¨ç³»ç»Ÿå¯åŠ¨å®Œæˆåå¯ä»¥åœ¨cloudbase-initçš„logç›®å½•ä¸‹é¢æŸ¥çœ‹å¯¹åº”çš„æ‰§è¡Œæ—¥å¿—\n\n```log\n2025-07-07 14:59:04.852 3768 INFO cloudbaseinit.metadata.services.osconfigdrive.windows [-] Config Drive found on G:\\\n2025-07-07 14:59:04.857 3768 DEBUG cloudbaseinit.metadata.services.baseconfigdrive [-] Metadata copied to folder: 'C:\\\\WINDOWS\\\\TEMP\\\\tmpbxgu6_cf' load C:\\Program Files\\Cloudbase Solutions\\Cloudbase-Init\\Python\\Lib\\site-packages\\cloudbaseinit\\metadata\\services\\baseconfigdrive.py:81\n2025-07-07 14:59:04.862 3768 INFO cloudbaseinit.init [-] Metadata service loaded: 'NoCloudConfigDriveService'\n2025-07-07 14:59:04.864 3768 DEBUG cloudbaseinit.init [-] Instance id: test-windows configure_host C:\\Program Files\\Cloudbase Solutions\\Cloudbase-Init\\Python\\Lib\\site-packages\\cloudbaseinit\\init.py:202\n2025-07-07 14:59:04.869 3768 DEBUG cloudbaseinit.utils.classloader [-] Loading class 'cloudbaseinit.plugins.common.sethostname.SetHostNamePlugin' load_class C:\\Program Files\\Cloudbase Solutions\\Cloudbase-Init\\Python\\Lib\\site-packages\\cloudbaseinit\\utils\\classloader.py:35\n2025-07-07 14:59:04.873 3768 DEBUG cloudbaseinit.utils.classloader [-] Loading class 'cloudbaseinit.plugins.common.setuserpassword.SetUserPasswordPlugin' load_class C:\\Program Files\\Cloudbase Solutions\\Cloudbase-Init\\Python\\Lib\\site-packages\\cloudbaseinit\\utils\\classloader.py:35\n2025-07-07 14:59:04.876 3768 DEBUG cloudbaseinit.utils.classloader [-] Loading class 'cloudbaseinit.plugins.windows.updates.WindowsAutoUpdatesPlugin' load_class C:\\Program Files\\Cloudbase Solutions\\Cloudbase-Init\\Python\\Lib\\site-packages\\cloudbaseinit\\utils\\classloader.py:35\n2025-07-07 14:59:04.882 3768 DEBUG cloudbaseinit.utils.classloader [-] Loading class 'cloudbaseinit.plugins.common.userdata.UserDataPlugin' load_class C:\\Program Files\\Cloudbase Solutions\\Cloudbase-Init\\Python\\Lib\\site-packages\\cloudbaseinit\\utils\\classloader.py:35\n2025-07-07 14:59:04.887 3768 INFO cloudbaseinit.init [-] Executing plugins for stage 'MAIN':\n2025-07-07 14:59:04.888 3768 DEBUG cloudbaseinit.init [-] Plugin 'SetHostNamePlugin' execution already done, skipping _exec_plugin C:\\Program Files\\Cloudbase Solutions\\Cloudbase-Init\\Python\\Lib\\site-packages\\cloudbaseinit\\init.py:61\n2025-07-07 14:59:04.894 3768 DEBUG cloudbaseinit.init [-] Plugin 'SetUserPasswordPlugin' execution already done, skipping _exec_plugin C:\\Program Files\\Cloudbase Solutions\\Cloudbase-Init\\Python\\Lib\\site-packages\\cloudbaseinit\\init.py:61\n2025-07-07 14:59:04.899 3768 DEBUG cloudbaseinit.init [-] Plugin 'WindowsAutoUpdatesPlugin' execution already done, skipping _exec_plugin C:\\Program Files\\Cloudbase Solutions\\Cloudbase-Init\\Python\\Lib\\site-packages\\cloudbaseinit\\init.py:61\n2025-07-07 14:59:04.902 3768 DEBUG cloudbaseinit.init [-] Plugin 'UserDataPlugin' execution already done, skipping _exec_plugin C:\\Program Files\\Cloudbase Solutions\\Cloudbase-Init\\Python\\Lib\\site-packages\\cloudbaseinit\\init.py:61\n2025-07-07 14:59:04.906 3768 DEBUG cloudbaseinit.metadata.services.baseconfigdrive [-] Deleting metadata folder: 'C:\\\\WINDOWS\\\\TEMP\\\\tmpbxgu6_cf' cleanup C:\\Program Files\\Cloudbase Solutions\\Cloudbase-Init\\Python\\Lib\\site-packages\\cloudbaseinit\\metadata\\services\\baseconfigdrive.py:93\n2025-07-07 14:59:04.911 3768 INFO cloudbaseinit.init [-] Plugins execution done\n```\n\nä»ä¸Šé¢çš„æ—¥å¿—å¯ä»¥çœ‹åˆ°ï¼Œæ‰¾åˆ°äº†Config Drive ï¼ˆGç›˜ï¼‰ï¼Œè·å–äº†hostnameä¸º`test-windows`ï¼Œå¹¶æˆåŠŸå¯åŠ¨äº† `UserDataPlugin`ã€`SetHostNamePlugin` ã€`SetUserPasswordPlugin`  è¿™å‡ ä¸ªæ’ä»¶\n\n> æ³¨æ„å¦‚æœæƒ³è¦hostnameé…ç½®æˆåŠŸï¼Œå¯èƒ½éœ€è¦é‡æ–°ç³»ç»Ÿ\n\n[https://cloudbase-init.readthedocs.io/en/latest/userdata.html#cloud-config](https://cloudbase-init.readthedocs.io/en/latest/userdata.html#cloud-config)\n\n# kubevirté…ç½®\n\næ­¤æ—¶å°±å®Œæˆäº†ç³»ç»Ÿçš„å°è£…ï¼Œæ¥ä¸‹æ¥æŠŠå¯¹åº”çš„qcow2é•œåƒå¯¼å‡ºåˆ°webserverï¼Œæ–¹ä¾¿åç»­å¯¼å…¥cdiä¸­\n\nå¯åŠ¨è™šæ‹Ÿæœºç”¨çš„æ˜¯kubevirtç»„ä»¶ï¼Œé‡Œé¢ä¸€ä¸ªè™šæ‹Ÿæœºçš„ç›¸å…³èµ„æºæœ‰ cdiã€vmã€vmiå’Œpodï¼Œå…¶ä¸­\n\ncdiæ˜¯ç”¨æ¥å¯¼å…¥è™šæ‹Ÿæœºé•œåƒçš„ï¼Œå¯ä»¥ç”¨httpçš„æ–¹å¼å¯¼å…¥ä¸Šé¢æ‰“åŒ…å¥½çš„win11çš„é•œåƒ\n\nvmå¯ä»¥ç†è§£ä¸ºå®šä¹‰è™šæ‹Ÿæœºçš„xml\n\nvmiå°±æ˜¯å¯¹åº”çš„è™šæ‹Ÿæœºè¿è¡Œæ—¶çš„å®ä¾‹\n\npodå°±æ˜¯å¯¹åº”k8sä¸­çš„è¿è¡Œèµ„æº\n\n## bisoé…ç½®\n\nå…¶ä¸­éœ€è¦é¢å¤–é…ç½®ä¸€ä¸‹vmï¼Œå› ä¸ºä½¿ç”¨çš„é•œåƒä¸ºwin11è¦ä½¿ç”¨uefå¯åŠ¨ï¼Œkubevirté»˜è®¤ä½¿ç”¨çš„æ˜¯bisoå¯åŠ¨çš„\n\n![](./boot.png)\n\n## cpué…ç½®\n\nè¿˜æœ‰å°±æ˜¯è¦é…ç½®ä¸€ä¸‹cpuçš„ç›¸å…³é…ç½®ï¼Œä¸ç„¶ä»»åŠ¡ç®¡ç†ä¸­çš„cpuæ•°é‡ä¼šè·Ÿè™šæ‹Ÿæœºé…ç½®å’Œè®¾å¤‡ç®¡ç†å™¨ä¸­æ˜¾ç¤ºçš„æ•°é‡ä¸ä¸€è‡´\n\n![](./cpu1.png)\n\nä¸ä¸€è‡´çš„æƒ…å†µå¦‚ä¸‹\n\n![](./cpu2.png)\n\n## cloudbaseé…ç½®\n\nkubevirtæ˜¯æ”¯æŒ `cloudInitNoCloud` å’Œ `cloudInitConfigDrive`çš„é…ç½®çš„ï¼Œå¹¶ä¸”ä¹Ÿæ”¯æŒä»k8sçš„secretä¸­è·å–é…ç½®ä¿¡æ¯\n\nå…·ä½“çœ‹å¦‚ä¸‹é“¾æ¥\n\n[https://kubevirt.io/user-guide/user_workloads/startup_scripts/#cloud-init-examples](https://kubevirt.io/user-guide/user_workloads/startup_scripts/#cloud-init-examples)\n\nå…¶å®ƒå‚è€ƒï¼š\n\n[https://kubevirt.io/2022/KubeVirt-installing_Microsoft_Windows_11_from_an_iso.html](https://kubevirt.io/2022/KubeVirt-installing_Microsoft_Windows_11_from_an_iso.html)\n\nè‡³æ­¤ï¼Œå°±å¯ä»¥åœ¨k8sä¸­è§£é”win11è™šæ‹Ÿæœºäº†ğŸ¥°\n\n","tags":["è¾¹åšè¾¹å­¦","windows11","kubevirt"]},{"title":"ä½¿ç”¨ansibleç®¡ç†windwos","url":"/2025/07/06/ä½¿ç”¨ansibleç®¡ç†windwos/","content":"\n> æœ€è¿‘è¦å¯¹20å¤šå°windowsä¸»æœºè¿›è¡Œç®¡ç†ï¼ˆå¯åŠ¨è¿›ç¨‹ã€æŒ‚è½½ç½‘ç»œç¡¬ç›˜å’Œä¿®æ”¹ç¯å¢ƒå˜é‡ï¼‰ï¼Œæ‰€ä»¥ä½¿ç”¨äº†ansibleåšç®¡ç†å·¥å…·\n\n# å®‰è£…ansible\n\nåœ¨ä½¿ç”¨absibleæ—¶ï¼Œåªéœ€è¦åœ¨é›†ç¾¤ä¸­çš„ä¸€å°é€‰æ‹©ä»»æ„ä¸€å°æœåŠ¡å™¨(linuxç³»ç»Ÿ)åœ¨ä¸Šé¢å®‰è£…ansibleå³å¯\n\nä½†æ˜¯é›†ç¾¤ä¸­æ˜¯windwosç³»ç»Ÿï¼Œ æ‰€ä»¥è¦åœ¨windwosä¸Šé¢å®‰è£…wslï¼Œå…ˆè¦åœ¨ç³»ç»ŸåŠŸèƒ½é‡Œé¢å¼€å¯wslåŠŸèƒ½ï¼Œç„¶åå®‰è£…wsl2ç¨‹åº\n\n[å®‰è£… WSL | Microsoft Learn](https://learn.microsoft.com/zh-cn/windows/wsl/install)\n\n```powershell\nwsl --list --online # æŸ¥è¯¢å¯ä»¥æŒ‰ç…§çš„linuxç‰ˆæœ¬\nwsl --install -d <Distribution Name> # å®‰è£…å¯¹åº”çš„linuxç³»ç»Ÿ\n```\n\nå®‰è£…å®Œæˆååœ¨wslä¸­å®‰è£…ansibleï¼Œæˆ‘çš„ç³»ç»Ÿæ˜¯ä½¿ç”¨dnfè¿›è¡Œå®‰è£…\n\n```shell\n# dnf install ansible-core\n```\n\n# é…ç½®windwos\n\nansibleè¦æ§åˆ¶windwosçš„è¯ï¼Œwindwoséœ€è¦è¿›è¡Œé…ç½®ï¼Œè¦å¼€å¯windwosçš„wrmï¼ˆWindows Remote Managementï¼‰æˆ–è€…é…ç½®sshæœåŠ¡\n\n[https://docs.ansible.com/ansible/latest/os_guide/windows_winrm.html](https://docs.ansible.com/ansible/latest/os_guide/windows_winrm.html)\n\n[https://docs.ansible.com/ansible/latest/os_guide/windows_ssh.html](https://docs.ansible.com/ansible/latest/os_guide/windows_ssh.html)\n\nè¿™é‡Œé…ç½®sshï¼Œå› ä¸ºå®ƒåŠŸèƒ½æ›´å¥½ï¼Œä½†æ˜¯è¦æ³¨æ„ç‰ˆæœ¬\n\n> <font style=\"color:rgb(64, 64, 64);background-color:rgb(252, 252, 252);\">Microsoft provides an OpenSSH implementation with Windows since Windows Server 2019 as a Windows capability. It can also be installed through an upstream package under </font>[<font style=\"color:rgb(41, 128, 185);\">Win32-OpenSSH</font>](https://github.com/PowerShell/Win32-OpenSSH)<font style=\"color:rgb(64, 64, 64);background-color:rgb(252, 252, 252);\">. Ansible officially only supports the OpenSSH implementation shipped with Windows, not the upstream package. The OpenSSH version must be version </font> `7.9.0.0` <font style=\"color:rgb(64, 64, 64);background-color:rgb(252, 252, 252);\"> at a minimum. This effectively means official support starts with Windows Server 2022 because Server 2019 ships with version `7.7.2.1` <font style=\"color:rgb(64, 64, 64);background-color:rgb(252, 252, 252);\">. Using older Windows versions or the upstream package might work but is not supported.</font>\n\n<font style=\"color:rgb(64, 64, 64);background-color:rgb(252, 252, 252);\">é…ç½®sshçš„è¯å¯ä»¥æ ¹æ®æ–‡æ¡£è¿›è¡Œå®‰è£…</font>\n\n```powershell\nGet-WindowsCapability -Name OpenSSH.Server* -Online |\n    Add-WindowsCapability -Online\nSet-Service -Name sshd -StartupType Automatic -Status Running\n\n$firewallParams = @{\n    Name        = 'sshd-Server-In-TCP'\n    DisplayName = 'Inbound rule for OpenSSH Server (sshd) on TCP port 22'\n    Action      = 'Allow'\n    Direction   = 'Inbound'\n    Enabled     = 'True'  # This is not a boolean but an enum\n    Profile     = 'Any'\n    Protocol    = 'TCP'\n    LocalPort   = 22\n}\nNew-NetFirewallRule @firewallParams\n\n$shellParams = @{\n    Path         = 'HKLM:\\SOFTWARE\\OpenSSH'\n    Name         = 'DefaultShell'\n    Value        = 'C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe'\n    PropertyType = 'String'\n    Force        = $true\n}\nNew-ItemProperty @shellParams\n```\n\næŒ‡å®šç™»å½•åçš„shellä¸ºpowershell\n\n```powershell\n# Set default to powershell.exe\n$shellParams = @{\n    Path         = 'HKLM:\\SOFTWARE\\OpenSSH'\n    Name         = 'DefaultShell'\n    Value        = 'C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe'\n    PropertyType = 'String'\n    Force        = $true\n}\nNew-ItemProperty @shellParams\n\n# Set default back to cmd.exe\nRemove-ItemProperty -Path HKLM:\\SOFTWARE\\OpenSSH -Name DefaultShell\n```\n\né…ç½®å¥½åï¼Œå¯ä»¥é€šè¿‡ssh windowsç”¨æˆ·å@åœ°å€ ç™»å½•åˆ°ç³»ç»Ÿ\n\n# é…ç½®ansible\n\né¦–å…ˆè¦å¯¹æˆ‘ä»¬å°†è¦ç®¡ç†çš„èµ„äº§å†™ä¸€ä¸ªansibleçš„èµ„äº§æ–‡ä»¶é‡Œé¢\n\n```powershell\nwin:\n  hosts:\n   10.88.128.xxx:\n   10.88.128.xxx:\n  vars:\n    ansible_user: \"xxx\" # Windowsä¸Šçš„SSHç”¨æˆ·å\n    ansible_password: \"xxx\" # Windows SSHç”¨æˆ·çš„å¯†ç  (æˆ–è€…é…ç½®SSH Key)\n    ansible_port: 22 # SSHé»˜è®¤ç«¯å£\n    ansible_connection: ssh # æŒ‡å®šä½¿ç”¨SSHè¿æ¥\n    ansible_shell_type: powershell # æŒ‡å®šWindowsä¸Šçš„Shellç±»å‹ï¼ŒPowershellæ˜¯å¸¸è§çš„é€‰æ‹©\n```\n\né…ç½®å¥½åå¯ä»¥è¿›è¡Œæµ‹è¯•\n\n```shell\n[root@Server-68ca6f1e-6023-4e99-9051-10e3746df9bb ~]# ansible -i /etc/ansible/win_inventory.yml all -m win_ping \n[WARNING]: Collection ansible.windows does not support Ansible version 2.14.18\n[WARNING]: Collection ansible.windows does not support Ansible version 2.14.18\n[WARNING]: Collection ansible.windows does not support Ansible version 2.14.18\n[WARNING]: Collection ansible.windows does not support Ansible version 2.14.18\n[WARNING]: Collection ansible.windows does not support Ansible version 2.14.18\n10.88.128.xx | SUCCESS => {\n    \"changed\": false,\n    \"ping\": \"pong\"\n}\n[WARNING]: Collection ansible.windows does not support Ansible version 2.14.18\n10.88.128.xxx | SUCCESS => {\n    \"changed\": false,\n    \"ping\": \"pong\"\n}\n```\n\nå¦‚æœæŠ¥winæ¨¡å—æ²¡æœ‰çš„è¯è¦è¿›è¡Œå®‰è£…\n\n```shell\nansible-galaxy collection install ansible.windows\n```\n\nå¦‚æœä½¿ç”¨win_pongå‘ç°ç»“æœæ˜¯ä¹±ç çš„è¯ï¼Œå¯ä»¥åˆ°windowsä¸Šé¢é‡æ–°å®‰è£…ä¸€ä¸‹ssh\n\n```shell\nRemove-WindowsCapability -Online -Name OpenSSH.Client # å¸è½½open-ssh\n# é‡æ–°æ‰§è¡Œä¸Šé¢çš„è„šæœ¬å®‰è£…open-ssh\n```\n\nåé¢å°±å¯ä»¥æ ¹æ®å®é™…æƒ…å†µç¼–å†™playbookäº†\n\nansibleä¸­winç›¸å…³çš„å‘½ä»¤æ–‡æ¡£\n\n[https://docs.ansible.com/ansible/latest/collections/ansible/windows/index.html#plugins-in-ansible-windows](https://docs.ansible.com/ansible/latest/collections/ansible/windows/index.html#plugins-in-ansible-windows)\n\n","tags":["è¾¹åšè¾¹å­¦","windows","ansible"]},{"title":"K8sä¸­VPC-NAT-GWå…¬ç½‘IPæ— æ³•è®¿é—®çš„æ’éšœè¿‡ç¨‹","url":"/2025/05/15/K8sä¸­VPC-NAT-GWå…¬ç½‘IPæ— æ³•è®¿é—®çš„æ’éšœè¿‡ç¨‹/","content":"\n> æµ‹è¯•å›¢é˜Ÿå‘ç°åœ¨æŸä¸ªç¯å¢ƒä¸­ï¼Œå‘ç°å…¬ç½‘ipæ— æ³•æ­£å¸¸ä½¿ç”¨\n\n# æ’æŸ¥\n\nè¯¥k8sä¸­ä½¿ç”¨kube-ovnä½œä¸ºcniï¼Œå¹¶ä¸”å¯¹ç‰¹å®šçš„vpcä½¿ç”¨é›†ä¸­å¼ç½‘å…³ï¼Œè¯¥é—®é¢˜å°±æ˜¯å‡ºç°åœ¨æŸä¸ªvpcçš„ç½‘å…³ä¸­\n\n[VPC å…¥é—¨ - Kube-OVN æ–‡æ¡£](https://kubeovn.github.io/docs/v1.13.x/vpc/vpc/#vpc_2)\n\nè¿›å…¥å¯¹åº”çš„vpc-nat-gwçš„podï¼ŒæŸ¥çœ‹ä¿¡æ¯æ˜¯å¦æ­£å¸¸\n\næŸ¥çœ‹ç½‘å¡ä¿¡æ¯\n\n![ip-a](./ip-a.png)\n\næŸ¥çœ‹iptableé…ç½®\n\n![ip-a](./iptable-legacy-save.jpg)\n\næŸ¥çœ‹è·¯ç”±é…ç½®\n\n![ip-r](./ip-r.jpg)\n\nä¸Šè¿°éƒ½æ²¡æœ‰é—®é¢˜ï¼Œå¼€å§‹ä½¿ç”¨tcpdumpè¿›è¡ŒæŠ“åŒ…\n\n![ip-r](./tcpdump.jpg)\n\nå¯ç”¨çœ‹åˆ°æœ‰æµé‡ä»eth0è¿‡æ¥ï¼ˆåœ¨å¯¹åº”vpcä¸Šå¯¹åº”çš„subnetçš„åº”ç”¨ä¸Šé¢ping 119.29.29.29ï¼‰\n\nä¹Ÿæœ‰xxx.xxx.255.5çš„æµé‡è¿‡æ¥ï¼ˆæœ¬åœ°pingå¯¹åº”çš„å…¬ç½‘ipï¼‰\n\nä¸Šè¿°è¯´æ˜åº”ç”¨æµé‡å’Œå…¬ç½‘æµé‡å¯ä»¥æ­£å¸¸è¾¾åˆ°vpc-nat-gw\n\nä½†æ˜¯æœ‰ä¸ªé—®é¢˜ï¼ŒæŒ‰ç…§iptablesçš„é…ç½®æ¥è¯´ï¼Œ10.0.4.10çš„æµé‡åº”è¯¥å›ç»è¿‡snatå˜æˆå…¬ç½‘ip(xxx.xxx.xxx.71)ï¼Œç„¶åä»net1ä¸­æµå‡ºï¼ŒåŒç†å…¬ç½‘ip(xxx.xxx.xxx.71)ä¹Ÿåº”è¯¥ä¹Ÿè¦å˜æˆ10.0.4.10ä»eth0ä¸­æµå‡º\n\næ‰€ä»¥é—®é¢˜å¯èƒ½å‡ºåœ¨iptableçš„é…ç½®ä¸­\n\n```bash\n# æŸ¥çœ‹POSTROUTINGå’ŒPREROUTINGçš„è§„åˆ™ï¼Œçœ‹çœ‹æ˜¯å¦æœ‰è§„åˆ™å†²çªï¼Œå¯ä»¥å‘ç°è§„åˆ™æ²¡æœ‰å†²çª\n# iptables-legacy -t nat -L POSTROUTING -n -v \nChain POSTROUTING (policy ACCEPT 835 packets, 38717 bytes)\n pkts bytes target     prot opt in     out     source               destination         \n  0     0   SNAT_FILTER  0    --  *      *       0.0.0.0/0            0.0.0.0/0  \n# iptables-legacy -t nat -L PREROUTING  -n -v \nChain PREROUTING (policy ACCEPT 1189 packets, 60269 bytes)\n pkts bytes target     prot opt in     out     source               destination         \n   0    0   DNAT_FILTER  0    --  *      *       0.0.0.0/0            0.0.0.0/0 \n   \n# æŸ¥çœ‹dnatå’Œsnatçš„è½¬æ¢è®°å½•ï¼Œå‘ç°æ²¡æœ‰è½¬æ¢æ•°æ®\n# iptables-legacy -t nat -L EXCLUSIVE_SNAT -n -v \nChain EXCLUSIVE_SNAT (1 references)\n pkts bytes target     prot opt in     out     source               destination         \n   0  0 \t SNAT       0    --  *      *       10.0.4.10            0.0.0.0/0          to:xxx.xxx.xxx.71\n# iptables-legacy -t nat -L EXCLUSIVE_DNAT -n -v \nChain EXCLUSIVE_DNAT (1 references)\n pkts bytes target     prot opt in     out     source               destination         \n  0 \t0    DNAT       0    --  *      *       0.0.0.0/0           xxx.xxx.xxx.71       to:10.0.4.10\n```\n\næŸ¥çœ‹ipv4çš„è½¬å‘æƒ…å†µï¼Œå‘ç°æ²¡æœ‰å¼€å¯å¯¹äºçš„é…ç½®ï¼Œä½¿ç”¨ sysctl -w net.ipv4.ip_forward=1 ä¸´æ—¶å¼€å¯ï¼Œè®¿é—®å°±æ­£å¸¸äº†\n\n![ip-r](./net.png)\n\n# æ€»ç»“\n\nåé¢å‘ç°æ˜¯å¯¹åº”è¢«è°ƒåº¦åˆ°vpc-nat-gwçš„èŠ‚ç‚¹æ²¡æœ‰é…ç½®ipv4è½¬å‘\n\nå¯èƒ½æ˜¯ä¹‹å‰ä¸´æ—¶é…ç½®äº†ï¼ˆ sysctl -w net.ipv4.ip_forward=1 ï¼‰ï¼Œåé¢è¢«é‡ç½®äº†\n\nåç»­é€šè¿‡ç¼–è¾‘ /etc/sysctl.conf æ·»åŠ  net.ipv4.ip_forward=1è¿›è¡Œæ°¸ä¹…é…ç½®","tags":["æ’éšœ","k8s","kube-ovn"]},{"title":"MTUè®¾ç½®ä¸å½“å¯¼è‡´è¯·æ±‚å¤±è´¥ï¼šé—®é¢˜åˆ†æä¸è§£å†³æ–¹æ³•","url":"/2025/04/26/MTUè®¾ç½®ä¸å½“å¯¼è‡´è¯·æ±‚å¤±è´¥ï¼šé—®é¢˜åˆ†æä¸è§£å†³æ–¹æ³•/","content":"\n> æœ€è¿‘ï¼Œæˆ‘åœ¨ç³»ç»Ÿä¸­è¶…èåˆçš„è™šæ‹Ÿæœºä¸­å‘ç°ä¸€ä¸ªé—®é¢˜ï¼Œå³è®¿é—®éƒ¨åˆ†æœåŠ¡æ—¶ä¼šå‡ºç°æ— æ³•è®¿é—®çš„é—®é¢˜ã€‚\n\n# ç°è±¡\n\n```shell\n[root@test-mtu ~] curl http://bilibili.com # æ­£å¸¸è®¿é—® \n<!DOCTYPE HTML PUBLIC \"-//IETF//DTD HTML 2.0//EN\">\n<html>\n<head><title>301 Moved Permanently</title></head>\n<body>\n<center><h1>301 Moved Permanently</h1></center>\n<hr/>Powered by Tengine<hr><center>tengine</center>\n</body>\n</html>\n[root@test-mtu ~] curl -v https://bilibili.com  # è®¿é—®å¤±è´¥\n*   Trying 8.134.50.24:443...\n* Connected to baidu.com (8.134.50.24) port 443 (#0)\n* ALPN, offering h2\n* ALPN, offering http/1.1\n*  CAfile: /etc/pki/tls/certs/ca-bundle.crt\n* TLSv1.0 (OUT), TLS header, Certificate Status (22):\n* TLSv1.3 (OUT), TLS handshake, Client hello (1):\n* OpenSSL SSL_connect: Connection reset by peer in connection to bilibili.com:443 \n* Closing connection 0\ncurl: (35) OpenSSL SSL_connect: Connection reset by peer in connection to bilibili.com:443 \n```\n\nç®€å•æ€»ç»“ä¸ºï¼š\n\nping æˆ–è€… curl bilibili.comã€baidu.comè¿™äº›æ˜¯æ²¡æœ‰é—®é¢˜çš„\n\nä½†æ˜¯ç”¨scpã€rysncã€è®¿é—®httpsæœåŠ¡å°±ä¼šå­˜åœ¨è®¿é—®ä¸é€šçš„é—®é¢˜\n\n# æ’æŸ¥\n\nä½¿ç”¨curlå‘½ä»¤è®¿é—® `http://bilibili.com`å’Œ`https://bilibili.com`\n\nå¹¶ä¸”ä½¿ç”¨tcpdumpè¿›è¡ŒæŠ“åŒ…\n\n`tcpdump -nne -w ./cap -i eth0 host bilibili.com`\n\nåé¢ä½¿ç”¨wiresharkè¿›è¡Œåˆ†æ\n\n![cap-mtu](.\\cap_mtu_1.png)\n\nå¯ä»¥çœ‹åˆ°ä¸Šé¢çš„1-10æ˜¯æ­£å¸¸çš„httpï¼Œ11-21æ˜¯å‡ºç°é”™è¯¯çš„httpsè¯·æ±‚\n\næ³¨æ„é‡Œé¢çš„ç¬¬16ä¸ªåŒ…ï¼Œä¿¡æ¯ä¸º `[TCP Previous segment not captured] ` è¡¨ç¤ºå‰ä¸€ä¸ªtcpåŒ…çš„æ•°æ®æ²¡æœ‰è¢«æ•è·ï¼Œè¯´æ˜å¯ä»¥å‰ä¸€ä¸ªæ•°æ®åŒ…ä¸¢å¤±äº†æˆ–è€…tcpdumpæ²¡æœ‰æ•è·åˆ°å¯¹åº”çš„tcpåŒ…ï¼Œä½†æ˜¯åè€…åº”è¯¥ä¸å¯èƒ½ï¼Œé¦–å…ˆåœ¨ä¸Šé¢çš„httpè¯·æ±‚ä¸­tcpdumpå®Œæ•´åœ°æ•è·åˆ°äº†æ‰€æœ‰çš„tcpåŒ…ï¼Œç„¶åcurl `https`è¯·æ±‚æ—¶ç¡®å®ä¼šå‡ºç°è®¿é—®å¤±è´¥çš„é—®é¢˜ï¼Œæ‰€ä»¥å¯ä»¥æ–­å®šæ˜¯tcpæ•°æ®åŒ…å­˜åœ¨ä¸¢å¤±çš„é—®é¢˜ã€‚\n\nåŒæ—¶å› ä¸º16ã€17çš„åŒ…å‡ºç°é—®é¢˜ï¼Œç³»ç»Ÿæ²¡æœ‰æ”¶åˆ°TLSæ¡æ‰‹æ—¶çš„ `server hello` ï¼Œä»¥ä¸ºç¬¬13ä¸ªåŒ…å‘é€å¤±è´¥ï¼Œåœ¨ç¬¬18ã€19ä¸ªåŒ…å°±æ˜¯é‡æ–°å‘é€äº†`[TCP Dup ACK 13#1]` \n\nTLSæ¡æ‰‹æµç¨‹å¦‚ä¸‹ï¼Œåœ¨å®¢æˆ·ç«¯å‘é€ `Client Hello` åï¼ŒæœåŠ¡å™¨åº”è¯¥è¿”å›`Server Hello `å’Œå¯¹åº”çš„è¯ä¹¦ä¿¡æ¯\n\n![tls](.\\tls_handle_share.gif)\n\n# ä¿®å¤\n\nåç»­å‘ç°æ—¶ç½‘å¡çš„mtué…ç½®é”™è¯¯äº†ï¼Œè¯¥è™šæ‹Ÿæœºçš„é»˜è®¤é…ç½®ä¸º 8950 ï¼Œåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œåº”è¯¥è¦é…ç½®è·Ÿè·¯ç”±å™¨ä¸€è‡´çš„mtuå€¼\n\nä½¿ç”¨è¯¥å‘½ä»¤æ¥ç¡®è®¤å¯¹åº”ç½‘å…³çš„mtuå€¼\n\n```shell\n[root@test-mtu ~] ping -M do -S mtuå€¼ ç½‘å…³ip\n```\n\nåç»­æŠŠmtuä¿®æ”¹ä¸º1450ï¼ˆè·Ÿæˆ‘çš„è·¯ç”±å™¨ä¸€è‡´æ—¶ï¼‰ï¼Œè¯¥é—®é¢˜å°±è§£å†³äº†ï¼Œå¯ä»¥æ­£å¸¸è®¿é—®æœåŠ¡\n\n# æ€»ç»“\n\næˆ‘åœ¨æŸ¥çœ‹ç¬¬16ä¸ªåŒ…æ—¶ï¼Œå‘ç°å®ƒçš„ackä¸º518ï¼Œåˆšå¥½è·Ÿç¬¬14ä¸ªåŒ…(Client Hello)çš„ç¡®è®¤è¦æ±‚ä¸€è‡´`(ack=1+tcp.len=517=518)`ï¼Œå¹¶ä¸”åœ¨å®¢æˆ·ç«¯å‘é€çš„SYNåŒ…çš„MSSä¸º8910ï¼Œæ‰€ä»¥æ„Ÿè§‰å°±æ˜¯MTUçš„é…ç½®å¯¼è‡´ç³»ç»Ÿä»¥ä¸ºè¯¥åŒ…æ˜¯å­˜åœ¨é”™è¯¯çš„\n\n> MSS æ˜¯ [TCP åè®®](https://zhida.zhihu.com/search?content_id=251059409&content_type=Article&match_order=1&q=TCP+åè®®&zhida_source=entity)ä¸­çš„ä¸€ä¸ªæ¦‚å¿µï¼Œå®ƒè¡¨ç¤º TCP æ•°æ®åŒ…æ¯æ¬¡èƒ½å¤Ÿä¼ è¾“çš„æœ€å¤§æ•°æ®é‡ã€‚MSS æ˜¯åœ¨å»ºç«‹ TCP è¿æ¥æ—¶åå•†ç¡®å®šçš„ï¼Œå®ƒçš„å€¼é€šå¸¸è¦å°äº MTUã€‚å› ä¸º TCP æ•°æ®åŒ…åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­éœ€è¦æ·»åŠ  TCP å¤´éƒ¨å’Œ [IP å¤´éƒ¨](https://zhida.zhihu.com/search?content_id=251059409&content_type=Article&match_order=1&q=IP+å¤´éƒ¨&zhida_source=entity)ï¼Œæ‰€ä»¥ MSS = MTU - IP å¤´éƒ¨å¤§å° - TCP å¤´éƒ¨å¤§å°ã€‚ä¾‹å¦‚ï¼Œåœ¨ä»¥å¤ªç½‘ä¸­ MTU ä¸º 1500 å­—èŠ‚ï¼ŒIP å¤´éƒ¨é€šå¸¸æ˜¯ 20 å­—èŠ‚ï¼ŒTCP å¤´éƒ¨é€šå¸¸æ˜¯ 20 å­—èŠ‚ï¼Œé‚£ä¹ˆ MSS = 1500 - 20 - 20 =1460 å­—èŠ‚ã€‚","tags":["æ’éšœ","mtu"]},{"title":"casdooræœåŠ¡å¯åŠ¨å´æ— æ³•è®¿é—®æ’éšœ","url":"/2025/04/03/casdooræœåŠ¡å¯åŠ¨å´æ— æ³•è®¿é—®æ’éšœ/","content":"\n> æœ€è¿‘ï¼Œæˆ‘ä»¬å›¢é˜Ÿåœ¨ç”Ÿäº§ç¯å¢ƒä¸­é‡åˆ°äº†ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯casdooræœåŠ¡é‡å¯åï¼Œæ—¥å¿—ä¹Ÿæ˜¾ç¤ºå‡ºæ¥äº†ï¼Œä½†æ˜¯å°±æ˜¯æ— æ³•è®¿é—®ï¼Œä½¿ç”¨curlåœ¨æœ¬åœ°è®¿é—®ä¹Ÿæ˜¯ä¸é€šã€‚\n\næ—¥å¿—ï¼š\n\n![log](./casdoor-log.png)\n\né¦–å…ˆå…ˆç®€ç»ä¸€ä¸‹casdooræ˜¯ä»€ä¹ˆ[æ¦‚è¿° | Casdoor Â· An open-source UI-first Identity and Access Management (IAM) / Single-Sign-On (SSO) platform with web UI supporting OAuth 2.0, OIDC, SAML, CAS, LDAP, SCIM, WebAuthn, TOTP, MFA, RADIUS, Google Workspace, Active Directory and Kerberos](https://casdoor.org/zh/docs/overview)\n\nç®€å•ç‚¹ç†è§£å°±æ˜¯å®ƒæ˜¯ä¸€ä¸ªå®ç°äº†`OAuth 2.0`è®¤è¯çš„ä¸€ä¸ªæœåŠ¡ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨å®ƒæ¥å®Œæˆä¸€ä¸ªè´¦å·å¯¹å¤šä¸ªåº”ç”¨è¿›è¡Œæ— æ„Ÿç™»å½•ï¼ŒåŒæ—¶å¯ä»¥æŠŠç”¨æˆ·æ•°æ®æ”¾åˆ°`casdoor`ä¸­ï¼Œå…¶å®ƒåº”ç”¨çš„æ•°æ®åº“å¯ä»¥åªç”¨æ¥å­˜æ”¾ä¸šåŠ¡æ•°æ®ã€‚\n\n# ç¯å¢ƒ\n\næ ¹æ®ç›¸å…³åŒå­¦çš„æè¿°ï¼Œç”Ÿäº§ç¯å¢ƒçš„`casdoor`ç¯å¢ƒå¦‚ä¸‹ã€‚\n\n- 3å°æœåŠ¡å™¨ä½¿ç”¨`docker`æˆ–`podman`å¯åŠ¨äº†ä¸€ä¸ª`casdoor`æœåŠ¡ï¼Œå®ç°é«˜å¯ç”¨\n- 3å°æœåŠ¡å™¨åŒæ—¶ä½¿ç”¨åŒä¸€ä¸ªæ•°æ®åº“(`mysql`)\n- ä½¿ç”¨nfsæ¥åŒæ­¥`casdoor`ä¸­çš„`tmp`æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶ä¸º`casdoor`çš„é»˜è®¤`session`ä¿å­˜ä½ç½®\n   - [sessioné…ç½®çš„ç›¸å…³æ–‡æ¡£](https://casdoor.org/zh/docs/basic/server-installation/#%E9%80%9A%E8%BF%87-ini-%E6%96%87%E4%BB%B6%E9%85%8D%E7%BD%AE:~:text=redisEndpoint%20%E5%90%8E%E5%A1%AB%E5%86%99,provider%2Dconfig%E3%80%82)\n   - å½“æ—¶è¯¥ tmp æ–‡ä»¶å¤§å°è‡³å°‘æœ‰40Gï¼Œä½†æ˜¯æˆ‘ä»¬ç¯å¢ƒå½“å‰çš„ç”¨æˆ·æ•°é‡ä¸è‡³äºä¼šæœ‰è¿™ä¹ˆå¤šçš„`session`ç¼“å­˜\n   - `nfs`å¯¹åº”æŒ‚è½½æœåŠ¡çš„è¿›ç¨‹å ç”¨è¿‡é«˜çš„`cpu`\n- `casdoor`çš„ç‰ˆæœ¬ä¸º1.814ï¼Œå…¶ä¸­çš„`beego`ç‰ˆæœ¬ä¸º1.12.3\n\n# æ’æŸ¥\n\nåç»­çš„æ’æŸ¥ç¯å¢ƒæ˜¯åœ¨æµ‹è¯•ç¯å¢ƒä¸­æ­å»ºçš„ï¼Œå¹¶ä¸”å¤åˆ»äº†å¯¹åº”çš„é—®é¢˜ã€‚ç¯å¢ƒå¦‚ä¸‹\n\n- ä½¿ç”¨`dcoker-compose`å¯åŠ¨äº†3ä¸ª`casdoor`å’Œä¸€ä¸ª`mysql`\n- å®¿ä¸»æœºçš„`8001`,`8002`,`8003`åˆ†åˆ«æ˜ å°„3ä¸ª`casdoor`çš„8000ç«¯å£\n- ä½¿ç”¨äº† docker çš„æŒ‚è½½æŠŠtmpæ–‡ä»¶åŒæ—¶æŒ‚è½½åˆ°äº†æ¯ä¸ª`casdoor`çš„ç›®å½•ï¼ˆæ¨¡æ‹Ÿ`nfs`ï¼‰\n- `tmp`çš„æ–‡ä»¶å¤§å°ä¸º`31G`\n\n## ç«¯å£è½¬å‘\n\nå› ä¸ºæœåŠ¡æ˜¯ä½¿ç”¨dockerå¯åŠ¨çš„ï¼Œå¹¶ä¸”ä½¿ç”¨çš„ç½‘ç»œæ¨¡å¼ä¸º`Bridge`ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆæ’æŸ¥`docker`ç½‘ç»œç›¸å…³çš„é—®é¢˜ã€‚\n\nå…ˆ `curl` `docker`çš„ç½‘å¡(`docker0`)çš„`ip`åœ°å€ï¼Œä½†æ˜¯è¿˜æ˜¯ `curl` ä¸é€šç›¸å…³æœåŠ¡ã€‚\n\n```shell\n[root@rocky-testing casdoor]# ss -anpl | grep 8001 # æŸ¥çœ‹ç«¯å£ç›‘å¬æƒ…å†µ\ntcp   LISTEN 0      4096  0.0.0.0:8001             0.0.0.0:*    users:((\"docker-proxy\",pid=1456272,fd=7)) \ntcp   LISTEN 0      4096 [::]:8001                [::]:*    users:((\"docker-proxy\",pid=1456280,fd=7))     \n[root@rocky-testing casdoor]# ifconfig docker0 #è·å–dockerçš„ç½‘å¡\ndocker0: flags=4099<UP,BROADCAST,MULTICAST>  mtu 1500\n        inet 172.17.0.1  netmask 255.255.0.0  broadcast 172.17.255.255\n        inet6 fe80::1469:daff:febf:1315  prefixlen 64  scopeid 0x20<link>\n        ether 16:69:da:bf:13:15  txqueuelen 0  (Ethernet)\n        RX packets 32519  bytes 2160933 (2.0 MiB)\n        RX errors 0  dropped 0  overruns 0  frame 0\n        TX packets 37734  bytes 94754551 (90.3 MiB)\n        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0\n\n[root@rocky-testing casdoor]# curl 172.17.0.1:8001 # curl å¯¹åº”çš„ç½‘å¡ip 8001ä¸ºcasdoorå¯åŠ¨çš„ç«¯å£\n```\n\nä½¿ç”¨`nsenter ` è¿›å…¥å¯¹åº”æœåŠ¡çš„`network ns`ï¼Œå¹¶å°è¯•`curl`è®¿é—®æœåŠ¡ï¼Œä½†è¿˜æ˜¯æ— æ³•è®¿é—®\n\n```shell\n[root@rocky-testing casdoor]# docker compose top casdoor-1 # è·å–åº”ç”¨çš„pid\nWARN[0000] /root/test/casdoor/docker-compose.yaml: the attribute `version` is obsolete, it will be ignored, please remove it to avoid potential confusion \ncasdoor-1\nUID    PID       PPID      C    STIME   TTY   TIME       CMD\n1000   1456231   1456210   4    14:58   ?     00:01:21   /server   \n[root@rocky-testing casdoor]# nsenter -n --target 1456231 # è¿›å…¥å¯¹åº”çš„ ns\n[root@rocky-testing casdoor]# ip link # æŸ¥çœ‹ç½‘å¡ï¼Œè·Ÿå®¿ä¸»æœºçš„ç½‘å¡ä¸ä¸€è‡´ï¼Œåªå‰©ä¸‹loå’Œeth0ç½‘å¡ï¼Œè¯´æ˜è¿›å…¥äº†å®¹å™¨çš„nsä¸­\n1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n2: eth0@if898: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP mode DEFAULT group default \n    link/ether 82:2e:b0:c9:cc:00 brd ff:ff:ff:ff:ff:ff link-netnsid 0\n[root@rocky-testing casdoor]# ss -anlp | grep 8000 # æŸ¥çœ‹ç«¯å£å ç”¨ï¼Œç¡®å®æœåŠ¡å·²ç»å¯åŠ¨ \ntcp   LISTEN 0      4096               *:8000               *:*    users:((\"server\",pid=1456231,fd=13))\n[root@rocky-testing casdoor]# curl 0.0.0.0:8000 # æ— æ³•curlé€šæœåŠ¡\n[root@rocky-testing casdoor]# exit # é€€å‡ºå¯¹åº”ns\nlogout\n```\n\n## strace\\pstackæŸ¥çœ‹ç³»ç»Ÿè°ƒç”¨\n\nåœ¨ä¸Šè¿°çš„ä¸¤æ­¥æ“ä½œåï¼Œè¿˜æ˜¯`curl`ä¸é€šï¼Œè¯´æ˜æœåŠ¡è™½ç„¶æ—¥å¿—å·²ç»æ‰“å°äº†ï¼Œä½†æ˜¯æœåŠ¡è¿˜æœªå¯ç”¨ã€‚\n\nä½¿ç”¨`strace`å’Œ`pstack`å‘½ä»¤æŸ¥çœ‹å¯¹åº”åº”ç”¨çš„ç³»ç»Ÿè°ƒç”¨ï¼ŒæŸ¥çœ‹casdoorçš„å¯åŠ¨åçš„è¡Œä¸º\n\n```shell\nstrace -p 1456231 -f -o ./strace-casdoor-1.log \npstack 1456231 > ./pstack-casdoor-1.log\n```\n\næŸ¥çœ‹å…¶æ—¥å¿—ï¼Œä»¥ä¸‹æ—¥å¿—å†…å®¹ä¸ºç”Ÿäº§ç¯å¢ƒä¸­è·å–çš„`strace`å’Œ`pstack`æ—¥å¿—\n\n```log\n# åˆ†æstraceçš„æ—¥å¿—ï¼Œå‘ç°ç¨‹åºæ˜¯æœ‰è§„å¾‹çš„æ‰§è¡Œä»¥ä¸‹ç³»ç»Ÿè°ƒç”¨\n... éƒ½æ˜¯nanosleep({tv_sec=0, tv_nsec=20000}, NULL) = 0 çš„è°ƒç”¨\n1146720 nanosleep({tv_sec=0, tv_nsec=20000}, NULL) = 0\n1146720 futex(0x45252c0, FUTEX_WAIT_PRIVATE, 0, {tv_sec=0, tv_nsec=103439635} <unfinished ...>\n1146729 <... newfstatat resumed>{st_mode=S_IFREG|0644, st_size=20, ...}, AT_SYMLINK_NOFOLLOW) = 0\n1146729 --- SIGURG {si_signo=SIGURG, si_code=SI_TKILL, si_pid=1, si_uid=1000} ---\n1146729 rt_sigreturn({mask=[]})         = 0\n1146729 futex(0x45252c0, FUTEX_WAKE_PRIVATE, 1) = 1\n1146720 <... futex resumed>)            = 0\n1146729 newfstatat(AT_FDCWD, \"tmp/0/0/001575f66990e62d6ed701f24599e1ca\",  <unfinished ...>\n1146720 nanosleep({tv_sec=0, tv_nsec=20000}, NULL) = 0\n1146720 futex(0x45252c0, FUTEX_WAIT_PRIVATE, 0, {tv_sec=0, tv_nsec=43396353} <unfinished ...>\n1146704 <... epoll_pwait resumed>[], 128, 998, NULL, 0) = 0\n1146704 epoll_pwait(4, [], 128, 0, NULL, 0) = 0\n1146704 epoll_pwait(4,  <unfinished ...>\n1146720 <... futex resumed>)            = -1 ETIMEDOUT (Connection timed out)\n1146720 nanosleep({tv_sec=0, tv_nsec=20000}, NULL) = 0\n... éƒ½æ˜¯nanosleep({tv_sec=0, tv_nsec=20000}, NULL) = 0 çš„è°ƒç”¨\n# åˆ†æpstackæ—¥å¿—ï¼Œç¨‹åºä¹Ÿæ˜¯ä¸åœåœ°æ‰§è¡Œä»¥ä¸‹æ–¹æ³•\n 37028.625 (47.259 ms): server/1146720  ... [continued]: futex())                                            = 0\n 37075.871 (         ): server/1146729 newfstatat(dfd: CWD, filename: 0xb77bf0, statbuf: 0xc000adced8, flag: SYMLINK_NOFOLLOW) ...\n 37075.900 ( 0.058 ms): server/1146720 nanosleep(rqtp: 0xc00008ff10)                                         = 0\n 37075.871 (62.859 ms): server/1146729  ... [continued]: newfstatat())                                       = 0\n 37075.965 (         ): server/1146720 futex(uaddr: 0x45252c0, op: WAIT|PRIVATE_FLAG, utime: 0xc00008feb0) ...\n 37138.754 ( 0.012 ms): server/1146729 futex(uaddr: 0x45252c0, op: WAKE|PRIVATE_FLAG, val: 1)                = 1\n 37075.965 (62.898 ms): server/1146720  ... [continued]: futex())                                            = 0\n 37138.781 (         ): server/1146729 newfstatat(dfd: CWD, filename: 0xb77c50, statbuf: 0xc000adcfa8, flag: SYMLINK_NOFOLLOW) ...\n 37138.881 ( 0.067 ms): server/1146720 nanosleep(rqtp: 0xc00008ff10)                                         = 0\n 37138.954 (25.650 ms): server/1146720 futex(uaddr: 0x45252c0, op: WAIT|PRIVATE_FLAG, utime: 0xc00008feb0)   = -1 ETIMEDOUT (Connection timed out)\n 37164.628 ( 0.088 ms): server/1146720 nanosleep(rqtp: 0xc00008ff10)                                         = 0\n 37164.724 ( 0.110 ms): server/1146720 nanosleep(rqtp: 0xc00008ff10)                                         = 0\n 37164.845 ( 0.085 ms): server/1146720 nanosleep(rqtp: 0xc00008ff10)                                         = 0\n```\n\né€šè¿‡ä¸Šè¿°çš„åˆ†æï¼Œå¯ä»¥å‘ç°`casdoor`ç¨‹åºåœ¨å¯åŠ¨åï¼Œä¸€ç›´è¯»å–`tmp`ç›®å½•ä¸‹çš„æ–‡ä»¶ä¿¡æ¯(å¹¶ä¸”å…¶ä¸­è¿˜æœ‰ä¸€ä¸ªé”)ï¼Œç»“åˆå‰é¢çš„ä¿¡æ¯å¯ä»¥å¾—å‡º`casdoor`åœ¨å¯åŠ¨çš„æ—¶å€™ä¼šä¸€ç›´è¯»å–`tmp`é‡Œé¢çš„`session`ä¿¡æ¯ï¼Œå¯¼è‡´`nfs`çš„è¿›ç¨‹çš„`cpu`ä½¿ç”¨ç‡è¿‡é«˜ã€‚\n\næ‰€ä»¥åé¢åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æŠŠ`nfs`çš„æŒ‚è½½ç»™å–æ¶ˆäº†(`tmp`ä¸­çš„`session`æ–‡ä»¶å°±ä¼šè¢«æ¸…ç©ºï¼Œå˜æˆä¸€ä¸ªç©ºæ–‡ä»¶å¤¹)ï¼Œåé¢å†å¯åŠ¨ï¼Œå°±å¯ä»¥æ­£å¸¸è®¿é—®æœåŠ¡äº†ï¼Œåç»­å¯èƒ½ä¼šè€ƒè™‘æŠŠ`session`æ”¾åˆ°`redis`ä¸­è¿›è¡Œå¤„ç†ã€‚\n\n# é—®é¢˜ğŸ¤”\n\nè™½ç„¶æœåŠ¡å¯ä»¥å¯åŠ¨äº†ä½†æ˜¯ç•™ä¸‹äº†3ä¸ªé—®é¢˜ï¼š\n\n- **ä¸ºä»€ä¹ˆcasdoorå¯åŠ¨çš„æ—¶å€™è¦å»è®¿é—®sessionæ–‡ä»¶(tmpç›®å½•ä¸‹çš„æ–‡ä»¶)**\n- **ä¸ºä»€ä¹ˆcasdoorçš„æ—¥å¿—éƒ½æ˜¾ç¤ºæœåŠ¡çš„ç«¯å£å·²ç»ç›‘å¬äº†ï¼Œä½†æ˜¯curlè¯¥æœåŠ¡è¿˜æ˜¯ä¸èƒ½é©¬ä¸Šè¿”å›è¯·æ±‚**\n- **åŒå­¦åæ˜ è¯¥tmpæ–‡ä»¶ä¹‹å‰å·²ç»æ¸…ç†è¿‡ä¸€æ¬¡äº†ï¼Œä½†æ˜¯ä¸€å¤©å·¦å³ç£ç›˜å ç”¨ç‡åˆä¸Šæ¥äº†è¿™æ˜¯ä¸ºä»€ä¹ˆ**\n\né’ˆå¯¹ä¸Šé¢çš„3ä¸ªé—®é¢˜ï¼Œæˆ‘é€‰æ‹© `æºç ` å¯åŠ¨ğŸ‘€\n\n## ä¸ºä»€ä¹ˆcasdoorå¯åŠ¨æ—¶è¦å»è®¿é—®sessionæ–‡ä»¶\n\nä¸ºä»€ä¹ˆcasdoorå¯åŠ¨è¦å»è®¿é—®sessionæ–‡ä»¶\n\né¦–å…ˆæ‰¾åˆ°å¯¹åº”çš„[github.dev/casdoor/casdoor/tree/v1.814.0](https://github.dev/casdoor/casdoor/tree/v1.814.0)ç‰ˆæœ¬ï¼ŒæŸ¥çœ‹å…¶`main.go`\n\n```go\nhttps://github.dev/casdoor/casdoor/blob/a5a627f92efd3cc3f3613ca119b340b66258ce64/main.go#L65-L95\n\t....\n\tbeego.BConfig.WebConfig.Session.SessionOn = true\n\tbeego.BConfig.WebConfig.Session.SessionName = \"casdoor_session_id\"\n\tif conf.GetConfigString(\"redisEndpoint\") == \"\" {\n\t\tbeego.BConfig.WebConfig.Session.SessionProvider = \"file\"\n\t\tbeego.BConfig.WebConfig.Session.SessionProviderConfig = \"./tmp\"\n\t} else {\n\t\tbeego.BConfig.WebConfig.Session.SessionProvider = \"redis\"\n\t\tbeego.BConfig.WebConfig.Session.SessionProviderConfig = conf.GetConfigString(\"redisEndpoint\")\n\t}\n\tbeego.BConfig.WebConfig.Session.SessionCookieLifeTime = 3600 * 24 * 30 //30å¤©çš„ç¼“å­˜æ—¶é—´\n\tbeego.BConfig.WebConfig.Session.SessionGCMaxLifetime = 3600 * 24 * 30 //30å¤©çš„ç¼“å­˜æ—¶é—´\n\t// beego.BConfig.WebConfig.Session.SessionCookieSameSite = http.SameSiteNoneMode\n\n\terr := logs.SetLogger(logs.AdapterFile, conf.GetConfigString(\"logConfig\"))\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\tport := beego.AppConfig.DefaultInt(\"httpport\", 8000)\n\t// logs.SetLevel(logs.LevelInformational)\n\tlogs.SetLogFuncCall(false)\n\n\terr = util.StopOldInstance(port)\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\n\tgo ldap.StartLdapServer()\n\tgo radius.StartRadiusServer()\n\tgo object.ClearThroughputPerSecond()\n\n\tbeego.Run(fmt.Sprintf(\":%v\", port))\n```\n\nåœ¨ä¸Šé¢çš„ä»£ç é‡Œé¢ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°é»˜è®¤æƒ…å†µä¸‹`casdoor`ä½¿ç”¨äº†`SessionProvider`ä¸º`file`ï¼Œå¹¶ä¸”ç›®å½•é…ç½®åˆ°äº†`./tmp`ä¸‹é¢ï¼Œåé¢å¯åŠ¨çš„å°±æ˜¯`beego`çš„æœåŠ¡äº†ï¼Œæ‰€ä»¥åé¢æŸ¥çœ‹çš„æ˜¯å¯¹åº”ç‰ˆæœ¬[beego](https://github.dev/beego/beego/tree/v1.12.11)çš„æºç ã€‚\n\né¦–å…ˆä»`beego.go`å¼€å§‹å¯åŠ¨æœåŠ¡\n\n```go\nhttps://github.com/beego/beego/blob/c280209bf5b94cf31094a200b166c97eb3898851/beego.go#L51-L73\n// Run beego application.\n// beego.Run() default run on HttpPort\n// beego.Run(\"localhost\")\n// beego.Run(\":8089\")\n// beego.Run(\"127.0.0.1:8089\")\nfunc Run(params ...string) {\n\tinitBeforeHTTPRun() //è¿™é‡Œå†ç¨‹åºå¯åŠ¨å‰ï¼Œè°ƒç”¨äº†initBeforeHTTPRunè¿™ä¸ªæ–¹æ³•\n\tif len(params) > 0 && params[0] != \"\" {\n\t\tstrs := strings.Split(params[0], \":\")\n\t\tif len(strs) > 0 && strs[0] != \"\" {\n\t\t\tBConfig.Listen.HTTPAddr = strs[0]\n\t\t}\n\t\tif len(strs) > 1 && strs[1] != \"\" {\n\t\t\tBConfig.Listen.HTTPPort, _ = strconv.Atoi(strs[1])\n\t\t}\n\n\t\tBConfig.Listen.Domains = params\n\t}\n\n\tBeeApp.Run()\n}\n....\nhttps://github.com/beego/beego/blob/c280209bf5b94cf31094a200b166c97eb3898851/beego.go#L91-L107\nfunc initBeforeHTTPRun() {\n\t//init hooks åœ¨è¿™ä¸ªæ–¹æ³•ä¸­æ³¨å†Œäº†SessionæœåŠ¡\n\tAddAPPStartHook(\n\t\tregisterMime,\n\t\tregisterDefaultErrorHandler,\n\t\tregisterSession,\n\t\tregisterTemplate,\n\t\tregisterAdmin,\n\t\tregisterGzip,\n\t)\n\n\tfor _, hk := range hooks {\n\t\tif err := hk(); err != nil { //åœ¨è¿™é‡Œæ‰§è¡Œäº†æ³¨å†Œçš„sessionæœåŠ¡\n\t\t\tpanic(err)\n\t\t}\n\t}\n}\n```\n\næŸ¥çœ‹å¯¹åº”çš„`registerSession`çš„ä»£ç å®ç°ï¼Œåœ¨`hook.go`ä¸­\n\n```go\nhttps://github.com/beego/beego/blob/c280209bf5b94cf31094a200b166c97eb3898851/hooks.go#L47-L76\nfunc registerSession() error {\n\tif BConfig.WebConfig.Session.SessionOn {\n\t\tvar err error\n\t\tsessionConfig := AppConfig.String(\"sessionConfig\")\n\t\tconf := new(session.ManagerConfig)\n\t\tif sessionConfig == \"\" {\n\t\t\t....\n            conf.Gclifetime = BConfig.WebConfig.Session.SessionGCMaxLifetime //å®šä¹‰äº†sessionçš„å­˜æ´»æ—¶é—´\n\t\t\tconf.ProviderConfig = filepath.ToSlash(BConfig.WebConfig.Session.SessionProviderConfig) //åœ¨è¿™é‡Œtmpçš„é…ç½®å˜æˆäº†æ–‡ä»¶è·¯å¾„é…ç½®\n\t\t\t....\n\t\t} else {\n\t\t\tif err = json.Unmarshal([]byte(sessionConfig), conf); err != nil {\n\t\t\t\treturn err\n\t\t\t}\n\t\t}\n\t\tif GlobalSessions, err = session.NewManager(BConfig.WebConfig.Session.SessionProvider, conf); err != nil {\n\t\t\treturn err\n\t\t}\n\t\tgo GlobalSessions.GC() //è¿™é‡Œä½¿ç”¨äº†GOåç¨‹å¯åŠ¨äº†ä¸€ä¸ªCGæœåŠ¡ï¼Œè¯¥æ“ä½œä¸ä¼šé˜»å¡ä¸»åç¨‹\n\t}\n\treturn nil\n}\n```\n\nè¿›å…¥`GlobalSessions.GC() `å‡½æ•°æŸ¥çœ‹å¯¹åº”å®ç°ï¼Œåœ¨`session.go`ä¸­\n\n```go\nhttps://github.com/beego/beego/blob/c280209bf5b94cf31094a200b166c97eb3898851/session/session.go#L290-L295\n// GC Start session gc process.\n// it can do gc in times after gc lifetime.\nfunc (manager *Manager) GC() {\n\tmanager.provider.SessionGC() //å¯åŠ¨æ—¶å…ˆæ‰§è¡Œä¸€æ¬¡SessionCG ç„¶åå†ä½¿ç”¨time.AfterFuncæ¥å®šæ—¶æ‰§è¡Œ\n\ttime.AfterFunc(time.Duration(manager.config.Gclifetime)*time.Second, func() { manager.GC() })\n}\n```\n\nè¿›å…¥`manager.provider.SessionGC() `å‡½æ•°æŸ¥çœ‹å…¶å®ç°ï¼Œå› ä¸ºæˆ‘ä»¬ä½¿ç”¨çš„`sessionProvider`ä¸º`file`ï¼Œæ‰€ä»¥è¦åœ¨`session/sess_file.go`ä¸­æŸ¥çœ‹å…¶å®ç°\n\n```go\n// filepderçš„å®šä¹‰\nhttps://github.com/beego/beego/blob/c280209bf5b94cf31094a200b166c97eb3898851/session/sess_file.go#L30-L33\nvar (\n\tfilepder      = &FileProvider{}\n\tgcmaxlifetime int64\n)\nhttps://github.com/beego/beego/blob/c280209bf5b94cf31094a200b166c97eb3898851/session/sess_file.go#L113-L118\n// FileProvider File session provider\ntype FileProvider struct {\n\tlock        sync.RWMutex\n\tmaxlifetime int64\n\tsavePath    string\n}\nhttps://github.com/beego/beego/blob/c280209bf5b94cf31094a200b166c97eb3898851/session/sess_file.go#L200-L207\n// SessionGC Recycle files in save path\nfunc (fp *FileProvider) SessionGC() {\n\tfilepder.lock.Lock() //è¿™é‡Œå…ˆé”ä½äº†filepder è¿™ä¸ªé”å¾ˆå…³é”®\n\tdefer filepder.lock.Unlock()\n\n\tgcmaxlifetime = fp.maxlifetime //è·å–gcè¶…æ—¶æ—¶é—´\n\tfilepath.Walk(fp.savePath, gcpath) //è¿™é‡Œä½¿ç”¨walkæ¥æµè§ˆsessionæ–‡ä»¶ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œå¹¶ä¸”æ‰§è¡Œgcpathçš„å›è°ƒ\n}\n....\nhttps://github.com/beego/beego/blob/c280209bf5b94cf31094a200b166c97eb3898851/session/sess_file.go#L284-L296\n// remove file in save path if expired\nfunc gcpath(path string, info os.FileInfo, err error) error {\n\tif err != nil {\n\t\treturn err\n\t}\n\tif info.IsDir() {\n\t\treturn nil\n\t}\n\tif (info.ModTime().Unix() + gcmaxlifetime) < time.Now().Unix() {\n\t\tos.Remove(path) //å¦‚æœè¯¥æ–‡ä»¶çš„ä¿®æ”¹æ—¶é—´åŠ ä¸Šè¶…æ—¶æ—¶é—´å¤§äºå½“å‰æ—¶é—´åˆ™è¿›è¡Œåˆ é™¤\n\t}\n\treturn nil\n}\n```\n\nåˆ°æ­¤ç¬¬ä¸€ä¸ªé—®é¢˜å·²ç»è§£å†³äº†ï¼Œå°±æ˜¯å› ä¸º`beego.go`å¯åŠ¨çš„æ—¶å€™ä¼šæ‰§è¡Œsessionçš„GCï¼Œè€Œç¨‹åºé…ç½®ä¸ºåˆ©ç”¨`file`ä¿å­˜`session`ï¼Œæ‰€ä»¥å°±è§£é‡Šäº†ä¸ºä»€ä¹ˆæŸ¥çœ‹`strace`å’Œ`pstack`çš„æ—¥å¿—æ—¶ä¼šæœ‰é”`futex` å’Œæ–‡ä»¶è¯»å–çš„`newfstatat`çš„ç³»ç»Ÿè°ƒç”¨\n\n## ä¸ºä»€ä¹ˆæœåŠ¡æ—¥å¿—éƒ½æ˜¾ç¤ºç«¯å£å·²ç»ç›‘å¬äº†ï¼Œä½†æ˜¯curlè¯¥æœåŠ¡è¿˜æ˜¯ä¸èƒ½é©¬ä¸Šè¿”å›è¯·æ±‚\n\nä¸ºä»€ä¹ˆæ—¥å¿—å·²ç»æ˜¾ç¤ºäº†ç«¯å£ç»‘å®šäº†ï¼Œä½†æ˜¯`curl`å¯¹åº”æœåŠ¡è¿˜æ˜¯ä¸é€š\n\nåœ¨ä¸Šé¢æˆ‘ä»¬å¾—çŸ¥æˆ‘ä»¬çš„æœåŠ¡æ˜¯åœ¨`beego.go`ä¸­å¯åŠ¨çš„ï¼Œæ‰€ä»¥å…ˆæŸ¥çœ‹å…¶æºç \n\n```go\nhttps://github.com/beego/beego/blob/c280209bf5b94cf31094a200b166c97eb3898851/beego.go#L51-L73\n// Run beego application.\n// beego.Run() default run on HttpPort\n// beego.Run(\"localhost\")\n// beego.Run(\":8089\")\n// beego.Run(\"127.0.0.1:8089\")\nfunc Run(params ...string) {\n\tinitBeforeHTTPRun() //è¿™é‡Œå†ç¨‹åºå¯åŠ¨å‰ï¼Œè°ƒç”¨äº†initBeforeHTTPRunè¿™ä¸ªæ–¹æ³•\n\tif len(params) > 0 && params[0] != \"\" {\n\t\tstrs := strings.Split(params[0], \":\")\n\t\tif len(strs) > 0 && strs[0] != \"\" {\n\t\t\tBConfig.Listen.HTTPAddr = strs[0]\n\t\t}\n\t\tif len(strs) > 1 && strs[1] != \"\" {\n\t\t\tBConfig.Listen.HTTPPort, _ = strconv.Atoi(strs[1])\n\t\t}\n\n\t\tBConfig.Listen.Domains = params\n\t}\n\n\tBeeApp.Run() //æ­£å¼å¯åŠ¨æœåŠ¡\n}\n```\n\næˆ‘ä»¬è¿™é‡Œç›´æ¥æŸ¥çœ‹`BeeApp.Run()`çš„å®ç°\n\n```go\nhttps://github.com/beego/beego/blob/c280209bf5b94cf31094a200b166c97eb3898851/app.go#L62-L239\n// Run beego application.\nfunc (app *App) Run(mws ...MiddleWare) {\n\taddr := BConfig.Listen.HTTPAddr\n\n\tif BConfig.Listen.HTTPPort != 0 {\n\t\taddr = fmt.Sprintf(\"%s:%d\", BConfig.Listen.HTTPAddr, BConfig.Listen.HTTPPort)\n\t}\n\tapp.Server.Handler = app.Handlers //è¿™é‡Œçš„app.Handlerså°±æ˜¯å®šä¹‰å¥½çš„è·¯ç”±å’ŒæœåŠ¡ï¼ŒæŠŠå®ƒæ³¨å†Œåˆ°httpæœåŠ¡çš„å›è°ƒé‡Œé¢\n\t// run cgi server\n\tif BConfig.Listen.EnableFcgi {\n\t\t....\n\t}\n\t....\n\t// run graceful mode\n\tif BConfig.Listen.Graceful {\n        ...\n\t}\n\t// run normal mode\n\tif BConfig.Listen.EnableHTTPS || BConfig.Listen.EnableMutualHTTPS {\n\t\t...\n\t}\n\tif BConfig.Listen.EnableHTTP {\n\t\tgo func() {\n\t\t\tapp.Server.Addr = addr\n\t\t\tlogs.Info(\"http server Running on http://%s\", app.Server.Addr) //å¯¹åº”çš„casdooræ—¥å¿—æ‰“å°çš„åœ°æ–¹\n\t\t\tif BConfig.Listen.ListenTCP4 {\n                ...\n\t\t\t} else {\n\t\t\t\tif err := app.Server.ListenAndServe(); err != nil { //æœåŠ¡å¯åŠ¨äº†\n\t\t\t\t\tlogs.Critical(\"ListenAndServe: \", err)\n\t\t\t\t\ttime.Sleep(100 * time.Microsecond)\n\t\t\t\t\tendRunning <- true\n\t\t\t\t}\n\t\t\t}\n\t\t}()\n\t}\n\t<-endRunning\n}\n```\n\né‚£ä¹ˆå½“æœ‰è¯·æ±‚è¿‡æ¥çš„æ—¶å€™ï¼Œå°±ä¼šè°ƒç”¨`app.Handlers`ä¸­çš„`ServeHTTP`æ¥å¤„ç†(å¿…é¡»å®ç°[HandlerFunc](https://cs.opensource.google/go/go/+/go1.24.2:src/net/http/server.go;l=2290) )ï¼Œ`app.Handlers`å°±åœ¨`route.go`é‡Œé¢\n\n```go\nhttps://github.com/beego/beego/blob/c280209bf5b94cf31094a200b166c97eb3898851/router.go#L693-L975\n// Implement http.Handler interface.\nfunc (p *ControllerRegister) ServeHTTP(rw http.ResponseWriter, r *http.Request) {\n\tstartTime := time.Now()\n\t....\n    https://github.com/beego/beego/blob/c280209bf5b94cf31094a200b166c97eb3898851/router.go#L756-L770\n\t// session init åœ¨è¿™é‡Œå°†ä¼šå¤„ç†è¯·æ±‚ä¸­çš„session\n\tif BConfig.WebConfig.Session.SessionOn {\n\t\tvar err error\n\t\tcontext.Input.CruSession, err = GlobalSessions.SessionStart(rw, r) //é€šè¿‡rwå’Œrè·å–å¯¹åº”çš„sessionä¿¡æ¯\n\t\tif err != nil {\n\t\t\tlogs.Error(err)\n\t\t\texception(\"503\", context)\n\t\t\tgoto Admin\n\t\t}\n\t\tdefer func() {\n\t\t\tif context.Input.CruSession != nil {\n\t\t\t\tcontext.Input.CruSession.SessionRelease(rw)\n\t\t\t}\n\t\t}()\n\t}\n\t...\n}\n```\n\n`GlobalSessions.SessionStart`å…¶å®ç°çš„æ–¹æ³•åœ¨`session/session.go`ä¸­\n\n```go\nhttps://github.com/beego/beego/blob/c280209bf5b94cf31094a200b166c97eb3898851/session/session.go#L207-L253\n// SessionStart generate or read the session id from http request.\n// if session id exists, return SessionStore with this id.\nfunc (manager *Manager) SessionStart(w http.ResponseWriter, r *http.Request) (session Store, err error) {\n    sid, errs := manager.getSid(r) // åœ¨è¯·æ±‚ä¸­è·å–sid (sessionId)\n\tif errs != nil {\n\t\treturn nil, errs\n\t}\n\n\tif sid != \"\" && manager.provider.SessionExist(sid) { // å¦‚æœè·å–åˆ°å°±ç”¨idæ¥æŸ¥çœ‹å¯¹åº”çš„sessionStoreï¼Œå¯ä»¥é€šè¿‡sessionStoreæ¥ç®¡ç†sessoin\n\t\treturn manager.provider.SessionRead(sid)\n\t}\n\n\t// Generate a new session å¦‚æœè·å–ä¸åˆ°sessionå°±é‡æ–°ç”Ÿæˆsession\n\tsid, errs = manager.sessionID()\n\tif errs != nil {\n\t\treturn nil, errs\n\t}\n\n\tsession, err = manager.provider.SessionRead(sid)\n\tif err != nil {\n\t\treturn nil, err\n\t}\n    // è®¾ç½®ä¸€ä¸ªcookieï¼ŒæŠŠsidæ”¾åˆ°cookieä¸­ï¼Œä¸‹æ¬¡å³å¯åœ¨è¯·æ±‚ä¸­è·å–å¯¹åº”çš„sidï¼Œä»è€Œè·å–session\n\tcookie := &http.Cookie{\n\t\tName:     manager.config.CookieName,\n\t\tValue:    url.QueryEscape(sid),\n\t\tPath:     \"/\",\n\t\tHttpOnly: !manager.config.DisableHTTPOnly,\n\t\tSecure:   manager.isSecure(r),\n\t\tDomain:   manager.config.Domain,\n\t\tSameSite: manager.config.CookieSameSite,\n\t}\n\tif manager.config.CookieLifeTime > 0 {\n\t\tcookie.MaxAge = manager.config.CookieLifeTime\n\t\tcookie.Expires = time.Now().Add(time.Duration(manager.config.CookieLifeTime) * time.Second)\n\t}\n\tif manager.config.EnableSetCookie {\n\t\thttp.SetCookie(w, cookie)\n\t}\n\tr.AddCookie(cookie)\n\n\tif manager.config.EnableSidInHTTPHeader {\n\t\tr.Header.Set(manager.config.SessionNameInHTTPHeader, sid)\n\t\tw.Header().Set(manager.config.SessionNameInHTTPHeader, sid)\n\t}\n\n\treturn\n}\n```\n\nåœ¨ä¸Šè¿°çš„æºç ä¸­ï¼Œæˆ‘ä»¬åº”è¯¥è¦å…³æ³¨é‡Œé¢çš„`SessionExist`ã€`SessionRead` çš„å®ç°ï¼Œæ‰€ä»¥æˆ‘ä»¬æŸ¥çœ‹å¯¹åº”çš„æºç ï¼Œåœ¨`session/sess_file.go`ä¸­\n\n```go\nhttps://github.com/beego/beego/blob/c280209bf5b94cf31094a200b166c97eb3898851/session/sess_file.go#L176-L190\n// SessionExist Check file session exist.\n// it checks the file named from sid exist or not.\nfunc (fp *FileProvider) SessionExist(sid string) bool {\n\tfilepder.lock.Lock() // è¿™é‡Œè·Ÿä¸Šé¢çš„sessionCGä¸€æ ·ï¼Œä¸Šé”äº†\n\tdefer filepder.lock.Unlock()\n\n\tif len(sid) < 2 {\n\t\tSLogger.Println(\"min length of session id is 2\", sid)\n\t\treturn false\n\t}\n\n\t_, err := os.Stat(path.Join(fp.savePath, string(sid[0]), string(sid[1]), sid))\n\treturn err == nil\n}\n\nhttps://github.com/beego/beego/blob/c280209bf5b94cf31094a200b166c97eb3898851/session/sess_file.go#L128-L176\n// SessionRead Read file session by sid.\n// if file is not exist, create it.\n// the file path is generated from sid string.\nfunc (fp *FileProvider) SessionRead(sid string) (Store, error) {\n\tinvalidChars := \"./\"\n\t...\n\tfilepder.lock.Lock() // è¿™é‡Œè·Ÿä¸Šé¢çš„sessionCGä¸€æ ·ï¼Œä¸Šé”äº†\n\tdefer filepder.lock.Unlock()\n\n\terr := os.MkdirAll(path.Join(fp.savePath, string(sid[0]), string(sid[1])), 0755) //åˆ›å»ºå¯¹åº”çš„æ–‡ä»¶å¤¹\n\tif err != nil {\n\t\tSLogger.Println(err.Error())\n\t}\n    // è·å–æ–‡ä»¶å¹¶å†™å…¥sessionä¿¡æ¯æˆ–è€…åˆ›å»ºå¯¹åº”çš„æ–‡ä»¶å¹¶å†™å…¥sessionä¿¡æ¯\n\t_, err = os.Stat(path.Join(fp.savePath, string(sid[0]), string(sid[1]), sid)) \n\tvar f *os.File\n\tif err == nil {\n\t\tf, err = os.OpenFile(path.Join(fp.savePath, string(sid[0]), string(sid[1]), sid), os.O_RDWR, 0777)\n\t} else if os.IsNotExist(err) {\n\t\tf, err = os.Create(path.Join(fp.savePath, string(sid[0]), string(sid[1]), sid))\n\t} else {\n\t\treturn nil, err\n\t}\n\n\tdefer f.Close()\n\t// ä¿®æ”¹æ–‡ä»¶Modifyæ—¶é—´ï¼Œåœ¨CGä¸­ä¹Ÿæ˜¯é€šè¿‡è¯¥å±æ€§åˆ¤æ–­æ–‡ä»¶æ˜¯å¦è¦è¢«CG\n\tos.Chtimes(path.Join(fp.savePath, string(sid[0]), string(sid[1]), sid), time.Now(), time.Now())\n\tvar kv map[interface{}]interface{}\n    // è¯»å–sessionä¿¡æ¯\n\tb, err := ioutil.ReadAll(f)\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\tif len(b) == 0 {\n\t\tkv = make(map[interface{}]interface{})\n\t} else {\n\t\tkv, err = DecodeGob(b)\n\t\tif err != nil {\n\t\t\treturn nil, err\n\t\t}\n\t}\n\n\tss := &FileSessionStore{sid: sid, values: kv}\n\treturn ss, nil\n}\n```\n\næ‰€ä»¥æˆ‘ä»¬è¿™é‡Œå°±å¯ä»¥è§£é‡Šï¼Œä¸ºä»€ä¹ˆæ—¥å¿—æ˜¾ç¤ºæœåŠ¡å¯åŠ¨äº†ï¼Œä½†æ˜¯è¯·æ±‚å°±æ˜¯ä¸è¡Œ\n\nå› ä¸ºåœ¨ä¸€å¼€å§‹å¯åŠ¨çš„æ—¶å€™ï¼Œ`beego`å°±ä¼šè‡ªå·±å¯¹`session`æ–‡ä»¶è¿›è¡ŒCGåŒæ—¶`lock`äº†ä¸€ä¸ª`RWMutex`\n\nåé¢è¯·æ±‚è¿‡æ¥çš„æ—¶å€™ï¼Œ`beego`åˆä¼šè¯»å–ä¸ºäº†è¯»`session`è€Œä¸Šé”ï¼Œä½†æ˜¯å¦‚æœå‰é¢çš„`CG`è¿˜æœªæ‰§è¡Œå®Œæˆï¼Œé‚£ä¹ˆè¿™ä¸ªå°±ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°å¯ä»¥ä¸Šé”ä¸ºæ­¢\n\næ‰€ä»¥å½“`tmp`çš„`session`æ–‡ä»¶è¿‡å¤šï¼Œé‚£ä¹ˆå¯åŠ¨çš„æ—¶å€™å°±è¦èŠ±å¤§é‡æ—¶é—´è¿›è¡Œ`CG`å¯¼è‡´è¯·æ±‚è¢«å¡ä½ï¼Œä¹Ÿè¯´æ˜ä¸ºä»€ä¹ˆåœ¨ç”Ÿäº§ç¯å¢ƒä¸­`nfs`çš„æŒ‚è½½è¿›ç¨‹ä¼š`cpu`è¿‡é«˜ï¼Œç„¶åæŠŠ`nfs`å–æ¶ˆæŒ‚è½½å(`tmp`ä¸­çš„`session`è¢«æ¸…ç©ºå)ï¼Œå¯åŠ¨åé©¬ä¸Šå°±å¯ä»¥æ­£å¸¸è®¿é—®äº†\n\nä»¥ä¸‹æ˜¯åœ¨æµ‹è¯•ç¯å¢ƒçš„æ¨¡æ‹Ÿ\n\n```shell\n[root@rocky-testing casdoor]# du -h --max-depth=1 ./shared-tmp/ \n....\n31G     ./shared-tmp/ # è¿™é‡Œå¼„äº†ä¸€ä¸ª31Gçš„sessionè¯·æ±‚\n```\n\né‡å¯ä¸€ä¸ª`casdoor`æœåŠ¡åï¼Œ`curl`è¯¥æœåŠ¡\n\n![log](./curl-8001.png)\n\nåœ¨ç¬¬ä¸€ä¸ªcurlé€šäº†ä»¥åï¼Œåé¢çš„curlæœåŠ¡å“åº”æ—¶é—´æ‰ä¼šæ­£å¸¸\n\n![log](./curl-8001-normal.png)\n\n## ä¸ºä»€ä¹ˆä¼šäº§ç”Ÿè¿™ä¹ˆå¤štmpæ–‡ä»¶\n\nä¸ºä»€ä¹ˆä¸€å¤©å¤šçš„æ—¶é—´ï¼Œ`tmp`æ–‡ä»¶ä¼šäº§ç”Ÿå¾ˆå¤šçš„æ–‡ä»¶ï¼Œå ç”¨æ¯”è¾ƒå¤§çš„å­˜å‚¨ï¼Ÿ\n\nè¿™å°±ä¸å¾—ä¸æè¿™ä¸ª`casdoor`äº†ï¼Œä»ä¸Šé¢æˆ‘ä»¬çŸ¥é“`casdoor`å¯ä»¥è®©æ˜¯ç”¨æ¥è§£å†³ç”¨æˆ·åœ¨å¤šä¸ªåº”ç”¨ä¸­çš„ç™»å½•é—®é¢˜çš„ï¼Œé‚£ä¹ˆåº”ç”¨åœ¨ç”¨æˆ·ç™»å½•çš„æ—¶å€™å°±è¦è®¿é—®`casdoor`è·å–ç”¨æˆ·çš„ä¿¡æ¯ï¼Œè€Œåˆšå¥½ï¼Œæˆ‘ä»¬åœ¨ç”Ÿäº§çš„ç¯å¢ƒä¸­ï¼Œæœ‰ä¸€ä¸ªæœåŠ¡å¤§æ¦‚ä¼šæ¯ç§’è¯·æ±‚`casdoor`æœåŠ¡3æ¬¡å·¦å³(åé¢æ”¹æˆåˆ©ç”¨ç¼“å­˜æœºåˆ¶äº†)ï¼ŒåŒæ—¶`casdoor`å†…éƒ¨çš„ç¼“å­˜è¶…æ—¶æ—¶é—´é…ç½®è®¾ç½®æˆäº†30å¤©ğŸ™ï¼Œè€Œ`beego`è‡ªå·±é»˜è®¤æ˜¯1å°æ—¶ã€‚\n\nè¿™é‡Œåˆæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œ`beego`é‡Œé¢çš„`session/session.go`ä¸­ä¸æ˜¯æœ‰`manager.provider.SessionExist`æ¥æŸ¥çœ‹`sid`æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨çš„è¯æ‰åˆ›å»ºæ–°çš„ã€‚å¯¹çš„ï¼Œè¿™ä¸ªå¯¹ä¸€èˆ¬ç½‘é¡µä¸Šä½¿ç”¨çš„ç”¨æˆ·æ¥è¯´æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œå› ä¸ºæµè§ˆå™¨ä¼šå¸®ä½ æŠŠ`cookie`æ”¾åˆ°æ¯æ¬¡çš„è¯·æ±‚ä¸­ï¼Œæ‰€ä»¥ä¸€ä¸ªç”¨æˆ·åªç”¨åˆ›å»ºä¸€ä¸ª`sid`å³å¯ï¼Œä½†æ˜¯è¿™ä¸ªæ˜¯åº”ç”¨çš„è¯·æ±‚ï¼Œå–å†³äºç¼–å†™åº”ç”¨çš„äººæœ‰æ²¡æœ‰æŠŠ`cookie`æˆ–è€…`sid`ç»™ä½ ä¼ é€’è¿‡æ¥ï¼Œå¦‚æœæ²¡æœ‰ä¼ é€’å°±ä¼šå‡ºç°æ¯æ¬¡è¯·æ±‚éƒ½æœ‰é‡æ–°åˆ›å»ºä¸€ä¸ª`sid`å’Œå¯¹åº”çš„`session`ä¿¡æ¯\n\n# æ€»ç»“\n\næ ¹æ®ä¸Šè¿°çš„åˆ†æï¼Œæˆ‘ç”»å‡ºæ¥äº†æ•´ä¸ªè¯·æ±‚æµç¨‹å›¾\n\n![log](./æµç¨‹å›¾.png)\n\nåŒæ—¶å¾—å‡ºè¿™æ¬¡çš„é—®é¢˜**åº”è¯¥æ˜¯**`beego`æ¡†æ¶çš„é—®é¢˜ğŸ¤¥ï¼Œä½†æ˜¯`casdoor`ä¹Ÿæ˜¯å­˜åœ¨è¿™ä¸€äº›é—®é¢˜çš„~~ï¼ˆæ„Ÿè§‰åƒæ˜¯æœ€ä½³å®è·µï¼‰~~\n\né¦–å…ˆ`casdoor`çš„ç¼“å­˜è®¾ç½®æˆç«‹30å¤©ï¼Œå¦‚æœç”¨çš„æ˜¯`file`ä½œä¸º`sessionProvider`ï¼Œå½“ç”¨æˆ·æ•°é‡å¤šçš„æ—¶å€™è¿˜æ˜¯ä¼šæœ‰é—®é¢˜ï¼Œæˆ–è€…ä½¿ç”¨`redis`æ¥åš`session`ç¼“å­˜ï¼Œè‡³å°‘`io`æ€§èƒ½æ¯”ç£ç›˜è¦å¿«ï¼Œ`sessionCG`æ—¶é—´ä¹Ÿå¿«\n\né™¤äº†ä¸Šé¢çš„é—®é¢˜ï¼Œæˆ‘ä»¬åœ¨å…¶å®ƒåœ°æ–¹ä¹Ÿå‘ç°äº†ä¸€äº›é—®é¢˜\n\næ¯”å¦‚åœ¨è®¿é—®`/api/get-groups`æ—¶ï¼Œå¯¹åº”çš„æ¥å£åœ¨è°ƒç”¨çš„æ—¶å€™æ²¡æœ‰ä¼ åˆ†é¡µå‚æ•°ï¼Œæ‰€ä»¥ä¼šå…¨æŸ¥æ•°æ®è¡¨ï¼Œåˆšå¥½é‡Œé¢æœ‰ä¸ªè·å–å¤šæ¡æ•°æ®ï¼Œç„¶åå¾ªç¯å¤šæ¡æ•°æ®å¹¶åç¨‹æŸ¥è¯¢æ•°æ®åº“ï¼Œé‚£ä¸ªæ—¶å€™åˆšå¥½æˆ‘ä»¬å¼„äº†å¾ˆå¤šæµ‹è¯•æ•°æ®ï¼Œå¯¼è‡´è¯¥ç¯å¢ƒä¸‹è°ƒç”¨è¯¥æ¥å£å°±ä¼šæŠŠæ•°æ®åº“è¿æ¥æ‰“æ»¡äº†ã€‚åé¢å¤„ç†æ–¹æ¡ˆåº”è¯¥æ˜¯æ›´æ¢äº†å…¶å®ƒç‰ˆæœ¬çš„`casdoor`ï¼Œåœ¨ç›®å‰ç¯å¢ƒçš„é‚£ä¸ªç‰ˆæœ¬æ‰¾ä¸åˆ°å¯¹åº”çš„æ¥å£ä¿¡æ¯äº†ã€‚\n\n\n\n","tags":["æ’éšœ","casdoor"]},{"title":"k8sä¸­ä¸ºPodé…ç½®è‡ªç­¾è¯ä¹¦ä»¥è®¿é—®HTTPSæœåŠ¡","url":"/2025/03/22/k8sä¸­ä¸ºPodé…ç½®è‡ªç­¾è¯ä¹¦ä»¥è®¿é—®HTTPSæœåŠ¡/","content":"\n> æœ€è¿‘åœ¨éƒ¨ç½²ä¸€å¥—ç³»ç»Ÿçš„å…¶å®ƒç¯å¢ƒæ—¶ï¼Œé‡åˆ°äº†è‡ªç­¾httpsè¯ä¹¦å’Œåº”ç”¨è‡ªç­¾è¯ä¹¦åˆ°k8sä¸­çš„é—®é¢˜ï¼Œæ•…æ­¤è®°å½•ä¸€ä¸‹ã€‚\n>\n> åœ¨éƒ¨ç½²çš„åº”ç”¨ä¸­ï¼Œæœ‰ä¸€ä¸ªéœ€è¦ä½¿ç”¨Standard OIDC Clientæ‰€æœ‰å¿…é¡»è¦httpsï¼Œè€Œä¸”è¦è®¤è¯çš„æœåŠ¡ä¸æ˜¯éƒ¨ç½²åœ¨æœ¬é›†ç¾¤ä¸­\n\n# æ¦‚å¿µ\n\n## Httpsç›¸å…³æ¦‚å¿µ\n\nä»€ä¹ˆæ˜¯httpsï¼Œhttpsè¯ä¹¦çš„ç§ç±»ï¼Œå¦‚ä½•è‡ªç­¾httpsè¿™äº›å†…å®¹è¿™é‡Œå°±ä¸åšå±•å¼€äº†ä»…ä½œä¸€ä¸ªè‡ªå·±çš„æ€»ç»“ã€‚å› ä¸ºç½‘ä¸Šçš„æ–‡ç« å’Œè§†é¢‘å¤ªå¤šäº†ï¼Œè¿™é‡Œæ¨èä¸€ä¸‹å‡ ä½å¤§ä½¬çš„æ–‡ç« ã€‚\n\n* [æœ‰å…³ TLS/SSL è¯ä¹¦çš„ä¸€åˆ‡ | å¡ç“¦é‚¦å™¶ï¼](https://www.kawabangga.com/posts/5330)\n* [HTTPS éšç§å®‰å…¨çš„ä¸€äº›å®è·µ](https://blog.laisky.com/p/https-in-action/#gsc.tab=0)\n* [å†™ç»™å¼€å‘äººå‘˜çš„å®ç”¨å¯†ç å­¦ï¼ˆå…«ï¼‰â€”â€” æ•°å­—è¯ä¹¦ä¸ TLS åè®® - This Cute World](https://thiscute.world/posts/about-tls-cert/)\n\n## æ€»ç»“\n\n**ä»¥ä¸‹æ€»ç»“éƒ¨åˆ†æ‘˜æŠ„ä¸ä¸Šè¿°æ–‡ç« ä¸­**\n\n- **HTTPSæ˜¯HTTP+TLS**ï¼Œå…¶ä¸­çš„TLSå°±æ˜¯ä¸ºäº†å‘å®¢æˆ·ç«¯è¯æ˜æœåŠ¡ç«¯è‡ªå·±çš„èº«ä»½ï¼Œé¿å…åˆ«äººä¼ªé€ è‡ªå·±çš„èº«ä»½å¯¹å®¢æˆ·ç«¯é€ æˆå½±å“ã€‚\n- **CAã€å®¢æˆ·ç«¯ã€ç½‘ç«™**ä¹‹é—´çš„å…³ç³»\n  - å®¢æˆ·ç«¯ä¿¡ä»» CA æœºæ„ï¼›\n  - CA æœºæ„ç»™ç½‘ç«™ç­¾å‘è¯ä¹¦ï¼›\n  - å®¢æˆ·ç«¯åœ¨è®¿é—®ç½‘ç«™çš„æ—¶å€™ï¼Œç½‘ç«™å‡ºç¤ºè‡ªå·±çš„è¯ä¹¦ï¼Œç”±äºå®¢æˆ·ç«¯ä¿¡ä»» CA æœºæ„ï¼Œä¹Ÿå°±ä¿¡ä»» CA æœºæ„ç­¾å‘çš„è¯ä¹¦ï¼›\n- PKI æ¶æ„ä½¿ç”¨ã€Œ**æ•°å­—è¯ä¹¦é“¾**ï¼ˆä¹Ÿå«åš**ä¿¡ä»»é“¾**ï¼‰ã€çš„æœºåˆ¶æ¥è§£å†³è¿™ä¸ªé—®é¢˜: \n  - CA æœºæ„é¦–å…ˆç”Ÿæˆè‡ªå·±çš„æ ¹è¯ä¹¦ä¸ç§é’¥ï¼Œå¹¶ä½¿ç”¨ç§é’¥ç»™æ ¹è¯ä¹¦ç­¾å\n    - å› ä¸ºç§é’¥è·Ÿè¯ä¹¦æœ¬èº«å°±æ˜¯ä¸€å¯¹ï¼Œå› æ­¤æ ¹è¯ä¹¦ä¹Ÿè¢«ç§°ä½œã€Œè‡ªç­¾åè¯ä¹¦ã€\n  - CA æ ¹è¯ä¹¦è¢«ç›´æ¥äº¤ä»˜ç»™å„å¤§è½¯ç¡¬ä»¶å‚å•†ï¼Œå†…ç½®åœ¨ä¸»æµçš„æ“ä½œç³»ç»Ÿä¸æµè§ˆå™¨ä¸­\n  - ç„¶å CA æœºæ„å†ä½¿ç”¨ç§é’¥ç­¾å‘ä¸€äº›æ‰€è°“çš„ã€Œä¸­é—´è¯ä¹¦ã€ï¼Œä¹‹åå°±æŠŠç§é’¥é›ªè—äº†ï¼Œéå¿…è¦ä¸ä¼šå†æ‹¿å‡ºæ¥ä½¿ç”¨ã€‚\n    - æ ¹è¯ä¹¦çš„ç§é’¥é€šå¸¸**ç¦»çº¿å­˜å‚¨**åœ¨å®‰å…¨åœ°ç‚¹\n    - ä¸­é—´è¯ä¹¦çš„æœ‰æ•ˆæœŸé€šå¸¸ä¼šæ¯”æ ¹è¯ä¹¦çŸ­ä¸€äº›\n    - éƒ¨åˆ†ä¸­é—´è¯ä¹¦ä¼šè¢«ä½œä¸ºå¤‡ä»½ä½¿ç”¨ï¼Œå¹³å¸¸ä¸ä¼šå¯ç”¨\n  - CA æœºæ„ä½¿ç”¨è¿™äº›ä¸­é—´è¯ä¹¦çš„ç§é’¥ï¼Œä¸ºç”¨æˆ·æäº¤çš„æ‰€æœ‰ CSR è¯·æ±‚ç­¾å\n  - CA æœºæ„ä¹Ÿå¯èƒ½ä¼šåœ¨ç»è¿‡ä¸¥æ ¼å®¡æ ¸åï¼Œä¸ºå…¶ä»–æœºæ„ç­¾å‘ä¸­é—´è¯ä¹¦ï¼Œè¿™æ ·å°±èƒ½èµ‹äºˆå…¶ä»–æœºæ„ç­¾å‘è¯ä¹¦çš„æƒåˆ©ï¼Œè€Œä¸”æ ¹è¯ä¹¦çš„å®‰å…¨æ€§ä¸å—å½±å“ã€‚\n  - å®¢æˆ·ç«¯è¦ç›¸ä¿¡è¿™ä¸ªè¯ä¹¦ï¼Œæœ€ç»ˆçš„ç›®çš„ä¸€å®šæ˜¯éªŒè¯åˆ°ä¸€ä¸ªè‡ªå·±ä¿¡ä»»çš„ **CA Root** ä¸Šå»ã€‚ä¸€æ—¦éªŒè¯äº† **CA Root**ï¼Œå®¢æˆ·ç«¯å°±ä¿¡ä»»äº† **Root** ç­¾å‘çš„è¯ä¹¦ï¼Œä¹Ÿå°±ä¿¡ä»»äº†ä»–ä»¬çš„è¯ä¹¦ã€‚\n- äº¤å‰ç­¾å\n  - å®é™…ä¸Šåœ¨ PKI ä½“ç³»ä¸­ï¼Œä¸€äº›è¯ä¹¦é“¾ä¸Šçš„ä¸­é—´è¯ä¹¦ä¼šè¢«ä½¿ç”¨å¤šä¸ªæ ¹è¯ä¹¦è¿›è¡Œç­¾åâ€”â€”æˆ‘ä»¬ç§°è¿™ä¸ºäº¤å‰ç­¾åã€‚äº¤å‰ç­¾åçš„ä¸»è¦ç›®çš„æ˜¯æå‡è¯ä¹¦çš„å…¼å®¹æ€§â€”â€”å®¢æˆ·ç«¯åªè¦å®‰è£…æœ‰å…¶ä¸­ä»»ä½•ä¸€ä¸ªæ ¹è¯ä¹¦ï¼Œå°±èƒ½æ­£å¸¸éªŒè¯è¿™ä¸ªä¸­é—´è¯ä¹¦ã€‚\n  - ä»è€Œä½¿ä¸­é—´è¯ä¹¦åœ¨è¾ƒè€çš„è®¾å¤‡ä¹Ÿèƒ½é¡ºåˆ©é€šè¿‡è¯ä¹¦éªŒè¯ã€‚\n- è¯ä¹¦çŠ¶æ€è®¤è¯ **OCSPåè®®**\n  - ä¸ºäº†åœ¨ç§é’¥æ³„æ¼çš„æƒ…å†µä¸‹ï¼Œèƒ½å¤ŸåŠé”€å¯¹åº”çš„è¯ä¹¦ï¼ŒPKI å…¬é’¥åŸºç¡€è®¾æ–½è¿˜æä¾›äº† OCSPï¼ˆOnline Certificate Status Protocolï¼‰è¯ä¹¦çŠ¶æ€æŸ¥è¯¢åè®®ã€‚\n  - Chrome/Firefox ç­‰æµè§ˆå™¨éƒ½ä¼šå®šæœŸé€šè¿‡ OCSP åè®®å»è¯·æ±‚ CA æœºæ„çš„ OCSP æœåŠ¡å™¨éªŒè¯è¯ä¹¦çŠ¶æ€ï¼Œ è¿™å¯èƒ½ä¼šæ‹–æ…¢ HTTPS åè®®çš„å“åº”é€Ÿåº¦ã€‚\n  - å› ä¸ºå®¢æˆ·ç«¯ç›´æ¥å»è¯·æ±‚ CA æœºæ„çš„ OCSP åœ°å€è·å–è¯ä¹¦çŠ¶æ€ï¼Œè¿™å°±å¯¼è‡´ CA æœºæ„å¯ä»¥è·å–åˆ°ä¸€äº›å¯¹åº”ç«™ç‚¹çš„ç”¨æˆ·ä¿¡æ¯ï¼ˆIP åœ°å€ã€ç½‘ç»œçŠ¶æ€ç­‰ï¼‰ã€‚\n  - ä¸ºäº†è§£å†³è¿™ä¸¤ä¸ªé—®é¢˜ï¼Œ[rfc6066](https://www.rfc-editor.org/rfc/rfc6066) å®šä¹‰äº† OCSP stapling åŠŸèƒ½ï¼Œå®ƒä½¿æœåŠ¡å™¨å¯ä»¥æå‰è®¿é—® OCSP è·å–è¯ä¹¦çŠ¶æ€ä¿¡æ¯å¹¶ç¼“å­˜åˆ°æœ¬åœ°ï¼ŒåŸºæœ¬ Nginx/Caddy ç­‰å„å¤§ Web æœåŠ¡å™¨æˆ–ç½‘å…³ï¼Œéƒ½æ”¯æŒ OCSP stapling åè®®ã€‚\n\n# å®è·µ\n\n## è¯ä¹¦çš„ç”Ÿæˆå’Œå®‰è£…\n\n### ç”Ÿæˆè‡ªç­¾è¯ä¹¦\n\næµç¨‹ \n\n- ç”Ÿæˆç§é’¥ key\n- ç”Ÿæˆ**è¯ä¹¦ç”Ÿæˆè¯·æ±‚csr**ï¼Œå¯ä»¥åœ¨**csr**ä¸­é…ç½®è¦ç”Ÿæˆçš„è¯ä¹¦çš„ä¿¡æ¯ï¼Œå¦‚**countryNameã€stateOrProvinceNameã€organizationNameã€CAã€SAN**\n  - **SAN (Subject Alternative Name):** å¯é€‰å­—æ®µï¼Œç”¨äºæŒ‡å®šè¯ä¹¦å¯ä»¥ä½¿ç”¨çš„å…¶ä»–åŸŸåæˆ–ä¸»æœºåã€‚\n    - å¯ä»¥é€šè¿‡é…ç½®è¿™ä¸ªæ¥è®©è¯ä¹¦ä¿æŠ¤å¤šä¸ªåŸŸåï¼Œä¾‹å¦‚ `example.com`ã€`www.example.com`ã€`*.example.com`ã€‚\n    - å¯ä»¥ä½¿ç”¨è¿™ä¸ªé…ç½®æ¥å¯¹å¯¹åº”çš„IPè¿›è¡Œä¿æŠ¤ï¼Œå³æŠŠSANé…ç½®ä¸ºå¯¹åº”çš„IPåœ°å€\n  - **CA**ï¼šé…ç½®ä¸º `TRUE` æˆ– `FALSE`ï¼Œå®ƒæŒ‡ç¤ºè¯¥è¯ä¹¦æ˜¯å¦å¯ä»¥ä½œä¸ºè¯ä¹¦é¢å‘æœºæ„ (CA) è¯ä¹¦ã€‚\n    - **`CA:TRUE`**ï¼šè¡¨æ˜è¯¥è¯ä¹¦å¯ä»¥ç”¨äºç­¾ç½²å…¶ä»–è¯ä¹¦ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªè¯ä¹¦å¯ä»¥ä½œä¸ºä¸€ä¸ª CA è¯ä¹¦ï¼Œé¢å‘ä¸‹çº§è¯ä¹¦ï¼Œç”¨äºåˆ›å»ºæ ¹ CA è¯ä¹¦æˆ–ä¸­é—´ CA è¯ä¹¦ã€‚ åªæœ‰ CA è¯ä¹¦æ‰èƒ½ç­¾ç½²å…¶ä»–è¯ä¹¦ï¼Œå»ºç«‹ä¿¡ä»»é“¾ã€‚\n    - **`CA=FALSE`**ï¼šè¡¨æ˜è¯¥è¯ä¹¦ä¸èƒ½ç”¨äºç­¾ç½²å…¶ä»–è¯ä¹¦ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªè¯ä¹¦æ˜¯ä¸€ä¸ªç»ˆç«¯å®ä½“è¯ä¹¦ï¼Œåªèƒ½ç”¨äºèº«ä»½éªŒè¯ã€åŠ å¯†ç­‰ç›®çš„ï¼Œä¸èƒ½é¢å‘ä¸‹çº§è¯ä¹¦ï¼Œç”¨äºåˆ›å»ºæœåŠ¡å™¨è¯ä¹¦ã€å®¢æˆ·ç«¯è¯ä¹¦ã€ä»£ç ç­¾åè¯ä¹¦ç­‰ã€‚ è¿™äº›è¯ä¹¦ç”¨äºä¿æŠ¤ç‰¹å®šçš„æœåŠ¡æˆ–åº”ç”¨ç¨‹åºï¼Œè€Œä¸æ˜¯ç”¨äºé¢å‘å…¶ä»–è¯ä¹¦ã€‚\n- é€šè¿‡`key+csr`ç”Ÿæˆå¯¹åº”çš„`crt`è¯ä¹¦\n\næœ¬æ–‡é€šè¿‡`openssl`æ¥ç”Ÿæˆè‡ªç­¾è¯ä¹¦ï¼Œä»¥ä¸‹æ˜¯ç”Ÿæˆè¯ä¹¦çš„è„šæœ¬\n\n```shell\n#!/bin/bash\n\n# Check if domain name is provided\nif [ -z \"$1\" ]; then\n    echo \"Usage: $0 <domain>\"\n    exit 1\nfi\n\nDOMAIN=$1\n# è¯ä¹¦è¿‡æœŸæ—¥æœŸ\nDAYS=3650\nCOUNTRY=\"CN\"\nSTATE=\"GZ\"\nCERT_DIR=\"./certs\"\nCONFIG_FILE=\"$CERT_DIR/openssl.cnf\"\n\n# Create directory for certificates if it doesn't exist\nmkdir -p $CERT_DIR\n\n# ç”Ÿæˆ private key\nopenssl genrsa -out $CERT_DIR/${DOMAIN}.key 2048\n\n# Create OpenSSL configuration file é€šè¿‡è¯¥é…ç½®æ–‡ä»¶ç”Ÿæˆå¯¹åº”çš„csr\ncat > $CONFIG_FILE <<EOL\n[ req ]\ndistinguished_name = req_distinguished_name\nprompt = no\ndefault_bits = 2048\nreq_extensions = cert_ext\n\n[ req_distinguished_name ]\ncountryName         = $COUNTRY\nstateOrProvinceName = $STATE\nlocalityName        = $STATE\norganizationName    = $STATE\ncommonName          = $DOMAIN\n\n[ cert_ext ]\nbasicConstraints = CA:TRUE # CAé…ç½® \nkeyUsage = digitalSignature, keyEncipherment\nextendedKeyUsage = serverAuth, clientAuth\nsubjectAltName = @alt_names\n# SANé…ç½®\n[ alt_names ]\nDNS.1 = $DOMAIN\nDNS.2 = *.$DOMAIN\n\nEOL\n\n# Generate CSR with extensions ç”Ÿæˆcsr\nopenssl req -new -key $CERT_DIR/${DOMAIN}.key -out $CERT_DIR/${DOMAIN}.csr -config $CONFIG_FILE\n\n# Generate self-signed certificate with both extensions ç”Ÿæˆcrt\nopenssl x509 -req -days $DAYS \\\n    -in $CERT_DIR/${DOMAIN}.csr \\\n    -signkey $CERT_DIR/${DOMAIN}.key \\\n    -out $CERT_DIR/${DOMAIN}.crt \\\n    -extensions cert_ext \\\n    -extfile $CONFIG_FILE\n\necho \"Certificate and key have been generated in the $CERT_DIR directory.\"\n```\n\nå¯¹åº”ç”Ÿæˆå‡ºæ¥çš„è¯ä¹¦ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ¥è¿›è¡ŒæŸ¥çœ‹\n\n```shell\n# æŸ¥çœ‹è¯ä¹¦(crt)ä¿¡æ¯\nopenssl x509 -noout -text -in server.crt\n\n# æŸ¥çœ‹è¯ä¹¦è¯·æ±‚(csr)ä¿¡æ¯\nopenssl req -noout -text -in server.csr\n\n# æŸ¥çœ‹ RSA ç§é’¥(key)ä¿¡æ¯\nopenssl rsa -noout -text -in server.key\n\n# éªŒè¯è¯ä¹¦æ˜¯å¦å¯ä¿¡\n## 1. ä½¿ç”¨ç³»ç»Ÿçš„è¯ä¹¦é“¾è¿›è¡ŒéªŒè¯\nopenssl verify server.crt\n## 2. ä½¿ç”¨æŒ‡å®šçš„ CA è¯ä¹¦è¿›è¡ŒéªŒè¯\nopenssl verify -CAfile ca.crt server.crt\n```\n\n### ä¸ºç³»ç»Ÿå®‰è£…è‡ªç­¾è¯ä¹¦\n\nè¿™é‡Œåªä»‹ç» RockyLinux9.3 å’Œ Debain12 ã€‚å› ä¸ºæˆ‘çš„ç³»ç»Ÿæ˜¯`RockyLinux9.3`ï¼Œpodçš„é•œåƒæ˜¯ `Debain12`å…¶å®ƒçš„å¤§å·®ä¸å·®ã€‚\n\nRockyLinux9.3\n\n- ä¸ºRockyLinuxå®‰è£…è‡ªç­¾è¯ä¹¦è¦æœ‰ä¸€ä¸ªæ³¨æ„ç‚¹ï¼Œæ—¢è¦æŠŠè¯ä¹¦ä¸­çš„ **CA** è®¾ç½®ä¸º **TRUE**\n- å¤åˆ¶è¯ä¹¦åˆ° `/etc/pki/ca-trust/source/anchors/` æ‰§è¡Œ `update-ca-trust `\n- å°±ä¼šç”ŸæˆåŒ…å«ç§æœ‰è¯ä¹¦çš„`ca-bundle.crt`åˆ°`/etc/pki/tls/certs/`ä¸­\n\nDebain12\n\n- å¤åˆ¶è¯ä¹¦åˆ° `/usr/local/share/ca-certificates/` æ‰§è¡Œ `update-ca-certificates --fresh`\n- å°±ä¼šç”ŸåŒ…å«ç§æœ‰è¯ä¹¦çš„`ca-certificates.crt` åˆ° `/etc/ssl/certs/`ä¸­\n\nå®‰è£…å®Œæˆä»¥åï¼Œå°±å¯ä»¥ä½¿ç”¨`curl`å‘½ä»¤å¯¹è¯ä¹¦è¿›è¡ŒéªŒè¯\n\n```shell\n# åœ¨æŠŠè¯ä¹¦é…ç½®åˆ°webæœåŠ¡åï¼Œå¯ä»¥ä½¿ç”¨curlå‘½ä»¤æ¥æŸ¥çœ‹è¯ä¹¦æ˜¯å¦åŒ¹é…\ncurl -v https://xxx.test.com --cacert /etc/ssl/certs/xxx.test.com.crt \n```\n\n## ä¸ºPodé…ç½®è¯ä¹¦\n\n- æœ¬æ¬¡å°†ä¼šä½¿ç”¨ä¸¤ç§æ–¹å¼æ¥è¿›è¡Œé…ç½®ï¼Œä¸€ç§æ˜¯é€šè¿‡`init-container`çš„æ–¹å¼æ¥å®‰è£…è¯ä¹¦ï¼Œå¦ä¸€ç§æ˜¯ä½¿ç”¨`certs-manager`ä¸­çš„`trust-manager`æ¥è‡ªåŠ¨ç®¡ç†podçš„è¯ä¹¦\n\n- åº”ç”¨éƒ¨ç½²ç¯å¢ƒï¼šé¡¹ç›®ä½¿ç”¨çš„æ˜¯`Kustomize`æ¥éƒ¨ç½²ä¸åŒçš„ç¯å¢ƒã€‚é¡¹ç›®ä¸­çš„ä»£ç ï¼š[k8s_demo/certs/app at main Â· kehaha-5/k8s_demo](https://github.com/kehaha-5/k8s_demo/tree/main/certs/app)\n\n\n```shell\n[root@rocky-testing app]# tree -L 3\n.\nâ”œâ”€â”€ debianupcaDockerfile\nâ”œâ”€â”€ deploy\nâ”‚   â”œâ”€â”€ base\nâ”‚   â”‚   â”œâ”€â”€ deployment.yaml\nâ”‚   â”‚   â””â”€â”€ kustomization.yaml\nâ”‚   â””â”€â”€ overlays\nâ”‚       â”œâ”€â”€ prod # ç”Ÿæˆç¯å¢ƒç”¨çš„æ˜¯CAçš„è¯ä¹¦\nâ”‚       â”œâ”€â”€ uat # ä½¿ç”¨init-containerå®‰è£…è¯ä¹¦\nâ”‚       â””â”€â”€ uat-trust # ä½¿ç”¨trust-manager\nâ”œâ”€â”€ Dockerfile\nâ”œâ”€â”€ go.mod\nâ”œâ”€â”€ go.sum\nâ”œâ”€â”€ main.go\nâ””â”€â”€ makefile\n\n6 directories, 8 files\n```\n\n### åœ¨é•œåƒç³»ç»Ÿä¸­å®‰è£…è¯ä¹¦\n\næ ¹æ®ä¸Šè¿°çš„ä¸ºç³»ç»Ÿå®‰è£…è¯ä¹¦çš„æ­¥éª¤ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `init-container` æŠŠè¯ä¹¦å®‰è£…åˆ°åº”ç”¨çš„`pod`ä¸­ã€‚æ³¨æ„ä¸€äº›é•œåƒæ˜¯æ²¡æœ‰é»˜è®¤å®‰è£…`ca-certificates ` éœ€è¦é¢å¤–å®‰è£…æˆ–è€…æŠŠç‰©ç†æœºçš„è¯ä¹¦`COPY`åˆ°é•œåƒå†…\n\n1. é¦–å…ˆå…ˆæŠŠè¯ä¹¦crt applyåˆ°k8sçš„secretä¸­\n\n```shell\nkubectl create secret generic ssl-test-web-crt --from-file=./ssl.test.com.crt --dry-run=client  -o yaml  | kubectl apply -f -\n```\n\n2. ä½¿ç”¨`init-container` æŠŠè¯ä¹¦ç”Ÿæˆåˆ°`ca-certificates.crt`ä¸­ï¼ŒåŒæ—¶æŠŠæ–°çš„è¯ä¹¦æŒ‚è½½åˆ°åº”ç”¨çš„`Pod`ä¸­\n\n```yaml\napiVersion: kustomize.config.k8s.io/v1beta1\nkind: Kustomization\n\n....\n\npatchesJson6902:\n  - target:\n      group: apps\n      version: v1\n      kind: Deployment\n      name: https-client\n    patch: |-\n    .....\n      - op: add\n      # æŠŠåŒ…å«è¯ä¹¦çš„secretæŒ‚è½½åˆ°volumesä¸­\n        path: /spec/template/spec/volumes/-\n        value:\n          name: ssl-test-web-crt\n          secret:\n            secretName: ssl-test-web-crt\n      - op: add\n      # æŠŠç”Ÿæˆå¥½çš„ca-certificates.crtæŒ‚è½½åˆ°åº”ç”¨ä¸Š\n        path: /spec/template/spec/containers/0/volumeMounts/-\n        value:\n          name: ssl-certs\n          mountPath: /etc/ssl/certs/\n      - op: add\n      # ä½¿ç”¨emptyDiræ¥ä¸´æ—¶ä¿å­˜ç”Ÿæˆçš„ca-certificates.crt\n        path: /spec/template/spec/volumes/-\n        value:\n          name: ssl-certs\n          emptyDir: {}\n      - op: add\n        path: /spec/template/spec/initContainers\n        value:\n          - name: init-container\n            image: debian\n            command: [\"/bin/sh\", \"-c\", \"update-ca-certificates --fresh && cp -r /etc/ssl/certs/* /mnt/ssl-certs/\" ]\n            volumeMounts:\n              - name: ssl-test-web-crt\n                mountPath: /usr/local/share/ca-certificates/\n              - name: ssl-certs\n                mountPath: /mnt/ssl-certs\n```\n\n3. ä½¿ç”¨ `kubectl apply -k ./deploy/overlays/uat/`éƒ¨ç½²è¯¥ç¯å¢ƒ\n\næŸ¥çœ‹æ—¥å¿—å¯¹åº”çš„æ—¥å¿—ï¼Œå‘ç°`init-container`ç”Ÿæˆæ–°è¯ä¹¦ï¼Œå¹¶ä¸”åº”ç”¨httpsè®¿é—®æˆåŠŸ\n\n![log](.\\uat-log.png)\n\n### ä½¿ç”¨trust-manager\n\nåœ¨`certs-manager`çš„æ–‡æ¡£ä¸­æœ‰ä¸€ä¸ªå«`trust-manager`çš„ç»„ä»¶[trust-manager - cert-manager Documentation](https://cert-manager.io/docs/trust/trust-manager/)\n\n>trust-manager is the easiest way to manage trust bundles in Kubernetes and OpenShift clusters.\n>\n>It orchestrates bundles of trusted X.509 certificates which are primarily used for validating certificates during a TLS handshake but can be used in other situations, too.\n\n- ä½ å¯ä»¥å•ç‹¬å®‰è£…`trust-manager`ï¼Œä½¿ç”¨é‡Œé¢çš„`bundles`æ¥é…ç½®è¯ä¹¦https://cert-manager.io/docs/trust/trust-manager/installation/#installing-trust-manager-without-cert-manager\n\n- ä¹Ÿå¯ä»¥å®‰è£…`certs-manager`å’Œ`trust-manager`ï¼Œä½¿ç”¨`certs-manager`ç”Ÿæˆè‡ªç­¾è¯ä¹¦ï¼Œç„¶åé…ç½®åˆ°`trust-manager`ä¸­ https://cert-manager.io/docs/trust/trust-manager/#quick-start-example\n\næˆ‘è¿™é‡Œç›´æ¥åªå®‰è£…`trust-manager`ä½¿ç”¨`bundles`æ¥é…ç½®è¯ä¹¦\n\n- å…ˆé€šè¿‡`helm`å®‰è£…`trust-manager`\n  - æ³¨æ„å®‰è£…çš„æ—¶å€™æœ‰ä¸€ä¸ª`app.trust.namespace`çš„é…ç½®(é»˜è®¤å€¼ä¸ºcert-manager)ï¼Œè¿™ä¸ªé…ç½®å®šä¹‰äº†é‚£äº›`namespace`ä¸‹çš„`Secret`å¯ä»¥è¢«è¯»å–ï¼Œè¿™æ ·ä¿è¯äº†åº”ç”¨çš„å®‰å…¨ https://cert-manager.io/docs/trust/trust-manager/installation/#trust-namespace\n\n> By default, the trust namespace is the only namespace where`Secret`s will be read. This restriction is in place for security reasons - we don't want to give trust-manager the permission to read all `Secret`s in all namespaces. With additional configuration, secrets may be read from or written to other namespaces.\n\n```yaml\nhelm repo add jetstack https://charts.jetstack.io --force-update\nhelm upgrade trust-manager jetstack/trust-manager \\\n  --install \\\n  --namespace cert-manager \\\n  --wait\n# å¯ä»¥åˆ©ç”¨ helm template å‘½ä»¤ç”Ÿæˆå¯¹åº”çš„helm value \nhelm template \\\n  trust-manager jetstack/cert-manager \\\n  --namespace cert-manager \n  > cert-manager.custom.yaml\n```\n\n- å…ˆæŠŠè¯ä¹¦å¯¼å…¥åˆ°`trust-namespace`çš„ \n\n```yaml\nkubectl create secret generic ssl-test-web-crt --from-file=./ssl.test.com.crt --dry-run=client -n cert-manager  -o yaml  | kubectl apply -f -   \n```\n\n- ç¼–å†™å¯¹åº”çš„`Bundle`\n  - `Bundle`ä¼šè‡ªå·±åœ¨å¯¹åº”çš„`namespcae`ä¸‹é¢ç”Ÿæˆä¸€ä¸ª `public-bundle` çš„ `configMap`\n\n```yaml\napiVersion: trust.cert-manager.io/v1alpha1\nkind: Bundle\nmetadata:\n  name: public-bundle\nspec:\n  sources:\n# ä¸ºtrueä¼šå¸®ä½ æ›´æ–°å¯¹åº”å®¹å™¨ä¸­çš„CAè¯ä¹¦\n# https://cert-manager.io/docs/trust/trust-manager/#securely-maintaining-a-trust-manager-installation\n  - useDefaultCAs: true\n  - secret:\n      name: \"ssl-test-web-crt\"\n      key: \"ssl.test.com.crt\"\n  target:\n    configMap:\n      key: \"ca-certificates.crt\"\n# è¿™é‡Œè¦ç»™å¯¹åº”è¦ç”Ÿæˆ public-bundle configMap çš„namespace æ‰“ä¸Šlabel\n# kubectl label ns default trust=enabled\n    namespaceSelector:\n      matchLabels:\n        trust: enabled\n```\n\n- æˆ‘ä»¬åªéœ€è¦åœ¨å¯¹åº”çš„å®¹å™¨ä¸­æŒ‚è½½`public-bundle`åˆ°`/etc/ssl/certs`\n\n```yaml\napiVersion: kustomize.config.k8s.io/v1beta1\nkind: Kustomization\n\nresources:\n- ../../base\n\n.....\n\npatchesJson6902:\n  - target:\n      group: apps\n      version: v1\n      kind: Deployment\n      name: https-client\n    patch: |-\n.....\n      - op: add\n        path: /spec/template/spec/volumes/-\n        value:\n        #å£°æ˜Volumes\n          name: public-bundle\n          configMap:\n            name: public-bundle\n            defaultMode: 0644\n            optional: false\n      - op: add\n        path: /spec/template/spec/containers/0/volumeMounts/-\n        value:\n        # VolumeMounts æŒ‚è½½åˆ°/etc/ssl/certs/\n          name: public-bundle\n          mountPath: /etc/ssl/certs/\n          readOnly: true\n\nimages:\n  - name: https-client\n    newTag: v1.0\n    newName: https-client\n```\n\n- å¦‚æœæˆåŠŸäº†ï¼Œåœ¨å®¹å™¨ä¸­å°±ä¼šå¦‚ä¸‹æ˜¾ç¤º\n\n```shell\nroot@https-client-6b74cfbddd-2nw2r:/app# ls -ltr /etc/ssl/certs/ca-certificates.crt              \nlrwxrwxrwx. 1 root root 26 Mar 23 06:26 /etc/ssl/certs/ca-certificates.crt -> ..data/ca-certificates.crt\n```\n\n# æœ€å\n\nå¯¹æ¯”ä¸Šè¿°çš„ä¸¤ç§æ–¹æ³•\n\nç¬¬ä¸€ç§æ–¹æ³•æˆ‘è§‰å¾—æ¯”è¾ƒç®€å•ï¼Œæ— é¡»é¢å¤–å®‰è£…å…¶å®ƒç»„ä»¶ï¼Œä½†æ˜¯å¯¹é…ç½®çš„å…¥ä¾µæ€§æ¯”è¾ƒé«˜ï¼Œéœ€è¦é¢å¤–é…ç½®ä¸€ä¸ªæœ‰`ca-certificates`çš„`init-container`\n\nç¬¬äºŒç§æ–¹æ³•éœ€è¦é¢å¤–å®‰è£…å¤šä¸€ä¸ª`trust-manager`ï¼Œä½†æ˜¯è½å®åˆ°å…·ä½“çš„`Pod`é…ç½®åªéœ€è¦é¢å¤–æŒ‚è½½ä¸€ä¸ª `ConfigMap` åˆ°å¯¹åº”çš„è¯ä¹¦è·¯å¾„å³å¯ï¼ŒåŒæ—¶å¯¹åº”çš„`bundle/public-bundle`ä¹Ÿæ˜¯æ”¯æŒè‡ªåŠ¨æ›´æ–°çš„ï¼Œå³ä½ çš„`secret`æ›´æ–°äº†ï¼Œå®ƒä¹Ÿä¼šè‡ªåŠ¨åŒæ­¥ã€‚\n\n```shell\n[root@rocky-testing ~]# kubectl get events\nLAST SEEN   TYPE     REASON              OBJECT                               MESSAGE\n52m         Normal   Synced              bundle/public-bundle                 Successfully synced Bundle to namespaces that match this label selector: trust=enabled\n```\n\nå½“ç„¶é™¤äº†ä¸Šè¿°ä¸¤ç§æ–¹æ³•ï¼Œè¿˜æœ‰æ²¡æœ‰**æ›´ç®€å•çš„æ–¹æ³•ï¼Œç”šè‡³ä¸éœ€è¦é¢å¤–çš„é…ç½®**ğŸ¤”\n\næœ‰çš„ï¼å¦‚æœä½ å…¬å¸æœ‰ä¸€ä»½æ”¯æŒå¤šåŸŸåçš„è¯ä¹¦ï¼Œå°±å¯ä»¥ç›´æ¥ä½¿ç”¨è¯¥ crt(ä¸€èˆ¬å«åšxxx_chain.crtæˆ–è€….pem) å’Œ key\n\nå¦‚ä½•æŸ¥çœ‹ï¼Ÿä½¿ç”¨ `openssl x509 -noout -text -in server.crt` æŸ¥çœ‹è¯ä¹¦ä¿¡æ¯ ç±»ä¼¼å¦‚ä¸‹\n\n```text\n            Â·Â·Â·Â·Â·Â·Â·\n # å¦‚æœ SAN (Subject Alternative Name) ä¸­åŒ…å«å¤šä¸ªåŸŸå æˆ–è€… é€šé…ç¬¦ *.test.com \n            X509v3 Subject Alternative Name: \n                DNS:*.test.com, DNS:test.com, DNS:abc.test.com\n    Signature Algorithm: sha256WithRSAEncryption\n    Signature Value:\n    Â·Â·Â·Â·Â·Â·\n```\n\nè¿™æ ·ä½ å°±å¯ä»¥ç”¨ `abc.test.com` ç­‰ç±»ä¼¼çš„`xxx.test.com` çš„äºŒçº§åŸŸå (æ³¨æ„ä¸‰çº§ä¸è¡Œ å¦‚ `xxx.adb.test.com`)\n\nå†é€šè¿‡ä¿®æ”¹hostsæˆ–è€…k8sä¸­çš„corednsï¼Œå°±å¯ä»¥ä½¿ç”¨ä¸éœ€è¦é¢å¤–é…ç½®ä½¿ç”¨`Https`äº† ğŸ˜Š","tags":["k8s","certs","è¾¹åšè¾¹å­¦"]},{"title":"Mysqlæ‰§è¡Œè¿‡é•¿æ’æŸ¥","url":"/2025/01/05/Mysqlæ‰§è¡Œè¿‡é•¿æ’æŸ¥/","content":"\n\n> å¼€å‘ååº”è¯´åº”ç”¨çš„æŸä¸ªæ¥å£è¿”å›è¿‡æ…¢ï¼ŒæŸ¥çœ‹æ—¥å¿—åå‘ç°ç¡®å®æœ‰ä¸€ä¸ªæ¥å£çš„sqlæ‰§è¡Œäº†20s\n\n![log](.\\log.jpg)\n\n# æ’æŸ¥\n\n## sqlä¼˜åŒ–\n\nè¾“å…¥sqlæ‰§è¡Œå‘ç°æ‰§è¡Œæ—¶é—´å¾ˆçŸ­è€Œä¸”æ•´ä¸ªæ•°æ®åº“çš„æ•°æ®é‡ä¸æ˜¯å¾ˆå¤§ï¼Œæ‰€ä»¥å¯ä»¥æ’æŸ¥sqlä¼˜åŒ–çš„é—®é¢˜\n\n## ç½‘ç»œæ’æŸ¥\n\nç¯å¢ƒï¼šåº”ç”¨åœ¨143ä¸Šé¢ï¼Œæ•°æ®åº“åœ¨142ä¸Šé¢ï¼Œæ•°æ®åº“ç«¯å£13360\n\nåˆ©ç”¨tcpdump+wireshark è¿›è¡ŒæŠ“åŒ…\n\n```shell\ntcpdump -i bond4.128 port 13360 -w ./mysql_cap\n```\n\nä½¿ç”¨wiresharkæ‰“å¼€é€‰ä¸­å¯ç”¨çš„æ•°æ®æµï¼Œæ‰¾åˆ°å¯¹åº”çš„sqlæ•°æ®tcpæµ\n\n![cap](.\\cap.jpg)\n\nåˆ†æå‘ç°ä»tcpæ¡æ‰‹åˆ°æ•°æ®åº“å¯†ç è®¤è¯ï¼Œç»å†äº†20ç§’(52-105)ï¼Œåé¢æ‰§è¡Œæ•°æ®åº“ç”¨çš„æ—¶é—´å¹¶ä¸å¤š(105-116)\n\n![cap1](.\\cap1.jpg)\n\nå¯ä»¥æ–­å®šæ˜¯æ•°æ®åº“åˆå§‹åŒ–è¿æ¥çš„é—®é¢˜ï¼ŒæŸ¥è¯¢ç›¸å…³ä¿¡æ¯å‘ç°æœ‰ä¸€ä¸ªç›¸å…³é…ç½®\n\n```shell\n[mysqld]\nskip-name-resolve\n```\n\nä¿®æ”¹è¯¥é…ç½®åï¼Œæ•°æ®è®¿é—®æ­£å¸¸äº†\n\n# æ‰©å±•\n\n## ä½œç”¨\n\né‚£ä¸ªè¿™ä¸ª `skip-name-resolve`çš„é…ç½®æœ‰ä»€ä¹ˆä½œç”¨ ä¸ºä»€ä¹ˆä¼šå¯¼è‡´é“¾æ¥è¶…æ—¶\n\nè¿™ä¸ªä¸»è¦ä½œç”¨æ˜¯æŠŠipå˜æˆhost æˆ–è€… hostæ˜ å°„æˆipçš„åŠŸèƒ½ï¼Œç„¶åæ”¾åˆ°ä¸€ä¸ªhost cacheé‡Œé¢ [ç›¸å…³æ–‡æ¡£](https://dev.mysql.com/doc/refman/8.4/en/host-cache.html)\n\né‚£Mysqlä¸ºä»€ä¹ˆè¦è¿™æ ·åšæï¼Ÿ\n\nå› ä¸ºMysqlä¼šç”¨è¿™ä¸ªhost cacheæ¥è¿½è¸ªè¿™ä¸ªhostçš„é”™è¯¯æƒ…å†µï¼Œå¯¹åº”çš„ç›¸å…³é…ç½® `max_connect_errors` \n\n![doc](.\\doc.png)\n\n## æµç¨‹\n\nè¯¦ç»†çš„æ•°æ®åº“è¿æ¥å’Œå¯¹åº”çš„host cacheå»ºç«‹ ä¹Ÿåœ¨æ–‡æ¡£é‡Œé¢æœ‰è¯´æ˜\n\nå¤§æ¦‚æµç¨‹\n\n+ ç¬¬ä¸€æ¬¡tcp clinetè¿æ¥åˆ°è¾¾çš„æ—¶å€™ï¼ŒMysqlå°±ä¼šåˆå§‹åŒ–å¯¹åº”çš„cacheå®ä¾‹\n+ serverå°±ä¼šå°è¯•å»æŠŠ IP to host æˆ–è€… name to host ä½¿ç”¨ DNS è§£æ\n+ å¦‚æœè¯¥è¿æ¥å‘ç”Ÿé”™è¯¯ å°±ä¼šæŠŠæ•°æ®è®°å½•ä¸‹æ¥ \n\n![doc](.\\doc1.png)\n\n## æœ€å\n\nè¿™å°±æ˜¯ä¸ºä»€ä¹ˆåœ¨tcpä¸‰æ¬¡æ¡æ‰‹åä¼šç­‰å¾…å¤§æ¦‚20ç§’å·¦å³ï¼Œå°±æ˜¯mysqlå°è¯•æŠŠè¿æ¥ipè§£æhostçš„è¡Œä¸º\n\nå½“ç„¶äº†ï¼Œè¿™ä¸ªipæ˜¯è§£æä¸åˆ°hostçš„æ‰€ä»¥å°±ä¼šå‡ºç°é”™è¯¯ï¼Œåœ¨docker log å¯ä»¥çœ‹åˆ°å¯¹åº”é”™è¯¯\n\n![mysql-log](.\\mysql-log.png)\nä¸ºä»€ä¹ˆè¯´æ˜¯`172.17.0.1`è¿™ä¸ªipè§£æé”™è¯¯æï¼Œä¸æ˜¯ä¸Šè¿°çš„143è¿™ä¸ªipï¼Ÿ\n\né‚£æ˜¯å› ä¸ºmysqlæ˜¯è·‘åœ¨dockerä¸Šé¢çš„ è€Œæµé‡ä¼šç»è¿‡dockerçš„ç½‘å¡å†åˆ°å®¹å™¨é‡Œé¢ï¼Œè€Œdockerçš„ç½‘å¡å°±æ˜¯`172.17.0.1`\n\n![docker-bridge](.\\docker-bridge.png)\n\n","tags":["mysql","æ’éšœ"]},{"title":"k8s-jenkins-æ„å»ºæŒç»­äº¤ä»˜æµæ°´çº¿","url":"/2024/08/23/k8s-jenkins-æ„å»ºæŒç»­äº¤ä»˜æµæ°´çº¿/","content":"\n> æœ¬æ¬¡é…ç½®å’Œä»£ç éƒ½åœ¨[github](https://github.com/kehaha-5/k8s_demo)ä¸Š \n\nä½¿ç”¨æ–¹æ³•:\n\n> `git clone https://github.com/kehaha-5/k8s_demo`\n> `cd k8s_demo`\n> `git fetch --all`\n> `git checkout -b tag 2.0`\n\n# æ¦‚è¦\n\n## ç¯å¢ƒ\n\næœ¬æ¬¡çš„ç¯å¢ƒè·Ÿä¸Šä¸€ç« [ä»é›¶åˆ°ä¸€--æ­å»ºwebé¡¹ç›®é›†ç¾¤ - kehaha-5](https://kehaha-5.github.io/2024/08/16/ä»é›¶åˆ°ä¸€--æ­å»ºwebé¡¹ç›®é›†ç¾¤/)çš„ç¯å¢ƒä¸€æ‘¸ä¸€æ ·ï¼Œéƒ½æ˜¯ä½¿ç”¨`k3s`æ¥è¿›è¡Œé›†ç¾¤çš„æ­å»º\n\n## æµç¨‹\n\nè¿™æ¬¡ç”¨åˆ°äº†k8sé›†ç¾¤+jenkins+harboræ„å»ºæŒç»­äº¤ä»˜æµæ°´çº¿\n\n1. æ‰‹åŠ¨åœ¨jenkinsä¸­è§¦å‘æ„å»º\n2. æ‹‰å»`git`é¡¹ç›®ä»£ç \n3. åˆ†åˆ«æ„å»º`vue3`å‰ç«¯ å’Œ `go` åç«¯é¡¹ç›® [k8s_demo/web at main Â· kehaha-5/k8s_demo (github.com)](https://github.com/kehaha-5/k8s_demo/tree/main/web)\n4. ä¿®æ”¹`k8s`éƒ¨ç½²æ–‡ä»¶ï¼Œæ·»åŠ ç‰ˆæœ¬å·å’Œ `kubernetes.io/change-cause`\n5. æ›´æ–°`k8s`éƒ¨ç½²\n\nè¿™æ¬¡æ²¡æœ‰ç§æœ‰åŒ–éƒ¨ç½²`gitlab`æ˜¯å› ä¸ºæ²¡æœ‰ç”¨åˆ°`webhook`ï¼Œæ˜¯ç›´æ¥é€šè¿‡jenkinsç›´æ¥è§¦å‘æ„å»ºç„¶åæ‹‰å»çš„ä»£ç \n\n# Harbor\n\né¦–å…ˆè¦å…ˆéƒ¨ç½²`harbor`ä½œä¸ºç§æœ‰é•œåƒä»“åº“ï¼Œæ–¹ä¾¿ä¸Šä¼ åç»­æ„å»ºçš„ç§æœ‰é•œåƒå’Œæ‰€éœ€è¦çš„é•œåƒã€‚\n\nè¿™æ¬¡éƒ¨ç½²ä¼šå»é…ç½®harborçš„`tls ` [Harbor docs | Configure HTTPS Access to Harbor (goharbor.io)](https://goharbor.io/docs/2.0.0/install-config/configure-https/) æŒ‰ç€è¯¥æ–‡æ¡£å°±å¯ä»¥ç”Ÿæˆå¯¹åº”çš„åŸŸåè¯ä¹¦ï¼Œå¹¶ä¸”è¦é…ç½®`k3s`çš„ç§æœ‰ä»“åº“é…ç½®[Private Registry Configuration | K3s](https://docs.k3s.io/installation/private-registry)ï¼ŒåŒæ—¶åœ¨æˆ‘çš„`ubuntu`ç³»ç»Ÿä¸Šé¢è¿˜è¦è¿›è¡Œ`update-ca-certificates` [Harbor docs | Troubleshooting Harbor Installation (goharbor.io)](https://goharbor.io/docs/2.0.0/install-config/troubleshoot-installation/)\n\nåœ¨ç”Ÿæˆå¥½è¯ä¹¦ä»¥åè¿˜è¦æŠŠè¯ä¹¦é…ç½®åˆ°`secret`\n\n```yaml\napiVersion: v1\nkind: Secret\nmetadata:\n  name: my-harbor-tls\n  namespace: devops-tools  \ntype: kubernetes.io/tls\ndata:\n  tls.crt: |\n    LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0t....\n  tls.key: |\n    LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tL....\n    \n```\n\nè¿™æ¬¡å®‰è£…æ˜¯é€šè¿‡`helm`æ¥å®‰è£…ï¼Œæ‰€ä»¥éœ€è¦ä¿®æ”¹`value.yaml`æ¥è¿›è¡Œè¯¦ç»†é…ç½® [Harbor docs | Deploying Harbor with High Availability via Helm (goharbor.io)](https://goharbor.io/docs/2.0.0/install-config/harbor-ha-helm/)\n\nè¿™é‡Œè¯´ä¸€ä¸‹æˆ‘çš„`expose`é…ç½®ï¼Œæˆ‘æ˜¯è¦é€šè¿‡`ingress`æ¥è¿›è¡Œå¯¹å¤–æš´éœ²çš„ï¼Œå› ä¸ºæˆ‘è‡ªå·±ç”Ÿæˆäº†tlsè¯ä¹¦ï¼Œæ‰€ä»¥`certSource`è¦æ”¹æˆ`secret`ï¼Œå¹¶ä¸”æŠŠ`secretName: `æ”¹æˆæˆ‘ä¸Šè¿°é…ç½®çš„secretä¸­\n\n```yaml\n  ....\n  type: ingress\n  tls:\n    enabled: true\n    # The source of the tls certificate. Set as \"auto\", \"secret\"\n    # or \"none\" and fill the information in the corresponding section\n    # 1) auto: generate the tls certificate automatically\n    # 2) secret: read the tls certificate from the specified secret.\n    # The tls certificate can be generated manually or by cert manager\n    # 3) none: configure no tls certificate for the ingress. If the default\n    # tls certificate is configured in the ingress controller, choose this option\n    certSource: secret\n    auto:\n      # The common name used to generate the certificate, it's necessary\n      # when the type isn't \"ingress\"\n      commonName: \"\"\n    secret:\n      # The name of secret which contains keys named:\n      # \"tls.crt\" - the certificate\n      # \"tls.key\" - the private key\n      secretName: \"my-harbor-tls\"\n\tingress:\n      hosts:\n        core: harbor.k8s.demo\n    ....\n```\n\nå…¶ä»–çš„æŒ‰éœ€é…ç½®å³å¯\n\n![harbor](.\\1.png)\n\nåœ¨æˆåŠŸéƒ¨ç½²ä»¥åï¼Œå…ˆæŠŠé¡¹ç›®éœ€è¦åˆ°çš„é•œåƒè¿›è¡Œæ„å»ºå’Œä¸Šä¼ \n\n```Dockerfile\nFROM alpine:3.20.2\nRUN set -eux && sed -i 's/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g' /etc/apk/repositories\nRUN apk update && apk add tzdata\n```\n\nå…ˆæ„å»ºåç«¯åŸºç¡€é•œåƒï¼Œåˆ°æ—¶å€™å°±æµæ°´çº¿ä¸­ç›´æ¥ä½¿ç”¨ï¼Œä¸éœ€è¦è€Œå¤–ä¸‹è½½æ‰€éœ€è¦çš„åŒ…ï¼ŒèŠ‚çº¦æµæ°´çº¿æ—¶é—´\n\nåŒæ—¶åœ¨`docker login`ä»¥åæŠŠé…ç½®æ–‡ä»¶ä¿å­˜åˆ°`Secret`é‡Œé¢ï¼Œæ–¹ä¾¿åç»­åœ¨æµæ°´çº¿ä¸­è¿›è¡Œé•œåƒä¸Šä¼ \n\n```yaml\n#harborLoginSecret.yaml\napiVersion: v1\nkind: Secret\nmetadata:\n  name: harbor-login\n  namespace: devops-tools  # Specify your namespace\ntype: kubernetes.io/dockerconfigjson\ndata:\n  .dockerconfigjson: ewoJImF1dGhzIjogewoJCSJoYXJib3IuazhzLmRlbW8iOiB7CgkJCSJhdXRoIjogIllXUnRhVzQ2U0dGeVltOXlNVEl6TkRVPSIKCQl9Cgl9Cn0=\n```\n\n# Jenkins\n\nè¿™é‡ŒæŒ‰ç€å®˜æ–¹æ–‡æ¡£[Kubernetes (jenkins.io)](https://www.jenkins.io/doc/book/installing/kubernetes/)åœ¨k8sä¸­éƒ¨ç½²jenkins\n\nå…¶ä¸­å› ä¸ºjenkinsåœ¨æµæ°´çº¿ä¸­ä¼šä½¿ç”¨åˆ°`kubernetes`çš„`agents` [Using Jenkins agents](https://www.jenkins.io/doc/book/using/using-agents/)ï¼Œæ‰€ä»¥è¿™é‡Œå†serviceä¸­è¦åŒæ—¶ä»£ç†`50000`ç«¯å£çš„æµé‡ï¼Œè®©`agents`å¯ä»¥å’Œ`jenkins`å¯ä»¥è¿›è¡Œè¿æ¥ [Jenkins Remoting](https://www.jenkins.io/projects/remoting/)\n\n```yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: jenkins-service\n  namespace: devops-tools\n  annotations:\n      prometheus.io/scrape: 'true'\n      prometheus.io/path:   /\n      prometheus.io/port:   '8080'\nspec:\n  selector:\n    app: jenkins-server\n  type: NodePort\n  ports:\n    - port: 8080\n      name: httpport\n      targetPort: 8080\n      nodePort: 32000\n    - port: 50000\n      name: jnlpport\n      targetPort: 50000\n      nodePort: 32500\n```\n\n![jenkins](.\\2.png)\n\n## gité…ç½®\n\nè¿™é‡Œè¦å»ç³»ç»Ÿé…ç½®é‡Œé¢çš„å‡­è¯é‡Œé¢é…ç½®ä¸€ä¸ª`SSH Username with private key`ï¼Œè¿™æ ·æ‰å¯ä»¥é€šè¿‡`git`æ¥æ‹‰å»ç§æœ‰ä»“åº“\n\nåŒæ—¶è¿˜è¦å†`å®‰å…¨é…ç½®`é‡Œé¢é…ç½®`Git Host Key Verification Configuration` æŠŠå®ƒé…ç½®ä¸º**Accept first connection**\n\n> Controls how Git plugin verifies the keys presented by the host during SSH connecting.\n>\n> - Known hosts file (default)\n>\n>   Verifies all host keys using the `known_hosts` file.\n>\n> - Accept first connection\n>\n>   Automatically adds host keys to the `known_hosts` file if the host has not been seen before, and does not allow connections to previously-seen hosts with modified keys.\n>\n>   - Note that when using ephemeral agents (ex. cloud agents), this strategy is essentially equivalent to **No verification** because it uses the `known_hosts` file on the agent. To avoid this, you can pre-configure `known_hosts` with all relevant hosts when creating the images or templates used to define your agents, or use the **Manually provided keys** or **Known hosts file** strategies.\n>\n>   - OpenSSH version 7.6 or higher is required to use this option with command line Git.\n>\n> - Manually provided keys\n>\n>   Verifies all host keys using a set of keys manually configured here.\n>\n> - No verification (not recommended)\n>\n>   Does not verify host keys at all.\n\n## Kubernetes \n\nå¯¹åº”k8sçš„é…ç½®ï¼Œå…ˆè¦å»ä¸‹è½½Kubernetesçš„æ’ä»¶[Kubernetes | Jenkins plugin](https://plugins.jenkins.io/kubernetes/)\n\nå¹¶ä¸”åœ¨ç³»ç»Ÿçš„`clouds`ä¸­æ·»åŠ ä¸€ä¸ªk8sé›†ç¾¤ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ª`Kubernetes åœ°å€`å¯ä»¥ä¸ç”¨è¿›è¡Œé…ç½®ï¼Œå› ä¸ºæˆ‘çš„jenkinsæ˜¯éƒ¨ç½²åœ¨k8sé›†ç¾¤é‡Œé¢çš„ï¼Œåœ¨æ¯ä¸ªpodséƒ½å¯ä»¥è®¿é—®å…¶è‡ªèº«çš„k8sé›†ç¾¤ [ä» Pod ä¸­è®¿é—® Kubernetes API | Kubernetes](https://kubernetes.io/zh-cn/docs/tasks/run-application/access-api-from-pod/)\n\n> **ç›´æ¥è®¿é—® REST API**\n>\n> åœ¨è¿è¡Œåœ¨ Pod ä¸­æ—¶ï¼Œä½ çš„å®¹å™¨å¯ä»¥é€šè¿‡è·å– `KUBERNETES_SERVICE_HOST` å’Œ `KUBERNETES_SERVICE_PORT_HTTPS` ç¯å¢ƒå˜é‡ä¸º Kubernetes API æœåŠ¡å™¨ç”Ÿæˆä¸€ä¸ª HTTPS URLã€‚ API æœåŠ¡å™¨çš„é›†ç¾¤å†…åœ°å€ä¹Ÿå‘å¸ƒåˆ° `default` å‘½åç©ºé—´ä¸­åä¸º `kubernetes` çš„ Service ä¸­ï¼Œ ä»è€Œ Pod å¯ä»¥å¼•ç”¨ `kubernetes.default.svc` ä½œä¸ºæœ¬åœ° API æœåŠ¡å™¨çš„ DNS åç§°ã€‚\n\n### åœ¨K8Sä¸­åŠ¨æ€åˆ›å»ºä»£ç†\n\nJenkinsæ„å»ºé¡¹ç›®æ—¶ï¼Œå¹¶è¡Œæ„å»ºï¼Œå¦‚æœå¤šä¸ªé¡¹ç›®åŒæ—¶æ„å»ºå°±ä¼šæœ‰ç­‰å¾…ã€‚æ‰€ä»¥è¿™é‡Œé‡‡ç”¨`master/slave`æ¶æ„\n\nè¿™é‡Œå®˜æ–¹æ˜¯æä¾›äº†åŸºç¡€çš„`slave`é•œåƒ [jenkins/inbound-agent - Docker Image | Docker Hub](https://hub.docker.com/r/jenkins/inbound-agent/)\n\nä½†æ˜¯æˆ‘æ˜¯éœ€è¦`node`å’Œ`go`ç¯å¢ƒæ¥è¿›è¡Œé¡¹ç›®æ„å»ºçš„ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦åœ¨å®˜æ–¹é•œåƒçš„åŸºç¡€ä¸Šé¢æ·»åŠ æ‰€éœ€è¦çš„æ„å»ºå·¥å…·\n\n```dockerfile\nFROM jenkins/inbound-agent:alpine3.20-jdk17\n\n# åˆ‡æ¢åˆ° root ç”¨æˆ·\nUSER root\n\nRUN set -eux && sed -i 's/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g' /etc/apk/repositories && apk update  &&\\\napk add nodejs npm && npm config set registry https://registry.npmmirror.com/ && \\\nnpm install @vue/cli@5.0.8\n\nCOPY go1.22.6.linux-amd64.tar.gz /app/go1.22.6.linux-amd64.tar.gz\nCOPY kubectl /usr/local/bin/\n\nRUN rm -rf /usr/local/go && \\\n    tar -C /usr/local -xzf /app/go1.22.6.linux-amd64.tar.gz && \\\n    ln -s /usr/local/go/bin/go /usr/local/bin/go && rm -rf /app/go1.22.6.linux-amd64.tar.gz\n\nUSER jenkins\n\n```\n\næŠŠå®ƒæ‰“åŒ…æˆé•œåƒå¹¶ä¸Šä¼ åˆ°ç§æœ‰çš„`harbor`ä¸­\n\n### åœ¨K8sä¸­çš„æƒé™é…ç½®\n\nå› ä¸ºåœ¨æµæ°´çº¿ä¸­ï¼Œä¼šä½¿ç”¨`kubectl`å¯¹ä¸åŒ`namespace`çš„deploymentè¿›è¡Œæ“ä½œæ‰€ä»¥éœ€è¦æœ‰å¯¹åº”çš„æƒé™\n\n```yaml\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: jenkins-prod\n  namespace: devops-tools\n\n--- \n\napiVersion: rbac.authorization.k8s.io/v1\nkind: Role\nmetadata:\n  namespace: prod\n  name: prod-pod-management\nrules:\n- apiGroups: [\"*\"] \n  resources: [\"deployments\"]\n  verbs: [\"*\"]\n\n---\n\napiVersion: rbac.authorization.k8s.io/v1\nkind: RoleBinding\nmetadata:\n  name: jenkins-prod-rolebinding\n  namespace: prod\nsubjects:\n- kind: ServiceAccount\n  name: jenkins-prod\n  namespace: devops-tools\nroleRef:\n  kind: Role\n  name: prod-pod-management\n  apiGroup: rbac.authorization.k8s.io\n\n\n```\n\nè¿™é‡Œåˆ›å»ºäº†ä¸€ä¸ª`jenkins-prod`çš„ç”¨æˆ·ï¼Œå¹¶ä¸”å¯ä»¥æ“ä½œ `namespace`ä¸º ` prod`ä¸‹çš„`deployments`æ‰€æœ‰è¡Œä¸º\n\n- æˆ‘è¿™é‡Œ`jenkins-prod`åªéœ€è¦æ“ä½œ`prod` ä¸‹çš„æƒé™æ‰€ä»¥ä½¿ç”¨`Role`\n- å¦‚æœæƒ³æ“ä½œä»»æ„`namespace`ä¸‹çš„èµ„æº ä½¿ç”¨`ClusterRole `\n- [ä½¿ç”¨ RBAC é‰´æƒ | Kubernetes](https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/rbac/#clusterrole-example)\n\n### æ‰“åŒ…é•œåƒ\n\næˆ‘çš„jenkinisæ˜¯éƒ¨ç½²åœ¨k8sçš„ç¯å¢ƒä¸­ï¼Œæ— æ³•ä½¿ç”¨`docker`æ¥è¿›è¡Œæ‰“åŒ…ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨`kaniko`[GoogleContainerTools/kaniko: Build Container Images In Kubernetes (github.com)](https://github.com/GoogleContainerTools/kaniko)æ¥è¿›è¡Œé•œåƒæ‰“åŒ…å’Œä¸Šä¼ åˆ°ç§æœ‰é•œåƒä»“åº“ï¼Œæ‰€ä»¥éœ€è¦æå‰å‡†å¤‡ä¸€ä»½`docker login`çš„`Secret`\n\n## æµæ°´çº¿\n\nokï¼Œåœ¨ä¸€åˆ‡éƒ½å‡†å¤‡å¥½äº†å°±å¯ä»¥åˆ›å»ºä¸€ä¸ªæµæ°´çº¿é¡¹ç›®ï¼Œå¹¶ç¼–å†™å¯¹åº”æµæ°´çº¿ä»£ç \n\nè¿™é‡Œéœ€è¦æ³¨æ„å‡ ç‚¹ï¼š\n\n- æˆ‘è¦å®šä¹‰äº†`parameters`å°±æ˜¯åœ¨æ‰§è¡Œæµæ°´çº¿å‰ï¼Œè¦è¾“å…¥æœ¬æ¬¡æ„å»ºçš„ç‰ˆæœ¬å·å’Œé•œåƒåœ°å€é…ç½®ï¼Œè¿™æ ·æ‰“åŒ…å‡ºæ¥çš„é•œåƒéƒ½ä¼šå­˜åœ¨ç‰ˆæœ¬ä¿¡æ¯ï¼Œæ–¹ä¾¿è¿½è¸ªå’Œç®¡ç†\n\n```groovy\n    parameters {\n        string(name: 'FRONTEND_VERSION', defaultValue: '1.0.0', description: 'å‰ç«¯ç‰ˆæœ¬å·')\n        string(name: 'BACKEND_VERSION', defaultValue: '1.0.0', description: 'åç«¯ç‰ˆæœ¬å·')\n        string(name: 'HARBOR_IP', defaultValue: '192.168.1.120', description: 'harborä»“åº“ip')\n        string(name: 'HARBOR_REGISTRY', defaultValue: 'harbor.k8s.demo', description: 'harborä»“åº“åœ°å€')\n    }\n```\n\n- åœ¨ä½¿ç”¨`agents`æ—¶è¦è¿›è¡Œä¸€å®šçš„é…ç½®\n\n  - ç¼“å­˜é…ç½®ï¼Œé€šè¿‡nfsæŒ‚è½½`go`å’Œ`npm`çš„ç›®å½•æ¥è¿›è¡Œèµ„æºç¼“å­˜\n\n  - é…ç½®`serviceAccountName`ä¸ºæˆ‘åˆ›å»ºçš„`jenkins-prod` ï¼Œ`serviceAccountName`å¯ä»¥ä¸ºpodæŒ‡å®šä¸€ä¸ªè´¦å·ï¼Œå¦‚æœä¸æŒ‡å®šé‚£ä¹ˆè´¦å·å°†ä¼šæ—¶è¯¥`namespace`ä¸‹çš„`default `å®ƒæ˜¯æ²¡æœ‰æƒé™æ“ä½œå…¶ä»–`namesapce`ä¸‹çš„èµ„æºçš„ [ä¸º Pod é…ç½®æœåŠ¡è´¦å· | Kubernetes](https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-service-account/)\n\n  - å› ä¸ºåœ¨è¿™ä¸ªé•œåƒé‡Œé¢ï¼Œæ‰§è¡Œçš„ç”¨æˆ·æ˜¯`jenkins`ï¼Œä½†æ˜¯æŒ‚è½½ç¼“å­˜çš„æƒé™æ˜¯`root`,æ‰€ä»¥æ˜¯æ— æ³•è®¿é—®åˆ°çš„ï¼Œä½†æ˜¯é€šè¿‡ä¿®æ”¹`securityContext.fsGroup`å®¹å™¨ä¸­æ‰€æœ‰è¿›ç¨‹ä¼šæ˜¯å…¶é™„ç»„IDçš„ä¸€éƒ¨åˆ†ï¼Œæ‰€ä»¥è¿™æ ·å°±å¯ä»¥æŠŠç¼“å­˜çš„æƒé™åˆ†é…åˆ°`jenkins`ä¸­ï¼Œä½¿å…¶æœ‰è¶³å¤Ÿçš„æƒé™æ“ä½œç¼“å­˜\n\n    - é‚£ä¸ºä»€ä¹ˆæ˜¯1000æï¼Ÿå› ä¸ºåœ¨é•œåƒå®šä¹‰çš„æ—¶å€™ï¼Œå°±æŒ‡å®šäº†å®¹å™¨å†…ç”¨æˆ·å’Œç»„ID éƒ½ä¸º1000\n\n      ![alpine3.20-jdk17](.\\3.png)\n\n```groovy\n    agent {\n        kubernetes {\n            yaml '''\n            apiVersion: v1\n            kind: Pod\n            metadata:\n              name: jenkins-slave\n            spec:\n              serviceAccountName: jenkins-prod\n              securityContext:\n                fsGroup: 1000\n              containers:\n              - name: jnlp\n                image: harbor.k8s.demo/library/jenkins/inbound-agent-k8s-demo:alpine3.20-jdk17\n                resources:\n                  limits:\n                    memory: \"1Gi\"\n                    cpu: \"1000m\"\n                  requests:\n                    memory: \"256Mi\"\n                    cpu: \"250m\"\n                volumeMounts:  \n                  - name: go-cache\n                    mountPath: /home/jenkins/go\n                  - name: npm-cache\n                    mountPath: /home/jenkins/.npm\n              volumes:  \n              - name: go-cache\n                nfs:\n                  server: 192.168.1.125  \n                  path: /mnt/nfs_share/go-cache  \n              - name: npm-cache\n                nfs:\n                  server: 192.168.1.125  \n                  path: /mnt/nfs_share/npm-cache  \n            '''\n        }\n    }\n```\n\n- åœ¨æ„å»ºé•œåƒæ—¶ï¼Œä½¿ç”¨äº†`kaniko`ä½œä¸º`agents`\n  - è¿™é‡Œä½¿ç”¨çš„ç‰ˆæœ¬ä¸º`debug`å› ä¸ºæµç¨‹æ˜¯å¯åŠ¨`agents`ï¼Œç­‰å¾…jnlpå¯¹å…¶è¿›è¡Œè¿æ¥ï¼Œè¿æ¥æˆåŠŸäº†æ‰å¯ä»¥ä½¿ç”¨ï¼Œæ‰€ä»¥ä¸èƒ½è®©podé€€å‡ºï¼Œè€Œ`debug`çš„ç‰ˆæœ¬æ˜¯æœ‰` busybox shell ` å¯ä»¥ä½¿ç”¨`sleep 99d`æ˜¯podä¸ä¼šé€€å‡º\n  - è¿™é‡Œå°±æ˜¯æŒ‚è½½äº†ä¸Šè¿°é…ç½®çš„`docker login`åçš„`config.json`æ–‡ä»¶ï¼Œä¿è¯äº†æ¨é€åˆ°ç§æœ‰ä»“åº“çš„æƒé™\n\n```groovy\n\tagent {\n                kubernetes {\n                    yaml '''\n                    apiVersion: v1\n                    kind: Pod\n                    metadata:\n                      labels:\n                        app: kaniko\n                    spec:\n                      containers:\n                      - name: kaniko\n                        image: harbor.k8s.demo/library/kaniko-project/executor:v1.23.2-debug\n                        command: [\"sleep\",\"99d\"]\n                        volumeMounts:\n                        - name: kaniko-secret\n                          mountPath: /kaniko/.docker\n                      volumes:\n                        - name: kaniko-secret\n                          secret:\n                            secretName: harbor-login\n                            items:\n                              - key: .dockerconfigjson\n                                path: config.json\n                    '''\n                }\n            }\n```\n\n- æ„å»ºé•œåƒå‘½ä»¤\n  - åœ¨æ„å»ºçš„æ—¶å€™éœ€è¦æŠŠæ‰€éœ€è¦çš„æ–‡ä»¶ä»ä¸Šä¸€ä¸ª`steps`ä¸­è·å–ï¼Œè¿™é‡Œä½¿ç”¨äº†`stash`å’Œ`unstash`  [Pipeline: Basic Steps (jenkins.io)](https://www.jenkins.io/doc/pipeline/steps/workflow-basic-steps/#stash-stash-some-files-to-be-used-later-in-the-build)\n    - åœ¨å°æ–‡ä»¶çš„æ—¶å€™å¯ä»¥è¿™æ ·ä½¿ç”¨ï¼Œä½†æ˜¯å¦‚æœæ–‡ä»¶è¿‡å¤šæˆ–å¤ªå¤§ï¼Œä¼šå½±å“æµæ°´çº¿æ‰§è¡Œçš„æ•ˆç‡ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥è€ƒè™‘ä½¿ç”¨å¤–éƒ¨æŒ‚è½½ï¼Œç»™æ„å»ºçš„agentsæ·»åŠ ä¸€ä¸ªæ–°çš„æŒ‚è½½ï¼ŒæŠŠæ‰“åŒ…çš„æ‰€éœ€æ–‡ä»¶å¤åˆ¶åˆ°å…¶ä¸­ï¼Œåœ¨æ‰“åŒ…podä¸­æŒ‚è½½è¯¥`volumne`ä¹Ÿå¯ä»¥è·å–æ‰€éœ€çš„æ–‡ä»¶\n  - è¿™é‡ŒæŠŠç‰ˆæœ¬é…ç½®åˆ°äº†é•œåƒä¸­ï¼Œè¿™æ ·å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶å¿«é€Ÿäº†è§£å…¶å¯¹åº”çš„åç«¯å’Œå‰ç«¯çš„ç‰ˆæœ¬\n\n```groovy\n            steps {\n                parallel (\n                    'æ„å»ºå‰ç«¯é•œåƒ': {\n                        unstash 'frontend-artifact'\n                        container('kaniko') {\n                            sh \"echo ${params.HARBOR_IP} ${params.HARBOR_REGISTRY} >> /etc/hosts\"\n                            sh \"\"\"\n                                /kaniko/executor  --context `pwd`/web/k8s/front/docker -f `pwd`/web/k8s/front/docker/Dockerfile \\\n                                --skip-tls-verify \\\n                                --force \\\n                                --destination ${params.HARBOR_REGISTRY}/k8s_demo/front:${params.FRONTEND_VERSION}  \n                            \"\"\"\n                        }\n                    },\n                    'æ„å»ºåç«¯é•œåƒ': {\n                        unstash 'backend-artifact'\n                        container('kaniko') {\n                            sh \"echo ${params.HARBOR_IP} ${params.HARBOR_REGISTRY} >> /etc/hosts\"\n                            sh \"\"\"\n                                /kaniko/executor --context `pwd`/web/k8s/back/docker --dockerfile `pwd`/web/k8s/back/docker/Dockerfile \\\n                                --skip-tls-verify \\\n                                --force \\\n                                --destination ${params.HARBOR_REGISTRY}/k8s_demo/back:${params.BACKEND_VERSION} \n                            \"\"\"\n                        }\n                    }\n                )\n            }\n        }\n```\n\n- k8sæ›´æ–°éƒ¨ç½²\n\n  - è¿™é‡Œåˆ©ç”¨äº†`annotate`ç»™æ¯ä¸ªç‰ˆæœ¬éƒ½`rollout histroy`éƒ½é…ç½®äº†`change-cause` æ–¹ä¾¿åæœŸè¿›è¡Œç‰ˆæœ¬å›é€€å’ŒæŸ¥çœ‹\n\n  - åŒæ—¶åˆ©ç”¨äº†`rollout restart`æ¥è¿›è¡Œæ»šåŠ¨æ›´æ–°\n\n    - æ»šåŠ¨æ›´æ–°æ˜¯ Kubernetes æä¾›çš„ä¸€ç§éƒ¨ç½²æ›´æ–°ç­–ç•¥ï¼Œå®ƒé€æ­¥æ›¿æ¢ Pod çš„æ—§ç‰ˆæœ¬ï¼Œç¡®ä¿åœ¨æ›´æ–°è¿‡ç¨‹ä¸­å§‹ç»ˆä¿æŒåº”ç”¨ç¨‹åºçš„å¯ç”¨æ€§ã€‚\n\n      - **é›¶åœæœºæ—¶é—´ (Zero Downtime):** è¿™æ˜¯æ»šåŠ¨æ›´æ–°æœ€å¤§çš„ä¼˜åŠ¿ã€‚åœ¨æ›´æ–°è¿‡ç¨‹ä¸­ï¼Œæ—§ Pod ä¼šé€æ­¥è¢«æ–° Pod æ›¿æ¢ï¼Œè€Œä¸ä¼šä¸€æ¬¡æ€§åœæ­¢æ‰€æœ‰æ—§ Podã€‚è¿™ä¿è¯äº†åº”ç”¨åœ¨æ›´æ–°è¿‡ç¨‹ä¸­å§‹ç»ˆè‡³å°‘æœ‰ä¸€éƒ¨åˆ†å®ä¾‹åœ¨è¿è¡Œï¼Œé¿å…äº†æœåŠ¡ä¸­æ–­ã€‚\n      - **æ§åˆ¶æ›´æ–°é€Ÿåº¦:** ä½ å¯ä»¥æ§åˆ¶æ»šåŠ¨æ›´æ–°çš„é€Ÿåº¦ï¼Œä¾‹å¦‚ä¸€æ¬¡æ›´æ–°å¤šå°‘ä¸ª Podï¼Œä»¥åŠæ¯æ¬¡æ›´æ–°ä¹‹é—´ç­‰å¾…çš„æ—¶é—´ã€‚è¿™è®©ä½ å¯ä»¥æ ¹æ®åº”ç”¨çš„å®é™…æƒ…å†µå’Œé£é™©æ‰¿å—èƒ½åŠ›æ¥è°ƒæ•´æ›´æ–°èŠ‚å¥ã€‚\n      - **å›æ»šèƒ½åŠ›:** å¦‚æœæ–°ç‰ˆæœ¬å‡ºç°é—®é¢˜ï¼Œä½ å¯ä»¥è½»æ¾åœ°å›æ»šåˆ°ä¹‹å‰çš„ç‰ˆæœ¬ã€‚Kubernetes ä¼šä¿ç•™æ—§ Pod çš„å†å²ç‰ˆæœ¬ï¼Œæ–¹ä¾¿ä½ å¿«é€Ÿå›æ»šã€‚\n\n    - **æ»šåŠ¨æ›´æ–°çš„é…ç½®**\n\n      åœ¨ Kubernetes ä¸­ï¼Œä½ å¯ä»¥é€šè¿‡ Deployment å¯¹è±¡æ¥ç®¡ç†åº”ç”¨çš„éƒ¨ç½²å’Œæ›´æ–°ã€‚ä»¥ä¸‹æ˜¯é…ç½®æ»šåŠ¨æ›´æ–°çš„ä¸€äº›å…³é”®å‚æ•°ï¼š\n\n      - **`strategy.type: RollingUpdate`**: æŒ‡å®šä½¿ç”¨æ»šåŠ¨æ›´æ–°ç­–ç•¥ã€‚\n      - **`strategy.rollingUpdate.maxSurge`**: æŒ‡å®šåœ¨æ›´æ–°è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥é¢å¤–åˆ›å»ºçš„æœ€å¤§ Pod æ•°é‡ã€‚ä¾‹å¦‚ï¼Œè®¾ç½®ä¸º `20%` è¡¨ç¤ºå¯ä»¥é¢å¤–åˆ›å»ºå½“å‰ Pod æ•°é‡ 20% çš„ Podã€‚\n      - **`strategy.rollingUpdate.maxUnavailable`**: æŒ‡å®šåœ¨æ›´æ–°è¿‡ç¨‹ä¸­ï¼Œä¸å¯ç”¨ Pod çš„æœ€å¤§æ•°é‡æˆ–ç™¾åˆ†æ¯”ã€‚ä¾‹å¦‚ï¼Œè®¾ç½®ä¸º `25%` è¡¨ç¤ºåœ¨æ›´æ–°è¿‡ç¨‹ä¸­ï¼Œæœ€å¤šå…è®¸ 25% çš„ Pod ä¸å¯ ç”¨ã€‚\n      - **`minReadySeconds`**: æŒ‡å®šæ–° Pod è¿›å…¥ \"Ready\" çŠ¶æ€åï¼Œéœ€è¦ç­‰å¾…çš„æœ€çŸ­æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œæ‰ä¼šè¢«è®¤ä¸ºæ˜¯å¯ç”¨çš„ï¼Œå¹¶ç»§ç»­æ›´æ–°å…¶ä»– Podã€‚\n\n    - æ‰€ä»¥æœ€å¥½æ¯ä¸ªåº”ç”¨çš„å‰¯æœ¬æ•°è‡³å°‘ä¸º2ï¼Œè¿™æ ·åœ¨æ»šåŠ¨æ›´æ–°æ—¶å¯ä»¥åšåˆ°ç»§ç»­æœåŠ¡\n\n    - [æ‰§è¡Œæ»šåŠ¨æ›´æ–° | Kubernetes](https://kubernetes.io/zh-cn/docs/tutorials/kubernetes-basics/update/update-intro/)\n\n```groovy\nstage('æ›´æ–°K8séƒ¨ç½²') {\n            steps {\n                script {\n                    sh \"\"\"\n                    sed -i 's|image: .*k8s_demo/.*|image: ${HARBOR_REGISTRY}/k8s_demo/back:${params.BACKEND_VERSION}|g' ./web/k8s/back/k8s/k8sDemoBack.yaml\n                    sed -i 's|image: .*k8s_demo/.*|image: ${HARBOR_REGISTRY}/k8s_demo/front:${params.FRONTEND_VERSION}|g' ./web/k8s/front/k8s/k8sDemoFront.yaml\n                    kubectl apply -f ./web/k8s/back/k8s/k8sDemoBack.yaml\n                    kubectl apply -f ./web/k8s/front/k8s/k8sDemoFront.yaml\n                    kubectl annotate deployment k8s-demo-front-end -n prod  kubernetes.io/change-cause=\"ci/cd update version to ${params.BACKEND_VERSION}\"\n                    kubectl annotate deployment k8s-demo-back-end -n prod  kubernetes.io/change-cause=\"ci/cd update version to ${params.BACKEND_VERSION}\"\n                    kubectl rollout restart deployment -n prod -l app=k8s-demo-front-end\n                    kubectl rollout restart deployment -n prod -l app=k8s-demo-back-end\n                      \"\"\"\n                }\n            }\n        }\n```\n\næœ€åå®Œæ•´çš„é…ç½®æ–‡ä»¶åœ¨ [k8s_demo/web/jenkins/jenkins.pipeline at main Â· kehaha-5/k8s_demo (github.com)](https://github.com/kehaha-5/k8s_demo/blob/main/web/jenkins/jenkins.pipeline)\n\n## æ‰§è¡Œ\n\nåœ¨æ‰§è¡Œçš„æ—¶å€™å¯ä»¥é…ç½®å¯¹åº”çš„ç‰ˆæœ¬å’Œé•œåƒä¿¡æ¯\n\n![jenkins k8s-demo](.\\4.png)\n\nåœ¨æ‰§è¡ŒæˆåŠŸåå¯ä»¥æŸ¥çœ‹å¯¹åº”çš„è®°å½•\n\n```shell\n#æŸ¥çœ‹æ»šåŠ¨æ›´æ–°è¿‡ç¨‹\nroot@node-m:~# kubectl rollout status  deployment  -n prod -l app=k8s-demo-back-end\ndeployment \"k8s-demo-back-end\" successfully rolled out\nroot@node-m:~# kubectl rollout status  deployment  -n prod -l app=k8s-demo-back-end\nWaiting for deployment \"k8s-demo-back-end\" rollout to finish: 1 out of 2 new replicas have been updated...\nWaiting for deployment \"k8s-demo-back-end\" rollout to finish: 1 out of 2 new replicas have been updated...\nWaiting for deployment \"k8s-demo-back-end\" rollout to finish: 1 old replicas are pending termination...\nWaiting for deployment \"k8s-demo-back-end\" rollout to finish: 1 old replicas are pending termination...\ndeployment \"k8s-demo-back-end\" successfully rolled out\n#æŸ¥çœ‹æ»šåŠ¨æ›´æ–°å†å²è®°å½•\nroot@node-m:~# kubectl rollout history deployment  -n prod -l app=k8s-demo-back-end\ndeployment.apps/k8s-demo-back-end\nREVISION  CHANGE-CAUSE\n1         <none>\n2         <none>\n3         <none>\n4         <none>\n5         ci/cd-update-version-to-1.0.0\n6         ci/cd update version to 1.1.2\n7         ci/cd update version to 1.1.2\n8         ci/cd update version to 1.1.5\n9         ci/cd update version to 1.1.5\n#æŸ¥çœ‹ç›®å‰podä¿¡æ¯\nroot@node-m:~# kubectl get pods -n prod -l app=k8s-demo-back-end\nNAME                                 READY   STATUS    RESTARTS   AGE\nk8s-demo-back-end-5c74755bcd-cgt78   1/1     Running   0          2m13s\nk8s-demo-back-end-5c74755bcd-md6j2   1/1     Running   0          2m14s\n```\n\nokï¼Œä»¥ä¸Šå°±æ˜¯å®ç°äº†åœ¨k8sä¸­éƒ¨ç½²jenkinså’Œharborå®ç°è‡ªåŠ¨äº¤ä»˜æµæ°´çº¿","tags":["k8s_demo","k3s","jenkins"]},{"title":"ä»é›¶åˆ°ä¸€--æ­å»ºwebé¡¹ç›®é›†ç¾¤","url":"/2024/08/16/ä»é›¶åˆ°ä¸€--æ­å»ºwebé¡¹ç›®é›†ç¾¤/","content":"\n> æœ¬æ¬¡é…ç½®å’Œä»£ç éƒ½åœ¨[github](https://github.com/kehaha-5/k8s_demo)ä¸Š \n\nä½¿ç”¨æ–¹æ³•:\n> `git clone https://github.com/kehaha-5/k8s_demo`\n  `cd k8s_demo`\n  `git fetch --all`\n  `git checkout -b tag 1.0`\n\n# æ¦‚è¿°\n\n## ç›®æ ‡\n1. éƒ¨ç½²mysqlé›†ç¾¤\n2. éƒ¨ç½²redisé›†ç¾¤\n3. éƒ¨ç½²ä¸€ä¸ªå‰åç«¯åˆ†ç¦»çš„é¡¹ç›®\n    1. åç«¯ginçº¯api\n    2. å‰ç«¯vue3\n\n## ç¯å¢ƒ\næœåŠ¡å™¨ä¸€å…±æœ‰3å°ï¼š\n1. ä¸»æœåŠ¡å™¨(4c,6g) æ˜¯é›†ç¾¤é‡Œé¢çš„serverèŠ‚ç‚¹ \n2. èŠ‚ç‚¹æœåŠ¡å™¨1(2c,4g) æ˜¯é›†ç¾¤é‡Œé¢çš„agentèŠ‚ç‚¹\n3. èŠ‚ç‚¹æœåŠ¡å™¨2(2c,2g) è¯¥æœåŠ¡å™¨ä¸ä»…æ˜¯é›†ç¾¤é‡Œé¢çš„agentèŠ‚ç‚¹ï¼Œä¹Ÿæ˜¯é¡¹ç›®ä¸­çš„å‰ç«¯æœåŠ¡å™¨\n    > é‚£ä¸ºä»€ä¹ˆè¦ä¸“é—¨å¼„ä¸€å°ä½é…ç½®çš„æœåŠ¡å™¨ä¸“é—¨è¿è¡Œå‰ç«¯?\n    >\n    > 1. å‰ç«¯çš„èµ„æºæµé‡ä¼šåœ¨webå æ®æ¯”è¾ƒå¤§çš„éƒ¨åˆ†ï¼Œå³ä½¿ä¸Šäº†`cdn`åœ¨æŸäº›æ—¶åˆ»ä¹Ÿä¼šå­˜åœ¨æµé‡å›æµåˆ°æœåŠ¡å™¨çš„ï¼Œå¯¼è‡´æœåŠ¡å™¨å¸¦å®½è¢«å æ»¡ï¼Œè‹¥åç«¯ä¹Ÿæ˜¯éƒ¨ç½²åœ¨è¯¥æœåŠ¡å™¨ä¸Šé¢ï¼Œä¼šå› ä¸ºæœåŠ¡å™¨å¸¦å®½é—®é¢˜å¯¼è‡´apiçš„å“åº”å˜æ…¢ï¼Œå¸¦æ¥ä¸å¥½çš„ç”¨æˆ·ä½“éªŒã€‚\n    >\n    > 2. åŒæ—¶è¿›è¡Œåˆç†çš„èµ„æºåˆ†é…ä¹Ÿå¯ä»¥èŠ‚çº¦æˆæœ¬\n5. ä¸€å°nfså­˜å‚¨æœåŠ¡å™¨\n4. æ‰€æœ‰æœåŠ¡å™¨éƒ½åœ¨åŒä¸€ä¸ªå†…ç½‘ä¸‹ï¼Œå¯ä»¥ç›¸äº’pingé€š\n\n# å‰æœŸå‡†å¤‡\n## é›†ç¾¤æ­å»º\nè¿™æ¬¡åˆ©ç”¨[k3s](https://github.com/k3s-io/k3s)æ¥è¿›è¡Œé›†ç¾¤çš„æ­å»ºï¼Œk3sæ˜¯ä¸€ä¸ªè½»é‡çº§çš„kubernetesé›†ç¾¤ï¼Œç›¸æ¯”è¾ƒäºk8sï¼Œk3sçš„èµ„æºå ç”¨æ›´å°‘ï¼Œå¹¶ä¸”éƒ¨ç½²æ›´åŠ ç®€å•ã€‚\n\nåœ¨åˆ©ç”¨k3séƒ¨ç½²é›†ç¾¤çš„æ—¶å€™è¦æ³¨æ„ä¸€ä¸‹å‡ ç‚¹ï¼š\n1. é»˜è®¤çš„k3sé›†ç¾¤çš„å‚¨å­˜æ˜¯ä½¿ç”¨sqlite3ï¼Œè¿™ä¸ªå¹¶ä¸é€‚åˆåœ¨é«˜å¯ç”¨çš„ç”Ÿäº§ç¯å¢ƒä¸‹ä½¿ç”¨ï¼Œæ‰€ä»¥åœ¨æ­£å¼çš„ç”Ÿäº§ç¯å¢ƒä¸­è¦ä½¿ç”¨[k3s-é«˜å¯ç”¨å¤–éƒ¨æ•°æ®åº“](https://docs.k3s.io/zh/datastore/ha)\n2. åœ¨å­˜å‚¨å®šä¹‰æ–¹é¢`pvc`ä¸­ï¼Œk3sæ˜¯æ²¡æœ‰`Kubernetes`è¿™ä¹ˆå¤šå·æ’ä»¶çš„ï¼Œéœ€è¦è‡ªå·±å»é…ç½® [k3s-å·å’Œå­˜å‚¨](https://docs.k3s.io/zh/storage)\n3. é›†ç¾¤è®¿é—®çš„æ–¹å¼ï¼Œk3sé»˜è®¤ä½¿ç”¨`k3s kubectl`å‘½ä»¤è¡Œè¿›è¡Œé›†ç¾¤çš„è®¿é—®ï¼Œå¦‚æœæ˜¯å¦å¤–å®‰è£…çš„`kubectl`ï¼Œéœ€è¦é…ç½®`kubectl`çš„è®¿é—®æ–¹å¼ï¼Œå¦å¤–`helm`ä¹Ÿæ˜¯å¦‚æ­¤ [k3s-é›†ç¾¤è®¿é—®](https://docs.k3s.io/zh/kubectl)\n4. k3sé»˜è®¤æ˜¯ä½¿ç”¨äº†`traefik`ä½œä¸ºé›†ç¾¤çš„`ingress controller`ï¼Œç›¸å…³é…ç½®æ–‡ä»¶çš„ä½ç½®å’Œä¿¡æ¯ [k3s-Networking Services](https://docs.k3s.io/zh/networking/networking-services)\n5. åœ¨k3sä¸­å¦‚æœéœ€è¦é…ç½®é•œåƒæºå¯ä»¥å‚è€ƒ [k3s-Private Registry Configuration](https://docs.k3s.io/zh/installation/private-registry)ï¼ŒåŒæ—¶æœ€å¥½å¯ç”¨`Embedded Registry Mirror`åŠŸèƒ½ï¼Œè¿™ä¸ªå¯ä»¥ä½¿èŠ‚ç‚¹é€šè¿‡é›†ç¾¤é‡Œé¢çš„å…¶ä»–èŠ‚ç‚¹è·å–å·²æœ‰çš„é•œåƒ [k3s-Embedded Registry Mirror](https://docs.k3s.io/zh/installation/registry-mirror)\n\n## é¢å¤–é…ç½®\nå› ä¸ºåœ¨ä¸Šè¿°ä¸­æåˆ°éœ€è¦ä¸€å°æœåŠ¡å™¨ä¸“é—¨åšwebèµ„æºæœåŠ¡å™¨ï¼Œæ‰€ä»¥åœ¨éƒ¨ç½²å®Œé›†ç¾¤åï¼Œéœ€è¦æŠŠå¯¹åº”æœåŠ¡nodeæ‰“ä¸Šæ±¡ç‚¹ï¼Œé˜²æ­¢å…¶ä»–podè¢«è°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹ä¸Šé¢\n\n```shell\nroot@node-m:~/k8s# kubectl taint nodes node-res type=res:NoSchedule \n# å…¶ä¸­NoScheduleçš„å«æœ‰å¦‚ä¸‹å’Œå…¶ä»–æ±¡ç‚¹ç±»å‹ï¼š\n# NoSchedule ï¼šè¡¨ç¤ºk8så°†ä¸ä¼šå°†Podè°ƒåº¦åˆ°å…·æœ‰è¯¥æ±¡ç‚¹çš„Nodeä¸Š\n# PreferNoSchedule ï¼šè¡¨ç¤ºk8så°†å°½é‡é¿å…å°†Podè°ƒåº¦åˆ°å…·æœ‰è¯¥æ±¡ç‚¹çš„Nodeä¸Š\n# NoExecute ï¼šè¡¨ç¤ºk8så°†ä¸ä¼šå°†Podè°ƒåº¦åˆ°å…·æœ‰è¯¥æ±¡ç‚¹çš„Nodeä¸Šï¼ŒåŒæ—¶ä¼šå°†Nodeä¸Šå·²ç»å­˜åœ¨çš„Podé©±é€å‡ºå»\nroot@node-m:~/k8s# kubectl describe nodes node-res\nName:               node-res\n...\nTaints:             type=res:NoSchedule\nUnschedulable:      false\n...\n```\næˆ–è€…ä½¿ç”¨k3sä¸­çš„`agent`é…ç½®æ–‡ä»¶ç»™èŠ‚ç‚¹è¿›è¡Œæ±¡ç‚¹é…ç½® [k3s-agent](https://docs.k3s.io/zh/cli/agent)\n\nåŒæ—¶åˆ›å»ºä¸€ä¸ª`prod`çš„namespaceï¼Œæˆ‘çš„æ‰€æœ‰åº”ç”¨éƒ½å°†ä¼šéƒ¨ç½²åˆ°è¯¥`namespace`ä¸Šé¢\n\n```yaml\napiVersion: v1\nkind: Namespace\nmetadata:\n  name: prod\n  labels:\n    name: prod\n```\n\n\n\n# å¼€å§‹éƒ¨ç½²\n## kubernetes dashboard\næ ¹æ®[æ–‡æ¡£](https://github.com/kubernetes/dashboard)å‘½ä»¤éƒ¨ç½² `dashboard`\n```shell\n# Add kubernetes-dashboard repository\nhelm repo add kubernetes-dashboard https://kubernetes.github.io/dashboard/\n# Deploy a Helm Release named \"kubernetes-dashboard\" using the kubernetes-dashboard chart\nhelm upgrade --install kubernetes-dashboard kubernetes-dashboard/kubernetes-dashboard --create-namespace --namespace kubernetes-dashboard\n```\néƒ¨ç½²å®Œåæˆ‘ä»¬è¿˜è¦åˆ›å»ºä¸€ä¸ªç”¨æˆ·ç”¨äºç®¡ç†k8s [Creating sample user](https://github.com/kubernetes/dashboard/blob/master/docs/user/access-control/creating-sample-user.md)\n\nå®Œæˆä¸Šè¿°éƒ¨ç½²ä»¥åï¼Œæˆ‘ä»¬å°±è¦è®¿é—®å¯¹åº”çš„`dashboard`ï¼Œç„¶åæˆ‘æ˜¯è¦ç”¨ip+ç«¯å£çš„è®¿é—®æ–¹å¼ï¼Œæ‰€ä»¥è¿˜è¦åˆ›å»ºä¸€ä¸ª`service`æŠŠæµé‡ä»£ç†åˆ°å¯¹åº”çš„podä¸Š\n\n```shell\ncat node-web.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: dashoard-web\n  namespace: kubernetes-dashboard\n  labels:\n    k8s-app: kubernetes-dashboard\nspec:\n  type: NodePort #è¿™é‡Œä½¿ç”¨NodePort å› ä¸ºæˆ‘æƒ³è¦ä»é›†ç¾¤å¤–éƒ¨è®¿é—®\n  selector:\n    app.kubernetes.io/name: kong\n  ports:\n    - protocol: TCP\n      port: 8000\n      targetPort: 8443\n```\næ³¨æ„è¿™é‡Œè¦ä»£ç†çš„æ˜¯`kubernetes-dashboard-kong`ä¸æ˜¯`kubernetes-dashboard-web`\n```shell\nroot@node-m:~/k8s/dashoboard# kubectl get endpoints -n kubernetes-dashboard\nNAME                               ENDPOINTS              AGE\ndashoard-web                       10.42.1.242:8443       12d\n...\nkubernetes-dashboard-kong-proxy    10.42.1.242:8443       34h\n...\n#è¿™é‡Œå¯ä»¥çœ‹åˆ°æˆ‘çš„dashoard-webå·²ç»ç»‘å®šåˆ°kubernetes-dashboard-kong-proxyä¸Šäº†\n kubectl get svc -n kubernetes-dashboard\nNAME          TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE\ndashoard-web  NodePort    10.43.234.91    <none>        8000:30756/TCP   12d\n...\n#æŸ¥çœ‹serviceä¿¡æ¯å¯ä»¥å¾—çŸ¥ dashoard-web çš„å¤–éƒ¨è®¿é—®ç«¯å£ä¸º 30756\n```\nç„¶åip+30756 å³å¯è®¿é—® `dashboard` åŒæ—¶è¿˜è¦åˆ›å»ºå¯¹åº”ç”¨æˆ·çš„token\n```shell\nroot@node-m:~/k8s/dashoboard# kubectl create token -n kubernetes-dashboard xxxx\n```\n![dashoard-web](.\\1.png)\n\n## NFSå­˜å‚¨æŒ‚è½½\n\nåœ¨æ‰€æœ‰åº”ç”¨éƒ¨ç½²å‰ï¼Œå…ˆéƒ¨ç½²å¤–éƒ¨å­˜å‚¨ä»‹è´¨\n\né¦–å…ˆå…ˆè¦å®‰è£… [csi-driver-nfs](https://github.com/kubernetes-csi/csi-driver-nfs) è¿™ä¸ªæ˜¯nfsçš„å·æ’ä»¶ï¼Œä¸å®‰è£…çš„è¯æ˜¯æ— æ³•ä½¿ç”¨nfsç›¸å…³å·åŠŸèƒ½\n\n```shell\nroot@node-m:~/k8s# cat ./nfs/storageClass.yaml\napiVersion: storage.k8s.io/v1\nkind: StorageClass\nmetadata:\n  name: nfs\nprovisioner: nfs.csi.k8s.io\nparameters:\n  server: 192.168.1.125\n  share: /mnt/nfs_share\n  # csi.storage.k8s.io/provisioner-secret is only needed for providing mountOptions in DeleteVolume\n  # csi.storage.k8s.io/provisioner-secret-name: \"mount-options\"\n  # csi.storage.k8s.io/provisioner-secret-namespace: \"default\"\nreclaimPolicy: Retain #å› ä¸ºè¦ä¿å­˜redis å’Œ mysqlçš„æ•°æ® æ‰€ä»¥ä½¿ç”¨Retain å½“pvcæˆ–pvè¢«åˆ é™¤ä»¥åä»ç„¶å¯ä»¥ä¿ç•™æ•°æ®\nvolumeBindingMode: Immediate\nmountOptions:\n  - nfsvers=4\n```\n\nè¿™é‡Œä½¿ç”¨çš„æ˜¯` Dynamic Volume Provisioning` è¿™æ ·å°±ä¸éœ€è¦æ¯ä¸ª`pvc`éƒ½å£°åä¸€ä¸ª`pv`äº†\n\n## MySQLé›†ç¾¤\n\nè¿™é‡Œè¦éƒ¨ç½²çš„æ˜¯ä¸€ä¸ª1ä¸ªä¸»èŠ‚ç‚¹2ä¸ªä»èŠ‚ç‚¹çš„MySQLé›†ç¾¤\n\n```yaml\n#configmap\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: mysql\n  namespace: prod\ndata:\n  master.cnf: |\n    # ä¸»èŠ‚ç‚¹MySQLçš„é…ç½®æ–‡ä»¶\n    [mysqld]\n    log-bin\n  slave.cnf: |\n    # ä»èŠ‚ç‚¹MySQLçš„é…ç½®æ–‡ä»¶\n    [mysqld]\n    log-bin\n    read_only=1\n    replicate_ignore_db=information_schema\n    replicate_ignore_db=performance_schema\n    replicate_ignore_db=mysql\n    replicate_ignore_db=sys\n  init.sh: |\n    #!/bin/bash\n    until mysql  -p\"$MYSQL_ROOT_PASSWORD\" -e \"select 1;\"; do sleep 1; done\n    [[ $HOSTNAME =~ -([0-9]+) ]] || exit 1\n    ordinal=${BASH_REMATCH[1]}\n    if [[ $ordinal -eq 0 ]]; then\n      mysql -p\"$MYSQL_ROOT_PASSWORD\" -e \"grant replication slave on *.* to '$REPLIC_USER'@'%' identified by '$REPLIC_PASSWORD'\"\n      mysql -p\"$MYSQL_ROOT_PASSWORD\" -e \"FLUSH PRIVILEGES\"\n    else\n      mysql -p\"$MYSQL_ROOT_PASSWORD\" -e \"change master to master_host='mysql-0.mysql-svc',master_user='$REPLIC_USER',master_password='$REPLIC_PASSWORD';\"\n      mysql -p\"$MYSQL_ROOT_PASSWORD\" -e \"start slave\"\n    fi\n    \n#sercet.yaml\napiVersion: v1\nkind: Secret\nmetadata:\n  name: mysql\n  namespace: prod\ntype: Opaque\ndata:\n  pass: NlFBMFpGSTRUYzZ6UmU5VWc4amI= #6QA0ZFI4Tc6zRe9Ug8jb\n  rep_pass: bWtzdFE2M3ZuYmFQeUJ5eGR6Z3Y= #mkstQ63vnbaPyByxdzgv\n  rep_user: cmVw #rep\n  \n#mysql.yaml\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: mysql\n  namespace: prod\nspec:\n  selector:\n    matchLabels:\n      app: mysql\n      app.kubernetes.io/name: mysql\n  replicas: 3\n  serviceName: mysql-svc\n  template:\n    metadata:\n      labels:\n        app: mysql\n        app.kubernetes.io/name: mysql\n    spec:\n      initContainers:\n        - name: init-mysql\n          image: mysql:5.7.34\n          command:\n          - bash\n          - \"-c\"\n          - |\n            set -ex\n            # Generate mysql server-id from pod ordinal index.\n            [[ $HOSTNAME =~ -([0-9]+)$ ]] || exit 1\n            ordinal=${BASH_REMATCH[1]}\n            echo [mysqld] > /mnt/conf.d/server-id.cnf\n            # Add an offset to avoid reserved server-id=0 value.\n            echo server-id=$((100 + $ordinal)) >> /mnt/conf.d/server-id.cnf\n            # cp config file to /mnt/conf.d\n            if [[ $ordinal -eq 0 ]]; then\n              cp /mnt/config-map/master.cnf /mnt/conf.d/\n            else\n              cp /mnt/config-map/slave.cnf /mnt/conf.d\n            fi\n            cp /mnt/config-map/init.sh /mnt/conf.d\n          volumeMounts:\n          - name: conf\n            mountPath: /mnt/conf.d/\n          - name: config-map\n            mountPath: /mnt/config-map/\n      containers:\n      - name: mysql\n        image: mysql:5.7.34\n        volumeMounts:\n          - name: conf\n            mountPath: /etc/mysql/conf.d\n          - name: data\n            mountPath: /var/lib/mysql/\n        env:\n        - name: MYSQL_ROOT_PASSWORD\n          valueFrom:\n            secretKeyRef:\n              name: mysql\n              key: pass\n        - name: REPLIC_USER\n          valueFrom:\n            secretKeyRef:\n              name: mysql\n              key: rep_user\n        - name: REPLIC_PASSWORD\n          valueFrom:\n            secretKeyRef:\n              name: mysql\n              key: rep_pass\n        ports:\n        - name: mysql\n          containerPort: 3306\n        resources:\n          requests:\n            cpu: \"500m\"\n            memory: \"500Mi\"\n          limits:\n            cpu: \"500m\"\n            memory: \"500Mi\"\n        lifecycle:\n          postStart:\n            exec:\n              command: [\"bash\",\"/etc/mysql/conf.d/init.sh\"]\n      volumes:\n      - name: config-map\n        configMap:\n          name: mysql\n      - name: conf\n        emptyDir: {}\n  volumeClaimTemplates:\n  - metadata:\n      name: data\n    spec:\n      accessModes: [\"ReadWriteOnce\"]\n      storageClassName: \"nfs\" #è¿™é‡Œä½¿ç”¨çš„å°±æ˜¯ä¸Šé¢å£°åçš„Dynamic Volume Provisioning\n      resources:\n        requests:\n          storage: 2Gi\n          \n#service.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: mysql-svc\n  namespace: prod\n  labels:\n    app: mysql\n    app.kubernetes.io/name: mysql\nspec:\n  ports:\n  - name: mysql\n    port: 3306\n  clusterIP: None #ä½¿ç”¨clusterIP: None è¿™æ ·æ¯ä¸ªpodéƒ½ä¼šæœ‰ä¸€ä¸ªç‹¬ç«‹çš„dnsåŸŸåå¯ä»¥å•ç‹¬è®¿é—®åˆ°ï¼ŒåŒæ—¶è®¿é—®ä¸»èŠ‚ç‚¹å°±å˜æˆmysql-0.mysql-svc\n  selector:\n    app: mysql\n---\n\napiVersion: v1\nkind: Service\nmetadata:\n  name: mysql-read\n  namespace: prod\n  labels:\n    app: mysql\n    app.kubernetes.io/name: mysql\n    readonly: \"true\"\nspec:\n  ports:\n  - name: mysql\n    port: 3306\n  selector:\n    app: mysql\n```\n\nè¿™é‡Œæœ‰å‡ ç‚¹éœ€è¦æ³¨æ„ä¸€ä¸‹ï¼š\n\n1. è¿™é‡Œåˆ›å»ºé›†ç¾¤ä½¿ç”¨çš„æ˜¯`StatefulSet` å› ä¸ºmysqlé›†ç¾¤ä¹‹é—´å­˜åœ¨æ‹“æ­¥ç»“æ„ï¼ˆå¿…é¡»å…ˆå¯åŠ¨masterèŠ‚ç‚¹å†å¯åŠ¨slaverèŠ‚ç‚¹ï¼‰ï¼Œä¸ºäº†å¤„ç†è¿™ç§çŠ¶æ€çš„å…³ç³»æ‰€ä»¥ä½¿ç”¨äº†`StatefulSet`\n\n   > ```shell\n   > [[ $HOSTNAME =~ -([0-9]+)$ ]] || exit 1\n   > ordinal=${BASH_REMATCH[1]}\n   > ```\n   > è¿™æ®µshellçš„æ„æ€æ˜¯è·å–hostnameä¸­çš„æ•°å­—ï¼Œç„¶åèµ‹å€¼ä¸ªordinalï¼Œè¿™æ ·é€šè¿‡åˆ¤æ–­ordinalå°±å¯ä»¥çŸ¥é“å½“å‰ç¯å¢ƒæ˜¯ä¸»èŠ‚ç‚¹è¿˜æ˜¯ä»èŠ‚ç‚¹ã€‚\n   >\n   > `StatefulSet`åˆ›å»ºçš„podåç§°æ˜¯æœ‰é¡ºåºçš„ï¼Œpod-indexï¼Œindexä¼šä»0å¼€å§‹ï¼Œè¿™é‡Œè§„å®špod-0ä¸ºä¸»èŠ‚ç‚¹\n\n2. mysql.yamlä¸­çš„`serviceName`å¿…é¡»è·ŸServiceé‡Œé¢çš„`metadata.name`ä¸€è‡´ï¼Œä¸ç„¶dnsåªèƒ½è§£æ`StatefulSetName`-`ServiceName`åˆ°ä»»æ„ä¸€ä¸ªpodä¸Šï¼Œä¸èƒ½é€šè¿‡`podsName`-`serviceName`è§£æåˆ°æŒ‡å®šçš„podä¸Šé¢  [StatefulSet | Kubernetes](https://kubernetes.io/zh-cn/docs/reference/kubernetes-api/workload-resources/stateful-set-v1/#:~:text=serviceName)\n\n   > **serviceName** (string), å¿…éœ€\n   >\n   > serviceName æ˜¯ç®¡ç†æ­¤ StatefulSet æœåŠ¡çš„åç§°ã€‚ è¯¥æœåŠ¡å¿…é¡»åœ¨ StatefulSet ä¹‹å‰å³å·²å­˜åœ¨ï¼Œå¹¶è´Ÿè´£è¯¥é›†åˆçš„ç½‘ç»œæ ‡è¯†ã€‚ Pod ä¼šè·å¾—ç¬¦åˆä»¥ä¸‹æ¨¡å¼çš„ DNS/ä¸»æœºåï¼š pod-specific-string.serviceName.default.svc.cluster.localã€‚ å…¶ä¸­ â€œpod-specific-stringâ€ ç”± StatefulSet æ§åˆ¶å™¨ç®¡ç†ã€‚\n\n3. å› ä¸ºæˆ‘è¿™é‡Œæ˜¯ç”¨äº†ä¸€ä¸ªè‡ªå®šä¹‰çš„`namespace`ï¼Œå¦‚æœåœ¨æœ¬`namespace`ä¸Šé¢é€šè¿‡`podsName`-`serviceName`æ˜¯å¯ä»¥ç›´æ¥è®¿é—®çš„ï¼Œä½†æ˜¯å¦‚æœæ˜¯å…¶ä»–`namespace`è®¿é—®å°±è¦ä½¿ç”¨ `podsName`-`serviceName`.`my-namcespace` æ‰å¯ä»¥è®¿é—® [è¯¦ç»†](https://kubernetes.io/zh-cn/docs/concepts/services-networking/dns-pod-service/#dns-records:~:text=Service%20%E7%9A%84%E5%90%8D%E5%AD%97,%E9%A1%B5%E9%9D%A2%E3%80%82)\n\n4. æˆ‘è¿™é‡Œçš„`resources.requests`å’Œ`resources.limits`çš„é…ç½®æ˜¯ä¸€æ ·çš„ï¼Œè¿™ä¸ªå±äºæ˜¯`Qos`ä¸­çš„`Guaranteed`\n\n   > Qosä¸­çš„ç±»å‹ï¼š\n   >\n   > **Guaranteedï¼ˆä¿éšœå‹ï¼‰ï¼š**\n   >\n   > - **æ¡ä»¶ï¼š** Pod ä¸­æ‰€æœ‰å®¹å™¨çš„ `resources.requests` å’Œ `resources.limits` éƒ½ç›¸ç­‰ï¼Œå¹¶ä¸”éƒ½è®¾ç½®äº†éé›¶å€¼ã€‚\n   > - ç‰¹ç‚¹ï¼š\n   >   - ä¼˜å…ˆçº§æœ€é«˜ï¼Œèµ„æºå¾—åˆ°æœ€å¼ºçš„ä¿éšœã€‚\n   >   - å½“èŠ‚ç‚¹èµ„æºä¸è¶³æ—¶ï¼ŒGuaranteed Pod ä¸ä¼šè¢«é©±é€ï¼Œé™¤éæ˜¯ç³»ç»Ÿä¿ç•™èµ„æºä¸è¶³ã€‚\n   > - **é€‚ç”¨åœºæ™¯ï¼š** å¯¹èµ„æºè¦æ±‚é«˜ä¸”ç¨³å®šçš„åº”ç”¨ï¼Œä¾‹å¦‚æ•°æ®åº“ã€æ ¸å¿ƒæœåŠ¡ç­‰ã€‚\n   >\n   > **Burstableï¼ˆå¯çªå¢å‹ï¼‰ï¼š**\n   >\n   > - **æ¡ä»¶ï¼š** Pod ä¸­è‡³å°‘æœ‰ä¸€ä¸ªå®¹å™¨çš„ `resources.requests` è®¾ç½®äº†å€¼ï¼Œå¹¶ä¸” `resources.requests` å°äº `resources.limits`ã€‚\n   > - ç‰¹ç‚¹ï¼š\n   >   - ä¼˜å…ˆçº§ä¸­ç­‰ï¼Œå¯ä»¥åœ¨ `resources.requests` çš„åŸºç¡€ä¸Šä½¿ç”¨æ›´å¤šèµ„æºï¼Œä½†ä¸èƒ½è¶…è¿‡ `resources.limits`ã€‚\n   >   - å½“èŠ‚ç‚¹èµ„æºä¸è¶³æ—¶ï¼ŒBurstable Pod å¯èƒ½è¢«é©±é€ï¼Œä¼˜å…ˆçº§ä½äº Guaranteed Podã€‚\n   > - **é€‚ç”¨åœºæ™¯ï¼š** å¯¹èµ„æºéœ€æ±‚æœ‰æ³¢åŠ¨ï¼Œä½†å³°å€¼ä½¿ç”¨ä¸ä¼šå¤ªé«˜çš„åº”ç”¨ï¼Œä¾‹å¦‚ Web æœåŠ¡å™¨ã€API æœåŠ¡ç­‰ã€‚\n   >\n   > **BestEffortï¼ˆå°½åŠ›è€Œä¸ºå‹ï¼‰ï¼š**\n   >\n   > - **æ¡ä»¶ï¼š** Pod ä¸­æ‰€æœ‰å®¹å™¨éƒ½æ²¡æœ‰è®¾ç½® `resources.requests` å’Œ `resources.limits`ã€‚\n   > - ç‰¹ç‚¹ï¼š\n   >   - ä¼˜å…ˆçº§æœ€ä½ï¼Œåªèƒ½ä½¿ç”¨èŠ‚ç‚¹ä¸Šå‰©ä½™çš„èµ„æºã€‚\n   >   - å½“èŠ‚ç‚¹èµ„æºä¸è¶³æ—¶ï¼ŒBestEffort Pod ä¼šè¢«ä¼˜å…ˆé©±é€ã€‚\n   > - **é€‚ç”¨åœºæ™¯ï¼š** å¯¹èµ„æºè¦æ±‚ä¸é«˜ï¼Œå¯ä»¥å®¹å¿è¢«é©±é€çš„åº”ç”¨ï¼Œä¾‹å¦‚æ‰¹å¤„ç†ä»»åŠ¡ã€æµ‹è¯•ä»»åŠ¡ç­‰ã€‚\n\n## redisé›†ç¾¤\n\nredisé«˜å¯ç”¨æœåŠ¡ä¸€èˆ¬æœ‰ä¸‰ç§ç±»å‹ï¼š\n\n1. Redis replication redisçš„ä¸»ä»å¤åˆ¶ [Redis replication | Docs](https://redis.io/docs/latest/operate/oss_and_stack/management/replication/)\n\n2. Redis Sentinel åœ¨redisçš„ä¸»ä»å¤åˆ¶åŸºç¡€ä¸Šæ·»åŠ äº†å“¨å…µï¼Œç¡®ä¿åœ¨redis-masterä¸‹çº¿äº†ä»¥åï¼Œé‡æ–°ä»redis-slaverä¸­é€‰ä¸¾ä¸€ä¸ªæ–°çš„masterå‡ºæ¥ï¼Œä¿è¯æœåŠ¡å¯ç”¨ï¼Œå½“æ—§çš„redis-masterä¸Šçº¿åå°±å˜æˆredis-slaverã€‚[High availability with Redis Sentinel | Docs](https://redis.io/docs/latest/operate/oss_and_stack/management/sentinel/)\n\n3.  Redis Cluster è¿™ä¸ªæ˜¯ç”±å¤šä¸ªredisä¸»ä»ä¸€èµ·ç»„æˆçš„é›†ç¾¤ï¼Œæ•°æ®ä¼šè¢«åˆ†æ•£åˆ°æ¯ä¸ªredisä¸»ä»ä¸Šé¢ [Scale with Redis Cluster | Docs](https://redis.io/docs/latest/operate/oss_and_stack/management/scaling/)\n\n   > ä¼šæœ‰16384 hash slots åœ¨ Redis Clusterï¼Œå®ƒä»¬ä¼šè¢«åˆ†æ•£åˆ°ä¸åŒçš„èŠ‚ç‚¹ä¸Šé¢ï¼Œè¯»å†™å¯¹åº”çš„æ•°æ®å°†ä¼šåœ¨å¯¹åº”çš„èŠ‚ç‚¹ä¸­è¿›è¡Œ\n   >\n   >  with Redis Cluster, you get the ability to:\n   >\n   > - Automatically split your dataset among multiple nodes.\n   > - Continue operations when a subset of the nodes are experiencing failures or are unable to communicate with the rest of the cluster.\n\nè€Œè¿™æ¬¡éƒ¨ç½²çš„å°±æ˜¯3ä¸ªnodeçš„`Redis Cluster`å…¶ä¸­æ¯ä¸ªnodeç”±ä¸€ä¸ªä¸»ä¸€ä¸ªä»ç»„æˆï¼Œæ‰€ä»¥ä¸€å…±æœ‰6ä¸ªredisæœåŠ¡\n\n```yaml\n#configmap\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: redis\n  namespace: prod\ndata:\n  redis.conf: |\n    port 6379\n    cluster-enabled yes #å¼€å¯é›†ç¾¤æ¨¡å¼\n    cluster-node-timeout 5000\n    cluster-config-file /data/nodes.conf\n    appendonly yes\n\n#sercet\napiVersion: v1\nkind: Secret\nmetadata:\n  name: redis\n  namespace: prod\ntype: Opaque\ndata:\n  pass: ZHFYbkdJNEUxM28zY0d6V3E1QXI= #dqXnGI4E13o3cGzWq5Ar\n  \n#redis\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: redis\n  namespace: prod\nspec:\n  selector:\n    matchLabels:\n      app: redis\n      app.kubernetes.io/name: redis\n  serviceName: redis-svc\n  replicas: 6\n  template:\n    metadata:\n      labels:\n        app: redis\n        app.kubernetes.io/name: redis\n    spec:\n      initContainers:\n        - name: init-redis  \n          image: redis:7.4\n          env:\n          - name: REDISCLI_AUTH\n            valueFrom:\n              secretKeyRef:\n                name: redis\n                key: pass\n          command:\n          - bash\n          - \"-c\"\n          - |\n            set -ex\n            cp /mnt/config-map/redis.conf /mnt/conf.d\n            echo \"requirepass $REDISCLI_AUTH\" >> /mnt/conf.d/redis.conf\n            echo \"masterauth $REDISCLI_AUTH\" >> /mnt/conf.d/redis.conf\n          volumeMounts:\n          - name: conf\n            mountPath: /mnt/conf.d/\n          - name: config-map\n            mountPath: /mnt/config-map/\n      containers:\n      - name: redis\n        image: redis:7.4\n        command: [\"redis-server\"]\n        args:\n        - /usr/local/etc/redis/redis.conf\n        - --cluster-announce-ip\n        - \"$(MY_POD_IP)\"\n        volumeMounts:\n          - name: conf\n            mountPath: /usr/local/etc/redis/\n          - name: data\n            mountPath: /data/\n        env:\n        - name: REDISCLI_AUTH\n          valueFrom:\n            secretKeyRef:\n              name: redis\n              key: pass\n        - name: MY_POD_IP\n          valueFrom:\n            fieldRef:\n             fieldPath: status.podIP\n        ports:\n        - name: redis\n          containerPort: 6379\n        resources:\n          requests:\n            cpu: \"100m\"\n            memory: \"200Mi\"\n          limits:\n            cpu: \"100m\"\n            memory: \"200Mi\"\n      volumes:\n      - name: config-map\n        configMap: \n          name: redis\n      - name: conf\n        emptyDir: {}\n  volumeClaimTemplates:\n  - metadata:\n      name: data\n    spec:\n      accessModes: [\"ReadWriteOnce\"]\n      storageClassName: \"nfs\"\n      resources:\n        requests:\n          storage: 2Gi\n\n#service\napiVersion: v1\nkind: Service\nmetadata:\n  name: redis-svc\n  namespace: prod\n  labels:\n    app: redis\n    app.kubernetes.io/name: redis\nspec:\n  ports:\n  - name: redis\n    port: 6379\n  clusterIP: None #è¿™é‡Œè·Ÿä¸Šé¢çš„mysqlä¸€æ ·ï¼Œé€šè¿‡redis-index.redis-svcæ¥è®¿é—®ä¸åŒçš„redisèŠ‚ç‚¹\n  selector:\n    app: redis\n\n#job\napiVersion: batch/v1\nkind: Job\nmetadata:\n  name: redis-cluster-create\n  namespace: prod\nspec:\n  template:\n    spec:\n      containers:\n      - name: redis-cli\n        image: redis:7.4\n        env:\n        - name: REDISCLI_AUTH\n          valueFrom:\n            secretKeyRef:\n              name: redis\n              key: pass\n        command: [\"/bin/sh\", \"-c\"]\n        args:\n          - |\n            redis-cli --cluster create \\\n              redis-0.redis-svc:6379 \\\n              redis-1.redis-svc:6379 \\\n              redis-2.redis-svc:6379 \\\n              redis-3.redis-svc:6379 \\\n              redis-4.redis-svc:6379 \\\n              redis-5.redis-svc:6379 \\\n              --cluster-replicas 1 -a $REDISCLI_AUTH --cluster-yes #cluster-replicas 1 è¡¨ç¤ºä¸ºæ¯ä¸€ä¸ªä¸»èŠ‚ç‚¹åˆ†é…ä¸€ä¸ªä»èŠ‚ç‚¹ï¼Œè¿™æ ·æ¯ä¸ªnodeå°±æœ‰ä¸¤ä¸ªredisç»„æˆä¸€ä¸ªä¸»ä¸€ä¸ªä»ï¼Œè¿™æ ·3ç”±ä¸ªnodeç»„æˆçš„redis clusterå°±è¦6ä¸ªredis\n      restartPolicy: Never\n  backoffLimit: 1\n```\n\nè¿™é‡Œè¦æ³¨æ„å‡ ç‚¹\n\n1. rediséƒ¨ç½²å®Œäº†è¿˜è¦æ‰§è¡Œåˆ›å»ºé›†ç¾¤çš„å‘½ä»¤ï¼Œè¿™é‡Œåˆ©ç”¨äº†jobæ¥å®Œæˆè¿™ä¸ª\n\n2. å¯†ç é…ç½®è¯´æ˜\n\n   1. requirepassè¡¨ç¤ºredisçš„å¯†ç \n   2. masterauth è¡¨ç¤ºredisä¸»ä»æ—¶å€™çš„å¯†ç  ä¸¤è€…éƒ½è¦åŒæ—¶è®¾ç½®ï¼Œä¸ç„¶ä¼šå­˜åœ¨å› å¯†ç é”™è¯¯æ— æ³•åŒæ­¥æ•°æ®\n   3. å¦‚æœæƒ³æ›´åŠ ç»†è‡´åŒ–çš„æ§åˆ¶redisçš„æƒé™å¯ä»¥æ–°å»ºç”¨æˆ·å¹¶ä¸”ä½¿ç”¨`ACL`çš„åŠŸèƒ½ [ACL | Docs (redis.io)](https://redis.io/docs/latest/operate/oss_and_stack/management/security/acl/)\n\n\n3. podçš„ipé—®é¢˜ï¼Œåœ¨ç¬¬ä¸€æ¬¡å¯åŠ¨redisé›†ç¾¤çš„æ—¶å€™ï¼Œä¼šæŠŠé›†ç¾¤ä¿¡æ¯å†™å…¥`/data/nodes.conf`ç±»ä¼¼\n\n   > 127.0.0.1:6379> CLUSTER NODES\n   > 171465406d506a29e3bfcd2cf62a578dfe048613 10.42.0.109:6379@16379 master - 0 1723877446841 3 connected 10923-16383\n   > 6ddad196c4998856d7587a2a31012bd3570342e8 10.42.0.111:6379@16379 myself,slave 50fc764dae51be95e3f24527b2458ceb44533a84 0 0 2 connected\n   > e43744bd3bd58f04158ea90bc044b1b200e0b153 10.42.1.40:6379@16379 slave 171465406d506a29e3bfcd2cf62a578dfe048613 0 1723877446842 3 connected\n   > 2ca5a824b3edca3baaf8caacf6d036061c9cb647 10.42.0.110:6379@16379 slave 5947054d518ac8ed6b1aeb4b378ad50eedd3bcbb 0 1723877445837 1 connected\n   > 5947054d518ac8ed6b1aeb4b378ad50eedd3bcbb 10.42.0.108:6379@16379 master - 0 1723877445000 1 connected 0-5460\n   > 50fc764dae51be95e3f24527b2458ceb44533a84 10.42.1.39:6379@16379 master - 0 1723877446000 2 connected 5461-10922\n\n   ä½†æ˜¯åœ¨é‡å¯redisé›†ç¾¤åpodçš„ipä¼šæ›´æ”¹ï¼Œå¯¼è‡´é›†ç¾¤çŠ¶æ€ä¸º`failed `ã€‚è§£å†³å¯ä»¥[å‚è€ƒ](https://github.com/redis/redis/issues/4289)\n\n## Ginåç«¯\n\n> ä»£ç  [k8s_demo/web/back at main Â· kehaha-5/k8s_demo (github.com)](https://github.com/kehaha-5/k8s_demo/tree/main/web/back)\n\nè¿™ä¸ªginåç«¯çš„è¯ï¼Œé™¤äº†æä¾›apiæœåŠ¡ä»¥å¤–å®ƒè¿˜è€Œå¤–ç›‘å¬ä¸€ä¸ªç«¯å£ç”¨æ¥ç»™podæä¾›å¥åº·æ£€æµ‹ [é…ç½®å­˜æ´»ã€å°±ç»ªå’Œå¯åŠ¨æ¢é’ˆ]([Kubernetes](https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/))\n\n```dockerfile\nFROM alpine:3.20.2\nCOPY ./k8s_demo /app/k8s_demo\nCOPY ./config-prod.yaml /app/config-prod.yaml\nRUN set -eux && sed -i 's/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g' /etc/apk/repositories\nRUN apk update && apk add tzdata\n```\n\næˆ‘ä»¬è¦æŠŠåç«¯ä»£ç å’Œæ‰€éœ€è¦çš„ç¯å¢ƒæ‰“åŒ…æˆé•œåƒï¼Œå› ä¸ºæˆ‘çš„k3sä½¿ç”¨çš„è¿è¡Œæ—¶æ˜¯`containerd`ï¼Œæ‰€ä»¥è¿™é‡Œåˆ©ç”¨`docker`è¿›è¡Œæ‰“åŒ…ï¼Œç„¶åå¯¼å‡ºé•œåƒå†å¯¼å…¥åˆ°`containerd`é‡Œé¢\n\n```shell\ndocker build -t k8s_demo/back:1.0 . #æ³¨æ„-tçš„æ ¼å¼ï¼Œåªæœ‰è¿™æ ·çš„æ ¼å¼å¯¼å…¥åˆ°cträ¸­æ‰ä¼šä¿ç•™\ndocker save  k8s_demo/back -o k8s_demo_back.tar\nctr -n k8s.io images import k8s_demo_back.tar #å¯¼å…¥æ—¶ï¼Œè¦é€‰æ‹©k8s.ioçš„namesapce ä¸ç„¶å¯èƒ½å‡ºç°podæ‰¾ä¸åˆ°image\n```\n\n```yaml\n#k8s-demo-back-end\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: k8s-demo-back-end\n  namespace: prod\n  labels:\n    app: k8s-demo-back-end\nspec:\n  replicas: 2\n  selector:\n    matchLabels:\n      app: k8s-demo-back-end\n  template:\n    metadata:\n      labels:\n        app: k8s-demo-back-end\n    spec:\n      affinity:\n        podAntiAffinity:\n          preferredDuringSchedulingIgnoredDuringExecution:\n          - weight: 100\n            podAffinityTerm:\n              labelSelector:\n                matchExpressions:\n                - key: app\n                  operator: In\n                  values:\n                  - k8s-demo-back-end\n              topologyKey: kubernetes.io/hostname\n      containers:\n      - name: k8s-demo-back-end\n        image: docker.io/k8s_demo/back:1.0@sha256:bf9041895c649d1a586851e2f2e072fb9680fe134c359ea59a577b010029ba5d\n        command: [\"/app/k8s_demo\"]\n        args: [\"-c\",\"/app/config-prod.yaml\"]\n        ports:\n        - name: api-port\n          containerPort: 40814\n        livenessProbe:\n          httpGet:\n            path: /api/health\n            port: 8080\n          initialDelaySeconds: 30\n          periodSeconds: 3\n        env:\n        - name: REDIS_PASSWORD\n          valueFrom:\n            secretKeyRef:\n              name: redis\n              key: pass\n        - name: MYSQL_PASSWORD\n          valueFrom:\n            secretKeyRef:\n              name: mysql\n              key: pass\n        - name: GIN_MODE\n          value: \"release\"\n        resources:\n          requests:\n            cpu: \"200m\"\n            memory: \"200Mi\"\n          limits:\n            cpu: \"1000m\"\n            memory: \"500Mi\"\n     \n#service.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: k8s-demo-back-end-service\n  namespace: prod\n  labels:\n    name: k8s-demo-back-end-service\nspec:\n  selector:\n    app: k8s-demo-back-end\n  ports:\n    - protocol: TCP\n      name: api-port\n      port: 40814     \n      targetPort: 40814  \n  clusterIP: None\n```\n\nè¿™é‡Œè¦æ³¨æ„ä¸€ä¸‹ï¼Œå› ä¸ºæˆ‘ä¸€ä¸ªå…±æœ‰3å°æœåŠ¡å™¨ï¼Œé™¤å»ä¸€å°ä¸“é—¨çš„å‰ç«¯æœåŠ¡å™¨ï¼Œé‚£æˆ‘è¿˜æœ‰ä¸¤å°æœåŠ¡å™¨ï¼Œæ‰€ä»¥è¿™é‡Œçš„`replicas`è®¾ç½®ä¸º2ï¼Œç„¶åæˆ‘æƒ³è®©æ¯ä¸ªpodå°½é‡ä¸è¦è°ƒåº¦åˆ°åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Šé¢ï¼Œæ‰€ä»¥ä½¿ç”¨äº†`affinity.podAntiAffinity`å°½é‡ä¸è¦è°ƒåº¦åˆ°å·²ç»æœ‰`app=k8s-demo-back-end`çš„èŠ‚ç‚¹ä¸Šé¢\n\n```shell\nroot@node-m:~/k8s# kubectl get pods -n prod -l app=k8s-demo-back-end -o wide\nNAME                   READY   STATUS    RESTARTS   AGE   IP            NODE     NOMINATED NODE   READINESS GATES\nk8s-demo-back-end...   1/1     Running   0          28s   10.42.1.42    node-s   <none>           <none>\nk8s-demo-back-end...   1/1     Running   0          27s   10.42.0.116   node-m   <none>           <none>\n```\n\n## å‰ç«¯éƒ¨ç½²\n\n> ä»£ç  [k8s_demo/web/front/k8s_demo at main Â· kehaha-5/k8s_demo (github.com)](https://github.com/kehaha-5/k8s_demo/tree/main/web/front/k8s_demo)\n\nè¿™é‡Œä¹Ÿæ˜¯è¦ä½¿ç”¨dockerè¿›è¡Œæ‰“åŒ…\n\n```dockerfile\nFROM  alpine:3.20.2\nCOPY ./dist/ /app/\n```\n\nå¯¼å…¥åˆ°`containerd`\n\n```shell\ndocker build -t k8s_demo/front:1.0 .\ndocker save  k8s_demo/front -o k8s_demo_front.tar\nctr -n k8s.io images import k8s_demo_front.tar\n```\n\n```yaml\n#configmap.yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: web-nginx\n  namespace: prod\ndata:\n  app.conf: |\n    server {\n        listen       80;\n        listen  [::]:80;\n        server_name  localhost;\n\n        #access_log  /var/log/nginx/host.access.log  main;\n\n        location / {\n            root   /usr/share/nginx/html;\n            index  index.html index.htm;\n            try_files $uri $uri/ /index.html; #vue3çš„historyæ¨¡å¼ä¸‹çš„è·¯ç”±é…ç½®\n        }\n    }\n\n#k8s-demo-back-front\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: k8s-demo-back-front\n  namespace: prod\nspec:\n  selector:\n    matchLabels:\n      app: k8s-demo-back-front\n      app.kubernetes.io/name: k8s-demo-back-front\n  template:\n    metadata:\n      labels:\n        app: k8s-demo-back-front\n        app.kubernetes.io/name: k8s-demo-back-front\n    spec:\n      tolerations:\n        - key: \"type\"\n          operator: \"Equal\"\n          value: \"res\"\n          effect: \"NoSchedule\"\n      initContainers:\n        - name: init-nginx\n          image: docker.io/k8s_demo/front:1.0@sha256:fecfc2dc67c49d8ff27a77cff8aee431f9baaee3ffc0fd22da8e8da20caaeddf\n          command:\n          - sh\n          - \"-c\"\n          - |\n            set -ex\n            cp -r /app/* /mnt/app/\n          volumeMounts:\n          - name: app\n            mountPath: /mnt/app/\n      containers:\n      - name: app-nginx\n        image: nginx:1.27.1-alpine3.20\n        volumeMounts:\n          - name: app\n            mountPath: /usr/share/nginx/html/\n          - name: config-map\n            mountPath: /etc/nginx/conf.d/\n        ports:\n        - name: app-nginx\n          containerPort: 80\n      volumes:\n      - name: app\n        emptyDir: {}\n      - name: config-map\n        configMap: \n          name: web-nginx\n      \n#service.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: k8s-demo-back-front-service\n  namespace: prod\n  labels:\n    name: k8s-demo-back-front-service\nspec:\n  selector:\n    app: k8s-demo-back-front\n  ports:\n    - protocol: TCP\n      name: web\n      port: 80     \n      targetPort: 80  \n  clusterIP: None\n\n```\n\nè¿™é‡Œéœ€è¦æ³¨æ„ä¸€ä¸‹æˆ‘ä½¿ç”¨äº†`tolerations`å®¹å¿ï¼Œå®¹å¿äº†èŠ‚ç‚¹å¯ä»¥å­˜åœ¨`type=res`çš„é”®å€¼å¯¹ï¼Œåˆšå¥½å¯¹åº”äº†`node-res`è¿™ä¸ªä¸“é—¨ç”¨æ¥è¿è¡Œå‰ç«¯çš„èŠ‚ç‚¹\n\n```shell\nroot@node-m:~/k8s# kubectl get pods -n prod -l app=k8s-demo-back-front -o wide\nNAME                     READY   STATUS    RESTARTS        AGE   IP           NODE       NOMINATED NODE   READINESS GATES\nk8s-demo-back-front...   1/1     Running   3 (3h10m ago)   23h   10.42.2.41   node-res   <none>           <none>\n```\n\n## ingress\n\nç°åœ¨æ‰€æœ‰çš„æœåŠ¡éƒ½éƒ¨ç½²äº†ï¼Œä½†æ˜¯éœ€è¦æŠŠå®ƒä»¬ç»Ÿä¸€æš´éœ²å‡ºå»ç»™å¤–éƒ¨è®¿é—®ï¼Œè¿™é‡Œå°±ç”¨åˆ°äº†`ingress`ï¼Œ`ingress`å¯ä»¥è¯´æ˜¯ç®¡ç†`service`çš„`service`æ‰€ä»¥å°±æ˜¯å®ƒæ¥æš´éœ²æœåŠ¡åˆ°å¤–éƒ¨\n\nä¸ºäº†è®©`ingress`å¯ä»¥æ­£å¸¸å·¥ä½œï¼Œæˆ‘ä»¬å¿…é¡»è¦æœ‰ä¸€ä¸ªå¯ç”¨çš„`ingress`æ§åˆ¶å™¨ [Ingress æ§åˆ¶å™¨ | Kubernetes](https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress-controllers/)\n\nè¿™é‡Œä½¿ç”¨çš„æ˜¯k3sé»˜è®¤ä½¿ç”¨çš„æ˜¯`Traefik ingress controller`çš„ï¼Œæ‰€ä»¥ç¬¬ä¸€æ­¥å…ˆè¦éƒ¨ç½²`traefik`çš„`dashboard`\n\n### Traefik dashboard\n\n```yaml\napiVersion: v1\nkind: Namespace\nmetadata:\n  name: traefik-dashboard\n  labels:\n    name: traefik-dashboard\n\n---\n\napiVersion: traefik.io/v1alpha1\nkind: IngressRoute\nmetadata:\n  name: traefik-dashboard\n  namespace: traefik-dashboard\nspec:\n  routes:\n  - match: Host(`traefik.localhost.com`) && (PathPrefix(`/api`) || PathPrefix(`/dashboard`))\n    kind: Rule\n    services:\n    - name: api@internal\n      kind: TraefikService\n    middlewares:\n      - name: auth\n\n---\n\napiVersion: traefik.io/v1alpha1\nkind: Middleware\nmetadata:\n  name: auth\n  namespace: traefik-dashboard\nspec:\n  basicAuth:\n    secret: authsecret  # Kubernetes secret named \"secretName\"\n\n\n--- \n\napiVersion: v1\nkind: Secret\nmetadata:\n  name: authsecret\n  namespace: traefik-dashboard\ndata:\n  users:\n    cm9vdDokYXByMSRibUhSclNOaSQ0L2d4L0xNMmpzVGdBRTUzMTcwSEkuCgo= #htpasswd -nb root wwM9yCz52mWpWysVONM0 | base64\n```\n\nè¿™ä¸ªå°±æ˜¯éƒ¨ç½²`Traefik dashboard`çš„é…ç½®ï¼Œå®ƒå°±æ˜¯ä½¿ç”¨`ingress route`æŠŠæœåŠ¡æš´éœ²åˆ°äº†`traefik.localhost.com`çš„`/dashboard`å’Œ`/api`ã€‚åŒæ—¶æˆ‘è¿˜ä½¿ç”¨äº†ä¸­é—´ä»¶æ¥åšç”¨æˆ·è®¤è¯ï¼Œåœ¨è®¿é—®çš„æ—¶å€™å¿…é¡»è¾“å…¥è´¦å·å’Œå¯†ç æ‰èƒ½æ­£å¸¸è®¿é—®ï¼Œå¦åˆ™å°±æ˜¯401ã€‚\n\né™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘è¿˜è¦ä¿®æ”¹æœ¬åœ°çš„hostæ–‡ä»¶æŠŠ`traefik.localhost.com`è¿™ä¸ªåŸŸåæŒ‡å‘æˆ‘çš„èŠ‚ç‚¹ipã€‚ä¹‹åè®¿é—®`http://traefik.localhost.com/dashboard/#/`å³å¯\n\n![Traefik-dashboard](.\\2.png)\n\nå‚è€ƒ:\n\n[Traefik Dashboard Documentation - Traefik](https://doc.traefik.io/traefik/operations/dashboard/)   \n\n[Traefik BasicAuth Documentation - Traefik](https://doc.traefik.io/traefik/middlewares/http/basicauth/)\n\n### æœåŠ¡é…ç½®\n\n```yaml\napiVersion: traefik.io/v1alpha1\nkind: Middleware\nmetadata:\n  name: header\n  namespace: prod\nspec:\n  headers:\n    accessControlAllowMethods:\n      - \"GET\"\n      - \"OPTIONS\"\n      - \"POST\"\n      - \"PUT\"\n    accessControlAllowHeaders:\n      - \"*\"\n    addVaryHeader: true\n    accessControlAllowOriginList: \n      - \"*\" #è¿™é‡Œæœ€å¥½è®¾ç½®ä¸ºå‰ç«¯çš„åŸŸå web.k8s.demo\n\n---\n\napiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: web-ingress\n  namespace: prod\n  annotations:\n    traefik.ingress.kubernetes.io/router.middlewares: prod-header@kubernetescrd\nspec:\n  rules:\n  - host: api.k8s.demo\n    http:\n      paths:\n      - path: /api\n        pathType: Prefix\n        backend:\n          service:\n            name: k8s-demo-back-end-service\n            port: \n              number: 40814\n  - host: web.k8s.demo\n    http:\n      paths:\n      - path: /\n        pathType: Prefix\n        backend:\n          service:\n            name: k8s-demo-back-front-service\n            port: \n              number: 80\n```\n\nè¿™ä¸ªå°±æ˜¯æˆ‘çš„æœåŠ¡é…ç½®ï¼Œè¿™é‡Œä½¿ç”¨äº†`api.k8s.demo`è®¿é—®åç«¯ï¼Œ`web.k8s.demo`è®¿é—®å‰ç«¯ï¼Œå…¶ä¸­`web.k8s.demo`è¦æŠŠipç»‘å®šåˆ°å‰ç«¯èŠ‚ç‚¹ä¸Šé¢ï¼ŒåŒæ—¶è¿™é‡Œè¿˜å†™äº†ä¸€ä¸ªä¸­é—´ä»¶æ¥è§£å†³è·¨åŸŸé—®é¢˜ã€‚\n\n![Traefik-ingress1](.\\3.png)\n\n![Traefik-ingress1](.\\4.png)\n\nè¿™é‡Œéœ€è¦æ³¨æ„ä¸¤ç‚¹ï¼š\n\n1. åœ¨`Ingress`é‡Œé¢ä½¿ç”¨ä¸­é—´ä»¶éœ€è¦éµå¾ªä¸€å®šçš„å‘½åè§„åˆ™\n\n   > ```yaml\n   > apiVersion: traefik.io/v1alpha1\n   > kind: Middleware\n   > metadata:\n   >   name: stripprefix\n   >   namespace: appspace\n   > spec:\n   >   stripPrefix:\n   >     prefixes:\n   >       - /stripit\n   > \n   > ---\n   > apiVersion: networking.k8s.io/v1\n   > kind: Ingress\n   > metadata:\n   >   name: ingress\n   >   namespace: appspace\n   >   annotations:\n   >     # referencing a middleware from Kubernetes CRD provider: \n   >     # <middleware-namespace>-<middleware-name>@kubernetescrd\n   >     \"traefik.ingress.kubernetes.io/router.middlewares\": appspace-stripprefix@kubernetescrd\n   > spec:\n   >   # ... regular ingress definition\n   > ```\n   >\n   > [Traefik Configuration Discovery Overview - Traefik](https://doc.traefik.io/traefik/providers/overview/#provider-namespace)\n\n2. åœ¨åé¢å®ç°çš„æ—¶å€™å‘ç°å› ä¸ºä½¿ç”¨äº†ingress å¯¼è‡´æ— è®ºæ˜¯è®¿é—®å‰ç«¯è¿˜æ˜¯åç«¯æµé‡éƒ½ä¼šèµ°åˆ°èŠ‚ç‚¹ä¸Šé¢ï¼Œæ‰€ä»¥å¦‚æœçœŸçš„è¦æŠŠæµé‡åˆ†å¼€ï¼Œæœ€å¥½æ˜¯ä¸ç”¨`ingress`ï¼Œä½¿ç”¨serviceä¸­çš„`NodePort`å…¬å¼€æœåŠ¡\n\nok ä»¥ä¸Šå°±æ˜¯`ä»é›¶åˆ°ä¸€--æ­å»ºwebé¡¹ç›®é›†ç¾¤`æ‰€æœ‰å†…å®¹äº†","tags":["k8s_demo","k3s"]},{"title":"docker-compose éƒ¨ç½²php-webé¡¹ç›®","url":"/2024/04/18/docker-compose-éƒ¨ç½²php-webé¡¹ç›®/","content":"\n> æœ€è¿‘æœ‰ä¸€ä¸ªæœ‹å‹ä»–æƒ³è®©æˆ‘å¸®ä»–éƒ¨ç½²ä¸€ä¸ªå‡ å¹´å‰çš„phpé¡¹ç›®ï¼Œæ—¢ç„¶æ˜¯å‡ å¹´å‰çš„å°±é¡¹ç›®äº†ï¼Œä¸ºä»€ä¹ˆè¿˜è¦é‡æ–°éƒ¨ç½²æï¼Ÿé‚£è‚¯å®šæ˜¯è¿˜æœ‰å‰©ä½™ä»·å€¼å•Š\n\n# æ¡†æ¶å‡çº§\nåœ¨éƒ¨ç½²é¡¹ç›®ä¹‹å‰ï¼Œå…ˆçœ‹ä¸€ä¸‹è¿™ä¸ªé¡¹ç›®æœ‰ä»€ä¹ˆå®‰å…¨é—®é¢˜ï¼Œå‘ç°åœ¨githubçš„Dependabot alertsç»™æˆ‘æŠ¥å‘Šäº†10ä¸ªå·¦å³çš„å®‰å…¨é—®é¢˜ï¼Œçœ‹äº†ä¸€ä¸‹ï¼Œé™¤äº†è€ç”Ÿå¸¸è°ˆçš„phpåºåˆ—åŒ–æ¼æ´ä»¥å¤–ï¼Œå‰©ä¸‹çš„éƒ½å¯ä»¥é€šè¿‡å‡çº§ä¾èµ–æ¥è¿›è¡Œè§£å†³ï¼Œæ‰€ä»¥ç¬¬ä¸€ä»¶äº‹å°±æ˜¯å…ˆæŠŠé¡¹ç›®çš„ä¾èµ–è¿›è¡Œå‡çº§\n\n![alerts](.\\1.png)\n\n# é¡¹ç›®ç»“æ„ && ä¾èµ–å®‰è£…\n\nokï¼Œä¾èµ–å‡çº§å¥½äº†ï¼Œå°±å…ˆcloneä¸‹æ¥çœ‹ä¸€ä¸‹ç›®å½•ç»“æ„å…ˆã€‚åˆ©ç”¨treeå‘½ä»¤æŸ¥çœ‹é¡¹ç›®ç»“æ„\n```sh\nkehaha@DESKTOP-4GO6ORF:~/docker/xxxxx$ tree -L 2 \n.\nâ””â”€â”€ xxxxx\n    â”œâ”€â”€ README.md\n    â”œâ”€â”€ back_end\n    â””â”€â”€ font_end\n\n3 directories, 1 file\n```\nä¸éš¾å‘ç°ï¼Œè¿™ä¸ªé¡¹ç›®æ˜¯ä¸€ä¸ªå‰åç«¯åˆ†ç¦»çš„é¡¹ç›®.\n\n## back_end\nå…ˆçœ‹ä¸€ä¸‹åç«¯çš„æ–‡ä»¶ï¼Œç‚¹å¼€æ¥çœ‹bank_endè¿›è¡ŒæŸ¥çœ‹ï¼Œå…ˆçœ‹ä¸€ä¸‹phpç”¨æ¥ç®¡ç†ä¾èµ–çš„`composer.json`\n```json\n\"require\": {\n    \"php\": \">=7.1.0\",\n    \"topthink/framework\": \"^6.0.0\",\n    \"topthink/think-orm\": \"^2.0\",\n    \"topthink/think-multi-app\": \"^1.0\",\n    \"topthink/think-captcha\": \"^3.0\",\n    \"thans/tp-jwt-auth\": \"^1.1\",\n    \"phpoffice/phpspreadsheet\": \"^1.17\"\n},\n```\nå¥½çš„è¿™ä¸ªé¡¹ç›®ç”¨åˆ°äº†thinkphp6ï¼Œè¦æ±‚çš„phpç‰ˆæœ¬è¦å¤§äº 7.1ã€‚æ—¢ç„¶è¿™æ ·å…ˆåˆ©ç”¨[composer](https://www.phpcomposer.com/)æ¥å®‰è£…åç«¯çš„ä¾èµ–ã€‚\n\nå› ä¸ºæˆ‘çš„ç”µè„‘é‡Œé¢æ²¡æœ‰å®‰è£…phpå’Œcomposer æ‰€ä»¥è¿™æ¬¡å°±åˆ©ç”¨dockeræ¥å®‰è£…ä¾èµ–ï¼Œè¿™é‡Œé€‰æ‹©çš„æ˜¯composer:1.8.2çš„é•œåƒ\n```sh\nkehaha@DESKTOP-4GO6ORF:~/docker/xxxx/xxxx/back_end$ docker run --rm --interactive --tty   --volume $PWD:/app composer:1.8.2 composer i\nLoading composer repositories with package information\nInstalling dependencies (including require-dev) from lock file\nYour requirements could not be resolved to an installable set of packages.\n\n  Problem 1\n    - Installation request for phpoffice/phpspreadsheet 1.17.1 -> satisfiable by phpoffice/phpspreadsheet[1.17.1].\n    - phpoffice/phpspreadsheet 1.17.1 requires ext-gd * -> the requested PHP extension gd is missing from your system.\n\n  To enable extensions, verify that they are enabled in your .ini files:\n    -\n    - /usr/local/etc/php/conf.d/date_timezone.ini\n    - /usr/local/etc/php/conf.d/docker-php-ext-sodium.ini\n    - /usr/local/etc/php/conf.d/docker-php-ext-zip.ini\n    - /usr/local/etc/php/conf.d/memory-limit.ini\n  You can also run `php --ini` inside terminal to see which files are used by PHP in CLI mode.\n```\nä¾èµ–å®‰è£…å¤±è´¥äº†å› ä¸ºéœ€è¦å®‰è£…gdæ‰©å±•ï¼Œçœ‹æ¥ä¸å¦‚ç›´æ¥å®‰è£…phpç„¶åå®‰è£…å®Œæ‰€éœ€è¦çš„æ‰©å±•æœ€åå†å®‰è£…composeræ¥ä¸‹è½½ä¾èµ–ã€‚æ‰€ä»¥è¿™æ¬¡ç›´æ¥åˆ©ç”¨dockerçš„phpæ¥å®‰è£…çš„æ¡†æ¶ä¾èµ–å’Œæ‰©å±•ä¾èµ–ï¼Œè¿™é‡Œæˆ‘é€‰æ‹©çš„php:7.3.33-zts-alpine3.14ã€‚\n\né‚£ä¹ˆphpå¦‚ä½•å¿«é€Ÿå®‰è£…æ‰©å±•ï¼Œå¯ä»¥å‚è€ƒ[hub.dockerphpçš„overview](https://hub.docker.com/_/php#:~:text=How%20to%20install%20more%20PHP%20extensions)ã€‚è¿™é‡Œæˆ‘é€‰æ‹©çš„ä½¿ç”¨[docker-php-extension-installer](https://github.com/mlocati/docker-php-extension-installer)æ¥å®‰è£…æ‰©å±•ã€‚\n\né¦–å…ˆå…ˆå¯åŠ¨php:7.3.33çš„å®¹å™¨å¹¶æŠŠé¡¹ç›®æŒ‚è½½åˆ°å®¹å™¨å†…ï¼Œç„¶åè¿›å…¥å®¹å™¨ï¼Œå®‰è£…è„šæœ¬ï¼Œå®‰è£…ä¾èµ–\n```sh\ninstall-php-extensions gd zip @composer #åé¢å‘ç°è¿˜è¦å®‰è£…zip\n```\nå®‰è£…å®Œæˆåï¼Œåˆ©ç”¨`composer i`å®‰è£…æ¡†æ¶ä¾èµ–\n```sh\nGenerating autoload files\n> @php think service:discover\nSucceed!\n> @php think vendor:publish\nFile /app/config/jwt.php exist!\nFile /app/config/captcha.php exist!\nFile /app/config/trace.php exist!\nSucceed!\n9 packages you are using are looking for funding.\nUse the `composer fund` command to find out more!\n```\né‚£ä¹ˆåç«¯æ¡†æ¶ä¾èµ–å°±å®‰è£…å®Œæˆäº†ã€‚\n\n## front_end\nè¿›åˆ°å‰ç«¯çš„æ–‡ä»¶ï¼Œçœ‹äº†ä¸€ä¸‹æ˜¯ä¸€ä¸ªvue2çš„é¡¹ç›®ï¼Œæˆ‘çš„ç”µè„‘æ˜¯å®‰è£…äº†nvmçš„ï¼Œå› æ­¤å¯ä»¥ä¸ç”¨dockeræ¥å®‰è£…ä¾èµ–å’Œæ‰“åŒ…é¡¹ç›®ã€‚å…ˆç”¨ `nvm use 14` åˆ‡æ¢åˆ° node14 çš„ç‰ˆæœ¬ï¼Œç„¶åç”¨ `npm i` å’Œ `npm run build:prod` æ¥è¿›è¡Œä¾èµ–å’Œé¡¹ç›®çš„å®‰è£…\n\n# ç¼–å†™éƒ¨ç½²æ–‡ä»¶\n\nå› ä¸ºæ•´ä¸ªé¡¹ç›®è¦ç”¨åˆ°`mysql` `nginx` `php-fpm`å› æ­¤åˆ©ç”¨docker-composeæ¥è¿›è¡Œé¡¹ç›®éƒ¨ç½²ã€‚é¦–å…ˆç¼–å†™docker-compose.yamlï¼ŒæŠŠè¦åˆ©ç”¨åˆ°çš„é•œåƒå’Œç«¯å£éƒ½è¿›è¡Œé…ç½®ï¼Œè¿™é‡Œä¸ç”¨æŒ‚è½½æ˜¯å› ä¸ºè¿™ä¸ªé¡¹ç›®åªæ˜¯è·‘æ¥æµ‹è¯•ï¼Œä¸æ˜¯æ­£å¼ä¸Šçº¿ï¼Œæ‰€ä»¥å°±æ²¡æœ‰ä½¿ç”¨volumeè¿›è¡Œæ–‡ä»¶æŒ‚è½½äº†ã€‚\n\n## docker-compose.yaml\n```yaml\nversion: \"3.8\"\n\nnetworks:\n  web_network:\n\nservices:\n  back:\n    container_name: php_back\n    build: ./php/\n    networks:\n      - web_network\n    depends_on:\n      - _front\n      - _mysql\n    restart: always\n    tty: true\n\n  front:\n    build: ./nginx/\n    container_name: _front\n    networks:\n      - web_network\n    ports:\n      - \"4416:80\"\n    restart: always\n\n  mysql:\n    build: ./mysql/\n    container_name: _mysql\n    networks:\n      - web_network\n    ports:\n      - \"44166:3306\"\n    restart: always\n```\nè¿™é‡Œå¯èƒ½å°±æœ‰é—®é¢˜äº†ï¼Œæ‰€æœ‰å®¹å™¨è™½ç„¶å†åŒä¸€ä¸ªcomposeä¸­ï¼Œä½†æ˜¯å®¹å™¨è‡ªå·±æ˜¯å¦‚ä½•è®¿é—®å¯¹æ–¹çš„æã€‚å…¶å®è¿™é‡Œæˆ‘å®šä¹‰äº†ä¸€ä¸ª`web_network`é‚£ä¹ˆå®ƒä»¬éƒ½åœ¨è¿™ä¸ªç½‘ç»œé‡Œé¢çš„è¯ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡å®¹å™¨åæ¥è®¿é—®å¯¹æ–¹ã€‚\n[å®˜æ–¹æ–‡æ¡£](https://docs.docker.com/compose/networking/#:~:text=For%20example%2C%20suppose,is%20running%20locally.)\n\n## nginx \nè¿™é‡Œå•ç‹¬ç¼–å†™nginxçš„Dockerfileæ˜¯å› ä¸ºè¦è¿›è¡Œä¸€äº›é…ç½®\n```yaml\nFROM nginx:stable\n\nCOPY ./dist/ /usr/share/nginx/html/ #å¤åˆ¶å‰ç«¯æ‰“åŒ…å¥½çš„æ–‡ä»¶è¿›å…¥\n\nCOPY ./default.conf /etc/nginx/conf.d/\n\nEXPOSE 80\n\n```\n```conf\nserver {\n    listen       80;\n    listen  [::]:80;\n    server_name  localhost;\n\n    location / {\n        root   /usr/share/nginx/html;\n        index  index.html index.htm;\n    }\n    error_page   500 502 503 504  /50x.html;\n    location = /50x.html {\n        root   /usr/share/nginx/html;\n    }\n\n    location ~ \\.php$ {\n        root           html;\n        fastcgi_pass   php_back:9000; #phpçš„å®¹å™¨åç§°\n        fastcgi_index  index.php;\n        fastcgi_param  SCRIPT_FILENAME  /var/www/html/$fastcgi_script_name; #è¿™ä¸ª/var/www/html/æ˜¯phpå®¹å™¨ä¸­é¡¹ç›®å­˜æ”¾çš„ä½ç½®ï¼Œå°±æ˜¯é€šè¿‡è·å–è¦æ‰§è¡Œçš„phpæ–‡ä»¶ä½ç½®æ¥è°ƒç”¨cgiæ¥æ‰§è¡Œå¯¹åº”çš„phpæ–‡ä»¶\n        include        fastcgi_params;\n    }\n}\n```\n\n## php\n\nè¿™é‡Œçš„phpæˆ‘ä½¿ç”¨çš„æ˜¯ `php:7.3-fpm-alpine3.14` ä¸ºä»€ä¹ˆæï¼Œåœ¨ `dockerhub` çš„ `php overview` ä¸­æœ‰å¦‚ä¸‹è§£é‡Šã€‚[å®˜æ–¹æ–‡æ¡£](https://hub.docker.com/_/php#:~:text=php%3A%3Cversion%3E%2Dfpm,this%20image%20variant.)\n```text\nphp:<version>-fpm\nThis variant contains PHP-FPM, which is a FastCGI implementation for PHP. See the PHP-FPM website for more information about PHP-FPM.\n\nIn order to use this image variant, some kind of reverse proxy (such as NGINX, Apache, or other tool which speaks the FastCGI protocol) will be required.\n\nSome potentially helpful resources:\n\nPHP-FPM.org\nsimplified example by @md5\nvery detailed article by Pascal Landau\nStack Overflow discussion\nApache httpd Wiki example\nWARNING: the FastCGI protocol is inherently trusting, and thus extremely insecure to expose outside of a private container network -- unless you know exactly what you are doing (and are willing to accept the extreme risk), do not use Docker's --publish (-p) flag with this image variant.\n```\næˆ‘ä»¬æ˜¯åˆ©ç”¨nginxæ¥è®¿é—®cgiæ¥è°ƒç”¨phpçš„ï¼Œå› æ­¤æˆ‘ä»¬è¦ä½¿ç”¨fpmçš„ç‰ˆæœ¬ã€‚\n\nå¦‚ä¸‹æ˜¯phpçš„Dokerfile\n```yaml\nFROM php:7.3-fpm-alpine3.14\n\nRUN curl -sSLf \\\n        -o /usr/local/bin/install-php-extensions \\\n        https://github.com/mlocati/docker-php-extension-installer/releases/latest/download/install-php-extensions && \\\n    chmod +x /usr/local/bin/install-php-extensions && \\\n    install-php-extensions gd zip #å®‰è£…ä¾èµ– gd zip\n    \nCOPY ./back_end /var/www/html/\n\nRUN mv \"$PHP_INI_DIR/php.ini-production\" \"$PHP_INI_DIR/php.ini\" \n\nEXPOSE 9000\n```\n\n## mysql\n\nmysqlçš„Dockerfileæ–‡ä»¶ï¼š\nè¿™é‡Œæˆ‘çš„mysqlç”¨çš„ç‰ˆæœ¬æ˜¯5.7.36\n\n```yaml\nFROM mysql:5.7.36\n\nCOPY ./my.cnf /etc/mysql/conf.d/ #mysqlçš„é…ç½®æ–‡ä»¶\nCOPY ./xxxx.sql /docker-entrypoint-initdb.d/xxxx.sql #å¤åˆ¶æå‰å‡†å¤‡å¥½çš„sqlæ–‡ä»¶è¿›å…¥å®¹å™¨ï¼Œå®¹å™¨åœ¨åˆå§‹åŒ–çš„æ—¶å€™ä¼šæ‰§è¡Œå¯¹åº”çš„sql\n\n# å®šä¹‰ç¯å¢ƒå˜é‡\nENV MYSQL_USER=\"xxxx\" #åˆ›å»ºç”¨æˆ·ï¼Œä¸€èˆ¬æˆ‘é¡¹ç›®éƒ¨ç½²çš„è¯ä¸ä¼šä½¿ç”¨rootç”¨æˆ·ï¼Œä¼šå•ç‹¬åˆ›å»ºä¸€ä¸ªç”¨æˆ·ï¼Œè¯¥ç”¨æˆ·åªæœ‰è¯¥åº“çš„æ‰€æœ‰æƒé™\nENV MYSQL_PASSWORD=\"xxxxx\" #åˆ›å»ºç”¨æˆ·çš„å¯†ç \nENV MYSQL_ROOT_PASSWORD=\"xxxx\" # rootç”¨æˆ·çš„å¯†ç \n\n# å®˜æ–¹æ–‡æ¡£\n# https://hubgw.docker.com/_/mysql#:~:text=Initializing%20a%20fresh,the%20MYSQL_DATABASE%20variable.\n# https://hubgw.docker.com/_/mysql#:~:text=MYSQL_DATABASE,to%20this%20database.\n# ENV MYSQL_DATABASE=\"xxxx\" å¯ä»¥åˆ›å»ºæŒ‡å®šåç§°çš„æ•°æ®åº“ï¼Œå¹¶ä¸”åœ¨æ‰§è¡Œæ—¶sqlæ—¶ä¼šé»˜è®¤ä½¿ç”¨è¯¥æ•°æ®åº“\n\nEXPOSE 3306\n```\nmy.cnfæ–‡ä»¶\n```conf\n[mysqld]\ndefault-time_zone = '+8:00'\ncharacter-set-server=utf8mb4\ncollation-server=utf8mb4_general_ci\n\n[client]\ndefault-character-set=utf8mb4\n```\nsqlæ–‡ä»¶\n```sql\nCREATE DATABASE IF NOT EXISTS xxxx  DEFAULT CHARACTER SET utf8mb4  COLLATE utf8mb4_unicode_ci; //åˆ›å»ºæ•°æ®åº“\nFLUSH PRIVILEGES; \nuse xxxx;\nSET FOREIGN_KEY_CHECKS=0;\n-- ----------------------------\n-- Table structure for xxx\n-- ----------------------------\nDROP TABLE IF EXISTS `xxx`;\nCREATE TABLE `xxx` (\n  `xxxx` int(11) NOT NULL AUTO_INCREMENT,\n  `xx` int(11) DEFAULT NULL COMMENT 'ä¸­æ–‡',\n  `xxx` varchar(11) DEFAULT NULL COMMENT 'ä¸­æ–‡',\n  `xxx` decimal(10,0) DEFAULT NULL COMMENT 'ä¸­æ–‡',\n  PRIMARY KEY (`xxxx`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\n\n.........\n```\nokï¼Œæ‰€æœ‰é…ç½®æ–‡ä»¶ç¼–å†™å¥½äº†ï¼Œå¯ä»¥è¿›è¡Œéƒ¨ç½²äº†ã€‚\n\n## éƒ¨ç½²\n\nä½¿ç”¨ `docker composer up -d --build` æ¥æ„å»ºå’Œéƒ¨ç½²é¡¹ç›®ï¼Œéƒ¨ç½²å®Œæˆè®¿é—®`127.0.0.1:4416`ï¼Œokè®¿é—®æˆåŠŸï¼ŒæŸ¥çœ‹å®¹å™¨çš„æ•°æ®åº“ä¹Ÿçœ‹åˆ°æœ‰å¯¹åº”çš„è¡¨äº†\n\n# é—®é¢˜\n\nè™½ç„¶éƒ¨ç½²æˆåŠŸï¼Œä½†æ˜¯è¿˜å­˜åœ¨ç€ä¸€äº›é—®é¢˜ \n\n## api \n\n![php-api](.\\2.png)\n\næˆ‘çš„apiæ¥å£ä¸º `/public/index.php/xxx/xxx` å¤ªé•¿äº†ï¼Œæˆ‘æƒ³ä½¿ç”¨ `/api/xxx` æ¥ä»£æ›¿ã€‚é‚£ä¹ˆå¦‚ä½•è¿›è¡Œæ›¿ä»£äº†ï¼Œè‚¯å®šæ˜¯ä½¿ç”¨`nginx`è¿›è¡Œé…ç½®\n1. é¦–å…ˆï¼Œå…ˆåœ¨å‰ç«¯çš„ `.env.production` æ–‡ä»¶ä¸­ä¿®æ”¹ `API` å‚æ•° å¹¶ä¸”è¿›è¡Œæ‰“åŒ…\n\n```js\n# just a flag\nENV = 'production'\n\n# base api\nVUE_APP_BASE_API = '/public/index.php' -> '/api'\nVUE_APP_UPLOAD_API = '/public/index.php/admin/user/Upload' -> '/api/admin/user/Upload'\nVUE_APP_DOWNLOAD_API = '/public/index.php/admin/user/download' -> '/api/admin/user/download'\n\n```\n2. ä¿®æ”¹`nginx`é…ç½®æ–‡ä»¶ä¸­å¤„ç†phpè¯·æ±‚çš„éƒ¨åˆ†\n```conf \n    location ~ ^/api/(.*)$ { # (.*)$ æŠŠ /api/abc/xxx ä¸­çš„/abc/xxxå˜æˆ $1\n        root           root;\n        fastcgi_pass   php_back:9000; \n        fastcgi_index  index.php;\n        fastcgi_param  SCRIPT_FILENAME  /var/www/html/public/index.php;\n        fastcgi_param  PATH_INFO /$1; #è®¾ç½® PATH_INFO å®šä¹‰thinkphp6çš„è·¯ç”±\n        include        fastcgi_params;\n    }\n```\n3. å°±å¯ä»¥æˆåŠŸè®¿é—®äº†\n\n![api](.\\3.png)\n\n\nè¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ä¸ºä»€ä¹ˆ æŠŠè·¯ç”±è®¾ç½®åˆ° `PATH_INFO` å°±å¯ä»¥æˆåŠŸè®¿é—®ï¼Œå› ä¸ºthinkphpæ”¯æŒé€šè¿‡`PATH_INFO`æ¥è®¿é—® [æ–‡æ¡£](https://static.kancloud.cn/manual/thinkphp/1697#:~:text=%E8%BF%99%E7%A7%8DURL%E6%A8%A1%E5%BC%8F,3)\n\n## mysqlæ‰©å±•\nå½“è®¿é—®æ•°æ®åº“çš„apiæ—¶å‘ç°å¦‚ä¸‹é—®é¢˜\n\n![api-mysql](.\\4.png)\n\né€šè¿‡æŸ¥è¯¢pdoå‘ç°è¿˜éœ€è¦å®‰è£…é©±åŠ¨ `PDO_MYSQL` \n\n![PDO_MYSQL](.\\5.png)\n\nåœ¨phpçš„Dockefileä¿®æ”¹ä¸º\n```yaml\n......\n\nRUN curl -sSLf \\\n        -o /usr/local/bin/install-php-extensions \\\n        https://github.com/mlocati/docker-php-extension-installer/releases/latest/download/install-php-extensions && \\\n    chmod +x /usr/local/bin/install-php-extensions && \\\n    install-php-extensions gd zip PDO_MYSQL #\n    \n......\n```\n## session\nå½“æ‰€æœ‰éƒ½å®‰è£…å¥½äº†ï¼Œä½†æ˜¯å½“è¦ç”¨åˆ°éªŒè¯ç è¿›è¡Œç™»é™†çš„æ—¶å€™ï¼Œå´ä¸€ç›´æ˜¾ç¤ºéªŒè¯ç é”™è¯¯ï¼Ÿç”±äºé‚£ä¸ªéªŒè¯ç ä½¿ç”¨`topthink/think-captcha`æ¥ç”Ÿæˆçš„ï¼Œæ‰€æœ‰ç›´æ¥ç‚¹å¼€å¯¹åº”çš„æºç çœ‹çœ‹æ˜¯å¦‚ä½•ç”ŸæˆéªŒè¯ç çš„\n\né¦–å…ˆæ˜¯éªŒè¯ç çš„ç”Ÿæˆï¼Œæˆ‘å‘ç°é‡Œé¢è°ƒç”¨äº†`session`æ–¹æ³•æŠŠéªŒè¯ç çš„å€¼æ”¾åˆ°äº†`session`é‡Œé¢\n\n![session1](.\\6.png)\n\nåœ¨éªŒè¯éªŒè¯ç çš„æ—¶å€™ï¼Œå°±æ˜¯ä»`session`é‡Œé¢è·å–keyæ¥è¿›è¡ŒéªŒè¯çš„\n\n![session2](.\\7.png)\n\nè€Œ`session`åœ¨è¿™ä¸ªé¡¹ç›®ä¸­æ˜¯ä»¥æ–‡ä»¶çš„å½¢å¼ä¿å­˜åœ¨ `runtime` ç›®å½•é‡Œé¢çš„ï¼Œæ‰€ä»¥æˆ‘è¿›å…¥äº†phpçš„å®¹å™¨ï¼ŒæŸ¥çœ‹`runtime`ç›®å½•å‘ç°ä»€ä¹ˆæ–‡ä»¶éƒ½æ²¡æœ‰ç”Ÿæˆï¼Œç”šè‡³logæ–‡ä»¶éƒ½æ²¡æœ‰ç”Ÿæˆ\n```sh\n/var/www/html # ls ./runtime/\n/var/www/html #\n```\næ‰€ä»¥å¾ˆæœ‰å¯èƒ½å°±æ˜¯æƒé™æœ‰é—®é¢˜ï¼Œæ‰€ä»¥åœ¨phpçš„Dockerfileä¸­ï¼ŒæŠŠ`runtime`ç›®å½•çš„æƒé™æ”¹æˆ`777` \n```yaml\n......\nRUN mv \"$PHP_INI_DIR/php.ini-production\" \"$PHP_INI_DIR/php.ini\" && chmod 777 /var/www/html/runtime    \n......\n```\næ”¹äº†ä»¥åé—®é¢˜å°±é¡ºåˆ©è§£å†³äº†ï¼Œå¯¹åº”çš„è®¿é—®logä¹Ÿæœ‰äº†\n```sh\n/var/www/html # ls ./runtime/*\n./runtime/log:\n202404\n\n./runtime/session:\nsess_3d7d70488b437c484f150d574558688f\n```\n\nè‡³æ­¤ï¼Œé¡ºåˆ©é€šè¿‡ `docker-compose` éƒ¨ç½²äº†ä¸€ä¸ªphpçš„webé¡¹ç›® ","tags":["web","docker-compose"]},{"title":"valgrindè¿›è¡Œæ€§èƒ½åˆ†æ","url":"/2024/03/05/ä½¿ç”¨valgrindè¿›è¡Œæ€§èƒ½åˆ†æ/","content":"\n> æœ€è¿‘å†™äº†ä¸€ä¸ª[c++é¡¹ç›®](https://github.com/kehaha-5/udp-transfiler)æ¥å­¦ä¹ ï¼Œåœ¨å®Œæˆåï¼Œæˆ‘æƒ³åˆ©ç”¨ `valgrind` å¯¹æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯è¿›è¡Œæ€§èƒ½åˆ†æ\n\n# å‰è¨€\n\nå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯éƒ½åœ¨æœ¬åœ°è¿è¡Œ\n\nåœ¨æœªå¼€å§‹ä¼˜åŒ–æ—¶ï¼Œå®¢æˆ·ç«¯ä¸‹è½½é€Ÿåº¦\n\n![speed1](./speed1.png)\né€Ÿåº¦åªæœ‰13MB\n\n\n# å·¥å…·\n\næœ¬æ¬¡æ€§èƒ½åˆ†æåˆ©ç”¨çš„æ˜¯valgrindçš„[callgrind](https://valgrind.org/docs/manual/cl-manual.html#cl-manual.options)å·¥å…·\n```bash\n# åˆ†æå‘½ä»¤\n valgrind --tool=callgrind --callgrind-out-file=./valgrindCheck/callgrind/client --separate-threads=yes ./build/TRANFILER_CLIENT #å®¢æˆ·ç«¯\n valgrind --tool=callgrind --callgrind-out-file=./valgrindCheck/callgrind/server --separate-threads=yes ./build/TRANFILER_SERVER #æœåŠ¡ç«¯\n#--separate-threads=<no|yes> [default: no]\n# This option specifies whether profile data should be generated separately for every thread. If yes, the file names get \"-threadID\" appended.\n```\nç»“æœåˆ†æç”¨çš„æ˜¯ [kcachegrind](https://kcachegrind.github.io)\n\n# æµ‹è¯•è¿‡ç¨‹\nå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯åˆ†åˆ«æ‰§è¡Œä»¥ä¸Šå‘½ä»¤ï¼Œç„¶åå®¢æˆ·ç«¯ä¸‹è½½ä¸€ä¸ªæ–‡ä»¶(å¤§çº¦200M)æŸ¥çœ‹ç»“æœï¼ˆå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯æ‰“åŒ…çš„éƒ½æ˜¯releaseç‰ˆæœ¬ï¼‰\n\n# åˆ†æ\n\n## å®¢æˆ·ç«¯\nå› ä¸ºæ˜¯è¦å¯¹ä¸‹è½½æ€§èƒ½è¿›è¡Œæ£€æµ‹ï¼Œå› æ­¤æˆ‘æŒ‘äº†ä¸‹è½½ä»£ç æ¥è¿›è¡Œåˆ†æ\n\n![å®¢æˆ·ç«¯-ä¸‹è½½](./speed1-client-analysis-sendMsg.png)\nä¸Šå›¾æ˜¯å®¢æˆ·ç«¯çš„å‘é€æ¶ˆæ¯çš„ä»£ç ï¼Œä»å›¾ä¸­å¯ä»¥åˆ†æå‡ºæ¥ `google::protobuf` ä½¿ç”¨äº†ä¸€åŠçš„cpuï¼Œå¦ä¸€åŠæ˜¯è¢« `setAck()`ä½¿ç”¨äº†\n\n![å®¢æˆ·ç«¯-ä¸‹è½½](./speed1-client-analysis-recv.png)\n\n![å®¢æˆ·ç«¯-ä¸‹è½½](./speed1-client-analysis-recv2.png)\n\nä¸Šé¢ä¸¤å¼ å›¾éƒ½æ˜¯å®¢æˆ·ç«¯çš„æ¥æ”¶æ•°æ®çš„ä»£ç ï¼Œä»å›¾ä¸­å¯ä»¥åˆ†æå‡ºæ¥ `google::protobuf` ä½¿ç”¨äº†å¿«80%çš„cpu \n\n## æœåŠ¡ç«¯\n![æœåŠ¡ç«¯-ä¸‹è½½](./speed1-server-analysis-1.png)\nä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼ŒæœåŠ¡ç«¯ä¸­è·å–æ–‡ä»¶å†…å®¹ `file::server` ä½¿ç”¨äº†1.63%çš„cpuï¼Œè€Œå¤„ç†`google::protobuf`ä½¿ç”¨äº† 17.26%\n\n## ç»“è®º\nå› æ­¤å¾—å‡ºå¯¼è‡´æ€§èƒ½é—®é¢˜çš„åŸå› å¤§æ¦‚ç‡æ˜¯`google::protobuf`ï¼Œæ‰“å¼€protoæ–‡ä»¶\n```proto\nsyntax = \"proto2\";\n\npackage msg.proto;\n\noption optimize_for = CODE_SIZE;\n\nmessage FileDownMsg{\n    required string hash = 1;\n    required uint64 startPos =2;\n    required uint64 dataIndex = 3;\n    optional int64 size = 4;\n    optional bytes data = 5;\n}\n```\nå‘ç°äº†é—®é¢˜ï¼šoptimize_forç”¨çš„æ˜¯CODE_SIZE ~~ä¸ºä»€ä¹ˆå½“åˆä¼šç”¨è¿™ä¸ªï¼Œæˆ‘ä¹Ÿä¸çŸ¥é“ğŸ¤¡~~ï¼Œåªè¦æŠŠoptimize_foråˆ é™¤äº†é»˜è®¤ä½¿ç”¨çš„å°±æ˜¯SPEED [æ–‡æ¡£](https://protobuf.dev/programming-guides/proto2/#:~:text=optimize_for%20(file%20option,full%20Message%20interface.)\n\n# å†æ¬¡æµ‹è¯•\n![speed2](./speed2.png)\né€Ÿåº¦è¾¾åˆ°23MBï¼Œæé«˜äº†75% ğŸ¤\n\n## å®¢æˆ·ç«¯\n![speed2-å®¢æˆ·ç«¯-ä¸‹è½½](./speed2-client-recv.png)\n\n![speed2-å®¢æˆ·ç«¯-ä¸‹è½½](./speed2-client-sendMsg.png)\n\nç”±ä¸Šé¢ä¸¤å¹…å›¾å¯ä»¥çŸ¥é“ï¼Œç»è¿‡ä¼˜åŒ–åï¼Œæ¥æ”¶æ•°æ®ä¸­çš„ `google::protobuf` çš„æ€§èƒ½ä½¿ç”¨è·Ÿ `recvfrom` çš„ä½¿ç”¨å‡ ä¹ä¸€æ ·äº†ï¼Œå‘é€ç«¯æ›´æ˜¯çœ‹ä¸åˆ°äº†`google::protobuf`æ€§èƒ½ç»Ÿè®¡\n\n## æœåŠ¡ç«¯\n![speed2-æœåŠ¡ç«¯-ä¸‹è½½](./speed2-server-analysis-1.png)\nç”±ä¸Šå›¾ä¹ŸçŸ¥æœåŠ¡ç«¯çš„`google::protobuf` çš„æ€§èƒ½ä½¿ç”¨ä¹Ÿæ˜æ˜¾ä¸‹é™äº†\n\n# è¿˜èƒ½å†ä¼˜åŒ–å—\n\n## ç¬¬äºŒæ¬¡åˆ†æ\nä½†æ˜¯ï¼Œåœ¨æœåŠ¡ç«¯ä¸­çš„å¤„ç†è¯·æ±‚ä¸­ä¸ºä»€ä¹ˆåªä½¿ç”¨äº†26%å·¦å³çš„cpuï¼Œé‚£å…¶ä»–cpuæ€§èƒ½å»å“ªé‡Œæ ğŸ¤”\n\n![speed2-æœåŠ¡ç«¯-ä¸‹è½½](./speed2-server-analysis-2.png)\n\né€šè¿‡æŸ¥çœ‹æ•´ä¸ªè°ƒç”¨æ ˆæˆ‘å‘ç°äº† `log` å‡½æ•°ä½¿ç”¨äº†40%çš„cpuï¼Œå°¤å…¶è®°å½•logæ—¶è·å–çš„æ—¶é—´å‡½æ•°\n\n## è·å–æ—¶é—´\nè·å–æ—¶é—´çš„ä»£ç å¦‚ä¸‹\n```cpp\nstd::string Log::getCurrTime() {\n    std::time_t t = std::time(NULL);\n    std::string mbstr(50, 0);\n    std::strftime(&mbstr[0], mbstr.size(), \"%F-%T\", std::localtime(&t));\n    return mbstr;\n}\n```\né‚£ä¹ˆè¿™æ®µä»£ç é‡Œé¢æœ‰ä»€ä¹ˆæ€§èƒ½é—®é¢˜æï¼Œå¯ä»¥åœ¨kcachegrindä¸­ç‚¹å‡»`log`å‡½æ•°è¿›è¡ŒæŸ¥çœ‹\n\n![speed2-æœåŠ¡ç«¯-ä¸‹è½½](./speed2-server-analysis-3.png)\n\nå‘ç°äº†å°±æ˜¯ `strftime` å’Œ `localtime`ï¼Œé‚£ä¸ºä»€ä¹ˆå®ƒä»¬æ‰§è¡Œæ€ä¹ˆæ…¢æï¼Œå› ä¸ºå®ƒä»¬éƒ½è¿›è¡Œäº†`syscall`ï¼ˆè¯¦æƒ…è¯·çœ‹[strftime](https://stackoverflow.com/questions/8174147/strftime-performance-vs-snprintf#:~:text=POSIX%20requires%20strftime%20to%20call%20tzset()%20(or%20act%20as%20if%20it%20did)%2C%20which%20on%20a%20linux%20system%20will%20likely%20stat%20/etc/timezone%20and%20other%20files%2C%20which%20is%20slow%20(compared%20to%20snprintf).%20Setting%20the%20TZ%20environment%20variable%20will%20generally%20give%20it%20a%20great%20boost.),[localtime](https://en.cppreference.com/w/cpp/chrono/c/localtime#:~:text=Notes-,This%20function%20may%20not%20be%20thread%2Dsafe.,.,-Example)ï¼‰\né‚£å¦‚ä½•è¿›è¡Œä¿®æ”¹\nç¬¬ä¸€ç§æ–¹æ³•æ˜¯ï¼šä¿®æ”¹ä»£ç ï¼Œä»£ç å‚è€ƒ[è¿™é‡Œ](https://gist.github.com/felipou/ad107bbb3a91814679beb22c0686fbeb)\nç¬¬äºŒç§æ–¹æ³•æ˜¯ï¼š~~åªç”Ÿäº§ timevalï¼Œåœ¨çœŸæ­£è¿›è¡Œå†™å…¥çš„æ—¶å€™åœ¨è½¬æ¢æˆæ—¥æœŸï¼ˆlogçº¿ç¨‹ï¼‰ä½†æ˜¯æ—¢ç„¶éƒ½è¿›è¡Œäº†ä¼˜åŒ–äº†ï¼Œè‚¯å®šæ˜¯é€‰æ‹©ç¬¬äºŒä¸ªæ–¹æ¡ˆï¼Œå¹¶ä¸”é‡‡ç”¨å‚è€ƒä»£ç é‡Œé¢çš„func3~~ï¼ˆæˆ‘éƒ½ä¸æ˜¾ç¤ºæ­£å¸¸è¯·æ±‚çš„logäº†ï¼Œè¯¦ç»†è¯·çœ‹åæ–‡ï¼‰\n\n## å†æ¬¡æµ‹è¯• ğŸ¤¡\n\n![speed3](./speed3.png)\n\n??? ä¸ºä»€ä¹ˆé€Ÿåº¦åŸºæœ¬ä¸Šè·Ÿä¸Šæ¬¡ä¸€æ ·ï¼Œé€Ÿé€Ÿæ‰“å¼€kcachegrindè¿›è¡Œåˆ†æ ğŸ¤ºğŸ¤ºğŸ¤º\n\n## ç¬¬ä¸‰æ¬¡åˆ†åˆ†æ\n\n![speed2-æœåŠ¡ç«¯-ä¸‹è½½](./speed3-server-analysis-1.png)\n\nå¯ä»¥çœ‹åˆ°`log`çš„cpuå ç”¨ç¡®å®å˜å°‘äº†ï¼Œä½†è¿˜æ˜¯å ç”¨äº†27%çš„cpuï¼Œæ‰€ä»¥ä¸å¦‚ç‚¹è¿›å»ä»”ç»†åˆ†æä¸€ä¸‹é‚£è¡Œä»£ç å ç”¨å¤§é‡cpu\n\n![speed2-æœåŠ¡ç«¯-ä¸‹è½½](./speed3-server-analysis-2.png)\nè¿›å…¥`log`åï¼Œå¯ä»¥çœ‹åˆ°åœ¨`Callee Map`ä¸­ï¼Œæœ€å¤§çš„ä¸¤å—åˆ†åˆ«æ˜¯ `sprintf` `vsprintf`\n\n![speed2-æœåŠ¡ç«¯-ä¸‹è½½](./speed3-server-analysis-3.png)\næŸ¥çœ‹åˆ°å¯¹åº”çš„ä»£ç å°±æ˜¯è¾“å‡ºæ—¶çš„æ ¼å¼åŒ–ï¼ˆè¦åœ¨debugæ¨¡å¼ä¸‹æ‰å¯ä»¥çœ‹åˆ°æºç ï¼‰ï¼Œé‚£è¿™ä¸ªçœŸçš„æ²¡æœ‰åŠæ³•ä¼˜åŒ–äº†å—ï¼Œå…¶å®è¿˜æ˜¯æœ‰çš„ï¼Œå°±æ˜¯å…³é—­æ­£å¸¸è¯·æ±‚æ—¶çš„logæ˜¾ç¤ºã€‚å› ä¸ºä¸€ä¸ªè¯·æ±‚å°±ä¼šè¾“å‡ºä¸¤ä¸ªlogä¿¡æ¯\n```bash\n2024-03-xx 09:03:44.975857 INFO 63 | udp recvfrom data to ip 127.0.0.1 prot 35512 ack is 1315955221\n2024-03-xx 09:03:44.975940 INFO 63 | udp recvfrom data to ip 127.0.0.1 prot 35512 ack is 508775843\n2024-03-xx 09:03:44.975978 INFO 90 | udp send data to ip 127.0.0.1 prot 35512 ack is 3372925139\n2024-03-xx 09:03:44.976044 INFO 90 | udp send data to ip 127.0.0.1 prot 35512 ack is 508775843\n```\nè€Œåœ¨ä¸‹è½½æ–‡ä»¶çš„æ—¶å€™ä¸€ç§’é’Ÿä¼šä¼ è¾“å¤§é‡çš„æ•°æ®åŒ…\n![speed2-æœåŠ¡ç«¯-ä¸‹è½½](./speed3-server-analysis-4.png)\nè¿™å°±ä¼šå¤§é‡è°ƒç”¨logå‡½æ•°ï¼Œä»è€Œå½±å“æ€§èƒ½ã€‚ä½†æ˜¯ä¸ºäº†è°ƒè¯•æ–¹ä¾¿ï¼Œå¯ä»¥æŠŠè¿™ä¸ªæ˜¯å¦æ˜¾ç¤ºæ­£å¸¸è¯·æ±‚çš„logå†™å…¥åˆ°é…ç½®æ–‡ä»¶ä¸­ï¼Œæ ¹æ®å®é™…è¿›è¡Œé…ç½®\n\n# æœ€ç»ˆç»“æœ\nç»è¿‡äº†ä¸Šè¿°`log`æ¨¡å—çš„ä¿®æ”¹ï¼Œä»¥ä¸‹å°±æ˜¯æœ€ç»ˆç»“æœï¼Œä»åˆšå¼€å§‹çš„13Mæå‡åˆ°35M ğŸ¤ğŸ¤\n![speed4](./speed4.png)\n","tags":["valgrind","æ€§èƒ½"]},{"title":"valgrindæ£€æµ‹å†…å­˜æ³„æ¼","url":"/2024/03/04/ä½¿ç”¨valgrindæ£€æµ‹å†…å­˜æ³„æ¼/","content":"\n> æœ€è¿‘å†™äº†ä¸€ä¸ª[c++é¡¹ç›®](https://github.com/kehaha-5/udp-transfiler)æ¥å­¦ä¹ ï¼Œå‘ç°å®¢æˆ·ç«¯åœ¨å¤šæ¬¡ä¸‹è½½æ–‡ä»¶åå†…å­˜åªå¢ä¸å‡ï¼Œå› æ­¤æƒ³åˆ©ç”¨ `valgrind` æ¥å¯¹æˆ‘å†™çš„å®¢æˆ·ç«¯è¿›è¡Œå†…å­˜æ³„æ¼æ£€æµ‹\n\n# æ£€æµ‹å‘½ä»¤ && å·¥å…·\n\n## æ£€æµ‹å‘½ä»¤\n\næˆ‘è¿™æ¬¡ä¸»è¦æ˜¯ä½¿ç”¨ valgrind ä¸­çš„ [massif](https://valgrind.org/docs/manual/ms-manual.html) æ¥è¿›è¡Œå†…å­˜æ³„æ¼æ£€æµ‹\n\n```bash\nvalgrind --tool=massif --time-unit=ms --detailed-freq=1 --massif-out-file=./valgrindCheck/massif.out.client ./build/TRANFILER_CLIENT \n# --time-unit=<i|ms|B> [default: i] å¯ä»¥è¯´æ˜¯è®°å½•çš„é¢—ç²’åº¦ï¼Œå¦‚æœç¨‹åºè¿è¡Œå¾ˆå¿«å°±ç”¨B\n# The time unit used for the profiling. There are three possibilities: instructions executed (i), which is good for most cases; real (wallclock) time (ms, i.e. milliseconds), which is sometimes useful; and bytes allocated/deallocated on the heap and/or stack (B), which is useful for very short-run programs, and for testing purposes, because it is the most reproducible across different machines.\n#--detailed-freq=<n> [default: 10] æ¯å¤šå°‘æ¬¡é—´éš”è®°å½•ä¸€æ¬¡è¯¦ç»†ä¿¡æ¯\n# Frequency of detailed snapshots. With --detailed-freq=1, every snapshot is detailed.\n```\n\n## æŸ¥çœ‹å·¥å…·\n\nç”Ÿæˆå‡ºæ¥çš„`massif.out.client`æ–‡ä»¶ï¼Œä½¿ç”¨ [massif-visualizer](https://apps.kde.org/zh-cn/massif-visualizer/) æ¥æŸ¥çœ‹\n\n# æµ‹è¯•è¿‡ç¨‹\nå®¢æˆ·ç«¯ä¸‹è½½ä¸€ä¸ªæ–‡ä»¶ï¼Œç„¶åå†ä¸‹è½½å¦ä¸€ä¸ªï¼Œä»¥æ­¤åå¤å‡ æ¬¡\n\n# æ£€æµ‹åˆ†æ\n\né¦–å…ˆæŒ‰ç…§æ­£å¸¸ç»“æ„æ¥è¯´ï¼Œå®¢æˆ·ç«¯å†…å­˜ä½¿ç”¨ä¼šåœ¨ä¸‹è½½æ–‡ä»¶çš„æ—¶å€™ä¸Šå‡(ä¿å­˜ä¸‹è½½è®°å½•)ï¼Œåœ¨ä¸‹è½½å®Œæˆåå†…å­˜ä½¿ç”¨ä¼šä¸‹é™\n\n### åˆ†æç»“æœ\n![ç»“æœ](./res.png)\n\né€šè¿‡ä¸Šå›¾å¯ä»¥çŸ¥é“æ­£å¸¸çš„å†…å­˜ä½¿ç”¨éƒ½æ˜¯åœ¨ä½¿ç”¨å®Œåä¼šè¢«é”€æ¯çš„ï¼Œå³å›¾ä¸­çš„æœ‰ä¸Šä¸‹å¡çº¿çš„å†…å­˜ï¼Œè€Œå­˜åœ¨å†…å­˜æ³„æ¼çš„å†…å­˜çš„å†…å­˜å°±åªæœ‰ä¸æ–­çš„ä¸Šå‡\n\n![åˆ†æ-1](./analysis-1.png)\n\næ‰“å¼€ä¸€ä¸ªè¿›è¡Œè¯¦æƒ…çš„åˆ†æ\n1. ç¨‹åºä¸­ç”¨çš„æ˜¯`protobuf`è¿›è¡Œæ¶ˆæ¯åºåˆ—åŒ–çš„ï¼Œå› æ­¤å¸¦æœ‰`google::protobuf`çš„å†…å­˜ä¿¡æ¯ï¼Œå¯ä»¥é€šè¿‡åœ¨ä¸‹è½½ç»“æŸçš„ææ„å‡½æ•°é‡Œé¢æ·»åŠ  [google::protobuf::ShutdownProtobufLibrary()](https://protobuf.dev/getting-started/cpptutorial/#:~:text=Also%20notice%20the,clean%20up%20everything) å»è§£å†³ åœ¨æœ¬é¡¹ç›®ä¸­åªè¦ä¸»çº¿ç¨‹æœ‰ä¸‹è½½æˆ–è€…å‘é€æ•°æ®å°±ä¼šç”¨åˆ°protobufæ‰€ä»¥å°±ä¸åšå¤„ç†äº†\n2. åªæœ‰ `ack::AckSet::setCbByAck`æ˜¯åœ¨ç¨‹åºä¸­ä¸ protobuf ä¸å¤ªç›¸å…³çš„\n3. è™½ç„¶ `downfile::interruption` è·Ÿ protobuf ç›¸å…³ä½†æ˜¯è¿™ä¸ªæ˜¯æœ¬æ¬¡ä¸‹è½½æ•°æ®çš„ä¸´æ—¶ä¿å­˜ï¼Œå› æ­¤åœ¨ä¸‹è½½å®Œä¹Ÿåº”è¯¥è¢«é‡Šæ”¾\n\n\n### é—®é¢˜ä¿®å¤\n\n#### `ack::AckSet::setCbByAck`\n\næŸ¥çœ‹å¯¹åº”çš„ä»£ç \n```cpp\n//è°ƒç”¨æ®µä»£ç \n_ackSetPtr->setCbByAck(ack, std::bind(&DownloaderEvents::timerExce, this, ack, resMsg));\n//å¯¹åº”æ–¹æ³•\nvoid AckSet::setCbByAck(u_long& ack, Cb cb) {\n    std::lock_guard<std::mutex> lock_guard(_ackMsgMapLock);\n    auto it = _ackMsgMap.find(ack);\n    if (it == _ackMsgMap.end()) {\n        return;\n    }\n    it->second = _timerPtr->runEvery(config::ClientConfig::getInstance().getPacketsTimerOut(), cb);\n}\n//é€šè¿‡æŸ¥çœ‹æ–¹æ³•å‘ç°è°ƒç”¨äº†æ·»åŠ å®šæ—¶å™¨çš„ä»£ç \nuint Timer::runEvery(u_long timerout, TimerCb cb) {\n    TimerEvenSharedPtr even = std::make_shared<timerEven>();\n    even->timeout = timerout;\n    even->interval = true;\n    even->cd = cb;\n    runAfter(even);\n    uint index = _currTimerIndex++;\n    _allTimerEven[index] = even;\n    return index;\n}\n```\nå…¶ä¸­ `std::unordered_map<unsigned int, std::shared_ptr<timer::timerEven>` å°±æ˜¯ `_allTimerEven` ä¸€ä¸ªç”¨äºä¿å­˜å½“å‰å®šæ—¶å™¨ä¸­æ‰€æœ‰å®šæ—¶ä»»åŠ¡çš„æˆå‘˜å¯¹è±¡ï¼Œä½†æ˜¯æˆ‘åœ¨ä¸€å®šæ¡ä»¶ä¸‹ä¼šå–æ¶ˆè¯¥å®šæ—¶ä»»åŠ¡ï¼Œæˆ‘æŸ¥æ‰¾åˆ°äº†å¯¹åº”çš„ä»£ç \n```cpp\nvoid cancelTimerEven(uint index) { _allTimerEven[index].reset(); };\n//é€šè¿‡é‡Šæ”¾shared_ptr å¯ä»¥å¯¼è‡´åœ¨è·å–è¶…æ—¶even(weak_ptr)æ—¶ æ— æ³•é€šè¿‡ lock() è·å–å…¶å¯¹è±¡ ä»è€Œå¾—å‡ºè¯¥å®šæ—¶äº‹ä»¶å·²ç»è¢«å–æ¶ˆ\n```\n\næ˜¯çš„ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•é‡Œé¢åªæœ‰é‡Šæ”¾äº†è¯¥å®šæ—¶å™¨å¯¹åº”çš„ `TimerEvenSharedPtr even` çš„æŒ‡é’ˆï¼Œæ²¡æœ‰é‡Šæ”¾å¯¹åº” `index` çš„ä¸‹æ ‡çš„ç©ºé—´ï¼Œä¿®æ”¹åçš„ä»£ç \n```cpp\nvoid cancelTimerEven(uint index) {\n    _allTimerEven[index].reset();\n    _allTimerEven.erase(index);\n};\n```\n\n#### `downfile::interruption`\n\nè¿™ä¸ªæ˜¯ç”¨äºä¿å­˜ `protobuf` çš„æ•°æ®ï¼Œå…¶ä¸­ `SingleBlockInfo` æ˜¯ä¸€ä¸ª `repeated` ç±»å‹çš„æ•°æ®ï¼Œå› æ­¤å¯ä»¥ç”¨åªèƒ½æŒ‡é’ˆçš„æ–¹å¼ï¼Œåœ¨ä¸‹è½½ç»“æŸæ—¶æ¡ç”¨å…¶`clear()`å’Œ`reset()`æ–¹æ³•æ¥é‡Šæ”¾å†…å­˜\n```cpp\n//ä¸‹è½½ç»“æŸè¦åˆ¤æ–­æ˜¯å¦ä¸‹è½½å®Œæˆï¼Œæœªå®Œæˆåˆ™ä¿å­˜ä¸­æ–­æ•°æ®åˆ°æ–‡ä»¶ï¼Œå®Œæˆçš„å°±åˆ·æ–°å‡ºæ­£å¸¸çš„æ–‡ä»¶åå‡ºæ¥\nvoid Downloader::flushAllInterruptionData() {\n    for (auto &it : _downfileInterruptionInfos) {\n        if (!it.second->isfinish()) {\n            flushInterruptionData(it.first);\n        } else {\n            delFlushInterruptionFile(it.first);\n        }\n        it.second->clear_info();\n        it.second.reset();\n    }\n    _downfileInterruptionInfos.clear();\n}\n```\n\n## é‡æ–°æµ‹è¯•\n\nç»è¿‡ä¸Šè¿°çš„ä»£ç ä¿®æ”¹åï¼Œé‡æ–°è¿è¡Œäº†ä¸€ä¸‹ç¨‹åºï¼Œå¾—åˆ°äº†ä»¥ä¸‹ç»“æœ\n\n![ç»“æœ-2](./res2.png)\n\nå½“è§‚å¯Ÿå†…å­˜è¯¦ç»†æ—¶å‘ç° `ack::AckSet::setCbByAck` å·²ç»ä¸è§äº†ï¼Œä¹Ÿå°±æ˜¯è¯´å†…å­˜è¢«æ­£å¸¸é‡Šæ”¾äº†\n\n![åˆ†æ-2-1](./analysis-2-1.png)\n\nå…¶ä¸­çš„`downfile::interruption`åœ¨ä¸€æ¬¡ä¸‹è½½å®Œæˆåä¹Ÿå‡ºç°äº†æ˜æ˜¾çš„å†…å­˜ä½¿ç”¨ä¸‹é™\n\n![åˆ†æ-2-2](./analysis-2-2.png)\n\n![åˆ†æ-2-3](./analysis-2-3.png)\n\nå†…å­˜æ³„æ¼åˆ†æè‡³æ­¤å°±å®Œæˆäº† âœŒâœŒâœŒ","tags":["valgrind","å†…å­˜æ³„æ¼"]}]