<!DOCTYPE html>
<html lang=zh-CN>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:description" content="">
    <meta property="og:type" content="website">
    <meta name="description" content="">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        k8sä¸­ä¸ºPodé…ç½®è‡ªç­¾è¯ä¹¦ä»¥è®¿é—®HTTPSæœåŠ¡ - kehaha-5
        
    </title>

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/aircloud.css">

    
<link rel="stylesheet" href="/css/gitment.css">

    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_28hi1hpxx24.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>

    









<meta name="generator" content="Hexo 7.3.0"></head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i> Just record it ! </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar radius">
            <img src="/img/avatar.jpg" />
        </div>
        <div class="name">
            <i>kehaha-5</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>ä¸»é¡µ</span>
                </a>
            </li>
            <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>æ ‡ç­¾</span>
                </a>
            </li>
            <li >
                <a href="/archives">
                    <i class="iconfont icon-guidang2"></i>
                    <span>å­˜æ¡£</span>
                </a>
            </li>
            <li >
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>å…³äº</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>æœç´¢</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5"><span class="toc-text">æ¦‚å¿µ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Https%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5"><span class="toc-text">Httpsç›¸å…³æ¦‚å¿µ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text">æ€»ç»“</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E8%B7%B5"><span class="toc-text">å®è·µ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%81%E4%B9%A6%E7%9A%84%E7%94%9F%E6%88%90%E5%92%8C%E5%AE%89%E8%A3%85"><span class="toc-text">è¯ä¹¦çš„ç”Ÿæˆå’Œå®‰è£…</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E8%87%AA%E7%AD%BE%E8%AF%81%E4%B9%A6"><span class="toc-text">ç”Ÿæˆè‡ªç­¾è¯ä¹¦</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E7%B3%BB%E7%BB%9F%E5%AE%89%E8%A3%85%E8%87%AA%E7%AD%BE%E8%AF%81%E4%B9%A6"><span class="toc-text">ä¸ºç³»ç»Ÿå®‰è£…è‡ªç­¾è¯ä¹¦</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BAPod%E9%85%8D%E7%BD%AE%E8%AF%81%E4%B9%A6"><span class="toc-text">ä¸ºPodé…ç½®è¯ä¹¦</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8%E9%95%9C%E5%83%8F%E7%B3%BB%E7%BB%9F%E4%B8%AD%E5%AE%89%E8%A3%85%E8%AF%81%E4%B9%A6"><span class="toc-text">åœ¨é•œåƒç³»ç»Ÿä¸­å®‰è£…è¯ä¹¦</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8trust-manager"><span class="toc-text">ä½¿ç”¨trust-manager</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9C%80%E5%90%8E"><span class="toc-text">æœ€å</span></a></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-bg" id="search-bg"></div>
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">æœç´¢</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>

        <div class="index-about-mobile">
            <i> Just record it ! </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        k8sä¸­ä¸ºPodé…ç½®è‡ªç­¾è¯ä¹¦ä»¥è®¿é—®HTTPSæœåŠ¡
    </div>

    <div class="post-meta">
        <span class="attr">å‘å¸ƒäºï¼š<span>2025-03-22 10:00:19</span></span>
        
        <span class="attr">æ ‡ç­¾ï¼š/
        
        <a class="tag" href="/tags/#k8s" title="k8s">k8s</a>
        <span>/</span>
        
        <a class="tag" href="/tags/#certs" title="certs">certs</a>
        <span>/</span>
        
        <a class="tag" href="/tags/#è¾¹åšè¾¹å­¦" title="è¾¹åšè¾¹å­¦">è¾¹åšè¾¹å­¦</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">è®¿é—®ï¼š<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content no-indent">
        <blockquote>
<p>æœ€è¿‘åœ¨éƒ¨ç½²ä¸€å¥—ç³»ç»Ÿçš„å…¶å®ƒç¯å¢ƒæ—¶ï¼Œé‡åˆ°äº†è‡ªç­¾httpsè¯ä¹¦å’Œåº”ç”¨è‡ªç­¾è¯ä¹¦åˆ°k8sä¸­çš„é—®é¢˜ï¼Œæ•…æ­¤è®°å½•ä¸€ä¸‹ã€‚</p>
<p>åœ¨éƒ¨ç½²çš„åº”ç”¨ä¸­ï¼Œæœ‰ä¸€ä¸ªéœ€è¦ä½¿ç”¨Standard OIDC Clientæ‰€æœ‰å¿…é¡»è¦httpsï¼Œè€Œä¸”è¦è®¤è¯çš„æœåŠ¡ä¸æ˜¯éƒ¨ç½²åœ¨æœ¬é›†ç¾¤ä¸­</p>
</blockquote>
<h1 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h1><h2 id="Httpsç›¸å…³æ¦‚å¿µ"><a href="#Httpsç›¸å…³æ¦‚å¿µ" class="headerlink" title="Httpsç›¸å…³æ¦‚å¿µ"></a>Httpsç›¸å…³æ¦‚å¿µ</h2><p>ä»€ä¹ˆæ˜¯httpsï¼Œhttpsè¯ä¹¦çš„ç§ç±»ï¼Œå¦‚ä½•è‡ªç­¾httpsè¿™äº›å†…å®¹è¿™é‡Œå°±ä¸åšå±•å¼€äº†ä»…ä½œä¸€ä¸ªè‡ªå·±çš„æ€»ç»“ã€‚å› ä¸ºç½‘ä¸Šçš„æ–‡ç« å’Œè§†é¢‘å¤ªå¤šäº†ï¼Œè¿™é‡Œæ¨èä¸€ä¸‹å‡ ä½å¤§ä½¬çš„æ–‡ç« ã€‚</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.kawabangga.com/posts/5330">æœ‰å…³ TLS&#x2F;SSL è¯ä¹¦çš„ä¸€åˆ‡ | å¡ç“¦é‚¦å™¶ï¼</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.laisky.com/p/https-in-action/#gsc.tab=0">HTTPS éšç§å®‰å…¨çš„ä¸€äº›å®è·µ</a></li>
<li><a target="_blank" rel="noopener" href="https://thiscute.world/posts/about-tls-cert/">å†™ç»™å¼€å‘äººå‘˜çš„å®ç”¨å¯†ç å­¦ï¼ˆå…«ï¼‰â€”â€” æ•°å­—è¯ä¹¦ä¸ TLS åè®® - This Cute World</a></li>
</ul>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p><strong>ä»¥ä¸‹æ€»ç»“éƒ¨åˆ†æ‘˜æŠ„ä¸ä¸Šè¿°æ–‡ç« ä¸­</strong></p>
<ul>
<li><strong>HTTPSæ˜¯HTTP+TLS</strong>ï¼Œå…¶ä¸­çš„TLSå°±æ˜¯ä¸ºäº†å‘å®¢æˆ·ç«¯è¯æ˜æœåŠ¡ç«¯è‡ªå·±çš„èº«ä»½ï¼Œé¿å…åˆ«äººä¼ªé€ è‡ªå·±çš„èº«ä»½å¯¹å®¢æˆ·ç«¯é€ æˆå½±å“ã€‚</li>
<li><strong>CAã€å®¢æˆ·ç«¯ã€ç½‘ç«™</strong>ä¹‹é—´çš„å…³ç³»<ul>
<li>å®¢æˆ·ç«¯ä¿¡ä»» CA æœºæ„ï¼›</li>
<li>CA æœºæ„ç»™ç½‘ç«™ç­¾å‘è¯ä¹¦ï¼›</li>
<li>å®¢æˆ·ç«¯åœ¨è®¿é—®ç½‘ç«™çš„æ—¶å€™ï¼Œç½‘ç«™å‡ºç¤ºè‡ªå·±çš„è¯ä¹¦ï¼Œç”±äºå®¢æˆ·ç«¯ä¿¡ä»» CA æœºæ„ï¼Œä¹Ÿå°±ä¿¡ä»» CA æœºæ„ç­¾å‘çš„è¯ä¹¦ï¼›</li>
</ul>
</li>
<li>PKI æ¶æ„ä½¿ç”¨ã€Œ<strong>æ•°å­—è¯ä¹¦é“¾</strong>ï¼ˆä¹Ÿå«åš<strong>ä¿¡ä»»é“¾</strong>ï¼‰ã€çš„æœºåˆ¶æ¥è§£å†³è¿™ä¸ªé—®é¢˜: <ul>
<li>CA æœºæ„é¦–å…ˆç”Ÿæˆè‡ªå·±çš„æ ¹è¯ä¹¦ä¸ç§é’¥ï¼Œå¹¶ä½¿ç”¨ç§é’¥ç»™æ ¹è¯ä¹¦ç­¾å<ul>
<li>å› ä¸ºç§é’¥è·Ÿè¯ä¹¦æœ¬èº«å°±æ˜¯ä¸€å¯¹ï¼Œå› æ­¤æ ¹è¯ä¹¦ä¹Ÿè¢«ç§°ä½œã€Œè‡ªç­¾åè¯ä¹¦ã€</li>
</ul>
</li>
<li>CA æ ¹è¯ä¹¦è¢«ç›´æ¥äº¤ä»˜ç»™å„å¤§è½¯ç¡¬ä»¶å‚å•†ï¼Œå†…ç½®åœ¨ä¸»æµçš„æ“ä½œç³»ç»Ÿä¸æµè§ˆå™¨ä¸­</li>
<li>ç„¶å CA æœºæ„å†ä½¿ç”¨ç§é’¥ç­¾å‘ä¸€äº›æ‰€è°“çš„ã€Œä¸­é—´è¯ä¹¦ã€ï¼Œä¹‹åå°±æŠŠç§é’¥é›ªè—äº†ï¼Œéå¿…è¦ä¸ä¼šå†æ‹¿å‡ºæ¥ä½¿ç”¨ã€‚<ul>
<li>æ ¹è¯ä¹¦çš„ç§é’¥é€šå¸¸<strong>ç¦»çº¿å­˜å‚¨</strong>åœ¨å®‰å…¨åœ°ç‚¹</li>
<li>ä¸­é—´è¯ä¹¦çš„æœ‰æ•ˆæœŸé€šå¸¸ä¼šæ¯”æ ¹è¯ä¹¦çŸ­ä¸€äº›</li>
<li>éƒ¨åˆ†ä¸­é—´è¯ä¹¦ä¼šè¢«ä½œä¸ºå¤‡ä»½ä½¿ç”¨ï¼Œå¹³å¸¸ä¸ä¼šå¯ç”¨</li>
</ul>
</li>
<li>CA æœºæ„ä½¿ç”¨è¿™äº›ä¸­é—´è¯ä¹¦çš„ç§é’¥ï¼Œä¸ºç”¨æˆ·æäº¤çš„æ‰€æœ‰ CSR è¯·æ±‚ç­¾å</li>
<li>CA æœºæ„ä¹Ÿå¯èƒ½ä¼šåœ¨ç»è¿‡ä¸¥æ ¼å®¡æ ¸åï¼Œä¸ºå…¶ä»–æœºæ„ç­¾å‘ä¸­é—´è¯ä¹¦ï¼Œè¿™æ ·å°±èƒ½èµ‹äºˆå…¶ä»–æœºæ„ç­¾å‘è¯ä¹¦çš„æƒåˆ©ï¼Œè€Œä¸”æ ¹è¯ä¹¦çš„å®‰å…¨æ€§ä¸å—å½±å“ã€‚</li>
<li>å®¢æˆ·ç«¯è¦ç›¸ä¿¡è¿™ä¸ªè¯ä¹¦ï¼Œæœ€ç»ˆçš„ç›®çš„ä¸€å®šæ˜¯éªŒè¯åˆ°ä¸€ä¸ªè‡ªå·±ä¿¡ä»»çš„ <strong>CA Root</strong> ä¸Šå»ã€‚ä¸€æ—¦éªŒè¯äº† <strong>CA Root</strong>ï¼Œå®¢æˆ·ç«¯å°±ä¿¡ä»»äº† <strong>Root</strong> ç­¾å‘çš„è¯ä¹¦ï¼Œä¹Ÿå°±ä¿¡ä»»äº†ä»–ä»¬çš„è¯ä¹¦ã€‚</li>
</ul>
</li>
<li>äº¤å‰ç­¾å<ul>
<li>å®é™…ä¸Šåœ¨ PKI ä½“ç³»ä¸­ï¼Œä¸€äº›è¯ä¹¦é“¾ä¸Šçš„ä¸­é—´è¯ä¹¦ä¼šè¢«ä½¿ç”¨å¤šä¸ªæ ¹è¯ä¹¦è¿›è¡Œç­¾åâ€”â€”æˆ‘ä»¬ç§°è¿™ä¸ºäº¤å‰ç­¾åã€‚äº¤å‰ç­¾åçš„ä¸»è¦ç›®çš„æ˜¯æå‡è¯ä¹¦çš„å…¼å®¹æ€§â€”â€”å®¢æˆ·ç«¯åªè¦å®‰è£…æœ‰å…¶ä¸­ä»»ä½•ä¸€ä¸ªæ ¹è¯ä¹¦ï¼Œå°±èƒ½æ­£å¸¸éªŒè¯è¿™ä¸ªä¸­é—´è¯ä¹¦ã€‚</li>
<li>ä»è€Œä½¿ä¸­é—´è¯ä¹¦åœ¨è¾ƒè€çš„è®¾å¤‡ä¹Ÿèƒ½é¡ºåˆ©é€šè¿‡è¯ä¹¦éªŒè¯ã€‚</li>
</ul>
</li>
<li>è¯ä¹¦çŠ¶æ€è®¤è¯ <strong>OCSPåè®®</strong><ul>
<li>ä¸ºäº†åœ¨ç§é’¥æ³„æ¼çš„æƒ…å†µä¸‹ï¼Œèƒ½å¤ŸåŠé”€å¯¹åº”çš„è¯ä¹¦ï¼ŒPKI å…¬é’¥åŸºç¡€è®¾æ–½è¿˜æä¾›äº† OCSPï¼ˆOnline Certificate Status Protocolï¼‰è¯ä¹¦çŠ¶æ€æŸ¥è¯¢åè®®ã€‚</li>
<li>Chrome&#x2F;Firefox ç­‰æµè§ˆå™¨éƒ½ä¼šå®šæœŸé€šè¿‡ OCSP åè®®å»è¯·æ±‚ CA æœºæ„çš„ OCSP æœåŠ¡å™¨éªŒè¯è¯ä¹¦çŠ¶æ€ï¼Œ è¿™å¯èƒ½ä¼šæ‹–æ…¢ HTTPS åè®®çš„å“åº”é€Ÿåº¦ã€‚</li>
<li>å› ä¸ºå®¢æˆ·ç«¯ç›´æ¥å»è¯·æ±‚ CA æœºæ„çš„ OCSP åœ°å€è·å–è¯ä¹¦çŠ¶æ€ï¼Œè¿™å°±å¯¼è‡´ CA æœºæ„å¯ä»¥è·å–åˆ°ä¸€äº›å¯¹åº”ç«™ç‚¹çš„ç”¨æˆ·ä¿¡æ¯ï¼ˆIP åœ°å€ã€ç½‘ç»œçŠ¶æ€ç­‰ï¼‰ã€‚</li>
<li>ä¸ºäº†è§£å†³è¿™ä¸¤ä¸ªé—®é¢˜ï¼Œ<a target="_blank" rel="noopener" href="https://www.rfc-editor.org/rfc/rfc6066">rfc6066</a> å®šä¹‰äº† OCSP stapling åŠŸèƒ½ï¼Œå®ƒä½¿æœåŠ¡å™¨å¯ä»¥æå‰è®¿é—® OCSP è·å–è¯ä¹¦çŠ¶æ€ä¿¡æ¯å¹¶ç¼“å­˜åˆ°æœ¬åœ°ï¼ŒåŸºæœ¬ Nginx&#x2F;Caddy ç­‰å„å¤§ Web æœåŠ¡å™¨æˆ–ç½‘å…³ï¼Œéƒ½æ”¯æŒ OCSP stapling åè®®ã€‚</li>
</ul>
</li>
</ul>
<h1 id="å®è·µ"><a href="#å®è·µ" class="headerlink" title="å®è·µ"></a>å®è·µ</h1><h2 id="è¯ä¹¦çš„ç”Ÿæˆå’Œå®‰è£…"><a href="#è¯ä¹¦çš„ç”Ÿæˆå’Œå®‰è£…" class="headerlink" title="è¯ä¹¦çš„ç”Ÿæˆå’Œå®‰è£…"></a>è¯ä¹¦çš„ç”Ÿæˆå’Œå®‰è£…</h2><h3 id="ç”Ÿæˆè‡ªç­¾è¯ä¹¦"><a href="#ç”Ÿæˆè‡ªç­¾è¯ä¹¦" class="headerlink" title="ç”Ÿæˆè‡ªç­¾è¯ä¹¦"></a>ç”Ÿæˆè‡ªç­¾è¯ä¹¦</h3><p>æµç¨‹ </p>
<ul>
<li>ç”Ÿæˆç§é’¥ key</li>
<li>ç”Ÿæˆ<strong>è¯ä¹¦ç”Ÿæˆè¯·æ±‚csr</strong>ï¼Œå¯ä»¥åœ¨<strong>csr</strong>ä¸­é…ç½®è¦ç”Ÿæˆçš„è¯ä¹¦çš„ä¿¡æ¯ï¼Œå¦‚<strong>countryNameã€stateOrProvinceNameã€organizationNameã€CAã€SAN</strong><ul>
<li><strong>SAN (Subject Alternative Name):</strong> å¯é€‰å­—æ®µï¼Œç”¨äºæŒ‡å®šè¯ä¹¦å¯ä»¥ä½¿ç”¨çš„å…¶ä»–åŸŸåæˆ–ä¸»æœºåã€‚<ul>
<li>å¯ä»¥é€šè¿‡é…ç½®è¿™ä¸ªæ¥è®©è¯ä¹¦ä¿æŠ¤å¤šä¸ªåŸŸåï¼Œä¾‹å¦‚ <code>example.com</code>ã€<code>www.example.com</code>ã€<code>*.example.com</code>ã€‚</li>
<li>å¯ä»¥ä½¿ç”¨è¿™ä¸ªé…ç½®æ¥å¯¹å¯¹åº”çš„IPè¿›è¡Œä¿æŠ¤ï¼Œå³æŠŠSANé…ç½®ä¸ºå¯¹åº”çš„IPåœ°å€</li>
</ul>
</li>
<li><strong>CA</strong>ï¼šé…ç½®ä¸º <code>TRUE</code> æˆ– <code>FALSE</code>ï¼Œå®ƒæŒ‡ç¤ºè¯¥è¯ä¹¦æ˜¯å¦å¯ä»¥ä½œä¸ºè¯ä¹¦é¢å‘æœºæ„ (CA) è¯ä¹¦ã€‚<ul>
<li>**<code>CA:TRUE</code>**ï¼šè¡¨æ˜è¯¥è¯ä¹¦å¯ä»¥ç”¨äºç­¾ç½²å…¶ä»–è¯ä¹¦ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªè¯ä¹¦å¯ä»¥ä½œä¸ºä¸€ä¸ª CA è¯ä¹¦ï¼Œé¢å‘ä¸‹çº§è¯ä¹¦ï¼Œç”¨äºåˆ›å»ºæ ¹ CA è¯ä¹¦æˆ–ä¸­é—´ CA è¯ä¹¦ã€‚ åªæœ‰ CA è¯ä¹¦æ‰èƒ½ç­¾ç½²å…¶ä»–è¯ä¹¦ï¼Œå»ºç«‹ä¿¡ä»»é“¾ã€‚</li>
<li>**<code>CA=FALSE</code>**ï¼šè¡¨æ˜è¯¥è¯ä¹¦ä¸èƒ½ç”¨äºç­¾ç½²å…¶ä»–è¯ä¹¦ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªè¯ä¹¦æ˜¯ä¸€ä¸ªç»ˆç«¯å®ä½“è¯ä¹¦ï¼Œåªèƒ½ç”¨äºèº«ä»½éªŒè¯ã€åŠ å¯†ç­‰ç›®çš„ï¼Œä¸èƒ½é¢å‘ä¸‹çº§è¯ä¹¦ï¼Œç”¨äºåˆ›å»ºæœåŠ¡å™¨è¯ä¹¦ã€å®¢æˆ·ç«¯è¯ä¹¦ã€ä»£ç ç­¾åè¯ä¹¦ç­‰ã€‚ è¿™äº›è¯ä¹¦ç”¨äºä¿æŠ¤ç‰¹å®šçš„æœåŠ¡æˆ–åº”ç”¨ç¨‹åºï¼Œè€Œä¸æ˜¯ç”¨äºé¢å‘å…¶ä»–è¯ä¹¦ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>é€šè¿‡<code>key+csr</code>ç”Ÿæˆå¯¹åº”çš„<code>crt</code>è¯ä¹¦</li>
</ul>
<p>æœ¬æ–‡é€šè¿‡<code>openssl</code>æ¥ç”Ÿæˆè‡ªç­¾è¯ä¹¦ï¼Œä»¥ä¸‹æ˜¯ç”Ÿæˆè¯ä¹¦çš„è„šæœ¬</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>

<span class="token comment"># Check if domain name is provided</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token parameter variable">-z</span> <span class="token string">"<span class="token variable">$1</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"Usage: <span class="token variable">$0</span> &lt;domain>"</span>
    <span class="token builtin class-name">exit</span> <span class="token number">1</span>
<span class="token keyword">fi</span>

<span class="token assign-left variable">DOMAIN</span><span class="token operator">=</span><span class="token variable">$1</span>
<span class="token comment"># è¯ä¹¦è¿‡æœŸæ—¥æœŸ</span>
<span class="token assign-left variable">DAYS</span><span class="token operator">=</span><span class="token number">3650</span>
<span class="token assign-left variable">COUNTRY</span><span class="token operator">=</span><span class="token string">"CN"</span>
<span class="token assign-left variable">STATE</span><span class="token operator">=</span><span class="token string">"GZ"</span>
<span class="token assign-left variable">CERT_DIR</span><span class="token operator">=</span><span class="token string">"./certs"</span>
<span class="token assign-left variable">CONFIG_FILE</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$CERT_DIR</span>/openssl.cnf"</span>

<span class="token comment"># Create directory for certificates if it doesn't exist</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token variable">$CERT_DIR</span>

<span class="token comment"># ç”Ÿæˆ private key</span>
openssl genrsa <span class="token parameter variable">-out</span> <span class="token variable">$CERT_DIR</span>/<span class="token variable">$&#123;DOMAIN&#125;</span>.key <span class="token number">2048</span>

<span class="token comment"># Create OpenSSL configuration file é€šè¿‡è¯¥é…ç½®æ–‡ä»¶ç”Ÿæˆå¯¹åº”çš„csr</span>
<span class="token function">cat</span> <span class="token operator">></span> <span class="token variable">$CONFIG_FILE</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOL
[ req ]
distinguished_name = req_distinguished_name
prompt = no
default_bits = 2048
req_extensions = cert_ext

[ req_distinguished_name ]
countryName         = <span class="token variable">$COUNTRY</span>
stateOrProvinceName = <span class="token variable">$STATE</span>
localityName        = <span class="token variable">$STATE</span>
organizationName    = <span class="token variable">$STATE</span>
commonName          = <span class="token variable">$DOMAIN</span>

[ cert_ext ]
basicConstraints = CA:TRUE # CAé…ç½® 
keyUsage = digitalSignature, keyEncipherment
extendedKeyUsage = serverAuth, clientAuth
subjectAltName = @alt_names
# SANé…ç½®
[ alt_names ]
DNS.1 = <span class="token variable">$DOMAIN</span>
DNS.2 = *.<span class="token variable">$DOMAIN</span>

EOL</span>

<span class="token comment"># Generate CSR with extensions ç”Ÿæˆcsr</span>
openssl req <span class="token parameter variable">-new</span> <span class="token parameter variable">-key</span> <span class="token variable">$CERT_DIR</span>/<span class="token variable">$&#123;DOMAIN&#125;</span>.key <span class="token parameter variable">-out</span> <span class="token variable">$CERT_DIR</span>/<span class="token variable">$&#123;DOMAIN&#125;</span>.csr <span class="token parameter variable">-config</span> <span class="token variable">$CONFIG_FILE</span>

<span class="token comment"># Generate self-signed certificate with both extensions ç”Ÿæˆcrt</span>
openssl x509 <span class="token parameter variable">-req</span> <span class="token parameter variable">-days</span> <span class="token variable">$DAYS</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">-in</span> <span class="token variable">$CERT_DIR</span>/<span class="token variable">$&#123;DOMAIN&#125;</span>.csr <span class="token punctuation">\</span>
    <span class="token parameter variable">-signkey</span> <span class="token variable">$CERT_DIR</span>/<span class="token variable">$&#123;DOMAIN&#125;</span>.key <span class="token punctuation">\</span>
    <span class="token parameter variable">-out</span> <span class="token variable">$CERT_DIR</span>/<span class="token variable">$&#123;DOMAIN&#125;</span>.crt <span class="token punctuation">\</span>
    <span class="token parameter variable">-extensions</span> cert_ext <span class="token punctuation">\</span>
    <span class="token parameter variable">-extfile</span> <span class="token variable">$CONFIG_FILE</span>

<span class="token builtin class-name">echo</span> <span class="token string">"Certificate and key have been generated in the <span class="token variable">$CERT_DIR</span> directory."</span></code></pre>

<p>å¯¹åº”ç”Ÿæˆå‡ºæ¥çš„è¯ä¹¦ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ¥è¿›è¡ŒæŸ¥çœ‹</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># æŸ¥çœ‹è¯ä¹¦(crt)ä¿¡æ¯</span>
openssl x509 <span class="token parameter variable">-noout</span> <span class="token parameter variable">-text</span> <span class="token parameter variable">-in</span> server.crt

<span class="token comment"># æŸ¥çœ‹è¯ä¹¦è¯·æ±‚(csr)ä¿¡æ¯</span>
openssl req <span class="token parameter variable">-noout</span> <span class="token parameter variable">-text</span> <span class="token parameter variable">-in</span> server.csr

<span class="token comment"># æŸ¥çœ‹ RSA ç§é’¥(key)ä¿¡æ¯</span>
openssl rsa <span class="token parameter variable">-noout</span> <span class="token parameter variable">-text</span> <span class="token parameter variable">-in</span> server.key

<span class="token comment"># éªŒè¯è¯ä¹¦æ˜¯å¦å¯ä¿¡</span>
<span class="token comment">## 1. ä½¿ç”¨ç³»ç»Ÿçš„è¯ä¹¦é“¾è¿›è¡ŒéªŒè¯</span>
openssl verify server.crt
<span class="token comment">## 2. ä½¿ç”¨æŒ‡å®šçš„ CA è¯ä¹¦è¿›è¡ŒéªŒè¯</span>
openssl verify <span class="token parameter variable">-CAfile</span> ca.crt server.crt</code></pre>

<h3 id="ä¸ºç³»ç»Ÿå®‰è£…è‡ªç­¾è¯ä¹¦"><a href="#ä¸ºç³»ç»Ÿå®‰è£…è‡ªç­¾è¯ä¹¦" class="headerlink" title="ä¸ºç³»ç»Ÿå®‰è£…è‡ªç­¾è¯ä¹¦"></a>ä¸ºç³»ç»Ÿå®‰è£…è‡ªç­¾è¯ä¹¦</h3><p>è¿™é‡Œåªä»‹ç» RockyLinux9.3 å’Œ Debain12 ã€‚å› ä¸ºæˆ‘çš„ç³»ç»Ÿæ˜¯<code>RockyLinux9.3</code>ï¼Œpodçš„é•œåƒæ˜¯ <code>Debain12</code>å…¶å®ƒçš„å¤§å·®ä¸å·®ã€‚</p>
<p>RockyLinux9.3</p>
<ul>
<li>ä¸ºRockyLinuxå®‰è£…è‡ªç­¾è¯ä¹¦è¦æœ‰ä¸€ä¸ªæ³¨æ„ç‚¹ï¼Œæ—¢è¦æŠŠè¯ä¹¦ä¸­çš„ <strong>CA</strong> è®¾ç½®ä¸º <strong>TRUE</strong></li>
<li>å¤åˆ¶è¯ä¹¦åˆ° <code>/etc/pki/ca-trust/source/anchors/</code> æ‰§è¡Œ <code>update-ca-trust </code></li>
<li>å°±ä¼šç”ŸæˆåŒ…å«ç§æœ‰è¯ä¹¦çš„<code>ca-bundle.crt</code>åˆ°<code>/etc/pki/tls/certs/</code>ä¸­</li>
</ul>
<p>Debain12</p>
<ul>
<li>å¤åˆ¶è¯ä¹¦åˆ° <code>/usr/local/share/ca-certificates/</code> æ‰§è¡Œ <code>update-ca-certificates --fresh</code></li>
<li>å°±ä¼šç”ŸåŒ…å«ç§æœ‰è¯ä¹¦çš„<code>ca-certificates.crt</code> åˆ° <code>/etc/ssl/certs/</code>ä¸­</li>
</ul>
<p>å®‰è£…å®Œæˆä»¥åï¼Œå°±å¯ä»¥ä½¿ç”¨<code>curl</code>å‘½ä»¤å¯¹è¯ä¹¦è¿›è¡ŒéªŒè¯</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># åœ¨æŠŠè¯ä¹¦é…ç½®åˆ°webæœåŠ¡åï¼Œå¯ä»¥ä½¿ç”¨curlå‘½ä»¤æ¥æŸ¥çœ‹è¯ä¹¦æ˜¯å¦åŒ¹é…</span>
<span class="token function">curl</span> <span class="token parameter variable">-v</span> https://xxx.test.com <span class="token parameter variable">--cacert</span> /etc/ssl/certs/xxx.test.com.crt </code></pre>

<h2 id="ä¸ºPodé…ç½®è¯ä¹¦"><a href="#ä¸ºPodé…ç½®è¯ä¹¦" class="headerlink" title="ä¸ºPodé…ç½®è¯ä¹¦"></a>ä¸ºPodé…ç½®è¯ä¹¦</h2><ul>
<li><p>æœ¬æ¬¡å°†ä¼šä½¿ç”¨ä¸¤ç§æ–¹å¼æ¥è¿›è¡Œé…ç½®ï¼Œä¸€ç§æ˜¯é€šè¿‡<code>init-container</code>çš„æ–¹å¼æ¥å®‰è£…è¯ä¹¦ï¼Œå¦ä¸€ç§æ˜¯ä½¿ç”¨<code>certs-manager</code>ä¸­çš„<code>trust-manager</code>æ¥è‡ªåŠ¨ç®¡ç†podçš„è¯ä¹¦</p>
</li>
<li><p>åº”ç”¨éƒ¨ç½²ç¯å¢ƒï¼šé¡¹ç›®ä½¿ç”¨çš„æ˜¯<code>Kustomize</code>æ¥éƒ¨ç½²ä¸åŒçš„ç¯å¢ƒã€‚é¡¹ç›®ä¸­çš„ä»£ç ï¼š<a target="_blank" rel="noopener" href="https://github.com/kehaha-5/k8s_demo/tree/main/certs/app">k8s_demo&#x2F;certs&#x2F;app at main Â· kehaha-5&#x2F;k8s_demo</a></p>
</li>
</ul>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@rocky-testing app<span class="token punctuation">]</span><span class="token comment"># tree -L 3</span>
<span class="token builtin class-name">.</span>
â”œâ”€â”€ debianupcaDockerfile
â”œâ”€â”€ deploy
â”‚   â”œâ”€â”€ base
â”‚   â”‚   â”œâ”€â”€ deployment.yaml
â”‚   â”‚   â””â”€â”€ kustomization.yaml
â”‚   â””â”€â”€ overlays
â”‚       â”œâ”€â”€ prod <span class="token comment"># ç”Ÿæˆç¯å¢ƒç”¨çš„æ˜¯CAçš„è¯ä¹¦</span>
â”‚       â”œâ”€â”€ uat <span class="token comment"># ä½¿ç”¨init-containerå®‰è£…è¯ä¹¦</span>
â”‚       â””â”€â”€ uat-trust <span class="token comment"># ä½¿ç”¨trust-manager</span>
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ go.mod
â”œâ”€â”€ go.sum
â”œâ”€â”€ main.go
â””â”€â”€ makefile

<span class="token number">6</span> directories, <span class="token number">8</span> files</code></pre>

<h3 id="åœ¨é•œåƒç³»ç»Ÿä¸­å®‰è£…è¯ä¹¦"><a href="#åœ¨é•œåƒç³»ç»Ÿä¸­å®‰è£…è¯ä¹¦" class="headerlink" title="åœ¨é•œåƒç³»ç»Ÿä¸­å®‰è£…è¯ä¹¦"></a>åœ¨é•œåƒç³»ç»Ÿä¸­å®‰è£…è¯ä¹¦</h3><p>æ ¹æ®ä¸Šè¿°çš„ä¸ºç³»ç»Ÿå®‰è£…è¯ä¹¦çš„æ­¥éª¤ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>init-container</code> æŠŠè¯ä¹¦å®‰è£…åˆ°åº”ç”¨çš„<code>pod</code>ä¸­ã€‚æ³¨æ„ä¸€äº›é•œåƒæ˜¯æ²¡æœ‰é»˜è®¤å®‰è£…<code>ca-certificates </code> éœ€è¦é¢å¤–å®‰è£…æˆ–è€…æŠŠç‰©ç†æœºçš„è¯ä¹¦<code>COPY</code>åˆ°é•œåƒå†…</p>
<ol>
<li>é¦–å…ˆå…ˆæŠŠè¯ä¹¦crt applyåˆ°k8sçš„secretä¸­</li>
</ol>
<pre class="language-bash" data-language="bash"><code class="language-bash">kubectl create secret generic ssl-test-web-crt --from-file<span class="token operator">=</span>./ssl.test.com.crt --dry-run<span class="token operator">=</span>client  <span class="token parameter variable">-o</span> yaml  <span class="token operator">|</span> kubectl apply <span class="token parameter variable">-f</span> -</code></pre>

<ol start="2">
<li>ä½¿ç”¨<code>init-container</code> æŠŠè¯ä¹¦ç”Ÿæˆåˆ°<code>ca-certificates.crt</code>ä¸­ï¼ŒåŒæ—¶æŠŠæ–°çš„è¯ä¹¦æŒ‚è½½åˆ°åº”ç”¨çš„<code>Pod</code>ä¸­</li>
</ol>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> kustomize.config.k8s.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Kustomization

<span class="token punctuation">...</span>.

<span class="token key atrule">patchesJson6902</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">target</span><span class="token punctuation">:</span>
      <span class="token key atrule">group</span><span class="token punctuation">:</span> apps
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
      <span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
      <span class="token key atrule">name</span><span class="token punctuation">:</span> https<span class="token punctuation">-</span>client
    <span class="token key atrule">patch</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token punctuation">-</span>
    <span class="token punctuation">...</span>..
      <span class="token punctuation">-</span> <span class="token key atrule">op</span><span class="token punctuation">:</span> add
      <span class="token comment"># æŠŠåŒ…å«è¯ä¹¦çš„secretæŒ‚è½½åˆ°volumesä¸­</span>
        <span class="token key atrule">path</span><span class="token punctuation">:</span> /spec/template/spec/volumes/<span class="token punctuation">-</span>
        <span class="token key atrule">value</span><span class="token punctuation">:</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> ssl<span class="token punctuation">-</span>test<span class="token punctuation">-</span>web<span class="token punctuation">-</span>crt
          <span class="token key atrule">secret</span><span class="token punctuation">:</span>
            <span class="token key atrule">secretName</span><span class="token punctuation">:</span> ssl<span class="token punctuation">-</span>test<span class="token punctuation">-</span>web<span class="token punctuation">-</span>crt
      <span class="token punctuation">-</span> <span class="token key atrule">op</span><span class="token punctuation">:</span> add
      <span class="token comment"># æŠŠç”Ÿæˆå¥½çš„ca-certificates.crtæŒ‚è½½åˆ°åº”ç”¨ä¸Š</span>
        <span class="token key atrule">path</span><span class="token punctuation">:</span> /spec/template/spec/containers/0/volumeMounts/<span class="token punctuation">-</span>
        <span class="token key atrule">value</span><span class="token punctuation">:</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> ssl<span class="token punctuation">-</span>certs
          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/ssl/certs/
      <span class="token punctuation">-</span> <span class="token key atrule">op</span><span class="token punctuation">:</span> add
      <span class="token comment"># ä½¿ç”¨emptyDiræ¥ä¸´æ—¶ä¿å­˜ç”Ÿæˆçš„ca-certificates.crt</span>
        <span class="token key atrule">path</span><span class="token punctuation">:</span> /spec/template/spec/volumes/<span class="token punctuation">-</span>
        <span class="token key atrule">value</span><span class="token punctuation">:</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> ssl<span class="token punctuation">-</span>certs
          <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
      <span class="token punctuation">-</span> <span class="token key atrule">op</span><span class="token punctuation">:</span> add
        <span class="token key atrule">path</span><span class="token punctuation">:</span> /spec/template/spec/initContainers
        <span class="token key atrule">value</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> init<span class="token punctuation">-</span>container
            <span class="token key atrule">image</span><span class="token punctuation">:</span> debian
            <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"update-ca-certificates --fresh &amp;&amp; cp -r /etc/ssl/certs/* /mnt/ssl-certs/"</span> <span class="token punctuation">]</span>
            <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ssl<span class="token punctuation">-</span>test<span class="token punctuation">-</span>web<span class="token punctuation">-</span>crt
                <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/local/share/ca<span class="token punctuation">-</span>certificates/
              <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ssl<span class="token punctuation">-</span>certs
                <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /mnt/ssl<span class="token punctuation">-</span>certs</code></pre>

<ol start="3">
<li>ä½¿ç”¨ <code>kubectl apply -k ./deploy/overlays/uat/</code>éƒ¨ç½²è¯¥ç¯å¢ƒ</li>
</ol>
<p>æŸ¥çœ‹æ—¥å¿—å¯¹åº”çš„æ—¥å¿—ï¼Œå‘ç°<code>init-container</code>ç”Ÿæˆæ–°è¯ä¹¦ï¼Œå¹¶ä¸”åº”ç”¨httpsè®¿é—®æˆåŠŸ</p>
<p><img src="/2025/03/22/k8s%E4%B8%AD%E4%B8%BAPod%E9%85%8D%E7%BD%AE%E8%87%AA%E7%AD%BE%E8%AF%81%E4%B9%A6%E4%BB%A5%E8%AE%BF%E9%97%AEHTTPS%E6%9C%8D%E5%8A%A1/uat-log.png" alt="log"></p>
<h3 id="ä½¿ç”¨trust-manager"><a href="#ä½¿ç”¨trust-manager" class="headerlink" title="ä½¿ç”¨trust-manager"></a>ä½¿ç”¨trust-manager</h3><p>åœ¨<code>certs-manager</code>çš„æ–‡æ¡£ä¸­æœ‰ä¸€ä¸ªå«<code>trust-manager</code>çš„ç»„ä»¶<a target="_blank" rel="noopener" href="https://cert-manager.io/docs/trust/trust-manager/">trust-manager - cert-manager Documentation</a></p>
<blockquote>
<p>trust-manager is the easiest way to manage trust bundles in Kubernetes and OpenShift clusters.</p>
<p>It orchestrates bundles of trusted X.509 certificates which are primarily used for validating certificates during a TLS handshake but can be used in other situations, too.</p>
</blockquote>
<ul>
<li><p>ä½ å¯ä»¥å•ç‹¬å®‰è£…<code>trust-manager</code>ï¼Œä½¿ç”¨é‡Œé¢çš„<code>bundles</code>æ¥é…ç½®è¯ä¹¦<a target="_blank" rel="noopener" href="https://cert-manager.io/docs/trust/trust-manager/installation/#installing-trust-manager-without-cert-manager">https://cert-manager.io/docs/trust/trust-manager/installation/#installing-trust-manager-without-cert-manager</a></p>
</li>
<li><p>ä¹Ÿå¯ä»¥å®‰è£…<code>certs-manager</code>å’Œ<code>trust-manager</code>ï¼Œä½¿ç”¨<code>certs-manager</code>ç”Ÿæˆè‡ªç­¾è¯ä¹¦ï¼Œç„¶åé…ç½®åˆ°<code>trust-manager</code>ä¸­ <a target="_blank" rel="noopener" href="https://cert-manager.io/docs/trust/trust-manager/#quick-start-example">https://cert-manager.io/docs/trust/trust-manager/#quick-start-example</a></p>
</li>
</ul>
<p>æˆ‘è¿™é‡Œç›´æ¥åªå®‰è£…<code>trust-manager</code>ä½¿ç”¨<code>bundles</code>æ¥é…ç½®è¯ä¹¦</p>
<ul>
<li>å…ˆé€šè¿‡<code>helm</code>å®‰è£…<code>trust-manager</code><ul>
<li>æ³¨æ„å®‰è£…çš„æ—¶å€™æœ‰ä¸€ä¸ª<code>app.trust.namespace</code>çš„é…ç½®(é»˜è®¤å€¼ä¸ºcert-manager)ï¼Œè¿™ä¸ªé…ç½®å®šä¹‰äº†é‚£äº›<code>namespace</code>ä¸‹çš„<code>Secret</code>å¯ä»¥è¢«è¯»å–ï¼Œè¿™æ ·ä¿è¯äº†åº”ç”¨çš„å®‰å…¨ <a target="_blank" rel="noopener" href="https://cert-manager.io/docs/trust/trust-manager/installation/#trust-namespace">https://cert-manager.io/docs/trust/trust-manager/installation/#trust-namespace</a></li>
</ul>
</li>
</ul>
<blockquote>
<p>By default, the trust namespace is the only namespace where<code>Secret</code>s will be read. This restriction is in place for security reasons - we donâ€™t want to give trust-manager the permission to read all <code>Secret</code>s in all namespaces. With additional configuration, secrets may be read from or written to other namespaces.</p>
</blockquote>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml">helm repo add jetstack https<span class="token punctuation">:</span>//charts.jetstack.io <span class="token punctuation">-</span><span class="token punctuation">-</span>force<span class="token punctuation">-</span>update
helm upgrade trust<span class="token punctuation">-</span>manager jetstack/trust<span class="token punctuation">-</span>manager \
  <span class="token punctuation">-</span><span class="token punctuation">-</span>install \
  <span class="token punctuation">-</span><span class="token punctuation">-</span>namespace cert<span class="token punctuation">-</span>manager \
  <span class="token punctuation">-</span><span class="token punctuation">-</span>wait
<span class="token comment"># å¯ä»¥åˆ©ç”¨ helm template å‘½ä»¤ç”Ÿæˆå¯¹åº”çš„helm value </span>
helm template \
  trust<span class="token punctuation">-</span>manager jetstack/cert<span class="token punctuation">-</span>manager \
  <span class="token punctuation">-</span><span class="token punctuation">-</span>namespace cert<span class="token punctuation">-</span>manager 
  <span class="token punctuation">></span> cert<span class="token punctuation">-</span>manager.custom.yaml</code></pre>

<ul>
<li>å…ˆæŠŠè¯ä¹¦å¯¼å…¥åˆ°<code>trust-namespace</code>çš„</li>
</ul>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml">kubectl create secret generic ssl<span class="token punctuation">-</span>test<span class="token punctuation">-</span>web<span class="token punctuation">-</span>crt <span class="token punctuation">-</span><span class="token punctuation">-</span>from<span class="token punctuation">-</span>file=./ssl.test.com.crt <span class="token punctuation">-</span><span class="token punctuation">-</span>dry<span class="token punctuation">-</span>run=client <span class="token punctuation">-</span>n cert<span class="token punctuation">-</span>manager  <span class="token punctuation">-</span>o yaml  <span class="token punctuation">|</span> kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span>   </code></pre>

<ul>
<li>ç¼–å†™å¯¹åº”çš„<code>Bundle</code><ul>
<li><code>Bundle</code>ä¼šè‡ªå·±åœ¨å¯¹åº”çš„<code>namespcae</code>ä¸‹é¢ç”Ÿæˆä¸€ä¸ª <code>public-bundle</code> çš„ <code>configMap</code></li>
</ul>
</li>
</ul>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> trust.cert<span class="token punctuation">-</span>manager.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Bundle
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> public<span class="token punctuation">-</span>bundle
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">sources</span><span class="token punctuation">:</span>
<span class="token comment"># ä¸ºtrueä¼šå¸®ä½ æ›´æ–°å¯¹åº”å®¹å™¨ä¸­çš„CAè¯ä¹¦</span>
<span class="token comment"># https://cert-manager.io/docs/trust/trust-manager/#securely-maintaining-a-trust-manager-installation</span>
  <span class="token punctuation">-</span> <span class="token key atrule">useDefaultCAs</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token punctuation">-</span> <span class="token key atrule">secret</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"ssl-test-web-crt"</span>
      <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">"ssl.test.com.crt"</span>
  <span class="token key atrule">target</span><span class="token punctuation">:</span>
    <span class="token key atrule">configMap</span><span class="token punctuation">:</span>
      <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">"ca-certificates.crt"</span>
<span class="token comment"># è¿™é‡Œè¦ç»™å¯¹åº”è¦ç”Ÿæˆ public-bundle configMap çš„namespace æ‰“ä¸Šlabel</span>
<span class="token comment"># kubectl label ns default trust=enabled</span>
    <span class="token key atrule">namespaceSelector</span><span class="token punctuation">:</span>
      <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
        <span class="token key atrule">trust</span><span class="token punctuation">:</span> enabled</code></pre>

<ul>
<li>æˆ‘ä»¬åªéœ€è¦åœ¨å¯¹åº”çš„å®¹å™¨ä¸­æŒ‚è½½<code>public-bundle</code>åˆ°<code>/etc/ssl/certs</code></li>
</ul>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> kustomize.config.k8s.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Kustomization

<span class="token key atrule">resources</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> ../../base

<span class="token punctuation">...</span>..

<span class="token key atrule">patchesJson6902</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">target</span><span class="token punctuation">:</span>
      <span class="token key atrule">group</span><span class="token punctuation">:</span> apps
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
      <span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
      <span class="token key atrule">name</span><span class="token punctuation">:</span> https<span class="token punctuation">-</span>client
    <span class="token key atrule">patch</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token punctuation">-</span>
<span class="token punctuation">...</span>..
      <span class="token punctuation">-</span> <span class="token key atrule">op</span><span class="token punctuation">:</span> add
        <span class="token key atrule">path</span><span class="token punctuation">:</span> /spec/template/spec/volumes/<span class="token punctuation">-</span>
        <span class="token key atrule">value</span><span class="token punctuation">:</span>
        <span class="token comment">#å£°æ˜Volumes</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> public<span class="token punctuation">-</span>bundle
          <span class="token key atrule">configMap</span><span class="token punctuation">:</span>
            <span class="token key atrule">name</span><span class="token punctuation">:</span> public<span class="token punctuation">-</span>bundle
            <span class="token key atrule">defaultMode</span><span class="token punctuation">:</span> <span class="token number">0644</span>
            <span class="token key atrule">optional</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
      <span class="token punctuation">-</span> <span class="token key atrule">op</span><span class="token punctuation">:</span> add
        <span class="token key atrule">path</span><span class="token punctuation">:</span> /spec/template/spec/containers/0/volumeMounts/<span class="token punctuation">-</span>
        <span class="token key atrule">value</span><span class="token punctuation">:</span>
        <span class="token comment"># VolumeMounts æŒ‚è½½åˆ°/etc/ssl/certs/</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> public<span class="token punctuation">-</span>bundle
          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/ssl/certs/
          <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

<span class="token key atrule">images</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> https<span class="token punctuation">-</span>client
    <span class="token key atrule">newTag</span><span class="token punctuation">:</span> v1.0
    <span class="token key atrule">newName</span><span class="token punctuation">:</span> https<span class="token punctuation">-</span>client</code></pre>

<ul>
<li>å¦‚æœæˆåŠŸäº†ï¼Œåœ¨å®¹å™¨ä¸­å°±ä¼šå¦‚ä¸‹æ˜¾ç¤º</li>
</ul>
<pre class="language-bash" data-language="bash"><code class="language-bash">root@https-client-6b74cfbddd-2nw2r:/app<span class="token comment"># ls -ltr /etc/ssl/certs/ca-certificates.crt              </span>
lrwxrwxrwx. <span class="token number">1</span> root root <span class="token number">26</span> Mar <span class="token number">23</span> 06:26 /etc/ssl/certs/ca-certificates.crt -<span class="token operator">></span> <span class="token punctuation">..</span>data/ca-certificates.crt</code></pre>

<h1 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h1><p>å¯¹æ¯”ä¸Šè¿°çš„ä¸¤ç§æ–¹æ³•</p>
<p>ç¬¬ä¸€ç§æ–¹æ³•æˆ‘è§‰å¾—æ¯”è¾ƒç®€å•ï¼Œæ— é¡»é¢å¤–å®‰è£…å…¶å®ƒç»„ä»¶ï¼Œä½†æ˜¯å¯¹é…ç½®çš„å…¥ä¾µæ€§æ¯”è¾ƒé«˜ï¼Œéœ€è¦é¢å¤–é…ç½®ä¸€ä¸ªæœ‰<code>ca-certificates</code>çš„<code>init-container</code></p>
<p>ç¬¬äºŒç§æ–¹æ³•éœ€è¦é¢å¤–å®‰è£…å¤šä¸€ä¸ª<code>trust-manager</code>ï¼Œä½†æ˜¯è½å®åˆ°å…·ä½“çš„<code>Pod</code>é…ç½®åªéœ€è¦é¢å¤–æŒ‚è½½ä¸€ä¸ª <code>ConfigMap</code> åˆ°å¯¹åº”çš„è¯ä¹¦è·¯å¾„å³å¯ï¼ŒåŒæ—¶å¯¹åº”çš„<code>bundle/public-bundle</code>ä¹Ÿæ˜¯æ”¯æŒè‡ªåŠ¨æ›´æ–°çš„ï¼Œå³ä½ çš„<code>secret</code>æ›´æ–°äº†ï¼Œå®ƒä¹Ÿä¼šè‡ªåŠ¨åŒæ­¥ã€‚</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@rocky-testing ~<span class="token punctuation">]</span><span class="token comment"># kubectl get events</span>
LAST SEEN   TYPE     REASON              OBJECT                               MESSAGE
52m         Normal   Synced              bundle/public-bundle                 Successfully synced Bundle to namespaces that match this label selector: <span class="token assign-left variable">trust</span><span class="token operator">=</span>enabled</code></pre>

<p>å½“ç„¶é™¤äº†ä¸Šè¿°ä¸¤ç§æ–¹æ³•ï¼Œè¿˜æœ‰æ²¡æœ‰<strong>æ›´ç®€å•çš„æ–¹æ³•ï¼Œç”šè‡³ä¸éœ€è¦é¢å¤–çš„é…ç½®</strong>ğŸ¤”</p>
<p>æœ‰çš„ï¼å¦‚æœä½ å…¬å¸æœ‰ä¸€ä»½æ”¯æŒå¤šåŸŸåçš„è¯ä¹¦ï¼Œå°±å¯ä»¥ç›´æ¥ä½¿ç”¨è¯¥ crt(ä¸€èˆ¬å«åšxxx_chain.crtæˆ–è€….pem) å’Œ key</p>
<p>å¦‚ä½•æŸ¥çœ‹ï¼Ÿä½¿ç”¨ <code>openssl x509 -noout -text -in server.crt</code> æŸ¥çœ‹è¯ä¹¦ä¿¡æ¯ ç±»ä¼¼å¦‚ä¸‹</p>
<pre class="language-text" data-language="text"><code class="language-text">           Â·Â·Â·Â·Â·Â·Â·
# å¦‚æœ SAN (Subject Alternative Name) ä¸­åŒ…å«å¤šä¸ªåŸŸå æˆ–è€… é€šé…ç¬¦ *.test.com 
           X509v3 Subject Alternative Name: 
               DNS:*.test.com, DNS:test.com, DNS:abc.test.com
   Signature Algorithm: sha256WithRSAEncryption
   Signature Value:
   Â·Â·Â·Â·Â·Â·</code></pre>

<p>è¿™æ ·ä½ å°±å¯ä»¥ç”¨ <code>abc.test.com</code> ç­‰ç±»ä¼¼çš„<code>xxx.test.com</code> çš„äºŒçº§åŸŸå (æ³¨æ„ä¸‰çº§ä¸è¡Œ å¦‚ <code>xxx.adb.test.com</code>)</p>
<p>å†é€šè¿‡ä¿®æ”¹hostsæˆ–è€…k8sä¸­çš„corednsï¼Œå°±å¯ä»¥ä½¿ç”¨ä¸éœ€è¦é¢å¤–é…ç½®ä½¿ç”¨<code>Https</code>äº† ğŸ˜Š</p>

        
        <br />
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>
        <div id="lv-container"></div>
        <div class="giscus"></div>
    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        
        <li>
            <a target="_blank"  href="https://github.com/kehaha-5">
                            <span class="fa-stack fa-lg">
                                <i class="iconfont icon-github"></i>
                            </span>
            </a>
        </li>
        

        

    </ul>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>  Theme <a target="_blank" rel="noopener" href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>

<script src="/js/index.js"></script>

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




    <script src="https://giscus.app/client.js"
        data-repo="kehaha-5/kehaha-5.github.io"
        data-repo-id="R_kgDOLah6DA"
        data-category="Announcements"
        data-category-id="DIC_kwDOLah6DM4CvJGE"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="preferred_color_scheme"
        data-lang="zh-CN"
        data-loading="lazy"
        crossorigin="anonymous"
        async>
</script>




</html>

<!-- fancybox support -->

    <!-- for theme: default is false -->
    <!-- for page: default is true -->
    
<script src="/js/fancybox/jquery.fancybox.min.js" key="fancybox_js"></script>
<script src="/js/fancybox/wrapImage.js" key="wrap_image_js"></script>

        
<link rel="stylesheet" href="/js/fancybox/jquery.fancybox.min.css" key="fancybox_css">

            