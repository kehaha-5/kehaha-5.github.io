[{"name":"Execute tasks on Windows host","hosts":"win","gather_facts":"no","vars":{"env_var_name":"RQD_TAGS","env_var_value":"AMD_EPYC_7542_64C_128T Houdini_20.5.487 Maya_2024 MtoA_5.3.4.1 HtoA_6.3.6.1","nas_password":"isoftstone ","nas_username":"isoftstone","kill_rqd_script":"Z:\\rqd\\ansible\\kill_rqd.bat","pause_seconds":120},"tasks":[{"name":"Display environment variable value","ansible.builtin.debug":{"msg":"Environment Variable Value: {{ env_var_value }}"}},{"name":"Set Windows Environment Variable","ansible.windows.win_environment":{"state":"present","name":"{{ env_var_name }}","value":"{{ env_var_value }}","level":"user"}},{"name":"Execute kill rqd batch script","ansible.windows.win_shell":{"_raw_params":"$port = 8444\n$connections = Get-NetTCPConnection -LocalPort $port -ErrorAction SilentlyContinue\nif ($connections) {\n    foreach ($conn in $connections) {\n        $pidToKill = $conn.OwningProcess\n        Write-Output \"Terminating process with PID $pidToKill listening on port $port\"\n        Stop-Process -Id $pidToKill -Force -ErrorAction SilentlyContinue\n    }\n} else {\n    Write-Output \"No process is listening on port $port\"\n}\n"}},{"name":"Execute start rqd script asynchronously using PowerShell","ansible.windows.win_powershell":{"script":"$rqd_path = \"C:\\Users\\xingzai\\AppData\\Local\\Programs\\Python\\Python38\\Scripts\\rqd.exe\"\n# 检查 rqd.exe 是否已经在运行\n$process = Get-Process -Name rqd -ErrorAction SilentlyContinue\nif ($process) {\n    Write-Host \"rqd.exe 已经在运行。\"\n} else {\n    Write-Host \"starting rqd.exe...\"\n    try {\n        # 使用 Start-Process 启动 rqd.exe，指定 WindowStyle 为 Normal 以确保新窗口\n        # ErrorAction Stop 会在 Start-Process 失败时产生错误\n        Start-Process -FilePath $rqd_path -WindowStyle Normal -ErrorAction Stop\n        Write-Host \"rqd.exe start success.\"\n    } catch {\n        Write-Host \"start rqd.exe failed, please check the path or permission. Error: $($_.Exception.Message)\"\n        # 如果启动失败，可以根据需要设置非零退出码\n        # exit 1\n    }\n}\n# 脚本执行完毕后立即退出\nexit 0\n"},"async":300,"poll":0}]}]